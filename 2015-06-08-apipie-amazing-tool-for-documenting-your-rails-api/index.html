<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=cache-control content="max-age=0"><meta http-equiv=cache-control content="no-cache"><meta http-equiv=expires content="0"><meta http-equiv=expires content="Tue, 01 Jan 1980 1:00:00 GMT"><meta http-equiv=pragma content="no-cache"><link rel=apple-touch-icon-precomposed sizes=192x192 href=/icon-192x192.png><link rel="shortcut icon" href=/favicon.ico><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#1b1b1b"><meta name=description content="Apipie - amazing tool for documenting your Rails API"><title>Apipie - amazing tool for documenting your Rails API | Ilya Bylich - Blog</title><style>:root{--background:#ffffff}@media(prefers-color-scheme:dark){:root{--background:#1b1b1b}}html{background-color:var(--background)}body{background-color:var(--background)}</style><link rel=stylesheet type=text/css href=/style.min.c8a2df3058ea59fb74948f071267ef16e3a4d0b23b7ec84883692939ef5dea45.css media=all></head><body><nav><ul class=menu><li><a tabindex=-1 class=menu-link href=/>Home</a></li><li><a tabindex=-1 class=menu-link href=https://github.com/iliabylich>GitHub</a></li><li><a tabindex=-1 class=menu-link href=https://twitter.com/IlyaBylich>Twitter</a></li><li><a tabindex=-1 class=menu-link href=mailto:ibylich@gmail.com>Email me</a></li><li><a tabindex=-1 class=menu-link href=/index.xml>RSS</a></li></ul></nav><div id=single-header><h1>Apipie - amazing tool for documenting your Rails API</h1><div id=single-meta><span class=datesub>Jun 8, 2015</span>
<span id=tags>&nbsp;&nbsp;
<span><a href=https://iliabylich.github.io/tags/ruby/>#ruby</a>
</span>&nbsp; <span><a href=https://iliabylich.github.io/tags/apipie/>#apipie</a>
</span>&nbsp; <span><a href=https://iliabylich.github.io/tags/documenting/>#documenting</a>
</span>&nbsp; <span><a href=https://iliabylich.github.io/tags/api/>#api</a>
</span>&nbsp;</span></div></div><aside class="hidden lg:block toc" id=tableOfContentContainer><nav id=TableOfContents><ul><li><a href=#apipie>Apipie</a></li><li><a href=#features>Features</a><ul><li><a href=#gathering-information-from-your-routes>Gathering information from your routes</a></li><li><a href=#api-versioning>API versioning</a></li><li><a href=#parameters-typing>Parameters typing</a></li><li><a href=#parameters-validation>Parameters validation</a></li><li><a href=#concerns>Concerns</a></li><li><a href=#specs-recording>Specs recording</a></li><li><a href=#other-features>Other features</a></li></ul></li><li><a href=#customization>Customization</a><ul><li><a href=#extracting-docs-to-mixins>Extracting docs to mixins</a></li><li><a href=#the-power-of-ruby-based-doc>The power of ruby-based doc</a></li><li><a href=#ability-to-define-default-documentation-for-all-actions-in-resource>Ability to define default documentation for all actions in resource</a></li></ul></li><li><a href=#demo>Demo</a></li><li><a href=#conclusion>Conclusion</a></li></ul></nav></aside><main><h2 id=apipie>Apipie</h2><p>This article is about <a href=https://github.com/Apipie/apipie-rails target=_blank rel="noreferrer nofollow">Apipie gem</a>
which provides a DSL for documenting your API. I will try to cover features that I personally use on my project.</p><p>Comparing to other tools for generating API documentation (<code>yardoc</code>, <code>sdoc</code>) I would say that the main thing that you gain with Apipie is that your documentation is a real ruby code, so you can write computations, concerns etc.</p><p>Here is a simple example of how it looks in code:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>UsersController</span> <span style=color:#f92672>&lt;</span> <span style=color:#66d9ef>ApplicationController</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  resource_description <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>    formats <span style=color:#f92672>[</span><span style=color:#e6db74>:json</span><span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>    api_versions <span style=color:#e6db74>&#39;public&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  api <span style=color:#e6db74>:POST</span>, <span style=color:#e6db74>&#39;/users&#39;</span> <span style=color:#e6db74>&#39;Create user&#39;</span>
</span></span><span style=display:flex><span>  description <span style=color:#e6db74>&#39;Create user with specifed user params&#39;</span>
</span></span><span style=display:flex><span>  param <span style=color:#e6db74>:user</span>, <span style=color:#66d9ef>Hash</span>, <span style=color:#e6db74>desc</span>: <span style=color:#e6db74>&#39;User information&#39;</span> <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>    param <span style=color:#e6db74>:full_name</span>, String, <span style=color:#e6db74>desc</span>: <span style=color:#e6db74>&#39;Full name of the user&#39;</span>
</span></span><span style=display:flex><span>    param <span style=color:#e6db74>:age</span>, <span style=color:#66d9ef>Fixnum</span>, <span style=color:#e6db74>desc</span>: <span style=color:#e6db74>&#39;Age of the user&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>create</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Some application code</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><p>So, you invoke a DSL from Apipie before your action method and it automatically comes to generated docs.</p><h2 id=features>Features</h2><h3 id=gathering-information-from-your-routes>Gathering information from your routes</h3><p>In the example above we have passed an HTTP verb and a path of this action. We don&rsquo;t have to do it! Instead, we can simply write:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span>api! <span style=color:#e6db74>&#39;Some description&#39;</span>
</span></span><span style=display:flex><span><span style=color:#75715e># other docs here...</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>create</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><p>It automatically takes information from your routes that look like</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span>resources <span style=color:#e6db74>:users</span>, <span style=color:#e6db74>only</span>: <span style=color:#f92672>[</span><span style=color:#e6db74>:create</span><span style=color:#f92672>]</span>
</span></span></code></pre></div><h3 id=api-versioning>API versioning</h3><p>You can pass versions of your API that include this endpoint on</p><ol><li>resource level (as in example)</li><li>action level (in pretty much the same way, <code>api_versions ...</code></li></ol><h3 id=parameters-typing>Parameters typing</h3><p>As you can see, in the first example we had 3 types:</p><ol><li><code>Hash</code></li><li><code>Array</code></li><li><code>Fixnum</code></li></ol><p>Apipie has also:
4. <code>Enum</code>
5. <code>Regexp</code></p><h3 id=parameters-validation>Parameters validation</h3><p>We have already typed parameters, so why do we ignore it and write custom <code>before_action</code>-s for validating parameters manually? This feature is enabled by default, but if you don&rsquo;t think that it&rsquo;s a good idea to validate your parameters through documenting tool, just pass</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span>config<span style=color:#f92672>.</span>validate <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>
</span></span></code></pre></div><p>The creator of the gem told me that &lsquo;People either love it or don&rsquo;t understand why it&rsquo;s even there&rsquo;, so it&rsquo;s up to you to decide if you need it.</p><h3 id=concerns>Concerns</h3><p>I would say that it does not work as people usually expect.</p><p><code>Apipie::DSL::Concern</code> allows you to document actions that are defined in concerns.</p><p><a href=https://github.com/Apipie/apipie-rails#concerns target=_blank rel="noreferrer nofollow">A quick example</a></p><p>Usually people think that it allows you to extract documentation from your controller in order to not mix code with documentation and application logic. And, to be honest, I think so too. The workaround for doing this goes below in the sections &lsquo;Extracting docs to mixins&rsquo;</p><h3 id=specs-recording>Specs recording</h3><p>Are you tired of writing examples manually? Me too :) With Apipie you can record request/response pairs to separated YAML file and display them in generated HTML. Pass <code>:show_in_doc</code> to metadata of your RSpec example and enjoy. Apipie embeds a module for recording requests to <code>ActionController::TestCase::Behavior</code> which is the core of all requests specs for RSpec and Minitest (yes, both of them delegate performing requests internally to <code>ActionController::TestCase::Behavior</code> - <a href=https://github.com/rspec/rspec-rails/blob/master/lib/rspec/rails/example/controller_example_group.rb#L12 target=_blank rel="noreferrer nofollow">source</a>
).</p><h3 id=other-features>Other features</h3><p>There is a plenty of other things in Apipie that are very cool, by I did not have a chance to use it yet.</p><ol><li>Localization. Currently it supports English, Russian, Chinese and Brazilian. If you want to add support for your language, use this as an example - <a href=https://github.com/Apipie/apipie-rails/blob/master/config/locales/en.yml target=_blank rel="noreferrer nofollow">source</a></li><li>Disqus integration. This is extremely useful when you have a decentralized team. If you have any questions - just leave a comment and wait for response! No need to define any models for storing users/comments/relations, everything is in the cloud.</li><li>Custom markup processors. Not sure that anyone can need it, default markup processor looks very stable.</li></ol><h2 id=customization>Customization</h2><p>Some of these items can be difficult to explain, if you have any questions after reading it, just google it, answers for all of them should be in ruby docs (or ping me if you still don&rsquo;t get it).</p><h3 id=extracting-docs-to-mixins>Extracting docs to mixins</h3><p>This is the main question I have got after reading official README. I don&rsquo;t want to mix documentation and application logic. First of all we need to understand how exactly Apipie builds mapping between action names and compiled DSL. Even without reading source code the only guess that we may have is <code>method_added</code> hook. Every time when you define a method (on instance or on class, it does not matter), Ruby automatically fires <code>method_added</code> method on your class.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>TestClass</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>self</span><span style=color:#f92672>.</span><span style=color:#a6e22e>method_added</span>(method_name)
</span></span><span style=display:flex><span>    puts <span style=color:#e6db74>&#34;Added method </span><span style=color:#e6db74>#{</span>method_name<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>method1</span>; <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>method2</span>; <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#75715e># =&gt; Added method method1</span>
</span></span><span style=display:flex><span><span style=color:#75715e># =&gt; Added method method2</span>
</span></span></code></pre></div><p>So, the algorithm is like this:</p><ol><li>You invoke method <code>api</code> (or <code>api!</code>)</li><li>Apipie internally saves action name (let&rsquo;s say, as <code>Apipie.current_action_name</code>) and arguments (in <code>Apipie.current_action_data</code>, for example)</li><li>You invoke other DSL methods</li><li>Apipie appends this data to <code>Apipie.current_action_data</code></li><li>You define a method (action in our case)</li><li>Apipie adds mapping <code>Apipie.current_action_name => Apipie.current_action_data</code> to a global Hash like <code>Apipie.all_docs</code></li><li>When you visit <code>/docs</code>, Apipie displays all data from <code>Apipie.all_docs</code></li></ol><p>And if it&rsquo;s true we can write something like:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#75715e># app/docs/users_doc.rb</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>module</span> UsersDoc
</span></span><span style=display:flex><span>  <span style=color:#75715e># we need the DSL, right?</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>extend</span> <span style=color:#66d9ef>Apipie</span><span style=color:#f92672>::</span><span style=color:#66d9ef>DSL</span><span style=color:#f92672>::</span><span style=color:#66d9ef>Concern</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  api <span style=color:#e6db74>:GET</span>, <span style=color:#e6db74>&#39;/users&#39;</span>, <span style=color:#e6db74>&#39;List users&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>show</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Nothing here, it&#39;s just a stub</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># app/controller/users_controller.rb</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>UsersController</span> <span style=color:#f92672>&lt;</span> <span style=color:#66d9ef>ApplicationController</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>include</span> <span style=color:#66d9ef>UsersDoc</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>show</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Application code goes here</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># and it overrides blank method</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># from the module</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><p>And yes, it works! Let&rsquo;s add resource description</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#66d9ef>module</span> UsersDoc
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>extend</span> <span style=color:#66d9ef>Apipie</span><span style=color:#f92672>::</span><span style=color:#66d9ef>DSL</span><span style=color:#f92672>::</span><span style=color:#66d9ef>Concern</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  resource_description <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>    formats <span style=color:#f92672>[</span><span style=color:#e6db74>:json</span><span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>    api_versions <span style=color:#e6db74>&#39;public&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><p>Which breaks it&mldr;</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>Apipie: Can not resolve resource UsersDoc name.
</span></span></code></pre></div><p>Yes, because our resource is <code>UsersController</code>. The error happens in the following lines in Apipie source code:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>get_resource_name</span>(klass)
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> klass<span style=color:#f92672>.</span>class <span style=color:#f92672>==</span> String
</span></span><span style=display:flex><span>        klass
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>elsif</span> @controller_to_resource_id<span style=color:#f92672>.</span>has_key?(klass)
</span></span><span style=display:flex><span>        @controller_to_resource_id<span style=color:#f92672>[</span>klass<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>elsif</span> <span style=color:#66d9ef>Apipie</span><span style=color:#f92672>.</span>configuration<span style=color:#f92672>.</span>namespaced_resources? <span style=color:#f92672>&amp;&amp;</span> klass<span style=color:#f92672>.</span>respond_to?(<span style=color:#e6db74>:controller_path</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span> <span style=color:#66d9ef>if</span> klass <span style=color:#f92672>==</span> <span style=color:#66d9ef>ActionController</span><span style=color:#f92672>::</span><span style=color:#66d9ef>Base</span>
</span></span><span style=display:flex><span>        path <span style=color:#f92672>=</span> klass<span style=color:#f92672>.</span>controller_path
</span></span><span style=display:flex><span>        path<span style=color:#f92672>.</span>gsub(version_prefix(klass), <span style=color:#e6db74>&#34;&#34;</span>)<span style=color:#f92672>.</span>gsub(<span style=color:#e6db74>&#34;/&#34;</span>, <span style=color:#e6db74>&#34;-&#34;</span>)
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>elsif</span> klass<span style=color:#f92672>.</span>respond_to?(<span style=color:#e6db74>:controller_name</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span> <span style=color:#66d9ef>if</span> klass <span style=color:#f92672>==</span> <span style=color:#66d9ef>ActionController</span><span style=color:#f92672>::</span><span style=color:#66d9ef>Base</span>
</span></span><span style=display:flex><span>        klass<span style=color:#f92672>.</span>controller_name
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>raise</span> <span style=color:#e6db74>&#34;Apipie: Can not resolve resource </span><span style=color:#e6db74>#{</span>klass<span style=color:#e6db74>}</span><span style=color:#e6db74> name.&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span></code></pre></div><p>Most of this code does not really matter, the thing is that Apipie does not know what to do with module <code>UsersDoc</code>. It has no <code>resource_id</code>, let&rsquo;s define it.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span>resource_description <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>  resource_id <span style=color:#e6db74>&#39;Users&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># other dsl</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><p>Now we get an error</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span>undefined method <span style=color:#e6db74>`superclass&#39; for UsersDoc:Module
</span></span></span></code></pre></div><p>But&mldr; Module (I mean, an instance of Module class) can&rsquo;t have a parent class. It&rsquo;s a module!</p><p>Forget that you are a ruby developer and define a method called <code>superclass</code> on your module :)</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#75715e># before calling DSL</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>self</span><span style=color:#f92672>.</span><span style=color:#a6e22e>superclass</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>UsersController</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><p>So, from this moment</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#66d9ef>UsersDoc</span><span style=color:#f92672>.</span>superclass <span style=color:#f92672>==</span> <span style=color:#66d9ef>UsersController</span>
</span></span><span style=display:flex><span><span style=color:#75715e># =&gt; true</span>
</span></span></code></pre></div><p>Refresh the page with documentation and see that it finally works!
Here is a gist with a full code that wraps ugly code and blank methods:
<a href=https://gist.github.com/iliabylich/c8032b193405673062e7 target=_blank rel="noreferrer nofollow">full gist</a></p><h3 id=the-power-of-ruby-based-doc>The power of ruby-based doc</h3><p>Imagine the following scenario:</p><p>I have two versions of API. When I was young and stupid, I implemented the first one (<code>v1</code>). And it has an authentication by plain username and password (in headers). Few years later something changed in my mind and I created another one (<code>v2</code>) which has token-based authentication.</p><p>First API contains 100 actions in 10 controllers, so does the second one, too. To make a documentation I have to copy-paste 2 lines of code 200 times (to put it for every action) or 20 times (to put it to every resource).</p><p>Instead of repeated copying the real description of authentication mechanism it would be really nice to have something like</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#75715e># for Api::V1</span>
</span></span><span style=display:flex><span>auth_with <span style=color:#e6db74>:password</span>
</span></span><span style=display:flex><span><span style=color:#75715e># for Api::V2</span>
</span></span><span style=display:flex><span>auth_with <span style=color:#e6db74>:token</span>
</span></span></code></pre></div><p>And describe authentication in a more declarative way. In order to make it we need to add our own method to DSL. Here is what it may look like:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#66d9ef>module</span> BaseDoc
</span></span><span style=display:flex><span>  <span style=color:#75715e># ... code from the gist</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>AUTH_METHODS</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    <span style=color:#e6db74>password</span>: <span style=color:#66d9ef>Api</span><span style=color:#f92672>::</span><span style=color:#66d9ef>Auth</span><span style=color:#f92672>::</span><span style=color:#66d9ef>PasswordDoc</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>token</span>: <span style=color:#66d9ef>Api</span><span style=color:#f92672>::</span><span style=color:#66d9ef>Auth</span><span style=color:#f92672>::</span><span style=color:#66d9ef>TokenDoc</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>auth_with</span>(auth_method)
</span></span><span style=display:flex><span>    mod <span style=color:#f92672>=</span> <span style=color:#66d9ef>AUTH_METHODS</span><span style=color:#f92672>[</span>auth_method<span style=color:#f92672>]</span> <span style=color:#f92672>or</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>raise</span> <span style=color:#e6db74>&#34;Unknown auth strategy </span><span style=color:#e6db74>#{</span>auth_method<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    send(<span style=color:#e6db74>:include</span>, mod)
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># app/docs/api/auth/password_doc.rb</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>module</span> Api::Auth::PasswordDoc
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>self</span><span style=color:#f92672>.</span><span style=color:#a6e22e>included</span>(base)
</span></span><span style=display:flex><span>    base<span style=color:#f92672>.</span>instance_eval <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e># documentation of password-</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>#  based authentication</span>
</span></span><span style=display:flex><span>      header <span style=color:#e6db74>:username</span>, <span style=color:#e6db74>required</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>      header <span style=color:#e6db74>:password</span>, <span style=color:#e6db74>required</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>      error <span style=color:#e6db74>code</span>: <span style=color:#ae81ff>401</span>, <span style=color:#e6db74>desc</span>: <span style=color:#e6db74>&#39;Unauthorized&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># app/docs/api/auth/token_doc.rb</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>module</span> Api::Auth::TokenDoc
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>self</span><span style=color:#f92672>.</span><span style=color:#a6e22e>included</span>(base)
</span></span><span style=display:flex><span>    base<span style=color:#f92672>.</span>instance_eval <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e># documentation of token-</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>#  based authentication</span>
</span></span><span style=display:flex><span>      header <span style=color:#e6db74>&#39;Token&#39;</span>, <span style=color:#e6db74>&#39;Your API token&#39;</span>
</span></span><span style=display:flex><span>      error <span style=color:#e6db74>code</span>: <span style=color:#ae81ff>401</span>, <span style=color:#e6db74>desc</span>: <span style=color:#e6db74>&#39;Token is requried&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><p>And from now we can write</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#66d9ef>module</span> Api::V1::UsersDoc
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>extend</span> <span style=color:#66d9ef>BaseDoc</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  doc_for <span style=color:#e6db74>:show</span> <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>    auth_with <span style=color:#e6db74>:password</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># or</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># auth_with :token</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><h3 id=ability-to-define-default-documentation-for-all-actions-in-resource>Ability to define default documentation for all actions in resource</h3><p>So, we have a <code>resource_description</code> and <code>api</code> methods, but how can we define common parts for all of our actions? I hate copy-paste driven development, let&rsquo;s write a DSL for this.</p><p>We want to have a <code>defaults</code> method which takes a block and executes it for each action.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#66d9ef>module</span> BaseDoc
</span></span><span style=display:flex><span>  <span style=color:#75715e># ...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>defaults</span>(<span style=color:#f92672>&amp;</span>block)
</span></span><span style=display:flex><span>    @defaults <span style=color:#f92672>=</span> block
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>doc_for</span>(action_name, <span style=color:#f92672>&amp;</span>block)
</span></span><span style=display:flex><span>    instance_eval(<span style=color:#f92672>&amp;</span>block)
</span></span><span style=display:flex><span>    <span style=color:#75715e># Only the next line added</span>
</span></span><span style=display:flex><span>    instance_eval(<span style=color:#f92672>&amp;</span>@defaults) <span style=color:#66d9ef>if</span> @defaults
</span></span><span style=display:flex><span>    api_version namespace_name <span style=color:#66d9ef>if</span> namespace_name
</span></span><span style=display:flex><span>    define_method(action_name) <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e># ... define it in your controller with the real code</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><p>So, we just store passed block and invoke it. This example is much simpler then the previous one.</p><h2 id=demo>Demo</h2><p><a href=https://github.com/iliabylich/apipie-demo target=_blank rel="noreferrer nofollow">URL</a></p><p>You can click by statically generated docs (thanks to GitHub pages):</p><ul><li><a href=http://iliabylich.github.io/apipie-demo/doc/apidoc/private_v1.html target=_blank rel="noreferrer nofollow"><code>Private::V1</code></a></li><li><a href=http://iliabylich.github.io/apipie-demo/doc/apidoc/private_v2.html target=_blank rel="noreferrer nofollow"><code>Private::V2</code></a></li><li><a href=http://iliabylich.github.io/apipie-demo/doc/apidoc/public.html target=_blank rel="noreferrer nofollow"><code>Public</code></a></li></ul><h2 id=conclusion>Conclusion</h2><p>Apipie is an amazing library and its most significant advantage is that you document ruby using ruby (being a ruby developer), which gives you ability to define custom behaviors and scenarios. I can&rsquo;t even imagine myself writing API docs using <code>yardoc</code> (however, I use it to document plain ruby classes).</p><p>If you have any bugs (or ideas to implement), please, <a href=https://github.com/Apipie/apipie-rails/issues target=_blank rel="noreferrer nofollow">create an issue on GitHub</a>
, let&rsquo;s make it even better!</p></main><br><footer><script defer>function addCopyButtonToCodeBlocks(){const e=document.querySelectorAll('code[class^="language-"]');e.forEach(e=>{const t=document.createElement("button");t.classList.add("copy-code-button"),t.innerHTML="copy",t.addEventListener("click",()=>{const n=e.textContent;navigator.clipboard.writeText(n),t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},1500)}),e.parentNode.before(t)})}setTimeout(function(){addCopyButtonToCodeBlocks()},100)</script><script defer>function throttle(e,t){var n=Date.now();return function(){var s=Date.now();n+t-s<0&&(e(),n=s)}}function scrollHandler(){const e=Array.from(document.querySelectorAll("body h2, body h3"));function t(){for(var n,s,o,i=window.pageYOffset||document.documentElement.scrollTop,t=0;t<e.length;t++)s=e[t].getAttribute("id"),n=document.querySelector('nav ul li a[href="#'+s+'"]'),n&&n.classList.remove("active-toc");for(t=e.length-1;t>=0;t--)if(o=e[t].offsetTop,i>o-75&&(s=e[t].getAttribute("id"),n=document.querySelector('nav ul li a[href="#'+s+'"]'),n)){n.classList.add("active-toc");break}}window.addEventListener("scroll",throttle(t,300))}setTimeout(scrollHandler,100)</script></footer></body></html>