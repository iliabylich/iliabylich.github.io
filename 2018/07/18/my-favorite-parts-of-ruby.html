<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      My favorite parts of Ruby &middot; Ilya Bylich
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/hyde.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-144-precomposed.png">
                                 <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
</head>


  <body class="theme-base-0b">

    <div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <h1>
        <a href="/">
          Ilya Bylich
        </a>
      </h1>
      <p class="lead">I'm a Ruby/Rust developer, sometimes I write long technical stories</p>
    </div>

    <nav class="sidebar-nav">
      <a class="sidebar-nav-item" href="/">Home</a>

      

      <a class="sidebar-nav-item" href="https://github.com/iliabylich">GitHub</a>
      <a class="sidebar-nav-item" href="https://twitter.com/IlyaBylich">Twitter</a>
      <a class="sidebar-nav-item" href="mailto:ibylich@gmail.com">Email me</a>

      <span class="sidebar-nav-item">
  <label for="current-theme">Theme</label>
  <select id="current-theme">
    <option>08</option>
    <option>09</option>
    <option>0a</option>
    <option>0b</option>
    <option>0c</option>
    <option>0d</option>
    <option>0f</option>
  </select>

  <script type="text/javascript">
    class Theme {
      static DEFAULT = "0b";

      static getCurrent() {
        return localStorage.getItem("current-theme") || Theme.DEFAULT;
      }

      static setCurrent(theme) {
        localStorage.setItem("current-theme", theme);
        document.body.className = `theme-base-${theme}`;
      }
    }

    const themeSelector = document.getElementById("current-theme");
    Theme.setCurrent(Theme.getCurrent());
    themeSelector.value = Theme.getCurrent();

    themeSelector.onchange = (e) => {
      const theme = e.target.value;
      Theme.setCurrent(theme);
    }
  </script>
</span>

    </nav>

    <p>&copy; 2022. All rights reserved.</p>
  </div>
</div>


    <div class="content container">
      <div class="post">
  <h1 class="post-title">My favorite parts of Ruby</h1>
  <span class="post-date">18 Jul 2018</span>

  <div id="table-of-contents">
    <ul id="toc" class="section-nav">
<li class="toc-entry toc-h3"><a href="#regexp-o-flag">Regexp ‘o’ flag</a></li>
<li class="toc-entry toc-h3"><a href="#invalid-encodings">Invalid encodings</a></li>
<li class="toc-entry toc-h3"><a href="#nested-heredocs">Nested heredocs</a></li>
<li class="toc-entry toc-h3"><a href="#setters-and-return-values">Setters and return values</a></li>
<li class="toc-entry toc-h3"><a href="#passing-blocks-to-the--method-aref">Passing blocks to the [] method (aref)</a></li>
<li class="toc-entry toc-h3"><a href="#global-variables">Global variables</a></li>
<li class="toc-entry toc-h3"><a href="#instance-variables-without--prefix">Instance variables without @ prefix</a></li>
<li class="toc-entry toc-h3"><a href="#implicit-coercing">Implicit coercing</a></li>
<li class="toc-entry toc-h3"><a href="#implicit-to_a">Implicit to_a</a></li>
<li class="toc-entry toc-h3"><a href="#heredoc-identifiers-and-newlines">HEREdoc identifiers and newlines</a></li>
<li class="toc-entry toc-h3"><a href="#1if-true">1if true</a></li>
<li class="toc-entry toc-h3"><a href="#defined">defined?</a></li>
<li class="toc-entry toc-h3"><a href="#return-in-the-classmodule-body">return in the class/module body</a></li>
<li class="toc-entry toc-h3"><a href="#meta-characters">Meta-characters</a></li>
<li class="toc-entry toc-h3"><a href="#invisible-rest-argument">Invisible rest argument</a></li>
<li class="toc-entry toc-h3"><a href="#dynamicity-of-optarg-defauls">Dynamicity of optarg defauls</a></li>
<li class="toc-entry toc-h3"><a href="#shadow-arguments">Shadow arguments</a></li>
<li class="toc-entry toc-h3"><a href="#dynamicity-of-rescue">Dynamicity of rescue</a></li>
<li class="toc-entry toc-h3"><a href="#positionalkeyword-arguments">Positional/keyword arguments</a></li>
<li class="toc-entry toc-h3"><a href="#final-words">Final words</a></li>
</ul>
  </div>

  <p><strong>Disclaimer #1</strong> first of all I’d like to say that I really like Ruby. I write a ton of Ruby code every single day and I prefer it over other languages. Please, do not take it seriously, Ruby is nice, and this post is mostly a joke.</p>

<p><strong>Disclaimer #2</strong> I’m not going to cover popular things like flip-flops (thanks God they are deprecated in 2.6.0).</p>

<p>I was thinking for a while which item should go first, but finally I had to give up. I think all items are funny.</p>

<h3 id="regexp-o-flag">Regexp ‘o’ flag</h3>

<p>I don’t even know if there’s anyone in the world using it. <code class="language-plaintext highlighter-rouge">o</code> flag is a very, very magical thing that “freezes” a regexp after parsing:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pry</span><span class="o">&gt;</span> <span class="mi">1</span><span class="p">.</span><span class="nf">upto</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span> <span class="nb">puts</span> <span class="sr">/</span><span class="si">#{</span><span class="n">i</span><span class="si">}</span><span class="sr">/o</span><span class="p">.</span><span class="nf">source</span> <span class="p">}</span>
<span class="mi">1</span>
<span class="mi">1</span>
<span class="mi">1</span>
<span class="mi">1</span>
<span class="mi">1</span>
<span class="n">pry</span><span class="o">&gt;</span> <span class="mi">3</span><span class="p">.</span><span class="nf">times</span><span class="p">.</span><span class="nf">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span> <span class="sr">/</span><span class="si">#{</span><span class="n">i</span><span class="si">}</span><span class="sr">/o</span><span class="p">.</span><span class="nf">object_id</span> <span class="p">}</span>
<span class="o">=&gt;</span> <span class="p">[</span><span class="mi">70135960411140</span><span class="p">,</span> <span class="mi">70135960411140</span><span class="p">,</span> <span class="mi">70135960411140</span><span class="p">]</span>
</code></pre></div></div>

<p>That’s a hacky way to define an inline regexp as a constant. It is a constant because its value is constant (<code class="language-plaintext highlighter-rouge">object_id</code> returns the same value). I think the main purpose of such flag is to reduce objects allocation, and I believe it wasn’t initially designed for such cases. If you are too lazy to extract a static regexp to a constant, simply add an <code class="language-plaintext highlighter-rouge">o</code> flag.</p>

<h3 id="invalid-encodings">Invalid encodings</h3>

<p>Well, I have to confess, sometimes I hate Ruby for various reasons, this feature is one of them.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># encoding: utf-8</span>

<span class="n">s</span> <span class="o">=</span> <span class="s2">"</span><span class="se">\xff</span><span class="s2">"</span>
<span class="nb">puts</span> <span class="n">s</span><span class="p">.</span><span class="nf">encoding</span>
<span class="nb">puts</span> <span class="n">s</span><span class="p">.</span><span class="nf">valid_encoding?</span>
<span class="nb">puts</span> <span class="n">s</span><span class="p">.</span><span class="nf">bytes</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ruby test.rb
ruby 2.5.1p57 (2018-03-29 revision 63029) [x86_64-darwin17]
UTF-8
false
255
</code></pre></div></div>

<p>In this case string is not a “real” string. This bytes sequence is simply invalid for UTF-8 (in UTF-8 any codepoint &gt; 127 works as a flag that indicates that the char is multibyte and the next char (or chars) defines a real value), but Ruby allows it. It’s not even a String, it’s just a container of bytes. And for some reason Ruby allows you to pack an arbitrary sequence of bytes into a string, and if you want to ask “Is it valid?” you have a (I think) conceptually wrong <code class="language-plaintext highlighter-rouge">String#valid_encoding?</code> method. Maybe the right way to solve it would be to:</p>

<ol>
  <li>reject such strings during parsing (and throw SyntaxError)</li>
  <li>raise an error when someone tries to put wrong bytes sequence to the string</li>
  <li>remove <code class="language-plaintext highlighter-rouge">String#valid_encoding?</code> method</li>
</ol>

<h3 id="nested-heredocs">Nested heredocs</h3>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">p</span> <span class="o">&lt;&lt;</span><span class="s2">"A</span><span class="si">#{</span><span class="n">b</span><span class="si">}</span><span class="s2">C"</span>
<span class="c1">#{</span>
  <span class="o">&lt;&lt;</span><span class="s2">"A</span><span class="si">#{</span><span class="n">b</span><span class="si">}</span><span class="s2">C"</span>
<span class="no">A</span><span class="c1">#{b}C</span>
<span class="p">}</span>
<span class="n">str</span>
<span class="no">A</span><span class="c1">#{b}C</span>
</code></pre></div></div>

<p>Nuff said, I’m quite sure that there are no syntax highlighters that can handle this code. GitHub can’t and Svbtle can’t as well. Try evaluating this code in IRB.</p>

<h3 id="setters-and-return-values">Setters and return values</h3>

<p>As you most probably know in Ruby setters can’t have return values. They always return their arguments:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">m</span><span class="o">=</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
  <span class="k">return</span> <span class="mi">42</span>
<span class="k">end</span>

<span class="nb">self</span><span class="p">.</span><span class="nf">m</span> <span class="o">=</span> <span class="s1">'return me'</span>
<span class="c1"># =&gt; "return me"</span>
</code></pre></div></div>

<p>Yes, you can make a return by calling a setter method using <code class="language-plaintext highlighter-rouge">Kernel#send</code>:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pry</span><span class="o">&gt;</span> <span class="nb">send</span><span class="p">(</span><span class="ss">:m</span><span class="o">=</span><span class="p">,</span> <span class="s1">'return me'</span><span class="p">)</span>
<span class="o">=&gt;</span> <span class="mi">42</span>
</code></pre></div></div>

<p>So, the general rule is like “if you call a setter method without :send you can’t make a return”. Wrong!</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pry</span><span class="o">&gt;</span> <span class="k">def</span> <span class="nf">[]=</span><span class="p">(</span><span class="n">a</span><span class="p">);</span> <span class="mi">42</span><span class="p">;</span> <span class="k">end</span>
<span class="n">pry</span><span class="o">&gt;</span> <span class="nb">self</span><span class="p">.</span><span class="nf">[</span><span class="p">]</span><span class="o">=</span> <span class="s1">'return me'</span>
<span class="o">=&gt;</span> <span class="mi">42</span>
</code></pre></div></div>

<p>I can’t imagine any reason to use such syntax, most probably it should be deprecated.</p>

<h3 id="passing-blocks-to-the--method-aref">Passing blocks to the [] method (aref)</h3>

<p>Imagine the following piece of code:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">[]</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
  <span class="nb">puts</span> <span class="n">idx</span> <span class="o">+</span> <span class="n">block</span><span class="p">.</span><span class="nf">call</span>
<span class="k">end</span>

<span class="nb">self</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">{</span> <span class="mi">2</span> <span class="p">}</span>
</code></pre></div></div>

<p>Looks valid, right? We pass a positional argument <code class="language-plaintext highlighter-rouge">1</code> and a block that returns <code class="language-plaintext highlighter-rouge">2</code> to the method called <code class="language-plaintext highlighter-rouge">[]</code>. The method should print <code class="language-plaintext highlighter-rouge">3</code>. Let’s run it with Ruby 2.5:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ruby -v test.rb
2.5.1p57 (2018-03-29 revision 63029) [x86_64-darwin17]
3
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">1 + 2 == 3</code>, everything is ok. Let’s try 2.4:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ruby -v test.rb
ruby 2.4.4p296 (2018-03-28 revision 63013) [x86_64-darwin17]
test.rb:5: syntax error, unexpected { arg, expecting end-of-input
self[1] { 2 }
         ^
</code></pre></div></div>

<p>Yes, this syntax was introduced in Ruby 2.5. Did you hear any announcements about it?</p>

<p><strong>Spoiler: there are no tests for this syntax in ruby/ruby repo. Guess why?</strong></p>

<h3 id="global-variables">Global variables</h3>

<p>Let’s take a simple code:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pry</span><span class="o">&gt;</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">].</span><span class="nf">join</span>
<span class="o">=&gt;</span> <span class="s2">"123"</span>
</code></pre></div></div>

<p>Do you know anything about “pure” functions (or pure methods in this case)? Ideally methods should only use <code class="language-plaintext highlighter-rouge">self</code> and provided arguments. Relying on any global state is bad because you are not the only one who can mutate it.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pry</span><span class="o">&gt;</span> <span class="vg">$,</span> <span class="o">=</span> <span class="s1">'Ruby'</span>
<span class="n">pry</span><span class="o">&gt;</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">].</span><span class="nf">join</span>
<span class="o">=&gt;</span> <span class="s2">"1Ruby2Ruby3"</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">String#join</code> uses a global variable as a default value for the separator. Literally <code class="language-plaintext highlighter-rouge">def join(sep = $,)</code>.</p>

<p>By the way, maybe I should put the following code to my current project before leaving it. How much time is needed to find it?</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="nb">rand</span> <span class="o">&gt;</span> <span class="mf">0.5</span>
  <span class="vg">$,</span> <span class="o">=</span> <span class="p">[</span><span class="mi">102</span><span class="p">,</span> <span class="mi">105</span><span class="p">,</span> <span class="mi">110</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">109</span><span class="p">,</span> <span class="mi">101</span><span class="p">].</span><span class="nf">pack</span><span class="p">(</span><span class="s1">'c*'</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div></div>

<p>After doing <code class="language-plaintext highlighter-rouge">require 'english'</code> you get two aliases for this global variable: <code class="language-plaintext highlighter-rouge">$OUTPUT_FIELD_SEPARATOR</code> and <code class="language-plaintext highlighter-rouge">$OFS</code>, that’s the real name of this global variable.</p>

<h3 id="instance-variables-without--prefix">Instance variables without @ prefix</h3>

<p>Spoiler: you may think that it’s impossible because the parser rejects such code. But in fact, Ruby allows it and there are even some specs for this - <a href="https://github.com/ruby/spec/blob/master/optional/capi/object_spec.rb#L803">RubySpec</a>. I don’t know much about Ruby internals, but at least one class uses ivars without <code class="language-plaintext highlighter-rouge">@</code>, it’s called <code class="language-plaintext highlighter-rouge">Range</code>. <code class="language-plaintext highlighter-rouge">(0..3)</code> has 3 instance variables:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">excl</code> = false</li>
  <li><code class="language-plaintext highlighter-rouge">begin</code> = 0</li>
  <li><code class="language-plaintext highlighter-rouge">end</code> = 3</li>
</ul>

<p>“Any proves?” - let’s marshal it:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pry</span><span class="o">&gt;</span> <span class="no">Marshal</span><span class="p">.</span><span class="nf">dump</span><span class="p">(</span><span class="mi">0</span><span class="o">..</span><span class="mi">3</span><span class="p">)</span>
<span class="o">=&gt;</span> <span class="s2">"</span><span class="se">\x04\b</span><span class="s2">o:</span><span class="se">\n</span><span class="s2">Range</span><span class="se">\b</span><span class="s2">:</span><span class="se">\t</span><span class="s2">exclF:</span><span class="se">\n</span><span class="s2">begini</span><span class="se">\x00</span><span class="s2">:</span><span class="se">\b</span><span class="s2">endi</span><span class="se">\b</span><span class="s2">"</span>
</code></pre></div></div>

<p>This string contains a version (4.8), an indicator of the object (<code class="language-plaintext highlighter-rouge">o</code>), a symbol <code class="language-plaintext highlighter-rouge">:Range</code>, a hash of instance variables <code class="language-plaintext highlighter-rouge">{ excl: false, begin: 0, end: 3 }</code>.</p>

<p>Let’s change a class name a bit (but keep the same length to not break anything):</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pry</span><span class="o">&gt;</span> <span class="k">class</span> <span class="nc">Hello</span><span class="p">;</span> <span class="k">end</span>
<span class="n">pry</span><span class="o">&gt;</span> <span class="no">Marshal</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span><span class="s2">"</span><span class="se">\x04\b</span><span class="s2">o:</span><span class="se">\n</span><span class="s2">Hello</span><span class="se">\b</span><span class="s2">:</span><span class="se">\t</span><span class="s2">exclF:</span><span class="se">\n</span><span class="s2">begini</span><span class="se">\x00</span><span class="s2">:</span><span class="se">\b</span><span class="s2">endi</span><span class="se">\b</span><span class="s2">"</span><span class="p">)</span>
                             <span class="o">^^^^^</span>
<span class="o">=&gt;</span> <span class="c1">#&lt;Hello:0x00007fece707a9c8&gt;</span>
</code></pre></div></div>

<p>Now we can change, for example, <code class="language-plaintext highlighter-rouge">excl</code> to <code class="language-plaintext highlighter-rouge">@one</code> (again, to keep the length the same):</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pry</span><span class="o">&gt;</span> <span class="no">Marshal</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span><span class="s2">"</span><span class="se">\x04\b</span><span class="s2">o:</span><span class="se">\n</span><span class="s2">Hello</span><span class="se">\b</span><span class="s2">:</span><span class="se">\t</span><span class="s2">@oneF:</span><span class="se">\n</span><span class="s2">begini</span><span class="se">\x00</span><span class="s2">:</span><span class="se">\b</span><span class="s2">endi</span><span class="se">\b</span><span class="s2">"</span><span class="p">)</span>
                                       <span class="o">^^^^</span>
<span class="o">=&gt;</span> <span class="c1">#&lt;Hello:0x00007fece70533a0 @one=false&gt;</span>

<span class="n">pry</span><span class="o">&gt;</span> <span class="n">_</span><span class="p">.</span><span class="nf">instance_variables</span>
<span class="o">=&gt;</span> <span class="p">[</span><span class="ss">:@one</span><span class="p">]</span>
</code></pre></div></div>

<p>The conclusion is simple: <code class="language-plaintext highlighter-rouge">excl</code> is an instance variable, but <code class="language-plaintext highlighter-rouge">Kernel#instance_variables</code> hides it.</p>

<p><code class="language-plaintext highlighter-rouge">Kernel#instance_variable_get / set</code> and Ruby Lexer are the places that validate instance variable names. Low-level C calls don’t do it and in general when you write a C extension you may easily get an ivar without <code class="language-plaintext highlighter-rouge">@</code> char.</p>

<p>You can read my article about marshalling to get a full overview of its internals.</p>

<h3 id="implicit-coercing">Implicit coercing</h3>

<p>As you may know there are two types of coercing in Ruby: explicit and implicit.</p>

<p>Explicit is when you call methods like <code class="language-plaintext highlighter-rouge">to_a</code>, <code class="language-plaintext highlighter-rouge">to_h</code>, <code class="language-plaintext highlighter-rouge">to_s</code>. When the object is not an Array/Hash/String, but can become it.</p>

<p>Implicit is when Ruby calls methods like <code class="language-plaintext highlighter-rouge">to_ary</code>, <code class="language-plaintext highlighter-rouge">to_hash</code>, <code class="language-plaintext highlighter-rouge">to_str</code> for you. When the object <strong>acts</strong> as an Array/Hash/String and converting it to the corresponding class must happen automatically.</p>

<p>There are a lot of methods in the corelib that are documented as “taking a String as an argument” but in fact they accept any objects that can be implicitly converted to a String.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pry</span><span class="o">&gt;</span> <span class="n">o</span> <span class="o">=</span> <span class="no">Object</span><span class="p">.</span><span class="nf">new</span>
<span class="n">pry</span><span class="o">&gt;</span> <span class="k">def</span> <span class="nc">o</span><span class="o">.</span><span class="nf">to_str</span><span class="p">;</span> <span class="s2">"hello"</span><span class="p">;</span> <span class="k">end</span>

<span class="n">pry</span><span class="o">&gt;</span> <span class="s2">"string"</span> <span class="o">+</span> <span class="n">o</span>
<span class="o">=&gt;</span> <span class="s2">"stringhello"</span>

<span class="n">pry</span><span class="o">&gt;</span> <span class="s2">"hello"</span><span class="p">.</span><span class="nf">casecmp</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
<span class="o">=&gt;</span> <span class="mi">0</span>

<span class="n">pry</span><span class="o">&gt;</span> <span class="s2">"testhello"</span><span class="p">.</span><span class="nf">chomp</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
<span class="o">=&gt;</span> <span class="s2">"test"</span>

<span class="n">pry</span><span class="o">&gt;</span> <span class="s2">"hellostr"</span><span class="p">.</span><span class="nf">delete_prefix</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
<span class="o">=&gt;</span> <span class="s2">"str"</span>

<span class="n">pry</span><span class="o">&gt;</span> <span class="s2">"hello world"</span><span class="p">.</span><span class="nf">start_with?</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
<span class="o">=&gt;</span> <span class="kp">true</span>
</code></pre></div></div>

<p>There are more methods like this, and not only for String.</p>

<p>Also, there’s a way to implicitly convert an abstract Object to</p>

<ul>
  <li>Array (using <code class="language-plaintext highlighter-rouge">*</code>)</li>
  <li>Hash (using <code class="language-plaintext highlighter-rouge">**</code>)</li>
  <li>Proc (using <code class="language-plaintext highlighter-rouge">&amp;</code>)</li>
</ul>

<p>Sometimes it can be ridiculous:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">User</span>
  <span class="k">def</span> <span class="nf">to_ary</span><span class="p">;</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">];</span> <span class="k">end</span>
  <span class="k">def</span> <span class="nf">to_hash</span><span class="p">;</span> <span class="p">{</span> <span class="ss">a: </span><span class="mi">1</span> <span class="p">};</span> <span class="k">end</span>
  <span class="k">def</span> <span class="nf">to_proc</span><span class="p">;</span> <span class="nb">proc</span> <span class="p">{</span> <span class="mi">42</span> <span class="p">};</span> <span class="k">end</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">m</span><span class="p">(</span><span class="o">*</span><span class="n">rest</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
  <span class="n">rest</span><span class="p">.</span><span class="nf">length</span> <span class="o">+</span> <span class="n">kwargs</span><span class="p">.</span><span class="nf">length</span> <span class="o">+</span> <span class="n">block</span><span class="p">.</span><span class="nf">call</span>
<span class="k">end</span>

<span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">new</span>
<span class="n">m</span><span class="p">(</span><span class="o">*</span><span class="n">user</span><span class="p">,</span> <span class="o">**</span><span class="n">user</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">user</span><span class="p">)</span>
<span class="c1"># =&gt; 44</span>
</code></pre></div></div>

<p>I’m not sure that this feature is required. But remember, that’s only my opinion.</p>

<p>Explicit coercing is explicit and forces you to call <code class="language-plaintext highlighter-rouge">to_a/to_h/to_s</code> manually. Probably it would be better to restrict <code class="language-plaintext highlighter-rouge">*/**/&amp;</code> operators to accept only <code class="language-plaintext highlighter-rouge">Array/Hash/Proc</code> objects (and to be as strict as possible).</p>

<h3 id="implicit-to_a">Implicit <code class="language-plaintext highlighter-rouge">to_a</code></h3>

<p>Previous section says that Ruby never invokes methods for explicit coercing on its own. There’s one exception: <code class="language-plaintext highlighter-rouge">to_a</code> method.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">o</span> <span class="o">=</span> <span class="no">Object</span><span class="p">.</span><span class="nf">new</span>
<span class="k">def</span> <span class="nc">o</span><span class="o">.</span><span class="nf">to_a</span><span class="p">;</span>   <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">];</span> <span class="k">end</span>
<span class="k">def</span> <span class="nc">o</span><span class="o">.</span><span class="nf">to_ary</span><span class="p">;</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">];</span> <span class="k">end</span>

<span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">o</span>
<span class="nb">p</span> <span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span>
<span class="c1"># [4, 5, 6]</span>
<span class="c1"># so, it calls to_ary, that's an implicit coercing</span>

<span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="o">*</span><span class="n">o</span>
<span class="nb">p</span> <span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span>
<span class="c1"># [1, 2, 3]</span>
<span class="c1"># it calls to_a !! an explicit coercing gets called by Ruby</span>
</code></pre></div></div>

<p>For some reason the concept of implicit/explicit coercing doesn’t work for this case.</p>

<h3 id="heredoc-identifiers-and-newlines">HEREdoc identifiers and newlines</h3>

<p>The section about nested heredocs shows a heredoc identifier that has an interpolation inside. Also, it’s possible to use <code class="language-plaintext highlighter-rouge">"\n"</code>:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">p</span> <span class="o">&lt;&lt;</span><span class="s2">"HERE
"</span>
<span class="n">content</span>
<span class="no">HERE</span>
</code></pre></div></div>

<p>it prints <code class="language-plaintext highlighter-rouge">"content\n"</code>. For some reason newline is not allowed in the middle of the heredoc identifier (and don’t get me wrong, I think that newlines should be rejected, no matter in the middle or in the end).</p>

<h3 id="1if-true"><code class="language-plaintext highlighter-rouge">1if true</code></h3>

<p>Yes, that’s a valid syntax. Ruby has very special rules for whitespaces and newlines. <code class="language-plaintext highlighter-rouge">1i</code> is a special syntax for complex numbers, but <code class="language-plaintext highlighter-rouge">1if true</code> is <code class="language-plaintext highlighter-rouge">1 if true</code>. There’s also a <code class="language-plaintext highlighter-rouge">1r</code> syntax for rational numbers, and yes, <code class="language-plaintext highlighter-rouge">1rescue nil</code> is <code class="language-plaintext highlighter-rouge">1 rescue nil</code>.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pry</span><span class="o">&gt;</span> <span class="mi">1</span><span class="k">if</span> <span class="kp">true</span>
<span class="mi">1</span>
<span class="n">pry</span><span class="o">&gt;</span> <span class="mi">1</span><span class="k">rescue</span> <span class="kp">nil</span>
<span class="mi">1</span>
</code></pre></div></div>

<p>But what about <code class="language-plaintext highlighter-rouge">1ri</code>?</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pry</span><span class="o">&gt;</span> <span class="mi">1</span><span class="n">rif</span> <span class="kp">true</span>
<span class="no">SyntaxError</span><span class="p">:</span> <span class="p">(</span><span class="n">syntax</span> <span class="n">error</span><span class="p">,</span> <span class="n">unexpected</span> <span class="n">tIDENTIFIER</span><span class="p">,</span> <span class="n">expecting</span> <span class="k">end</span><span class="o">-</span><span class="n">of</span><span class="o">-</span><span class="n">input</span><span class="p">)</span>
<span class="mi">1</span><span class="n">rif</span> <span class="kp">true</span>
 <span class="o">^~~</span>
</code></pre></div></div>

<p>Sweet. Bonus:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pry</span><span class="o">&gt;</span> <span class="k">def</span> <span class="nf">m</span><span class="p">;</span> <span class="mi">1</span><span class="k">return</span><span class="p">;</span> <span class="k">end</span>
<span class="no">SyntaxError</span> <span class="p">:</span> <span class="p">(</span><span class="n">syntax</span> <span class="n">error</span><span class="p">,</span> <span class="n">unexpected</span> <span class="n">keyword_return</span><span class="p">,</span> <span class="n">expecting</span> <span class="n">keyword_end</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">m</span><span class="p">;</span> <span class="mi">1</span><span class="k">return</span><span class="p">;</span> <span class="k">end</span>
        <span class="o">^~~~~~</span>

<span class="n">pry</span><span class="o">&gt;</span> <span class="k">def</span> <span class="nf">m</span><span class="p">;</span> <span class="mi">1</span><span class="k">retry</span><span class="p">;</span> <span class="k">end</span>
<span class="no">SyntaxError</span><span class="p">:</span> <span class="p">(</span><span class="n">syntax</span> <span class="n">error</span><span class="p">,</span> <span class="n">unexpected</span> <span class="n">keyword_retry</span><span class="p">,</span> <span class="n">expecting</span> <span class="n">keyword_end</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">m</span><span class="p">;</span> <span class="mi">1</span><span class="k">retry</span><span class="p">;</span> <span class="k">end</span>
        <span class="o">^~~~~</span>

<span class="n">pry</span><span class="o">&gt;</span> <span class="k">def</span> <span class="nf">m</span><span class="p">;</span> <span class="p">(</span><span class="mi">1</span><span class="k">redo</span><span class="p">;</span> <span class="k">end</span>
<span class="no">SyntaxError</span><span class="p">:</span> <span class="n">syntax</span> <span class="n">error</span><span class="p">,</span> <span class="n">unexpected</span> <span class="n">keyword_redo</span><span class="p">,</span> <span class="n">expecting</span> <span class="n">keyword_end</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">m</span><span class="p">;</span> <span class="mi">1</span><span class="k">redo</span><span class="p">;</span> <span class="k">end</span>
        <span class="o">^~~~</span>
</code></pre></div></div>

<p>Looks like there are special rules for keyword modifiers.</p>

<h3 id="defined"><code class="language-plaintext highlighter-rouge">defined?</code></h3>

<p>I think this is the most controversial keyword in Ruby. It takes literally everything as an argument.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pry</span><span class="o">&gt;</span> <span class="k">defined?</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span>
 <span class="o">=&gt;</span> <span class="s2">"self"</span>
<span class="n">pry</span><span class="o">&gt;</span> <span class="k">defined?</span><span class="p">(</span><span class="kp">nil</span><span class="p">)</span>
 <span class="o">=&gt;</span> <span class="s2">"nil"</span>
<span class="n">pry</span><span class="o">&gt;</span> <span class="k">defined?</span><span class="p">(</span><span class="kp">true</span><span class="p">)</span>
 <span class="o">=&gt;</span> <span class="s2">"true"</span>
<span class="n">pry</span><span class="o">&gt;</span> <span class="k">defined?</span><span class="p">(</span><span class="kp">false</span><span class="p">)</span>
 <span class="o">=&gt;</span> <span class="s2">"false"</span>

<span class="n">pry</span><span class="o">&gt;</span> <span class="k">defined?</span><span class="p">(</span><span class="n">a</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
 <span class="o">=&gt;</span> <span class="s2">"assignment"</span>
<span class="n">pry</span><span class="o">&gt;</span> <span class="n">a</span>
 <span class="o">=&gt;</span> <span class="kp">nil</span>

<span class="n">pry</span><span class="o">&gt;</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="k">defined?</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
 <span class="o">=&gt;</span> <span class="s2">"local-variable"</span>

<span class="n">pry</span><span class="o">&gt;</span> <span class="k">defined?</span><span class="p">(</span><span class="k">begin</span><span class="p">;</span> <span class="mi">1</span><span class="p">;</span> <span class="mi">2</span><span class="p">;</span> <span class="mi">3</span><span class="p">;</span> <span class="k">end</span><span class="p">)</span>
 <span class="o">=&gt;</span> <span class="s2">"expression"</span>

<span class="n">pry</span><span class="o">&gt;</span> <span class="k">defined?</span><span class="p">(</span><span class="nb">self</span><span class="p">.</span><span class="nf">m</span><span class="p">)</span>
 <span class="o">=&gt;</span> <span class="kp">nil</span>
<span class="n">pry</span><span class="o">&gt;</span> <span class="k">def</span> <span class="nf">m</span><span class="p">;</span> <span class="k">end</span><span class="p">;</span> <span class="k">defined?</span><span class="p">(</span><span class="nb">self</span><span class="p">.</span><span class="nf">m</span><span class="p">)</span>
 <span class="o">=&gt;</span> <span class="s2">"method"</span>

<span class="n">pry</span><span class="o">&gt;</span> <span class="k">module</span> <span class="nn">M</span><span class="p">;</span> <span class="k">def</span> <span class="nf">m</span><span class="p">;</span> <span class="k">end</span><span class="p">;</span> <span class="k">end</span>
<span class="n">pry</span><span class="o">&gt;</span> <span class="kp">include</span> <span class="no">M</span>
<span class="n">pry</span><span class="o">&gt;</span> <span class="k">def</span> <span class="nf">m</span><span class="p">;</span> <span class="k">defined?</span><span class="p">(</span><span class="k">super</span><span class="p">);</span> <span class="k">end</span>
<span class="n">pry</span><span class="o">&gt;</span> <span class="n">m</span>
 <span class="o">=&gt;</span> <span class="s2">"super"</span>
</code></pre></div></div>

<p>It also can return <code class="language-plaintext highlighter-rouge">yield</code>, <code class="language-plaintext highlighter-rouge">constant</code>, <code class="language-plaintext highlighter-rouge">class variable</code>, <code class="language-plaintext highlighter-rouge">instance-variable</code> and <code class="language-plaintext highlighter-rouge">global-variable</code>. By the way, where’s the dash in the <code class="language-plaintext highlighter-rouge">class variable</code>?</p>

<p>That’s a strong violation of a single responsibility principle. This keyword can handle EVERYTHING!</p>

<p>Moreover, it handles all kinds of exceptions inside:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pry</span><span class="o">&gt;</span> <span class="n">a</span> <span class="o">=</span> <span class="no">Object</span><span class="p">.</span><span class="nf">new</span>
<span class="n">pry</span><span class="o">&gt;</span> <span class="k">defined?</span><span class="p">(</span>
  <span class="n">a</span><span class="p">.</span><span class="nf">b</span><span class="p">.</span><span class="nf">c</span><span class="p">.</span><span class="nf">d</span> <span class="o">+</span>
  <span class="no">MissingConstant</span> <span class="o">+</span>
  <span class="k">yield</span> <span class="o">+</span>
  <span class="k">super</span> <span class="o">+</span>
  <span class="kp">nil</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span>
  <span class="nb">eval</span><span class="p">(</span><span class="s2">"!@#$%^"</span><span class="p">)</span> <span class="o">+</span>
  <span class="nb">require</span><span class="p">(</span><span class="s1">'missing_file'</span><span class="p">)</span>
<span class="p">)</span>
 <span class="o">=&gt;</span> <span class="kp">nil</span>
</code></pre></div></div>

<p>That’s too much for a single keyword.</p>

<h3 id="return-in-the-classmodule-body"><code class="language-plaintext highlighter-rouge">return</code> in the class/module body</h3>

<p>You can’t call <code class="language-plaintext highlighter-rouge">return</code> from a module/class body:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pry</span><span class="o">&gt;</span> <span class="k">class</span> <span class="nc">A</span><span class="p">;</span> <span class="k">return</span> <span class="mi">1</span><span class="p">;</span> <span class="k">end</span>
<span class="no">SyntaxError</span> <span class="p">(</span><span class="no">Invalid</span> <span class="k">return</span> <span class="k">in</span> <span class="k">class</span><span class="o">/</span><span class="k">module</span> <span class="nn">body</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">A</span><span class="p">;</span> <span class="k">return</span> <span class="mi">1</span><span class="p">;</span> <span class="k">end</span>
         <span class="o">^~~~~~</span>
<span class="n">pry</span><span class="o">&gt;</span> <span class="k">module</span> <span class="nn">A</span><span class="p">;</span> <span class="k">return</span> <span class="mi">1</span><span class="p">;</span> <span class="k">end</span>
<span class="no">SyntaxError</span> <span class="p">(</span><span class="no">Invalid</span> <span class="k">return</span> <span class="k">in</span> <span class="k">class</span><span class="o">/</span><span class="k">module</span> <span class="nn">body</span><span class="p">)</span>
<span class="k">module</span> <span class="nn">A</span><span class="p">;</span> <span class="k">return</span> <span class="mi">1</span><span class="p">;</span> <span class="k">end</span>
          <span class="o">^~~~~~</span>
</code></pre></div></div>

<p>It throws a <code class="language-plaintext highlighter-rouge">SyntaxError</code>, i.e. even if the code is unreachable, you still can’t write it, it’s simply invalid.</p>

<p>But you can use <code class="language-plaintext highlighter-rouge">return</code> in a singleton class body:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pry</span><span class="o">&gt;</span> <span class="k">class</span> <span class="o">&lt;&lt;</span> <span class="nb">self</span><span class="p">;</span> <span class="k">return</span><span class="p">;</span> <span class="k">end</span>
<span class="no">LocalJumpError</span><span class="p">:</span> <span class="n">unexpected</span> <span class="k">return</span>
</code></pre></div></div>

<p>Now that’s a <code class="language-plaintext highlighter-rouge">LocalJumpError</code>, so this code can be interpreted if nobody touches it:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pry</span><span class="o">&gt;</span> <span class="k">class</span> <span class="o">&lt;&lt;</span> <span class="nb">self</span><span class="p">;</span> <span class="k">return</span><span class="p">;</span> <span class="k">end</span> <span class="k">if</span> <span class="kp">false</span>
 <span class="o">=&gt;</span> <span class="kp">nil</span>
</code></pre></div></div>

<h3 id="meta-characters">Meta-characters</h3>

<p>Again, this is something that probably could be removed from Ruby, I don’t know anyone using it.</p>

<p>Metacharacter is a special sequence of characters that gets interpreted as a single character. Most probably you know one of them - <code class="language-plaintext highlighter-rouge">\uDDDD</code>. But there are more:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pry</span><span class="o">&gt;</span> <span class="s2">"</span><span class="se">\u</span><span class="s2">1234"</span>
 <span class="o">=&gt;</span> <span class="s2">"ሴ"</span>
<span class="n">pry</span><span class="o">&gt;</span> <span class="s2">"</span><span class="se">\377</span><span class="s2">"</span>
 <span class="o">=&gt;</span> <span class="s2">"</span><span class="se">\xFF</span><span class="s2">"</span>
<span class="n">pry</span><span class="o">&gt;</span> <span class="s2">"</span><span class="se">\xFF</span><span class="s2">"</span>
 <span class="o">=&gt;</span> <span class="s2">"</span><span class="se">\xFF</span><span class="s2">"</span>
<span class="n">pry</span><span class="o">&gt;</span> <span class="s2">"</span><span class="se">\C</span><span class="s2">-</span><span class="se">\a</span><span class="s2">"</span>
 <span class="o">=&gt;</span> <span class="s2">"</span><span class="se">\a</span><span class="s2">"</span>
<span class="n">pry</span><span class="o">&gt;</span> <span class="s2">"</span><span class="se">\c</span><span class="s2">a"</span>
 <span class="o">=&gt;</span> <span class="s2">"</span><span class="se">\u</span><span class="s2">0001"</span>
<span class="n">pry</span><span class="o">&gt;</span> <span class="s2">"</span><span class="se">\M</span><span class="s2">-a"</span>
 <span class="o">=&gt;</span> <span class="s2">"</span><span class="se">\xE1</span><span class="s2">"</span>
<span class="n">pry</span><span class="o">&gt;</span> <span class="s2">"</span><span class="se">\C</span><span class="s2">-</span><span class="se">\M</span><span class="s2">-f"</span>
 <span class="o">=&gt;</span> <span class="s2">"</span><span class="se">\x86</span><span class="s2">"</span>
<span class="n">pry</span><span class="o">&gt;</span> <span class="s2">"</span><span class="se">\M</span><span class="s2">-</span><span class="se">\c</span><span class="s2">f"</span>
 <span class="o">=&gt;</span> <span class="s2">"</span><span class="se">\x86</span><span class="s2">"</span>
<span class="n">pry</span><span class="o">&gt;</span> <span class="s2">"</span><span class="se">\c\M</span><span class="s2">-f"</span>
 <span class="o">=&gt;</span> <span class="s2">"</span><span class="se">\x86</span><span class="s2">"</span>
</code></pre></div></div>

<p>That’s absolutely insane! Moreover, Ruby starting from 2.6 ignores spaces (and tabs) around codepoints in the <code class="language-plaintext highlighter-rouge">\u{}</code> syntax:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pry</span><span class="o">&gt;</span> <span class="s2">"</span><span class="se">\u</span><span class="s2">{    123   456   }"</span>
 <span class="o">=&gt;</span> <span class="s2">"ģі"</span>
</code></pre></div></div>

<h3 id="invisible-rest-argument">Invisible rest argument</h3>

<p>MRI has a special rule for <code class="language-plaintext highlighter-rouge">Proc</code> class: it expands a single array argument:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pry</span><span class="o">&gt;</span> <span class="nb">proc</span> <span class="p">{</span> <span class="o">|</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="o">|</span> <span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">]</span> <span class="p">}.</span><span class="nf">call</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
<span class="o">=&gt;</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
</code></pre></div></div>

<p>… but only if it the proc takes more than one argument. And if the arity is 1 it works as you’d expect:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pry</span><span class="o">&gt;</span> <span class="nb">proc</span> <span class="p">{</span> <span class="o">|</span><span class="n">a</span><span class="o">|</span> <span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="p">}.</span><span class="nf">call</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
<span class="o">=&gt;</span> <span class="p">[[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]]</span>
</code></pre></div></div>

<p>And here’s an edge case: it’s possible to put a trailing comma after arguments list:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pry</span><span class="o">&gt;</span> <span class="nb">proc</span> <span class="p">{</span> <span class="o">|</span><span class="n">a</span><span class="p">,</span><span class="o">|</span> <span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="p">}.</span><span class="nf">call</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
<span class="o">=&gt;</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</code></pre></div></div>

<p>… and MRI still expands an array. So how many arguments does this proc have?</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pry</span><span class="o">&gt;</span> <span class="nb">proc</span><span class="p">{</span><span class="o">|</span><span class="n">a</span><span class="p">,</span><span class="o">|</span><span class="p">}.</span><span class="nf">arity</span>
<span class="o">=&gt;</span> <span class="mi">1</span>
</code></pre></div></div>

<p>What’s going on?</p>

<p>The answer is simple: there’s an invisible rest argument after trailing comma. The real interface of this proc is:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">proc</span> <span class="p">{</span> <span class="o">|</span><span class="n">a</span><span class="p">,</span> <span class="o">*|</span> <span class="p">}</span>
</code></pre></div></div>

<p>MRI generates it for you and then hides it.</p>

<p>If you are interested in implementation details take a look at <a href="https://github.com/ruby/ruby/blob/trunk/parse.y#L3007-L3015">parse.y</a> - there’s a special field <code class="language-plaintext highlighter-rouge">excessed_comma</code> that works as a flag.</p>

<p>Also, you can clearly see in the Ripper’s output:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pry</span><span class="o">&gt;</span> <span class="nb">require</span> <span class="s1">'ripper'</span>
<span class="n">pry</span><span class="o">&gt;</span> <span class="no">Ripper</span><span class="p">.</span><span class="nf">sexp</span><span class="p">(</span><span class="s1">'proc{|a|}'</span><span class="p">)[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
<span class="o">=&gt;</span> <span class="p">[</span><span class="ss">:params</span><span class="p">,</span> <span class="p">[[</span><span class="ss">:@ident</span><span class="p">,</span> <span class="s2">"a"</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">]]],</span> <span class="kp">nil</span><span class="p">,</span> <span class="kp">nil</span><span class="p">,</span> <span class="kp">nil</span><span class="p">,</span> <span class="kp">nil</span><span class="p">,</span> <span class="kp">nil</span><span class="p">,</span> <span class="kp">nil</span><span class="p">]</span>
<span class="n">pry</span><span class="o">&gt;</span> <span class="no">Ripper</span><span class="p">.</span><span class="nf">sexp</span><span class="p">(</span><span class="s1">'proc{|a,|}'</span><span class="p">)[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
<span class="o">=&gt;</span> <span class="p">[</span><span class="ss">:params</span><span class="p">,</span> <span class="p">[[</span><span class="ss">:@ident</span><span class="p">,</span> <span class="s2">"a"</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">]]],</span> <span class="kp">nil</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kp">nil</span><span class="p">,</span> <span class="kp">nil</span><span class="p">,</span> <span class="kp">nil</span><span class="p">,</span> <span class="kp">nil</span><span class="p">]</span>
</code></pre></div></div>

<p>Do you see the difference?</p>

<h3 id="dynamicity-of-optarg-defauls">Dynamicity of optarg defauls</h3>

<p>In Ruby optional arguments are very, very powerful. You can pass pretty much anything as a default value of the argument in the method signature:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pry</span><span class="o">&gt;</span> <span class="k">def</span> <span class="nf">m</span><span class="p">(</span><span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="nb">puts</span> <span class="s1">'no a'</span><span class="p">));</span> <span class="n">a</span><span class="p">;</span> <span class="k">end</span>
<span class="n">pry</span><span class="o">&gt;</span> <span class="n">m</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="o">=&gt;</span> <span class="mi">1</span>
<span class="n">pry</span><span class="o">&gt;</span> <span class="n">m</span>
<span class="n">no</span> <span class="n">a</span>
<span class="o">=&gt;</span> <span class="kp">nil</span>
</code></pre></div></div>

<p>I don’t like it in general. I would say it’s too powerful, you can abuse this feature and do some really crazy stuff. For example like this:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">m</span><span class="p">(</span><span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="k">return</span> <span class="mi">1</span><span class="p">;</span> <span class="kp">nil</span><span class="p">))</span>
  <span class="k">return</span> <span class="mi">2</span>
<span class="k">end</span>
</code></pre></div></div>

<p>What does this method return when you call it without any arguments? Yep, it returns <code class="language-plaintext highlighter-rouge">1</code>.</p>

<p>The reason why it works this way is that MRI inlines optional arguments initialization to the method body, so in VM this code actually looks like:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">m</span><span class="p">(</span><span class="n">a</span> <span class="o">=</span> <span class="kp">nil</span><span class="p">)</span>
  <span class="n">a</span> <span class="o">||=</span> <span class="p">(</span><span class="k">return</span> <span class="mi">1</span><span class="p">;</span> <span class="kp">nil</span><span class="p">)</span>
  <span class="k">return</span> <span class="mi">2</span>
<span class="k">end</span>
</code></pre></div></div>

<p>You can even go further and redefine a method in its arguments:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">factorial</span><span class="p">(</span>
  <span class="n">n</span><span class="p">,</span>
  <span class="n">redefinition</span> <span class="o">=</span> <span class="o">&lt;&lt;-</span><span class="no">RUBY</span><span class="p">,</span><span class="sh">
    define_method(__method__) do |
      _ = (return 1 if n == 1; nil),
      _ = eval(redefinition),
      _ = (return n * (n -= 1; send(__method__)); nil)
    |

    end
</span><span class="no">  RUBY</span>
  <span class="n">_</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">redefinition</span><span class="p">),</span>
  <span class="n">_</span> <span class="o">=</span> <span class="p">(</span><span class="k">return</span> <span class="nb">send</span><span class="p">(</span><span class="n">__method__</span><span class="p">);</span> <span class="kp">nil</span><span class="p">)</span>
<span class="p">)</span>
  <span class="c1"># &lt;&lt;EMPTY BODY&gt;&gt;</span>
<span class="k">end</span>

<span class="nb">p</span> <span class="n">factorial</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="shadow-arguments">Shadow arguments</h3>

<p>I think only people that work with parsing/unparsing tools are aware of this feature. That’s a special kind of argument that “shadows” outer variable. The syntax is <code class="language-plaintext highlighter-rouge">|;shadowarg|</code>:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pry</span><span class="o">&gt;</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="nb">proc</span> <span class="p">{</span> <span class="n">n</span> <span class="p">}.</span><span class="nf">call</span>
 <span class="o">=&gt;</span> <span class="mi">1</span>
<span class="n">pry</span><span class="o">&gt;</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="nb">proc</span> <span class="p">{</span> <span class="o">|</span><span class="p">;</span><span class="n">n</span><span class="o">|</span> <span class="n">n</span> <span class="p">}.</span><span class="nf">call</span>
 <span class="o">=&gt;</span> <span class="kp">nil</span>
</code></pre></div></div>

<p>Basically, it’s nice to have an ability to use own isolated set of local variables in your block and be sure that you don’t change an outer scope. But again, does anyone use it? And also it reminds me a <code class="language-plaintext highlighter-rouge">var</code> keyword from the JavaScript.</p>

<h3 id="dynamicity-of-rescue">Dynamicity of rescue</h3>

<p>Take a look at the following code:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">begin</span>
  <span class="k">raise</span> <span class="s1">'error message'</span>
<span class="k">rescue</span> <span class="o">=&gt;</span> <span class="no">RuntimeError</span>
  <span class="nb">puts</span> <span class="s1">'caught an error'</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Looks correct from the first glance, right? And it even prints <code class="language-plaintext highlighter-rouge">caught an error</code>, but in fact it has an invalid code construction. It is valid from the parser perspective, but I think you don’t want to write such code, it redefines a constant <code class="language-plaintext highlighter-rouge">RuntimeError</code>.</p>

<p>Ruby has a very tricky mechanism of converting getters to setters. It can convert</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">local variable get</code> to <code class="language-plaintext highlighter-rouge">local variable set</code> (most popular usage of <code class="language-plaintext highlighter-rouge">rescue</code> handler)</li>
  <li><code class="language-plaintext highlighter-rouge">instance variable get</code> to <code class="language-plaintext highlighter-rouge">instance variable set</code></li>
  <li><code class="language-plaintext highlighter-rouge">const get</code> to <code class="language-plaintext highlighter-rouge">const set</code></li>
  <li><code class="language-plaintext highlighter-rouge">getter method</code> to <code class="language-plaintext highlighter-rouge">setter method</code></li>
  <li>and many more like global/class variables</li>
</ul>

<p>So if you have <code class="language-plaintext highlighter-rouge">object = OpenStruct.new</code> and you catch an error using <code class="language-plaintext highlighter-rouge">rescue =&gt; object.field</code> you’ll get <code class="language-plaintext highlighter-rouge">object.field = &lt;thrown error&gt;</code> called under the hood.</p>

<p>That’s definitely very, very flexible but does anyone need it? I’d better reject all cases above except local variables.</p>

<p>I’ve seen the first snippet in the real codebase and it was quite difficult to understand why the spec that asserts something like <code class="language-plaintext highlighter-rouge">expect { code construction }.to raise_error(RuntimeError)</code> doesn’t work.</p>

<h3 id="positionalkeyword-arguments">Positional/keyword arguments</h3>

<p>I used to think that positional and keyword arguments act like two completely separate groups of arguments. If the last argument is a Hash and you pass it to the method call it</p>

<ul>
  <li>populates all kwargs</li>
  <li>raises an error if some kwargs are missing</li>
  <li>sets default values to missing optional kwargs</li>
</ul>

<p>But I was wrong. One argument value can populate positional <strong>and</strong> keyword argument:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">m</span><span class="p">(</span><span class="n">a</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="ss">b: </span><span class="mi">1</span><span class="p">)</span>
  <span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">]</span>
<span class="k">end</span>

<span class="nb">p</span> <span class="n">m</span><span class="p">(</span><span class="ss">b: </span><span class="mi">2</span><span class="p">,</span> <span class="s1">'b'</span> <span class="o">=&gt;</span> <span class="mi">3</span><span class="p">)</span>
<span class="c1"># =&gt; [{"b"=&gt;3}, 2]</span>
</code></pre></div></div>

<p>I feel like it’s a bug:</p>

<ol>
  <li>There’s only one argument provided</li>
  <li>And some of its keys are not symbols</li>
  <li>So MRI should not use it for kwargs initialization</li>
  <li>And <code class="language-plaintext highlighter-rouge">a</code> must be <code class="language-plaintext highlighter-rouge">{ b: 2, 'b' =&gt; 3 }</code></li>
  <li>And so <code class="language-plaintext highlighter-rouge">b</code> must be just <code class="language-plaintext highlighter-rouge">1</code> (default value)</li>
</ol>

<h3 id="final-words">Final words</h3>

<p>This story is not about bad parts of Ruby or anything like that. Don’t feel bad because of this - I’m really sorry. I was trying to cover some rarely used features and explain as much as I can.</p>

</div>


  <div class="comments">
    <div id="disqus_thread"></div>
    <script>
        var disqus_config = function () {
          this.page.url = document.location.href;  // Replace PAGE_URL with your page's canonical URL variable
          this.page.identifier = document.location.pathname; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
        };
        (function() { // DON'T EDIT BELOW THIS LINE
          var d = document, s = d.createElement('script');
          s.src = 'https://ibylich-myblog.disqus.com/embed.js';
          s.setAttribute('data-timestamp', +new Date());
          (d.head || d.body).appendChild(s);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>


<div class="related">
  <h2>Related Posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/2021/12/27/writing-bindings-upside-down.html">
            Writing bindings upside down
            <small>27 Dec 2021</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2020/11/22/lib-ruby-parser.html">
            lib-ruby-parser
            <small>22 Nov 2020</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2020/01/25/evaluating-ruby-in-ruby.html">
            Evaluating Ruby in Ruby
            <small>25 Jan 2020</small>
          </a>
        </h3>
      </li>
    
  </ul>
</div>

    </div>
  </body>
</html>
