<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=cache-control content="max-age=0"><meta http-equiv=cache-control content="no-cache"><meta http-equiv=expires content="0"><meta http-equiv=expires content="Tue, 01 Jan 1980 1:00:00 GMT"><meta http-equiv=pragma content="no-cache"><link rel=apple-touch-icon-precomposed sizes=192x192 href=/icon-192x192.png><link rel="shortcut icon" href=/favicon.ico><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#1b1b1b"><meta name=description content="Capybara and asynchronous stuff"><title>Capybara and asynchronous stuff | Ilya Bylich - Blog</title><style>:root{--background:#ffffff}@media(prefers-color-scheme:dark){:root{--background:#1b1b1b}}html{background-color:var(--background)}body{background-color:var(--background)}</style><link rel=stylesheet type=text/css href=/style.min.4fed9ac4c3b0f6bfa63910fda772dff0eac2295876cd9f9770b2337489272971.css media=all></head><body><nav><ul class=menu><li><a tabindex=-1 class=menu-link href=/>Home</a></li><li><a tabindex=-1 class=menu-link href=https://github.com/iliabylich>GitHub</a></li><li><a tabindex=-1 class=menu-link href=https://twitter.com/IlyaBylich>Twitter</a></li><li><a tabindex=-1 class=menu-link href=mailto:ibylich@gmail.com>Email me</a></li><li><a tabindex=-1 class=menu-link href=/index.xml>RSS</a></li></ul></nav><div id=single-header><h1>Capybara and asynchronous stuff</h1><div id=single-meta><span class=datesub>Jul 1, 2015</span>
<span id=tags>&nbsp;&nbsp;
<span><a href=https://iliabylich.github.io/tags/ruby/>#ruby</a>
</span>&nbsp; <span><a href=https://iliabylich.github.io/tags/capybara/>#capybara</a>
</span>&nbsp; <span><a href=https://iliabylich.github.io/tags/webdriver/>#webdriver</a>
</span>&nbsp;</span></div></div><aside class="hidden lg:block toc" id=tableOfContentContainer><nav id=TableOfContents><ul><li><a href=#what-is-capybara-poltergeist-and-phantomjs>What is Capybara, Poltergeist and PhantomJS?</a><ul><li><a href=#phantomjs>PhantomJS</a></li><li><a href=#poltergeist>Poltergeist</a></li><li><a href=#capybara>Capybara</a></li></ul></li><li><a href=#asynchronous-javascript-code-in-your-tests>Asynchronous JavaScript code in your tests</a></li><li><a href=#capybarapoltergeistphantomjs-installation>Capybara/Poltergeist/PhantomJS installation</a></li><li><a href=#small-example>Small example</a></li><li><a href=#but-capybara-waits-for-my-ajax-requests>But&mldr; Capybara waits for my AJAX requests</a></li><li><a href=#can-we-reuse-it>Can we reuse it?</a></li><li><a href=#can-we-organize-it-as-a-common-reusable-solution>Can we organize it as a common reusable solution?</a></li><li><a href=#wrapping-up>Wrapping up</a></li><li><a href=#passing-data-to-template>Passing data to template</a></li><li><a href=#lets-write-something-complex>Let&rsquo;s write something complex</a><ul><li><a href=#visiting-the-page>Visiting the page</a></li><li><a href=#injecting-dexiejs-into-the-page>Injecting <code>Dexie.js</code> into the page</a></li><li><a href=#create-indexeddb-instance>Create IndexedDB instance</a></li><li><a href=#write-some-data-to-the-database>Write some data to the database</a></li><li><a href=#reading-data>Reading data</a></li></ul></li><li><a href=#conclusion>Conclusion</a></li></ul></nav></aside><main><h2 id=what-is-capybara-poltergeist-and-phantomjs>What is Capybara, Poltergeist and PhantomJS?</h2><p>In this part I will try to cover the following aspects:</p><ol><li>Running asynchronous code in a web driver</li><li>Making the call synchronous</li><li>Wrapping it into some common solution</li><li>Advanced example - working with IndexedDB from Capybara</li></ol><h3 id=phantomjs>PhantomJS</h3><p>First of all, we need to know what is PhantomJS. I would say it&rsquo;s a &rsquo;tool that acts like a browser but can be controlled from outside using simple command interface&rsquo;. In more common words, it&rsquo;s a web driver. It&rsquo;s a full-featured WebKit (an engine of Chrome/Safari/few last versions of Opera and other browsers), but in console. You can use it for scripting, automating or testing.</p><h3 id=poltergeist>Poltergeist</h3><p>Poltergeist is a Ruby wrapper for PhantomJS. Usually you write the code for PhantomJS on JavaScript, with Poltergeist you can run it on Ruby.</p><h3 id=capybara>Capybara</h3><p>Well, I&rsquo;m pretty sure you know what it is. It&rsquo;s a test framework. And it supports different web drivers like:</p><p><code>RackTest</code> - web driver that does not support JavaScript, extremely fast, but deadly primitive; best solution for tests that don&rsquo;t require any JavaScript execution</p><p><code>Selenium</code> - the most popular web driver</p><p>Advantages:</p><ol><li>Supports a lot of browsers (so you can run multiple test suites in different browsers)</li><li>Super stable</li></ol><p>Disadvantages:</p><ol><li>Requires X server to be installed on the machine that runs it (some cloud CI services just don&rsquo;t have it)</li><li>Opens a real browser that executes your test scenario, that slows your test suite.</li></ol><p><code>Capybara-webkit</code> - headless WebKit (does not run a browser), but still requires X server</p><p><code>Poltergeist</code> - see above, headless WebKit, <strong>does not require X server</strong>, so you can run it everywhere.</p><h2 id=asynchronous-javascript-code-in-your-tests>Asynchronous JavaScript code in your tests</h2><p>When you write integration tests sometimes you need to run asynchronous JavaScript in context of your page and get a response back to Ruby. Here is an example from my current project: the client part of our application supports offline mode, so we store the data in WebSQL and sync it with server once connection is restored. The API of WebSQL is asynchronous, so we have a result of execution in some provided callback:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>// something like
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>WebSQLWrapper</span>.<span style=color:#a6e22e>execute</span>(<span style=color:#e6db74>&#39;select 1&#39;</span>, <span style=color:#66d9ef>function</span>(<span style=color:#a6e22e>result</span>) {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// result of execution becomes available after some time
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>});
</span></span></code></pre></div><p>We have integration tests with Capybara+Poltergeist+PhantomJS combo that tests the whole stack of interaction between a client-side application and a server API. And WebSQL should be flushed between tests or populated with startup data before some specific tests. We also have delayed operations on the client that runs periodically.</p><p>All these features require us to run JavaScript code manually in PhantomJS between/before tests.</p><h2 id=capybarapoltergeistphantomjs-installation>Capybara/Poltergeist/PhantomJS installation</h2><p>Quite simple:</p><ol><li>PhantomJS: <code>sudo apt-get install phantomjs</code> or download binaries from the official site (you can even try 2.0 beta there).</li><li>Capybara: <code>gem 'capybara'</code> and that&rsquo;s it.</li><li>Poltergeist: <code>gem 'poltergeist'</code>.</li></ol><p>Require both of them in your <code>spec_helper</code> and force Capybara to use Poltergeist as a web driver:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span>require <span style=color:#e6db74>&#39;capybara/rails&#39;</span>
</span></span><span style=display:flex><span>require <span style=color:#e6db74>&#39;capybara/poltergeist&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>Capybara</span><span style=color:#f92672>.</span>register_driver <span style=color:#e6db74>:poltergeist_debug</span> <span style=color:#66d9ef>do</span> <span style=color:#f92672>|</span>app<span style=color:#f92672>|</span>
</span></span><span style=display:flex><span>  driver_options <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    <span style=color:#e6db74>inspector</span>: <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>timeout</span>: <span style=color:#ae81ff>5</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>js_errors</span>: <span style=color:#66d9ef>false</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>debug</span>: <span style=color:#66d9ef>false</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>phantomjs_logger</span>: <span style=color:#66d9ef>Logger</span><span style=color:#f92672>.</span>new(<span style=color:#e6db74>&#39;/dev/null&#39;</span>)
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#66d9ef>ENV</span><span style=color:#f92672>[</span><span style=color:#e6db74>&#39;DEBUG_PHANTOMJS&#39;</span><span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>    driver_options<span style=color:#f92672>.</span>merge!({
</span></span><span style=display:flex><span>      <span style=color:#e6db74>logger</span>: <span style=color:#66d9ef>Kernel</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>js_errors</span>: <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>debug</span>: <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>phantomjs_logger</span>: <span style=color:#66d9ef>File</span><span style=color:#f92672>.</span>open(<span style=color:#66d9ef>Rails</span><span style=color:#f92672>.</span>root<span style=color:#f92672>.</span>join(<span style=color:#e6db74>&#39;log/phantomjs.log&#39;</span>), <span style=color:#e6db74>&#39;a&#39;</span>)
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>Capybara</span><span style=color:#f92672>::</span><span style=color:#66d9ef>Poltergeist</span><span style=color:#f92672>::</span><span style=color:#66d9ef>Driver</span><span style=color:#f92672>.</span>new(app, driver_options)
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>Capybara</span><span style=color:#f92672>.</span>javascript_driver <span style=color:#f92672>=</span> <span style=color:#e6db74>:poltergeist_debug</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>Capybara</span><span style=color:#f92672>.</span>default_driver <span style=color:#f92672>=</span> <span style=color:#e6db74>:poltergeist_debug</span>
</span></span></code></pre></div><p>With this configuration Poltergeist does not print any noisy output, but you can enable it by passing <code>DEBUG_PHANTOMJS=true</code></p><h2 id=small-example>Small example</h2><p>Here is a simple of the code that returns it&rsquo;s response asynchronously:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#a6e22e>setTimeout</span>(<span style=color:#66d9ef>function</span>() {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>alert</span>(<span style=color:#e6db74>&#39;Thanks for waiting 1 second&#39;</span>);
</span></span><span style=display:flex><span>}, <span style=color:#ae81ff>1000</span>);
</span></span></code></pre></div><p>This code actually does nothing, but it&rsquo;s a demonstration of how asynchronous stuff works.</p><h2 id=but-capybara-waits-for-my-ajax-requests>But&mldr; Capybara waits for my AJAX requests</h2><p>Yes, when you write something like:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span>it <span style=color:#e6db74>&#39;displays a message&#39;</span> <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>  expect(page)<span style=color:#f92672>.</span>to have_text(<span style=color:#e6db74>&#39;Hey&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><p>and at the moment of running this expectation your page does not have this text <strong>but receives it a second later</strong> - the test will be green. Why?</p><p>Capybara has a setting called <code>default_wait_time</code> (was changed to <code>default_max_wait_time</code>, but is still acceptable) which is 2 seconds by default. <a href=https://github.com/jnicklas/capybara/blob/master/lib/capybara/node/base.rb#L76 target=_blank rel="noreferrer nofollow">Here is how Capybara uses it</a>
.</p><p>It runs the code again and again, and stops if</p><ol><li>It has a result of code execution - then it simple returns it</li><li>The time has come (2 seconds) - then it raises an error</li></ol><p>(A little remark here. Capybara saves the time on the beginning of this method and on every iteration compares this time with <code>Time.now</code> - this is a very nice hack to save Capybara from wrapping API calls into <code>Timecop.freeze</code> - good job!)</p><h2 id=can-we-reuse-it>Can we reuse it?</h2><p>Yes, of course. Let&rsquo;s simplify it a little bit:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#66d9ef>module</span> WaitHelper
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>extend</span> self
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># Calls provided +block+ every 100ms</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>#   and stops when it returns false</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>#</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># @param timeout [Fixnum]</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># @yield block for execution</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>#</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># @example</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>#   current_time = Time.now</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>#   WaitHelper.wait_until(3) do</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>#     Time.now - current_time &gt; 2</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>#   end</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>#</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>#   # 2 seconds later ...</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>#   # =&gt; true</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>#</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>#   current_time = Time.now</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>#   WaitHelper.wait_until(3) do</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>#     Time.now - current_time &gt; 10</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>#   end</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>#</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>#   # 3 seconds later (after timeout)</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>#   # =&gt; false</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>#</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>wait_until</span>(timeout, <span style=color:#f92672>&amp;</span>block)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>Timeout</span><span style=color:#f92672>.</span>timeout(timeout) <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>        sleep(<span style=color:#ae81ff>0</span><span style=color:#f92672>.</span><span style=color:#ae81ff>1</span>) <span style=color:#66d9ef>until</span> value <span style=color:#f92672>=</span> block<span style=color:#f92672>.</span>call
</span></span><span style=display:flex><span>        value
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>rescue</span> <span style=color:#66d9ef>TimeoutError</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><p>Alright, now let&rsquo;s use it.</p><ol><li>Modify JavaScript code to set result into some global variable (JavaScript function context, you know)</li><li>Run the code that gets response in callback.</li><li>Run the code that polls the response from global variable</li><li>Wrap this code with <code>WaitHelper.wait_until(timeout) {}</code></li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span>code_for_execution <span style=color:#f92672>=</span> <span style=color:#e6db74>&lt;&lt;-JS
</span></span></span><span style=display:flex><span><span style=color:#e6db74></span>  setTimeout(function() {
</span></span><span style=display:flex><span>    window<span style=color:#f92672>.</span>asyncResponse <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;some response&#39;</span>;
</span></span><span style=display:flex><span>  }, <span style=color:#ae81ff>1000</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>JS</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>code_for_polling <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;window.asyncResponse&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>Capybara</span><span style=color:#f92672>.</span>current_session<span style=color:#f92672>.</span>evaluate_script(code_for_execution)
</span></span><span style=display:flex><span>result <span style=color:#f92672>=</span> <span style=color:#66d9ef>WaitHelper</span><span style=color:#f92672>.</span>wait_until(<span style=color:#ae81ff>2</span>) <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>Capybara</span><span style=color:#f92672>.</span>current_session<span style=color:#f92672>.</span>evaluate_script(code_for_polling)
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>puts result
</span></span><span style=display:flex><span><span style=color:#75715e># =&gt; &#39;some response&#39;</span>
</span></span></code></pre></div><h2 id=can-we-organize-it-as-a-common-reusable-solution>Can we organize it as a common reusable solution?</h2><p>Why not. Here is a gem called <a href=https://github.com/iliabylich/capybara-async-runner target=_blank rel="noreferrer nofollow"><code>capybara-async-runner</code></a>
. And here is how to use it.</p><p>Installation:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#75715e># Gemfile</span>
</span></span><span style=display:flex><span>gem <span style=color:#e6db74>&#39;capybara-async_runner&#39;</span>
</span></span><span style=display:flex><span><span style=color:#75715e># spec/spec_helper.rb</span>
</span></span><span style=display:flex><span>require <span style=color:#e6db74>&#39;capybara/async_runner&#39;</span>
</span></span></code></pre></div><p>First of all, I don&rsquo;t like to mix JavaScript and Ruby code in a single file, so we need templates (like <code>.js.erb</code>).
You need to specify the directory with templates:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#75715e># spec/spec_helper.rb</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>Capybara</span><span style=color:#f92672>::</span><span style=color:#66d9ef>AsyncRunner</span><span style=color:#f92672>.</span>setup <span style=color:#66d9ef>do</span> <span style=color:#f92672>|</span>config<span style=color:#f92672>|</span>
</span></span><span style=display:flex><span>  config<span style=color:#f92672>.</span>commands_directory <span style=color:#f92672>=</span> <span style=color:#66d9ef>Rails</span><span style=color:#f92672>.</span>root<span style=color:#f92672>.</span>join(<span style=color:#e6db74>&#39;spec/fixtures/async_commands&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><p>Let&rsquo;s write our first command</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>TestCommand</span> <span style=color:#f92672>&lt;</span> <span style=color:#66d9ef>Capybara</span><span style=color:#f92672>::</span><span style=color:#66d9ef>AsyncRunner</span><span style=color:#f92672>::</span><span style=color:#66d9ef>Command</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># global command name</span>
</span></span><span style=display:flex><span>  self<span style=color:#f92672>.</span>command_name <span style=color:#f92672>=</span> <span style=color:#e6db74>:test_command_name</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># .js.erb file in directory specified above</span>
</span></span><span style=display:flex><span>  self<span style=color:#f92672>.</span>file_to_run <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;template&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  response <span style=color:#e6db74>:parsed_json</span> <span style=color:#66d9ef>do</span> <span style=color:#f92672>|</span>data<span style=color:#f92672>|</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>JSON</span><span style=color:#f92672>.</span>parse(data)
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><p>This class follows the Command pattern, you can invoke it in the following way:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#66d9ef>Capybara</span><span style=color:#f92672>::</span><span style=color:#66d9ef>AsyncRunner</span><span style=color:#f92672>.</span>run(<span style=color:#e6db74>:test_command_name</span>)
</span></span><span style=display:flex><span><span style=color:#75715e># or</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>TestCommand</span><span style=color:#f92672>.</span>new<span style=color:#f92672>.</span>invoke
</span></span></code></pre></div><p>Let&rsquo;s create our template for this command:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>// spec/fixtures/async_commands/template.js.erb
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>setTimeout</span>(<span style=color:#66d9ef>function</span>() {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>json</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>JSON</span>.<span style=color:#a6e22e>stringify</span>([<span style=color:#ae81ff>1</span>,<span style=color:#ae81ff>2</span>,<span style=color:#ae81ff>3</span>]);
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;%=</span> <span style=color:#a6e22e>parsed_json</span>(<span style=color:#a6e22e>js</span>[<span style=color:#f92672>:</span><span style=color:#a6e22e>json</span>]) <span style=color:#f92672>%&gt;</span>
</span></span><span style=display:flex><span>})
</span></span></code></pre></div><p>There are few things that I need to explain:</p><ol><li><code>parsed_json</code> - this is an output point from the script that was defined in the command class. When you call it in the template, it embeds some JavaScript that stores passed data into the global variable. <code>parsed_json(123)</code> produces something like <code>window.parsed_json_result = 123</code> (so we can can grab this response later from the second script)</li><li><code>js</code> - this is a proxy method from the gem that acts like a Hash. The method <code>[]</code> on this Hash returns passed key (and the whole method <code>js</code> is kind of &ldquo;JavaScript memory&rdquo;). <code>&lt;%= parsed_json(js[:json]) %></code> produces <code>window.parsed_json_result = json</code> which is exactly what we need.</li><li>When you call <code>Capybara::AsyncRunner.run(:test_command_name)</code>, the gem executes the script generated from your template in the context of <code>Capybara.current_session</code>. Then it subscribes to all defined responses (this is actually, the second script) and returns the first one that becomes defined (<code>window.parsed_json_result</code> in this case).</li><li>The block that we have specified for <code>parsed_json</code> is like a handler for transforming data which it returns (we invoke <code>parsed_json</code> method with <code>json</code> variable which contains raw JSON, our handler parses it)</li></ol><p>If you are familiar with templates in Ruby, just quickly look at the <a href=https://github.com/iliabylich/capybara-async-runner/blob/master/lib/capybara/async_runner/env.rb target=_blank rel="noreferrer nofollow">code</a>
, this class is a context of rendering.</p><h2 id=wrapping-up>Wrapping up</h2><p>You need to follow these steps to create a command using a gem:</p><ol><li>Specify the directory with templates in the gem configuration file</li><li>Create a command class</li><li>Specify its name</li><li>Specify the name of template</li><li>Create a template file</li><li>Define a response(s)</li><li>Call them in the template</li></ol><h2 id=passing-data-to-template>Passing data to template</h2><p>You can pass any data to the template:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>TestCommand</span> <span style=color:#f92672>&lt;</span> <span style=color:#66d9ef>Capybara</span><span style=color:#f92672>::</span><span style=color:#66d9ef>AsyncRunner</span><span style=color:#f92672>::</span><span style=color:#66d9ef>Command</span>
</span></span><span style=display:flex><span>  self<span style=color:#f92672>.</span>command_name <span style=color:#f92672>=</span> <span style=color:#e6db74>:test</span>
</span></span><span style=display:flex><span>  self<span style=color:#f92672>.</span>template <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;template&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># if you don&#39;t pass any block</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># it will return raw value</span>
</span></span><span style=display:flex><span>  response <span style=color:#e6db74>:done</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>data <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>  name: <span style=color:#e6db74>&#39;Ilya&#39;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>Capybara</span><span style=color:#f92672>::</span><span style=color:#66d9ef>AsyncRunner</span><span style=color:#f92672>.</span>run(<span style=color:#e6db74>:test</span>, data)
</span></span><span style=display:flex><span><span style=color:#75715e># =&gt; &#39;Ilya&#39;</span>
</span></span></code></pre></div><p>And use it template:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#a6e22e>someLongRunningMethod</span>(<span style=color:#66d9ef>function</span>() {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// &#39;done&#39; is a method that generates JavaScript
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>// &#39;data&#39; returns data that we&#39;ve passed to &#39;run&#39;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>// :name is a key in that Hash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#f92672>&lt;%=</span> <span style=color:#a6e22e>done</span>(<span style=color:#a6e22e>data</span>[<span style=color:#f92672>:</span><span style=color:#a6e22e>name</span>]) <span style=color:#f92672>%&gt;</span>
</span></span><span style=display:flex><span>})
</span></span></code></pre></div><h2 id=lets-write-something-complex>Let&rsquo;s write something complex</h2><p>As I mentioned before, on my current project we use WebSQL, but it&rsquo;s <a href=http://www.w3.org/TR/webdatabase/ target=_blank rel="noreferrer nofollow">deprecated</a>
, so I&rsquo;m not going to use it in examples. Instead let&rsquo;s write a wrapper for IndexedDB.</p><p>First of all, we need a JavaScript wrapper, I don&rsquo;t like the native IndexedDB API. First result from google = <a href=http://www.dexie.org/ target=_blank rel="noreferrer nofollow"><code>Dexie.js</code></a>
.</p><p>Let&rsquo;s plan our scenario:</p><ol><li>Visit any page</li><li>Inject <code>Dexie.js</code> into the page</li><li>Create IndexedDB instance</li><li>Write some data to the database</li><li>Read them and print</li></ol><h3 id=visiting-the-page>Visiting the page</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#66d9ef>Capybara</span><span style=color:#f92672>.</span>current_session<span style=color:#f92672>.</span>visit(<span style=color:#e6db74>&#39;http://google.com&#39;</span>)
</span></span></code></pre></div><h3 id=injecting-dexiejs-into-the-page>Injecting <code>Dexie.js</code> into the page</h3><ul><li><a href=https://github.com/iliabylich/capybara-async-runner/blob/master/examples/indexeddb/commands/wrapper_loader.rb target=_blank rel="noreferrer nofollow">Command</a></li><li><a href=https://github.com/iliabylich/capybara-async-runner/blob/master/examples/indexeddb/templates/wrapper/inject.js.erb target=_blank rel="noreferrer nofollow">Template</a></li></ul><p>How to invoke:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#66d9ef>module</span> IndexedDB
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>URL</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;http://www.url.to.dexie.js.source&#39;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>Capybara</span><span style=color:#f92672>::</span><span style=color:#66d9ef>AsyncRunner</span><span style=color:#f92672>.</span>run(<span style=color:#e6db74>&#39;indexeddb:wrapper:inject&#39;</span>, <span style=color:#e6db74>url</span>: <span style=color:#66d9ef>IndexedDB</span><span style=color:#f92672>::</span><span style=color:#66d9ef>URL</span>)
</span></span></code></pre></div><p>Explanation:</p><ol><li>JavaScript code detects whether the library has already been loaded</li><li>If not - appends <code>&lt;script></code> tag to the <code>&lt;head></code></li><li>If yes - returns &lsquo;success&rsquo;</li><li>If 3 seconds passed and we still have no library code - returns &rsquo;error'</li></ol><p>The command raises an exception if response is <code>error</code>.</p><p>All this manipulations are synchronous for Ruby. The end of running the command means that we can continue execution.</p><p>Moreover, this command is safe, we can call it multiple times and it will inject the script into the page only once.</p><h3 id=create-indexeddb-instance>Create IndexedDB instance</h3><ul><li><a href=https://github.com/iliabylich/capybara-async-runner/blob/master/examples/indexeddb/commands/wrapper_initializer.rb target=_blank rel="noreferrer nofollow">Command</a></li><li><a href=https://github.com/iliabylich/capybara-async-runner/blob/master/examples/indexeddb/templates/wrapper/initialize.js.erb target=_blank rel="noreferrer nofollow">Template</a></li></ul><p>How to invoke:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#66d9ef>Capybara</span><span style=color:#f92672>::</span><span style=color:#66d9ef>AsyncRunner</span><span style=color:#f92672>.</span>run(<span style=color:#e6db74>&#39;indexeddb:wrapper:initialize&#39;</span>)
</span></span></code></pre></div><p>Explanation:</p><ol><li>JavaScript opens the database using <code>Dexie.js</code></li><li>If <code>callback</code> was called, returns <code>sucess</code></li><li>If <code>errback</code> was called, returns <code>error</code> with error message</li><li>Ruby command raises error if <code>error</code> was returned</li></ol><h3 id=write-some-data-to-the-database>Write some data to the database</h3><ul><li><a href=https://github.com/iliabylich/capybara-async-runner/blob/master/examples/indexeddb/commands/insert.rb target=_blank rel="noreferrer nofollow">Command</a></li><li><a href=https://github.com/iliabylich/capybara-async-runner/blob/master/examples/indexeddb/templates/commands/insert.js.erb target=_blank rel="noreferrer nofollow">Template</a></li></ul><p>How to invoke:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span>user_data <span style=color:#f92672>=</span> { name: <span style=color:#e6db74>&#39;Some Name&#39;</span> }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>user_id <span style=color:#f92672>=</span> <span style=color:#66d9ef>Capybara</span><span style=color:#f92672>::</span><span style=color:#66d9ef>AsyncRunner</span><span style=color:#f92672>.</span>run(<span style=color:#e6db74>&#39;indexeddb:insert&#39;</span>, <span style=color:#e6db74>store</span>: <span style=color:#e6db74>&#39;users&#39;</span>, <span style=color:#e6db74>data</span>: user_data)
</span></span><span style=display:flex><span>p <span style=color:#e6db74>&#34;User ID: </span><span style=color:#e6db74>#{</span>user_id<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span></code></pre></div><p>This step is quite simple if you understand the previous one.</p><h3 id=reading-data>Reading data</h3><ul><li><a href=https://github.com/iliabylich/capybara-async-runner/blob/master/examples/indexeddb/commands/query.rb target=_blank rel="noreferrer nofollow">Command</a></li><li><a href=https://github.com/iliabylich/capybara-async-runner/blob/master/examples/indexeddb/templates/commands/query.js.erb target=_blank rel="noreferrer nofollow">Template</a></li></ul><p>How to invoke:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span>methods <span style=color:#f92672>=</span> <span style=color:#f92672>[</span>
</span></span><span style=display:flex><span>  { method: <span style=color:#e6db74>&#39;where&#39;</span>, <span style=color:#e6db74>arguments</span>: <span style=color:#f92672>[</span><span style=color:#e6db74>&#39;id&#39;</span><span style=color:#f92672>]</span>},
</span></span><span style=display:flex><span>  { method: <span style=color:#e6db74>&#39;equals&#39;</span>, <span style=color:#e6db74>arguments</span>: <span style=color:#f92672>[</span>user_id<span style=color:#f92672>]</span> },
</span></span><span style=display:flex><span>  { method: <span style=color:#e6db74>&#39;toArray&#39;</span>, <span style=color:#e6db74>arguments</span>: <span style=color:#f92672>[]</span> }
</span></span><span style=display:flex><span><span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>p <span style=color:#66d9ef>Capybara</span><span style=color:#f92672>::</span><span style=color:#66d9ef>AsyncRunner</span><span style=color:#f92672>.</span>run(<span style=color:#e6db74>&#39;indexeddb:query&#39;</span>, <span style=color:#e6db74>store</span>: <span style=color:#e6db74>&#39;users&#39;</span>, methods: methods)
</span></span></code></pre></div><p>Here we pass an array of methods and their arguments to template, iterate over them and build a <code>Dexie.js</code> scope (just like <code>ActiveRecord::Relation</code>), and return a result back to ruby command.</p><p>After wrapping it even more we can get interface like <a href=https://github.com/iliabylich/capybara-async-runner/blob/master/examples/indexeddb/indexdb.rb#L133 target=_blank rel="noreferrer nofollow">this</a></p><p>Full example can be found <a href=https://github.com/iliabylich/capybara-async-runner/tree/master/examples/indexeddb target=_blank rel="noreferrer nofollow">here</a></p><h2 id=conclusion>Conclusion</h2><p>I would say the topic of this article is not so popular. Single page applications that work in offline mode (and because of this, use WebSQL/IndexedDB/some other asynchronous storage, probably) are still not frequent today. Usually when you build an SPA, you just write your tests using Jasmine or something like that. You mock your requests to the server API and test your client in some isolated environment. But these tests are still functional (you verify a single component - client, in this case - but not the whole application).</p><p>Someday working on a rich client-side application, remember about the idea of this post. You can control the logical flow of your client-server communication in integration tests, and this is good. Wrap your client code, build a micro-framework on top of this gem and test every piece of your code.</p></main><br><footer><script defer>function addCopyButtonToCodeBlocks(){const e=document.querySelectorAll('code[class^="language-"]');e.forEach(e=>{const t=document.createElement("button");t.classList.add("copy-code-button"),t.innerHTML="copy",t.addEventListener("click",()=>{const n=e.textContent;navigator.clipboard.writeText(n),t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},1500)}),e.parentNode.before(t)})}setTimeout(function(){addCopyButtonToCodeBlocks()},100)</script><script defer>function throttle(e,t){var n=Date.now();return function(){var s=Date.now();n+t-s<0&&(e(),n=s)}}function scrollHandler(){const e=Array.from(document.querySelectorAll("body h2, body h3"));function t(){for(var n,s,o,i=window.pageYOffset||document.documentElement.scrollTop,t=0;t<e.length;t++)s=e[t].getAttribute("id"),n=document.querySelector('nav ul li a[href="#'+s+'"]'),n&&n.classList.remove("active-toc");for(t=e.length-1;t>=0;t--)if(o=e[t].offsetTop,i>o-75&&(s=e[t].getAttribute("id"),n=document.querySelector('nav ul li a[href="#'+s+'"]'),n)){n.classList.add("active-toc");break}}window.addEventListener("scroll",throttle(t,300))}setTimeout(scrollHandler,100)</script></footer></body></html>