<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=cache-control content="max-age=0"><meta http-equiv=cache-control content="no-cache"><meta http-equiv=expires content="0"><meta http-equiv=expires content="Tue, 01 Jan 1980 1:00:00 GMT"><meta http-equiv=pragma content="no-cache"><link rel=apple-touch-icon-precomposed sizes=192x192 href=/icon-192x192.png><link rel="shortcut icon" href=/favicon.ico><link rel=preconnect href=https://fonts.googleapis.com crossorigin><link rel=preload href="https://fonts.googleapis.com/css2?family=Inter&display=swap" onload='this.onload=null,this.rel="stylesheet",this.removeAttribute("as")' as=style><noscript><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=Inter&display=swap"></noscript><meta name=description content="What is Ruby DSL"><title>What is Ruby DSL</title>





<link rel="stylesheet" href="/css/main.c8826345ad7ba562c619be2596e20207fe470ef61aecf9db4c6405371222040f.css" integrity="sha256-yIJjRa17pWLGGb4lluICB/5HDvYa7PnbTGQFNxIiBA8=" crossorigin="anonymous">





</head><body class="m-auto px-4 xl:pl-80 font-inter dark:bg-gray-900 text-black dark:text-gray-400"><nav class="pt-5 pb-5"><ul class="flex flex-row items-center justify-start"><li class=pr-3><a class="text-blue-500 hover:underline dark:text-blue-300" href=/>Home</a></li><li class=pr-3><a class="text-blue-500 hover:underline dark:text-blue-300" href=https://github.com/iliabylich>GitHub</a></li><li class=pr-3><a class="text-blue-500 hover:underline dark:text-blue-300" href=https://twitter.com/IlyaBylich>Twitter</a></li><li class=pr-3><a class="text-blue-500 hover:underline dark:text-blue-300" href=mailto:ibylich@gmail.com>Email me</a></li><li class=pr-3><a class="text-blue-500 hover:underline dark:text-blue-300" href=/index.xml>RSS</a></li></ul></nav><div class=pb-2><h1 class="font-bold text-2xl pb-5">What is Ruby DSL</h1><span>May 26, 2015</span></div><aside class="relative bg-gray-200 border-1 p-6 border-black dark:bg-gray-800 xl:dark:bg-transparent xl:fixed xl:left-1 xl:top-1 xl:w-80 xl:bg-transparent xl:border-0 xl:text-xs"><a class="block hover:underline pl-0" href=#what-is-ruby-dsl>What is Ruby DSL?
</a><a class="block hover:underline pl-0" href=#blocks-and-context>Blocks and context
</a><a class="block hover:underline pl-0" href=#so>So?
</a><a class="block hover:underline pl-0" href=#advanced-dsl-example>Advanced DSL example
</a><a class="block hover:underline pl-0" href=#defining-methods-dynamically>Defining methods dynamically
</a><a class="block hover:underline pl-0" href=#where-is-the-code>Where is the code?
</a><a class="block hover:underline pl-0" href=#whats-wrong-in-the-previous-example>What&rsquo;s wrong in the previous example?
</a><a class="block hover:underline pl-0" href=#conclusion>Conclusion</a></aside><main><h1 id=what-is-ruby-dsl class="text-4xl border-b-2 mt-8 mb-2 border-black dark:border-gray-400">What is Ruby DSL?
<a href=#what-is-ruby-dsl>#</a></h1><p>As you already know, DSL means domain-specific language. It&rsquo;s like a language in a language. Here are some examples that we use every day:</p><div class="group relative"><button class="hidden group-hover:inline absolute top-0.5 right-0.5 bg-gray-200 p-2 hover:bg-gray-400" data-copy=true>copy</button><pre class="bg-neutral-800 text-white p-4"><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>User</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>attr_reader</span> <span style=color:#e6db74>:name</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Profile</span> <span style=color:#f92672>&lt;</span> <span style=color:#66d9ef>ActiveRecord</span><span style=color:#f92672>::</span><span style=color:#66d9ef>Base</span>
</span></span><span style=display:flex><span>  has_many <span style=color:#e6db74>:posts</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ApiController</span> <span style=color:#f92672>&lt;</span> <span style=color:#66d9ef>ActionController</span><span style=color:#f92672>::</span><span style=color:#66d9ef>Base</span>
</span></span><span style=display:flex><span>  before_action <span style=color:#e6db74>:authenticate</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span></span></span></pre></div><p>But all these examples use rails-provided DSL, how about your own? First of all, you should know that all these methods (<code>attr_reader</code>, <code>has_many</code> and <code>before_action</code>) are actually class-methods of <code>Module</code>, <code>ActiveRecord::Base</code> and <code>ActionController::Base</code>. So you can write something like:</p><div class="group relative"><button class="hidden group-hover:inline absolute top-0.5 right-0.5 bg-gray-200 p-2 hover:bg-gray-400" data-copy=true>copy</button><pre class="bg-neutral-800 text-white p-4"><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>TestClass</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>self</span><span style=color:#f92672>.</span><span style=color:#a6e22e>my_dsl_method</span>(dsl_method_arg)
</span></span><span style=display:flex><span>    puts <span style=color:#e6db74>&#34;dsl method called with </span><span style=color:#e6db74>#{</span>dsl_method_arg<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>  my_dsl_method <span style=color:#e6db74>:some_argument</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span></span></span></pre></div><p>And the body of <code>my_dsl_method</code> can be more dynamic then just printing a string. It can define methods, execute some calculations, etc. Less words, more code!</p><p>For example, we want a DSL like this:</p><div class="group relative"><button class="hidden group-hover:inline absolute top-0.5 right-0.5 bg-gray-200 p-2 hover:bg-gray-400" data-copy=true>copy</button><pre class="bg-neutral-800 text-white p-4"><span style=display:flex><span>survey <span style=color:#e6db74>&#39;Survey title&#39;</span> <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>  question <span style=color:#e6db74>&#39;Question 1 title&#39;</span> <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>    answer <span style=color:#e6db74>&#39;Option 1&#39;</span>
</span></span><span style=display:flex><span>    answer <span style=color:#e6db74>&#34;Option 2&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  question <span style=color:#e6db74>&#39;Question 2 title&#39;</span> <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>    answer <span style=color:#e6db74>&#39;Option 3&#39;</span>
</span></span><span style=display:flex><span>    answer <span style=color:#e6db74>&#39;Option 4&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span></span></span></pre></div><h1 id=blocks-and-context class="text-4xl border-b-2 mt-8 mb-2 border-black dark:border-gray-400">Blocks and context
<a href=#blocks-and-context>#</a></h1><p>Ruby blocks are the heart of DSL in ruby. Blocks can be <code>call</code>-ed, <code>instance_eval</code>-ed and <code>instance_exec</code>-ed. The difference between <code>call</code> and <code>instance_eval</code> is the context of block execution:</p><div class="group relative"><button class="hidden group-hover:inline absolute top-0.5 right-0.5 bg-gray-200 p-2 hover:bg-gray-400" data-copy=true>copy</button><pre class="bg-neutral-800 text-white p-4"><span style=display:flex><span>require <span style=color:#e6db74>&#39;ostruct&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>proc1 <span style=color:#f92672>=</span> proc { puts self<span style=color:#f92672>.</span>name }
</span></span><span style=display:flex><span>proc2 <span style=color:#f92672>=</span> proc { <span style=color:#f92672>|</span>obj<span style=color:#f92672>|</span> puts obj<span style=color:#f92672>.</span>name }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>object <span style=color:#f92672>=</span> <span style=color:#66d9ef>OpenStruct</span><span style=color:#f92672>.</span>new(name: <span style=color:#e6db74>&#39;John&#39;</span>)
</span></span><span style=display:flex><span>object<span style=color:#f92672>.</span>instance_eval(<span style=color:#f92672>&amp;</span>proc1) <span style=color:#75715e># self in proc1 is object</span>
</span></span><span style=display:flex><span><span style=color:#75715e># =&gt; &#39;John&#39;</span>
</span></span><span style=display:flex><span>proc2<span style=color:#f92672>.</span>call(object) <span style=color:#75715e># obj in proc2 is object</span>
</span></span><span style=display:flex><span><span style=color:#75715e># =&gt; &#39;John&#39;</span></span></span></pre></div><p><code>instance_exec</code> is pretty much like <code>instance_eval</code> but it also takes extra arguments that becomes accessible in the block.</p><h1 id=so class="text-4xl border-b-2 mt-8 mb-2 border-black dark:border-gray-400">So?
<a href=#so>#</a></h1><p>Here is the draft of the code that simulates a survey:</p><div class="group relative"><button class="hidden group-hover:inline absolute top-0.5 right-0.5 bg-gray-200 p-2 hover:bg-gray-400" data-copy=true>copy</button><pre class="bg-neutral-800 text-white p-4"><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Survey</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>initialize</span>(title, <span style=color:#f92672>&amp;</span>block)
</span></span><span style=display:flex><span>    @title <span style=color:#f92672>=</span> title
</span></span><span style=display:flex><span>    instance_eval(<span style=color:#f92672>&amp;</span>block)
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>question</span>(question_title, <span style=color:#f92672>&amp;</span>block)
</span></span><span style=display:flex><span>    <span style=color:#75715e># Storing question</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>run</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Printing stored questions</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>survey</span>(title, <span style=color:#f92672>&amp;</span>block)
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>Survey</span><span style=color:#f92672>.</span>new(title, <span style=color:#f92672>&amp;</span>block)<span style=color:#f92672>.</span>run
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>survey <span style=color:#e6db74>&#39;Survey title&#39;</span> <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>  question <span style=color:#e6db74>&#39;My Question1&#39;</span>
</span></span><span style=display:flex><span>  question <span style=color:#e6db74>&#39;My Question2&#39;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span></span></span></pre></div><p>This DSL does not make anything yet, but it&rsquo;s a good prototype of how it should look. We <code>instance_eval</code> passed block, so DSL-method <code>question</code> becomes instance method of <code>Survey</code> class, and instance of <code>Survey</code> becomes the context of internal DSL block.</p><p>Let&rsquo;s implement <code>question</code> and <code>run</code> methods.</p><p>Method question should build instance of <code>Question</code> class with passed <code>title</code> and store it.</p><div class="group relative"><button class="hidden group-hover:inline absolute top-0.5 right-0.5 bg-gray-200 p-2 hover:bg-gray-400" data-copy=true>copy</button><pre class="bg-neutral-800 text-white p-4"><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Survey</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># ...</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>question</span>(question_title, <span style=color:#f92672>&amp;</span>block)
</span></span><span style=display:flex><span>    questions <span style=color:#f92672>&lt;&lt;</span> <span style=color:#66d9ef>Question</span><span style=color:#f92672>.</span>new(question_title, <span style=color:#f92672>&amp;</span>block)
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>questions</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># With this code we have pre-defined value</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># of `questions` method</span>
</span></span><span style=display:flex><span>    @questions <span style=color:#f92672>||=</span> <span style=color:#f92672>[]</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span></span></span></pre></div><p>And the <code>Question</code> class:</p><div class="group relative"><button class="hidden group-hover:inline absolute top-0.5 right-0.5 bg-gray-200 p-2 hover:bg-gray-400" data-copy=true>copy</button><pre class="bg-neutral-800 text-white p-4"><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Question</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>initialize</span>(title, <span style=color:#f92672>&amp;</span>block)
</span></span><span style=display:flex><span>    @title <span style=color:#f92672>=</span> title
</span></span><span style=display:flex><span>    instance_eval(<span style=color:#f92672>&amp;</span>block)
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>answer</span>(answer_text)
</span></span><span style=display:flex><span>    answers <span style=color:#f92672>&lt;&lt;</span> answer_text
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>answers</span>
</span></span><span style=display:flex><span>    @answers <span style=color:#f92672>||=</span> <span style=color:#f92672>[]</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span></span></span></pre></div><p>Let&rsquo;s put all together:</p><div class="group relative"><button class="hidden group-hover:inline absolute top-0.5 right-0.5 bg-gray-200 p-2 hover:bg-gray-400" data-copy=true>copy</button><pre class="bg-neutral-800 text-white p-4"><span style=display:flex><span>survey <span style=color:#e6db74>&#39;Survey title&#39;</span> <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># here `self` is an instance of Survey class</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># so we can call ANY instance methods of Survey</span>
</span></span><span style=display:flex><span>  question <span style=color:#e6db74>&#39;Question 1&#39;</span> <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># here `self` is an instance of Question class</span>
</span></span><span style=display:flex><span>    answer <span style=color:#e6db74>&#39;Answer 1&#39;</span>
</span></span><span style=display:flex><span>    answer <span style=color:#e6db74>&#39;Answer 2&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span></span></span></pre></div><p>The only missing method is <code>Survey#run</code>:</p><div class="group relative"><button class="hidden group-hover:inline absolute top-0.5 right-0.5 bg-gray-200 p-2 hover:bg-gray-400" data-copy=true>copy</button><pre class="bg-neutral-800 text-white p-4"><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Survey</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># ...</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>run</span>
</span></span><span style=display:flex><span>    puts @title
</span></span><span style=display:flex><span>    questions<span style=color:#f92672>.</span>each(<span style=color:#f92672>&amp;</span><span style=color:#e6db74>:run</span>)
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Question</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># ...</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>run</span>
</span></span><span style=display:flex><span>    puts @title
</span></span><span style=display:flex><span>    answers<span style=color:#f92672>.</span>each_with_index <span style=color:#66d9ef>do</span> <span style=color:#f92672>|</span>answer, index<span style=color:#f92672>|</span>
</span></span><span style=display:flex><span>      puts <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>#{</span>index <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span><span style=color:#e6db74>}</span><span style=color:#e6db74>. </span><span style=color:#e6db74>#{</span>answer<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>    result_number <span style=color:#f92672>=</span> gets<span style=color:#f92672>.</span>chomp<span style=color:#f92672>.</span>to_i <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    result <span style=color:#f92672>=</span> answers<span style=color:#f92672>[</span>result_number<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>    puts <span style=color:#e6db74>&#34;Your answer is </span><span style=color:#e6db74>#{</span>result<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span></span></span></pre></div><p><a class="text-blue-500 hover:underline" href=https://gist.github.com/iliabylich/9ea5dd31ee92571f8d59 target=_blank rel="noreferrer nofollow">Full code is available on gist</a>
or <a class="text-blue-500 hover:underline" href=https://github.com/iliabylich/multi-level-dsl target=_blank rel="noreferrer nofollow">a bit more complex example with tests on GitHub</a>
.</p><h1 id=advanced-dsl-example class="text-4xl border-b-2 mt-8 mb-2 border-black dark:border-gray-400">Advanced DSL example
<a href=#advanced-dsl-example>#</a></h1><p>DSL that we have made before allows us to write some code using shortcuts, but usually we create DSL to define new methods (or change existing ones).</p><p>Let&rsquo;s build something like:</p><div class="group relative"><button class="hidden group-hover:inline absolute top-0.5 right-0.5 bg-gray-200 p-2 hover:bg-gray-400" data-copy=true>copy</button><pre class="bg-neutral-800 text-white p-4"><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>User</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>extend</span> <span style=color:#66d9ef>MyModuleWithDSL</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  accessor_with_default_value <span style=color:#e6db74>:full_name</span>, <span style=color:#e6db74>&#39;Fname Lname&#39;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>u <span style=color:#f92672>=</span> <span style=color:#66d9ef>User</span><span style=color:#f92672>.</span>new
</span></span><span style=display:flex><span>u<span style=color:#f92672>.</span>full_name
</span></span><span style=display:flex><span><span style=color:#75715e># =&gt; &#39;Fname Lname&#39;</span>
</span></span><span style=display:flex><span>u<span style=color:#f92672>.</span>full_name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;Another Name&#39;</span>
</span></span><span style=display:flex><span>u<span style=color:#f92672>.</span>full_name
</span></span><span style=display:flex><span><span style=color:#75715e># =&gt; &#39;Another Name&#39;</span></span></span></pre></div><h1 id=defining-methods-dynamically class="text-4xl border-b-2 mt-8 mb-2 border-black dark:border-gray-400">Defining methods dynamically
<a href=#defining-methods-dynamically>#</a></h1><p>Here we need <code>define_method</code> method. It takes two parameters: a method name and a block that becomes body of created method:</p><div class="group relative"><button class="hidden group-hover:inline absolute top-0.5 right-0.5 bg-gray-200 p-2 hover:bg-gray-400" data-copy=true>copy</button><pre class="bg-neutral-800 text-white p-4"><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>User</span>
</span></span><span style=display:flex><span>  define_method <span style=color:#e6db74>:my_method</span> <span style=color:#66d9ef>do</span> <span style=color:#f92672>|</span>arg<span style=color:#f92672>|</span>
</span></span><span style=display:flex><span>    puts <span style=color:#e6db74>&#34;Called with </span><span style=color:#e6db74>#{</span>arg<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>User</span><span style=color:#f92672>.</span>new<span style=color:#f92672>.</span>my_method(<span style=color:#ae81ff>123</span>)
</span></span><span style=display:flex><span><span style=color:#75715e># =&gt; Called with 123</span></span></span></pre></div><p>A huge difference between defining method with <code>define_method</code> and <code>def method_name</code> is that <code>define_method</code> does not lose current context:</p><div class="group relative"><button class="hidden group-hover:inline absolute top-0.5 right-0.5 bg-gray-200 p-2 hover:bg-gray-400" data-copy=true>copy</button><pre class="bg-neutral-800 text-white p-4"><span style=display:flex><span>local_var <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;test&#39;</span>
</span></span><span style=display:flex><span>define_method <span style=color:#e6db74>:method1</span> <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>  puts local_var <span style=color:#75715e># Works here</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>method1
</span></span><span style=display:flex><span><span style=color:#75715e># =&gt; &#39;test&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>method2</span>
</span></span><span style=display:flex><span>  puts local_var <span style=color:#75715e># Does not work</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>method2
</span></span><span style=display:flex><span><span style=color:#75715e># =&gt; NameError: undefined local variable or method `local_var&#39; for main:Object</span></span></span></pre></div><p>This allows us to pass any variables to DSL and use them in dynamically defined methods.</p><h1 id=where-is-the-code class="text-4xl border-b-2 mt-8 mb-2 border-black dark:border-gray-400">Where is the code?
<a href=#where-is-the-code>#</a></h1><p>Here is it:</p><div class="group relative"><button class="hidden group-hover:inline absolute top-0.5 right-0.5 bg-gray-200 p-2 hover:bg-gray-400" data-copy=true>copy</button><pre class="bg-neutral-800 text-white p-4"><span style=display:flex><span><span style=color:#66d9ef>module</span> ModuleWithDSL
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>accessor_with_default_value</span>(attr_name, default_value)
</span></span><span style=display:flex><span>    <span style=color:#75715e># Here we need to build something like</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># def full_name</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#  @full_name || &#39;Fname Lname&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># end</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># attr_writer :full_name</span>
</span></span><span style=display:flex><span>    define_method attr_name <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>      instance_variable_get(<span style=color:#e6db74>&#34;@</span><span style=color:#e6db74>#{</span>attr_name<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>) <span style=color:#f92672>||</span> default_value
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>attr_writer</span> attr_name
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>User</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>extend</span> <span style=color:#66d9ef>ModuleWithDSL</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># so all methods from ModuleWithDSL</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># become class-methods of User</span>
</span></span><span style=display:flex><span>  accessor_with_default_value <span style=color:#e6db74>:full_name</span>, <span style=color:#e6db74>&#39;default&#39;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>u <span style=color:#f92672>=</span> <span style=color:#66d9ef>User</span><span style=color:#f92672>.</span>new
</span></span><span style=display:flex><span>u<span style=color:#f92672>.</span>full_name
</span></span><span style=display:flex><span><span style=color:#75715e># =&gt; &#39;default&#39;</span>
</span></span><span style=display:flex><span>u<span style=color:#f92672>.</span>full_name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;Full Name&#39;</span>
</span></span><span style=display:flex><span>u<span style=color:#f92672>.</span>full_name
</span></span><span style=display:flex><span><span style=color:#75715e># =&gt; &#39;Full Name&#39;</span></span></span></pre></div><h1 id=whats-wrong-in-the-previous-example class="text-4xl border-b-2 mt-8 mb-2 border-black dark:border-gray-400">What&rsquo;s wrong in the previous example?
<a href=#whats-wrong-in-the-previous-example>#</a></h1><p>What I personally don&rsquo;t like here is that there is no way to override defined method using <code>super</code> (I don&rsquo;t like <code>alias_method_chain</code>, we really can make it work using super method). Why super does not work? Because the method is defined directly on the class:</p><div class="group relative"><button class="hidden group-hover:inline absolute top-0.5 right-0.5 bg-gray-200 p-2 hover:bg-gray-400" data-copy=true>copy</button><pre class="bg-neutral-800 text-white p-4"><span style=display:flex><span><span style=color:#66d9ef>User</span><span style=color:#f92672>.</span>instance_method(<span style=color:#e6db74>:full_name</span>)
</span></span><span style=display:flex><span><span style=color:#75715e># =&gt; #&lt;UnboundMethod: User#full_name&gt;</span></span></span></pre></div><p>The following example is quite complex, but still:</p><div class="group relative"><button class="hidden group-hover:inline absolute top-0.5 right-0.5 bg-gray-200 p-2 hover:bg-gray-400" data-copy=true>copy</button><pre class="bg-neutral-800 text-white p-4"><span style=display:flex><span><span style=color:#66d9ef>module</span> ModuleWithDSL
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>self</span><span style=color:#f92672>.</span><span style=color:#a6e22e>extended</span>(base)
</span></span><span style=display:flex><span>    mod <span style=color:#f92672>=</span> base<span style=color:#f92672>.</span>const_set(<span style=color:#e6db74>:AccessorsWithDefaultValues</span>, <span style=color:#66d9ef>Module</span><span style=color:#f92672>.</span>new)
</span></span><span style=display:flex><span>    base<span style=color:#f92672>.</span>send(<span style=color:#e6db74>:include</span>, mod)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>super</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>accessor_with_default_value</span>(attr_name, default_value)
</span></span><span style=display:flex><span>    const_get(<span style=color:#e6db74>:AccessorsWithDefaultValues</span>)<span style=color:#f92672>.</span>module_eval <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>      define_method attr_name <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>        instance_variable_get(<span style=color:#e6db74>&#34;@</span><span style=color:#e6db74>#{</span>attr_name<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>) <span style=color:#f92672>||</span> default_value
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>attr_writer</span> attr_name
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span></span></span></pre></div><p>Here when this module <code>extend</code>-s some class/module, we define a sub-module called <code>AccessorsWithDefaultValues</code> in the class using <code>extended</code> hook, include it in the class and define ALL dynamic methods on this module. What does it give us?</p><div class="group relative"><button class="hidden group-hover:inline absolute top-0.5 right-0.5 bg-gray-200 p-2 hover:bg-gray-400" data-copy=true>copy</button><pre class="bg-neutral-800 text-white p-4"><span style=display:flex><span><span style=color:#66d9ef>User</span><span style=color:#f92672>.</span>instance_method(<span style=color:#e6db74>:full_name</span>)
</span></span><span style=display:flex><span><span style=color:#75715e># =&gt; #&lt;UnboundMethod: User(User::AccessorsWithDefaultValues)#full_name&gt;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>User</span><span style=color:#f92672>.</span>ancestors
</span></span><span style=display:flex><span><span style=color:#75715e># =&gt; [User, User::AccessorsWithDefaultValues, ...]</span></span></span></pre></div><p>So now we can override our <code>accessor</code>-s on <code>User</code>:</p><div class="group relative"><button class="hidden group-hover:inline absolute top-0.5 right-0.5 bg-gray-200 p-2 hover:bg-gray-400" data-copy=true>copy</button><pre class="bg-neutral-800 text-white p-4"><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>User</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>extend</span> <span style=color:#66d9ef>ModuleWithDSL</span>
</span></span><span style=display:flex><span>  accessor_with_default_value <span style=color:#e6db74>:counter</span>, <span style=color:#ae81ff>123</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>counter</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>super</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>10</span> <span style=color:#75715e># default behavior + 10</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>user <span style=color:#f92672>=</span> <span style=color:#66d9ef>User</span><span style=color:#f92672>.</span>new
</span></span><span style=display:flex><span>user<span style=color:#f92672>.</span>counter
</span></span><span style=display:flex><span><span style=color:#75715e># =&gt; 133 (123 + 10 = default + custom)</span>
</span></span><span style=display:flex><span>user<span style=color:#f92672>.</span>counter <span style=color:#f92672>=</span> <span style=color:#ae81ff>15</span>
</span></span><span style=display:flex><span>user<span style=color:#f92672>.</span>counter
</span></span><span style=display:flex><span><span style=color:#75715e># =&gt; 25</span></span></span></pre></div><p>ActiveRecord does the same job, you can override any column-method:</p><div class="group relative"><button class="hidden group-hover:inline absolute top-0.5 right-0.5 bg-gray-200 p-2 hover:bg-gray-400" data-copy=true>copy</button><pre class="bg-neutral-800 text-white p-4"><span style=display:flex><span><span style=color:#66d9ef>User</span><span style=color:#f92672>.</span>instance_method(<span style=color:#e6db74>:email</span>)
</span></span><span style=display:flex><span><span style=color:#75715e># =&gt; #&lt;UnboundMethod: User(#&lt;#&lt;Class:0x00000008c44ac0&gt;:0x00000008c44b38&gt;)#email(__temp__56d61696c6)&gt;</span>
</span></span><span style=display:flex><span><span style=color:#75715e># This module is anonymous, but it doesn&#39;t matter, it wasn&#39;t defined _directly_ on User:</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>User</span> <span style=color:#f92672>&lt;</span> <span style=color:#66d9ef>ActiveRecord</span><span style=color:#f92672>::</span><span style=color:#66d9ef>Base</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># If you have column `email`</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>email</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>super</span><span style=color:#f92672>.</span>upcase
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span></span></span></pre></div><p>A lot of developers build a DSL in their libraries to simplify the code, and this allows us to write our code in a more declarative fashion. But they forgot (quite often) about allowing us to override the code generated with this DSL. When the library does not support overriding generated code, use <code>alias_method</code>:</p><div class="group relative"><button class="hidden group-hover:inline absolute top-0.5 right-0.5 bg-gray-200 p-2 hover:bg-gray-400" data-copy=true>copy</button><pre class="bg-neutral-800 text-white p-4"><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>User</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>include</span> <span style=color:#66d9ef>SomeModule</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># here we call some DSL</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># and, let&#39;s say, it generates method &#39;run&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># and we need to add before hooks</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># to this method</span>
</span></span><span style=display:flex><span>  alias_method <span style=color:#e6db74>:original_run</span>, <span style=color:#e6db74>:run</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>run</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># before hook goes here..</span>
</span></span><span style=display:flex><span>    original_run
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span></span></span></pre></div><h1 id=conclusion class="text-4xl border-b-2 mt-8 mb-2 border-black dark:border-gray-400">Conclusion
<a href=#conclusion>#</a></h1><p>DSL is a tool for fast prototyping, here are some advantages:</p><ol><li>It makes your code look nicer (the code that calls DSL)</li><li>Amazing level of abstraction, you can focus exactly on your logic and forget about any code-related stuff.</li></ol><p>And disadvantages:</p><ol><li>Your code becomes slow (usually just a little bit, but sometimes it can be critical)</li><li>The effort to maintain your DSL grows with its complexity. Yes, it&rsquo;s very easy to make DSL implementation look ugly</li></ol><p>I really love to use DSL from third-party libraries (AR, RSpec, Capybara, FactoryBot). But as I said before, I don&rsquo;t write it in enterprise and usually I ask people to avoid it.</p><p>But if you write DSL, please wrap generated stuff into module to let developers override your code and be happy, this is what DSL is made for :)</p></main><br><footer><script type=module defer>
  const copyToClipboard = (e) => {
    const button = e.target;
    const src = button.nextElementSibling.textContent
    navigator.clipboard.writeText(src)

    const originalText = button.innerText
    button.innerText = "copied!"
    setTimeout(() => {
      button.innerText = originalText
    }, 1500);
  }

  Array.from(document.querySelectorAll("[data-copy]")).forEach(button => {
    button.addEventListener("click", copyToClipboard)
  })
</script></footer></body></html>