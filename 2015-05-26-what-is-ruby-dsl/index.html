<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=cache-control content="max-age=0"><meta http-equiv=cache-control content="no-cache"><meta http-equiv=expires content="0"><meta http-equiv=expires content="Tue, 01 Jan 1980 1:00:00 GMT"><meta http-equiv=pragma content="no-cache"><link rel=apple-touch-icon-precomposed sizes=192x192 href=/icon-192x192.png><link rel="shortcut icon" href=/favicon.ico><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#1b1b1b"><meta name=description content="What is Ruby DSL"><title>What is Ruby DSL | Ilya Bylich - Blog</title><style>:root{--background:#ffffff}@media(prefers-color-scheme:dark){:root{--background:#1b1b1b}}html{background-color:var(--background)}body{background-color:var(--background)}</style><link rel=stylesheet type=text/css href=/style.min.bc9c53f4c8c502891338c2b605412b41da61bca150c6a77869811fc296d3098c.css media=all></head><body><nav><ul class=menu><li><a tabindex=-1 class=menu-link href=/>Home</a></li><li><a tabindex=-1 class=menu-link href=https://github.com/iliabylich>GitHub</a></li><li><a tabindex=-1 class=menu-link href=https://twitter.com/IlyaBylich>Twitter</a></li><li><a tabindex=-1 class=menu-link href=mailto:ibylich@gmail.com>Email me</a></li><li><a tabindex=-1 class=menu-link href=/index.xml>RSS</a></li></ul></nav><div id=single-header><h1>What is Ruby DSL</h1><div id=single-meta><span class=datesub>May 26, 2015</span>
<span id=tags>&nbsp;&nbsp;
<span><a href=https://iliabylich.github.io/tags/ruby/>#ruby</a>
</span>&nbsp; <span><a href=https://iliabylich.github.io/tags/dsl/>#dsl</a>
</span>&nbsp;</span></div></div><aside class="hidden lg:block toc" id=tableOfContentContainer><nav id=TableOfContents><ul><li><a href=#what-is-ruby-dsl>What is Ruby DSL?</a></li><li><a href=#blocks-and-context>Blocks and context</a></li><li><a href=#so>So?</a></li><li><a href=#advanced-dsl-example>Advanced DSL example</a></li><li><a href=#defining-methods-dynamically>Defining methods dynamically</a></li><li><a href=#where-is-the-code>Where is the code?</a></li><li><a href=#whats-wrong-in-the-previous-example>What&rsquo;s wrong in the previous example?</a></li><li><a href=#conclusion>Conclusion</a></li></ul></nav></aside><main><h2 id=what-is-ruby-dsl>What is Ruby DSL?</h2><p>As you already know, DSL means domain-specific language. It&rsquo;s like a language in a language. Here are some examples that we use every day:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>User</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>attr_reader</span> <span style=color:#e6db74>:name</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Profile</span> <span style=color:#f92672>&lt;</span> <span style=color:#66d9ef>ActiveRecord</span><span style=color:#f92672>::</span><span style=color:#66d9ef>Base</span>
</span></span><span style=display:flex><span>  has_many <span style=color:#e6db74>:posts</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ApiController</span> <span style=color:#f92672>&lt;</span> <span style=color:#66d9ef>ActionController</span><span style=color:#f92672>::</span><span style=color:#66d9ef>Base</span>
</span></span><span style=display:flex><span>  before_action <span style=color:#e6db74>:authenticate</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><p>But all these examples use rails-provided DSL, how about your own? First of all, you should know that all these methods (<code>attr_reader</code>, <code>has_many</code> and <code>before_action</code>) are actually class-methods of <code>Module</code>, <code>ActiveRecord::Base</code> and <code>ActionController::Base</code>. So you can write something like:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>TestClass</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>self</span><span style=color:#f92672>.</span><span style=color:#a6e22e>my_dsl_method</span>(dsl_method_arg)
</span></span><span style=display:flex><span>    puts <span style=color:#e6db74>&#34;dsl method called with </span><span style=color:#e6db74>#{</span>dsl_method_arg<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>  my_dsl_method <span style=color:#e6db74>:some_argument</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><p>And the body of <code>my_dsl_method</code> can be more dynamic then just printing a string. It can define methods, execute some calculations, etc. Less words, more code!</p><p>For example, we want a DSL like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span>survey <span style=color:#e6db74>&#39;Survey title&#39;</span> <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>  question <span style=color:#e6db74>&#39;Question 1 title&#39;</span> <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>    answer <span style=color:#e6db74>&#39;Option 1&#39;</span>
</span></span><span style=display:flex><span>    answer <span style=color:#e6db74>&#34;Option 2&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  question <span style=color:#e6db74>&#39;Question 2 title&#39;</span> <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>    answer <span style=color:#e6db74>&#39;Option 3&#39;</span>
</span></span><span style=display:flex><span>    answer <span style=color:#e6db74>&#39;Option 4&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><h2 id=blocks-and-context>Blocks and context</h2><p>Ruby blocks are the heart of DSL in ruby. Blocks can be <code>call</code>-ed, <code>instance_eval</code>-ed and <code>instance_exec</code>-ed. The difference between <code>call</code> and <code>instance_eval</code> is the context of block execution:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span>require <span style=color:#e6db74>&#39;ostruct&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>proc1 <span style=color:#f92672>=</span> proc { puts self<span style=color:#f92672>.</span>name }
</span></span><span style=display:flex><span>proc2 <span style=color:#f92672>=</span> proc { <span style=color:#f92672>|</span>obj<span style=color:#f92672>|</span> puts obj<span style=color:#f92672>.</span>name }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>object <span style=color:#f92672>=</span> <span style=color:#66d9ef>OpenStruct</span><span style=color:#f92672>.</span>new(name: <span style=color:#e6db74>&#39;John&#39;</span>)
</span></span><span style=display:flex><span>object<span style=color:#f92672>.</span>instance_eval(<span style=color:#f92672>&amp;</span>proc1) <span style=color:#75715e># self in proc1 is object</span>
</span></span><span style=display:flex><span><span style=color:#75715e># =&gt; &#39;John&#39;</span>
</span></span><span style=display:flex><span>proc2<span style=color:#f92672>.</span>call(object) <span style=color:#75715e># obj in proc2 is object</span>
</span></span><span style=display:flex><span><span style=color:#75715e># =&gt; &#39;John&#39;</span>
</span></span></code></pre></div><p><code>instance_exec</code> is pretty much like <code>instance_eval</code> but it also takes extra arguments that becomes accessible in the block.</p><h2 id=so>So?</h2><p>Here is the draft of the code that simulates a survey:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Survey</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>initialize</span>(title, <span style=color:#f92672>&amp;</span>block)
</span></span><span style=display:flex><span>    @title <span style=color:#f92672>=</span> title
</span></span><span style=display:flex><span>    instance_eval(<span style=color:#f92672>&amp;</span>block)
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>question</span>(question_title, <span style=color:#f92672>&amp;</span>block)
</span></span><span style=display:flex><span>    <span style=color:#75715e># Storing question</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>run</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Printing stored questions</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>survey</span>(title, <span style=color:#f92672>&amp;</span>block)
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>Survey</span><span style=color:#f92672>.</span>new(title, <span style=color:#f92672>&amp;</span>block)<span style=color:#f92672>.</span>run
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>survey <span style=color:#e6db74>&#39;Survey title&#39;</span> <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>  question <span style=color:#e6db74>&#39;My Question1&#39;</span>
</span></span><span style=display:flex><span>  question <span style=color:#e6db74>&#39;My Question2&#39;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><p>This DSL does not make anything yet, but it&rsquo;s a good prototype of how it should look. We <code>instance_eval</code> passed block, so DSL-method <code>question</code> becomes instance method of <code>Survey</code> class, and instance of <code>Survey</code> becomes the context of internal DSL block.</p><p>Let&rsquo;s implement <code>question</code> and <code>run</code> methods.</p><p>Method question should build instance of <code>Question</code> class with passed <code>title</code> and store it.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Survey</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># ...</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>question</span>(question_title, <span style=color:#f92672>&amp;</span>block)
</span></span><span style=display:flex><span>    questions <span style=color:#f92672>&lt;&lt;</span> <span style=color:#66d9ef>Question</span><span style=color:#f92672>.</span>new(question_title, <span style=color:#f92672>&amp;</span>block)
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>questions</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># With this code we have pre-defined value</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># of `questions` method</span>
</span></span><span style=display:flex><span>    @questions <span style=color:#f92672>||=</span> <span style=color:#f92672>[]</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><p>And the <code>Question</code> class:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Question</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>initialize</span>(title, <span style=color:#f92672>&amp;</span>block)
</span></span><span style=display:flex><span>    @title <span style=color:#f92672>=</span> title
</span></span><span style=display:flex><span>    instance_eval(<span style=color:#f92672>&amp;</span>block)
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>answer</span>(answer_text)
</span></span><span style=display:flex><span>    answers <span style=color:#f92672>&lt;&lt;</span> answer_text
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>answers</span>
</span></span><span style=display:flex><span>    @answers <span style=color:#f92672>||=</span> <span style=color:#f92672>[]</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><p>Let&rsquo;s put all together:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span>survey <span style=color:#e6db74>&#39;Survey title&#39;</span> <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># here `self` is an instance of Survey class</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># so we can call ANY instance methods of Survey</span>
</span></span><span style=display:flex><span>  question <span style=color:#e6db74>&#39;Question 1&#39;</span> <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># here `self` is an instance of Question class</span>
</span></span><span style=display:flex><span>    answer <span style=color:#e6db74>&#39;Answer 1&#39;</span>
</span></span><span style=display:flex><span>    answer <span style=color:#e6db74>&#39;Answer 2&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><p>The only missing method is <code>Survey#run</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Survey</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># ...</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>run</span>
</span></span><span style=display:flex><span>    puts @title
</span></span><span style=display:flex><span>    questions<span style=color:#f92672>.</span>each(<span style=color:#f92672>&amp;</span><span style=color:#e6db74>:run</span>)
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Question</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># ...</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>run</span>
</span></span><span style=display:flex><span>    puts @title
</span></span><span style=display:flex><span>    answers<span style=color:#f92672>.</span>each_with_index <span style=color:#66d9ef>do</span> <span style=color:#f92672>|</span>answer, index<span style=color:#f92672>|</span>
</span></span><span style=display:flex><span>      puts <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>#{</span>index <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span><span style=color:#e6db74>}</span><span style=color:#e6db74>. </span><span style=color:#e6db74>#{</span>answer<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>    result_number <span style=color:#f92672>=</span> gets<span style=color:#f92672>.</span>chomp<span style=color:#f92672>.</span>to_i <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    result <span style=color:#f92672>=</span> answers<span style=color:#f92672>[</span>result_number<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>    puts <span style=color:#e6db74>&#34;Your answer is </span><span style=color:#e6db74>#{</span>result<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><p><a href=https://gist.github.com/iliabylich/9ea5dd31ee92571f8d59 target=_blank rel="noreferrer nofollow">Full code is available on gist</a>
or <a href=https://github.com/iliabylich/multi-level-dsl target=_blank rel="noreferrer nofollow">a bit more complex example with tests on GitHub</a>
.</p><h2 id=advanced-dsl-example>Advanced DSL example</h2><p>DSL that we have made before allows us to write some code using shortcuts, but usually we create DSL to define new methods (or change existing ones).</p><p>Let&rsquo;s build something like:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>User</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>extend</span> <span style=color:#66d9ef>MyModuleWithDSL</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  accessor_with_default_value <span style=color:#e6db74>:full_name</span>, <span style=color:#e6db74>&#39;Fname Lname&#39;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>u <span style=color:#f92672>=</span> <span style=color:#66d9ef>User</span><span style=color:#f92672>.</span>new
</span></span><span style=display:flex><span>u<span style=color:#f92672>.</span>full_name
</span></span><span style=display:flex><span><span style=color:#75715e># =&gt; &#39;Fname Lname&#39;</span>
</span></span><span style=display:flex><span>u<span style=color:#f92672>.</span>full_name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;Another Name&#39;</span>
</span></span><span style=display:flex><span>u<span style=color:#f92672>.</span>full_name
</span></span><span style=display:flex><span><span style=color:#75715e># =&gt; &#39;Another Name&#39;</span>
</span></span></code></pre></div><h2 id=defining-methods-dynamically>Defining methods dynamically</h2><p>Here we need <code>define_method</code> method. It takes two parameters: a method name and a block that becomes body of created method:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>User</span>
</span></span><span style=display:flex><span>  define_method <span style=color:#e6db74>:my_method</span> <span style=color:#66d9ef>do</span> <span style=color:#f92672>|</span>arg<span style=color:#f92672>|</span>
</span></span><span style=display:flex><span>    puts <span style=color:#e6db74>&#34;Called with </span><span style=color:#e6db74>#{</span>arg<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>User</span><span style=color:#f92672>.</span>new<span style=color:#f92672>.</span>my_method(<span style=color:#ae81ff>123</span>)
</span></span><span style=display:flex><span><span style=color:#75715e># =&gt; Called with 123</span>
</span></span></code></pre></div><p>A huge difference between defining method with <code>define_method</code> and <code>def method_name</code> is that <code>define_method</code> does not lose current context:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span>local_var <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;test&#39;</span>
</span></span><span style=display:flex><span>define_method <span style=color:#e6db74>:method1</span> <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>  puts local_var <span style=color:#75715e># Works here</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>method1
</span></span><span style=display:flex><span><span style=color:#75715e># =&gt; &#39;test&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>method2</span>
</span></span><span style=display:flex><span>  puts local_var <span style=color:#75715e># Does not work</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>method2
</span></span><span style=display:flex><span><span style=color:#75715e># =&gt; NameError: undefined local variable or method `local_var&#39; for main:Object</span>
</span></span></code></pre></div><p>This allows us to pass any variables to DSL and use them in dynamically defined methods.</p><h2 id=where-is-the-code>Where is the code?</h2><p>Here is it:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#66d9ef>module</span> ModuleWithDSL
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>accessor_with_default_value</span>(attr_name, default_value)
</span></span><span style=display:flex><span>    <span style=color:#75715e># Here we need to build something like</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># def full_name</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#  @full_name || &#39;Fname Lname&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># end</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># attr_writer :full_name</span>
</span></span><span style=display:flex><span>    define_method attr_name <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>      instance_variable_get(<span style=color:#e6db74>&#34;@</span><span style=color:#e6db74>#{</span>attr_name<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>) <span style=color:#f92672>||</span> default_value
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>attr_writer</span> attr_name
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>User</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>extend</span> <span style=color:#66d9ef>ModuleWithDSL</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># so all methods from ModuleWithDSL</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># become class-methods of User</span>
</span></span><span style=display:flex><span>  accessor_with_default_value <span style=color:#e6db74>:full_name</span>, <span style=color:#e6db74>&#39;default&#39;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>u <span style=color:#f92672>=</span> <span style=color:#66d9ef>User</span><span style=color:#f92672>.</span>new
</span></span><span style=display:flex><span>u<span style=color:#f92672>.</span>full_name
</span></span><span style=display:flex><span><span style=color:#75715e># =&gt; &#39;default&#39;</span>
</span></span><span style=display:flex><span>u<span style=color:#f92672>.</span>full_name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;Full Name&#39;</span>
</span></span><span style=display:flex><span>u<span style=color:#f92672>.</span>full_name
</span></span><span style=display:flex><span><span style=color:#75715e># =&gt; &#39;Full Name&#39;</span>
</span></span></code></pre></div><h2 id=whats-wrong-in-the-previous-example>What&rsquo;s wrong in the previous example?</h2><p>What I personally don&rsquo;t like here is that there is no way to override defined method using <code>super</code> (I don&rsquo;t like <code>alias_method_chain</code>, we really can make it work using super method). Why super does not work? Because the method is defined directly on the class:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#66d9ef>User</span><span style=color:#f92672>.</span>instance_method(<span style=color:#e6db74>:full_name</span>)
</span></span><span style=display:flex><span><span style=color:#75715e># =&gt; #&lt;UnboundMethod: User#full_name&gt;</span>
</span></span></code></pre></div><p>The following example is quite complex, but still:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#66d9ef>module</span> ModuleWithDSL
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>self</span><span style=color:#f92672>.</span><span style=color:#a6e22e>extended</span>(base)
</span></span><span style=display:flex><span>    mod <span style=color:#f92672>=</span> base<span style=color:#f92672>.</span>const_set(<span style=color:#e6db74>:AccessorsWithDefaultValues</span>, <span style=color:#66d9ef>Module</span><span style=color:#f92672>.</span>new)
</span></span><span style=display:flex><span>    base<span style=color:#f92672>.</span>send(<span style=color:#e6db74>:include</span>, mod)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>super</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>accessor_with_default_value</span>(attr_name, default_value)
</span></span><span style=display:flex><span>    const_get(<span style=color:#e6db74>:AccessorsWithDefaultValues</span>)<span style=color:#f92672>.</span>module_eval <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>      define_method attr_name <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>        instance_variable_get(<span style=color:#e6db74>&#34;@</span><span style=color:#e6db74>#{</span>attr_name<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>) <span style=color:#f92672>||</span> default_value
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>attr_writer</span> attr_name
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><p>Here when this module <code>extend</code>-s some class/module, we define a sub-module called <code>AccessorsWithDefaultValues</code> in the class using <code>extended</code> hook, include it in the class and define ALL dynamic methods on this module. What does it give us?</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#66d9ef>User</span><span style=color:#f92672>.</span>instance_method(<span style=color:#e6db74>:full_name</span>)
</span></span><span style=display:flex><span><span style=color:#75715e># =&gt; #&lt;UnboundMethod: User(User::AccessorsWithDefaultValues)#full_name&gt;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>User</span><span style=color:#f92672>.</span>ancestors
</span></span><span style=display:flex><span><span style=color:#75715e># =&gt; [User, User::AccessorsWithDefaultValues, ...]</span>
</span></span></code></pre></div><p>So now we can override our <code>accessor</code>-s on <code>User</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>User</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>extend</span> <span style=color:#66d9ef>ModuleWithDSL</span>
</span></span><span style=display:flex><span>  accessor_with_default_value <span style=color:#e6db74>:counter</span>, <span style=color:#ae81ff>123</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>counter</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>super</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>10</span> <span style=color:#75715e># default behavior + 10</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>user <span style=color:#f92672>=</span> <span style=color:#66d9ef>User</span><span style=color:#f92672>.</span>new
</span></span><span style=display:flex><span>user<span style=color:#f92672>.</span>counter
</span></span><span style=display:flex><span><span style=color:#75715e># =&gt; 133 (123 + 10 = default + custom)</span>
</span></span><span style=display:flex><span>user<span style=color:#f92672>.</span>counter <span style=color:#f92672>=</span> <span style=color:#ae81ff>15</span>
</span></span><span style=display:flex><span>user<span style=color:#f92672>.</span>counter
</span></span><span style=display:flex><span><span style=color:#75715e># =&gt; 25</span>
</span></span></code></pre></div><p>ActiveRecord does the same job, you can override any column-method:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#66d9ef>User</span><span style=color:#f92672>.</span>instance_method(<span style=color:#e6db74>:email</span>)
</span></span><span style=display:flex><span><span style=color:#75715e># =&gt; #&lt;UnboundMethod: User(#&lt;#&lt;Class:0x00000008c44ac0&gt;:0x00000008c44b38&gt;)#email(__temp__56d61696c6)&gt;</span>
</span></span><span style=display:flex><span><span style=color:#75715e># This module is anonymous, but it doesn&#39;t matter, it wasn&#39;t defined _directly_ on User:</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>User</span> <span style=color:#f92672>&lt;</span> <span style=color:#66d9ef>ActiveRecord</span><span style=color:#f92672>::</span><span style=color:#66d9ef>Base</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># If you have column `email`</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>email</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>super</span><span style=color:#f92672>.</span>upcase
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><p>A lot of developers build a DSL in their libraries to simplify the code, and this allows us to write our code in a more declarative fashion. But they forgot (quite often) about allowing us to override the code generated with this DSL. When the library does not support overriding generated code, use <code>alias_method</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>User</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>include</span> <span style=color:#66d9ef>SomeModule</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># here we call some DSL</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># and, let&#39;s say, it generates method &#39;run&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># and we need to add before hooks</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># to this method</span>
</span></span><span style=display:flex><span>  alias_method <span style=color:#e6db74>:original_run</span>, <span style=color:#e6db74>:run</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>run</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># before hook goes here..</span>
</span></span><span style=display:flex><span>    original_run
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><h2 id=conclusion>Conclusion</h2><p>DSL is a tool for fast prototyping, here are some advantages:</p><ol><li>It makes your code look nicer (the code that calls DSL)</li><li>Amazing level of abstraction, you can focus exactly on your logic and forget about any code-related stuff.</li></ol><p>And disadvantages:</p><ol><li>Your code becomes slow (usually just a little bit, but sometimes it can be critical)</li><li>The effort to maintain your DSL grows with its complexity. Yes, it&rsquo;s very easy to make DSL implementation look ugly</li></ol><p>I really love to use DSL from third-party libraries (AR, RSpec, Capybara, FactoryBot). But as I said before, I don&rsquo;t write it in enterprise and usually I ask people to avoid it.</p><p>But if you write DSL, please wrap generated stuff into module to let developers override your code and be happy, this is what DSL is made for :)</p></main><br><footer><script defer>function addCopyButtonToCodeBlocks(){const e=document.querySelectorAll('code[class^="language-"]');e.forEach(e=>{const t=document.createElement("button");t.classList.add("copy-code-button"),t.innerHTML="copy",t.addEventListener("click",()=>{const n=e.textContent;navigator.clipboard.writeText(n),t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},1500)}),e.parentNode.before(t)})}setTimeout(function(){addCopyButtonToCodeBlocks()},100)</script><script defer>function throttle(e,t){var n=Date.now();return function(){var s=Date.now();n+t-s<0&&(e(),n=s)}}function scrollHandler(){const e=Array.from(document.querySelectorAll("body h2, body h3"));function t(){for(var n,s,o,i=window.pageYOffset||document.documentElement.scrollTop,t=0;t<e.length;t++)s=e[t].getAttribute("id"),n=document.querySelector('nav ul li a[href="#'+s+'"]'),n&&n.classList.remove("active-toc");for(t=e.length-1;t>=0;t--)if(o=e[t].offsetTop,i>o-75&&(s=e[t].getAttribute("id"),n=document.querySelector('nav ul li a[href="#'+s+'"]'),n)){n.classList.add("active-toc");break}}window.addEventListener("scroll",throttle(t,300))}setTimeout(scrollHandler,100)</script></footer></body></html>