<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Capybara and asynchronous stuff &middot; Ilya Bylich
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/hyde.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="192x192" href="/public/apple-touch-icon-192-precomposed.png">
                                 <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/feed.xml">

  <script async src="https://www.googletagmanager.com/gtag/js?id=G-EBV7BR668S"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-EBV7BR668S');
</script>

</head>


  <body class="theme-base-0b">

    <div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <h1>
        <a href="/">
          Ilya Bylich
        </a>
      </h1>
      <p class="lead">I'm a Ruby/Rust developer, sometimes I write long technical stories</p>
    </div>

    <nav class="sidebar-nav">
      <a class="sidebar-nav-item" href="/">Home</a>

      

      <a class="sidebar-nav-item" href="https://github.com/iliabylich">GitHub</a>
      <a class="sidebar-nav-item" href="https://twitter.com/IlyaBylich">Twitter</a>
      <a class="sidebar-nav-item" href="mailto:ibylich@gmail.com">Email me</a>
      <a class="sidebar-nav-item" href="https://iliabylich.github.io/feed.xml">RSS</a>

      <span class="sidebar-nav-item">
  <label for="current-theme">Theme</label>
  <select id="current-theme">
    <option>08</option>
    <option>09</option>
    <option>0a</option>
    <option>0b</option>
    <option>0c</option>
    <option>0d</option>
    <option>0f</option>
  </select>

  <script type="text/javascript">
    class Theme {
      static DEFAULT = "0b";

      static getCurrent() {
        return localStorage.getItem("current-theme") || Theme.DEFAULT;
      }

      static setCurrent(theme) {
        localStorage.setItem("current-theme", theme);
        document.body.className = `theme-base-${theme}`;
      }
    }

    const themeSelector = document.getElementById("current-theme");
    Theme.setCurrent(Theme.getCurrent());
    themeSelector.value = Theme.getCurrent();

    themeSelector.onchange = (e) => {
      const theme = e.target.value;
      Theme.setCurrent(theme);
    }
  </script>
</span>

    </nav>

    <p>&copy; 2022. All rights reserved.</p>
  </div>
</div>


    <div class="content container">
      <div class="post">
  <h1 class="post-title">Capybara and asynchronous stuff</h1>
  <span class="post-date">30 Jun 2015</span>

  <div class="reading-time" title="Estimated read time">
  This article will take 9 minutes to read
  <br />
  (or maybe less, the algorithm treats code as text)
</div>


  <div id="table-of-contents">
    <ul id="toc" class="section-nav">
<li class="toc-entry toc-h1"><a href="#what-is-capybara-poltergeist-and-phantomjs">What is Capybara, Poltergeist and PhantomJS?</a>
<ul>
<li class="toc-entry toc-h2"><a href="#phantomjs">PhantomJS</a></li>
<li class="toc-entry toc-h2"><a href="#poltergeist">Poltergeist</a></li>
<li class="toc-entry toc-h2"><a href="#capybara">Capybara</a></li>
</ul>
</li>
<li class="toc-entry toc-h1"><a href="#asynchronous-javascript-code-in-your-tests">Asynchronous JavaScript code in your tests</a></li>
<li class="toc-entry toc-h1"><a href="#capybarapoltergeistphantomjs-installation">Capybara/Poltergeist/PhantomJS installation</a></li>
<li class="toc-entry toc-h1"><a href="#small-example">Small example</a></li>
<li class="toc-entry toc-h1"><a href="#but-capybara-waits-for-my-ajax-requests">But… Capybara waits for my AJAX requests</a></li>
<li class="toc-entry toc-h1"><a href="#can-we-reuse-it">Can we reuse it?</a></li>
<li class="toc-entry toc-h1"><a href="#can-we-organize-it-as-a-common-reusable-solution">Can we organize it as a common reusable solution?</a></li>
<li class="toc-entry toc-h1"><a href="#wrapping-up">Wrapping up</a></li>
<li class="toc-entry toc-h1"><a href="#passing-data-to-template">Passing data to template</a></li>
<li class="toc-entry toc-h1"><a href="#lets-write-something-complex">Let’s write something complex</a>
<ul>
<li class="toc-entry toc-h2"><a href="#visiting-the-page">Visiting the page</a></li>
<li class="toc-entry toc-h2"><a href="#injecting-dexiejs-into-the-page">Injecting Dexie.js into the page</a></li>
<li class="toc-entry toc-h2"><a href="#create-indexeddb-instance">Create IndexedDB instance</a></li>
<li class="toc-entry toc-h2"><a href="#write-some-data-to-the-database">Write some data to the database</a></li>
<li class="toc-entry toc-h2"><a href="#reading-data">Reading data</a></li>
</ul>
</li>
<li class="toc-entry toc-h1"><a href="#conclusion">Conclusion</a></li>
</ul>
  </div>

  <p>In this entry I will try to cover the following aspects:</p>
<ol>
  <li>Running asynchronous code in a web driver</li>
  <li>Making the call synchronous</li>
  <li>Wrapping it into some common solution</li>
  <li>Advanced example - working with IndexedDB from Capybara</li>
</ol>

<h1 id="what-is-capybara-poltergeist-and-phantomjs">What is Capybara, Poltergeist and PhantomJS?</h1>

<h2 id="phantomjs">PhantomJS</h2>

<p>First of all, we need to know what is PhantomJS. I would say it’s a ‘tool that acts like a browser but can be controlled from outside using simple command interface’. In more common words, it’s a web driver. It’s a full-featured WebKit (an engine of Chrome/Safari/few last versions of Opera and other browsers), but in console. You can use it for scripting, automating or testing.</p>

<h2 id="poltergeist">Poltergeist</h2>

<p>Poltergeist is a Ruby wrapper for PhantomJS. Usually you write the code for PhantomJS on JavaScript, with Poltergeist you can run it on Ruby.</p>

<h2 id="capybara">Capybara</h2>

<p>Well, I’m pretty sure you know what it is. It’s a test framework. And it supports different web drivers like:</p>

<p><code class="language-plaintext highlighter-rouge">RackTest</code>  - web driver that does not support JavaScript, extremely fast, but deadly primitive; best solution for tests that don’t require any JavaScript execution</p>

<p><code class="language-plaintext highlighter-rouge">Selenium</code>  - the most popular web driver</p>

<p>Advantages:</p>

<ol>
  <li>Supports a lot of browsers (so you can run multiple test suites in different browsers)</li>
  <li>Super stable</li>
</ol>

<p>Disadvantages:</p>

<ol>
  <li>Requires X server to be installed on the machine that runs it (some cloud CI services just don’t have it)</li>
  <li>Opens a real browser that executes your test scenario, that slows your test suite.</li>
</ol>

<p><code class="language-plaintext highlighter-rouge">Capybara-webkit</code> - headless WebKit (does not run a browser), but still requires X server</p>

<p><code class="language-plaintext highlighter-rouge">Poltergeist</code> - see above, headless WebKit, <strong>does not require X server</strong>, so you can run it everywhere.</p>

<h1 id="asynchronous-javascript-code-in-your-tests">Asynchronous JavaScript code in your tests</h1>

<p>When you write integration tests sometimes you need to run asynchronous JavaScript in context of your page and get a response back to Ruby. Here is an example from my current project: the client part of our application supports offline mode, so we store the data in WebSQL and sync it with server once connection is restored. The API of WebSQL is asynchronous, so we have a result of execution in some provided callback:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// something like</span>
<span class="nx">WebSQLWrapper</span><span class="p">.</span><span class="nx">execute</span><span class="p">(</span><span class="dl">'</span><span class="s1">select 1</span><span class="dl">'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// result of execution becomes available after some time</span>
<span class="p">});</span>
</code></pre></div></div>

<p>We have integration tests with Capybara+Poltergeist+PhantomJS combo that tests the whole stack of interaction between a client-side application and a server API. And WebSQL should be flushed between tests or populated with startup data before some specific tests. We also have delayed operations on the client that runs periodically.</p>

<p>All these features require us to run JavaScript code manually in PhantomJS between/before tests.</p>

<h1 id="capybarapoltergeistphantomjs-installation">Capybara/Poltergeist/PhantomJS installation</h1>

<p>Quite simple:</p>
<ol>
  <li>PhantomJS: <code class="language-plaintext highlighter-rouge">sudo apt-get install phantomjs</code> or download binaries from the official site (you can even try 2.0 beta there).</li>
  <li>Capybara: <code class="language-plaintext highlighter-rouge">gem 'capybara'</code> and that’s it.</li>
  <li>Poltergeist: <code class="language-plaintext highlighter-rouge">gem 'poltergeist'</code>.</li>
</ol>

<p>Require both of them in your <code class="language-plaintext highlighter-rouge">spec_helper</code> and force Capybara to use Poltergeist as a web driver:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s1">'capybara/rails'</span>
<span class="nb">require</span> <span class="s1">'capybara/poltergeist'</span>

<span class="no">Capybara</span><span class="p">.</span><span class="nf">register_driver</span> <span class="ss">:poltergeist_debug</span> <span class="k">do</span> <span class="o">|</span><span class="n">app</span><span class="o">|</span>
  <span class="n">driver_options</span> <span class="o">=</span> <span class="p">{</span>
    <span class="ss">inspector: </span><span class="kp">true</span><span class="p">,</span>
    <span class="ss">timeout: </span><span class="mi">5</span><span class="p">,</span>
    <span class="ss">js_errors: </span><span class="kp">false</span><span class="p">,</span>
    <span class="ss">debug: </span><span class="kp">false</span><span class="p">,</span>
    <span class="ss">phantomjs_logger: </span><span class="no">Logger</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s1">'/dev/null'</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="no">ENV</span><span class="p">[</span><span class="s1">'DEBUG_PHANTOMJS'</span><span class="p">]</span>
    <span class="n">driver_options</span><span class="p">.</span><span class="nf">merge!</span><span class="p">({</span>
      <span class="ss">logger: </span><span class="no">Kernel</span><span class="p">,</span>
      <span class="ss">js_errors: </span><span class="kp">true</span><span class="p">,</span>
      <span class="ss">debug: </span><span class="kp">true</span><span class="p">,</span>
      <span class="ss">phantomjs_logger: </span><span class="no">File</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="no">Rails</span><span class="p">.</span><span class="nf">root</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="s1">'log/phantomjs.log'</span><span class="p">),</span> <span class="s1">'a'</span><span class="p">)</span>
    <span class="p">})</span>
  <span class="k">end</span>
  <span class="no">Capybara</span><span class="o">::</span><span class="no">Poltergeist</span><span class="o">::</span><span class="no">Driver</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">driver_options</span><span class="p">)</span>
<span class="k">end</span>

<span class="no">Capybara</span><span class="p">.</span><span class="nf">javascript_driver</span> <span class="o">=</span> <span class="ss">:poltergeist_debug</span>
<span class="no">Capybara</span><span class="p">.</span><span class="nf">default_driver</span> <span class="o">=</span> <span class="ss">:poltergeist_debug</span>
</code></pre></div></div>

<p>With this configuration Poltergeist does not print any noisy output, but you can enable it by passing <code class="language-plaintext highlighter-rouge">DEBUG_PHANTOMJS=true</code></p>

<h1 id="small-example">Small example</h1>

<p>Here is a simple of the code that returns it’s response asynchronously:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">alert</span><span class="p">(</span><span class="dl">'</span><span class="s1">Thanks for waiting 1 second</span><span class="dl">'</span><span class="p">);</span>
<span class="p">},</span> <span class="mi">1000</span><span class="p">);</span>
</code></pre></div></div>

<p>This code actually does nothing, but it’s a demonstration of how asynchronous stuff works.</p>

<h1 id="but-capybara-waits-for-my-ajax-requests">But… Capybara waits for my AJAX requests</h1>

<p>Yes, when you write something like:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">it</span> <span class="s1">'displays a message'</span> <span class="k">do</span>
  <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">).</span><span class="nf">to</span> <span class="n">have_text</span><span class="p">(</span><span class="s1">'Hey'</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div></div>

<p>and at the moment of running this expectation your page does not have this text <strong>but receives it a second later</strong> - the test will be green. Why?</p>

<p>Capybara has a setting called <code class="language-plaintext highlighter-rouge">default_wait_time</code> (was changed to <code class="language-plaintext highlighter-rouge">default_max_wait_time</code>, but is still acceptable) which is 2 seconds by default. <a href="https://github.com/jnicklas/capybara/blob/master/lib/capybara/node/base.rb#L76">Here is how Capybara uses it</a>.</p>

<p>It runs the code again and again, and stops if</p>

<ol>
  <li>It has a result of code execution - then it simple returns it</li>
  <li>The time has come (2 seconds) - then it raises an error</li>
</ol>

<p>(A little remark here. Capybara saves the time on the beginning of this method and on every iteration compares this time with <code class="language-plaintext highlighter-rouge">Time.now</code> - this is a very nice hack to save Capybara from wrapping API calls into <code class="language-plaintext highlighter-rouge">Timecop.freeze</code> - good job!)</p>

<h1 id="can-we-reuse-it">Can we reuse it?</h1>

<p>Yes, of course. Let’s simplify it a little bit:</p>
<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">module</span> <span class="nn">WaitHelper</span>
  <span class="kp">extend</span> <span class="nb">self</span>

  <span class="c1"># Calls provided +block+ every 100ms</span>
  <span class="c1">#   and stops when it returns false</span>
  <span class="c1">#</span>
  <span class="c1"># @param timeout [Fixnum]</span>
  <span class="c1"># @yield block for execution</span>
  <span class="c1">#</span>
  <span class="c1"># @example</span>
  <span class="c1">#   current_time = Time.now</span>
  <span class="c1">#   WaitHelper.wait_until(3) do</span>
  <span class="c1">#     Time.now - current_time &gt; 2</span>
  <span class="c1">#   end</span>
  <span class="c1">#</span>
  <span class="c1">#   # 2 seconds later ...</span>
  <span class="c1">#   # =&gt; true</span>
  <span class="c1">#</span>
  <span class="c1">#   current_time = Time.now</span>
  <span class="c1">#   WaitHelper.wait_until(3) do</span>
  <span class="c1">#     Time.now - current_time &gt; 10</span>
  <span class="c1">#   end</span>
  <span class="c1">#</span>
  <span class="c1">#   # 3 seconds later (after timeout)</span>
  <span class="c1">#   # =&gt; false</span>
  <span class="c1">#</span>
  <span class="k">def</span> <span class="nf">wait_until</span><span class="p">(</span><span class="n">timeout</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
    <span class="k">begin</span>
      <span class="no">Timeout</span><span class="p">.</span><span class="nf">timeout</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span> <span class="k">do</span>
        <span class="nb">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span> <span class="k">until</span> <span class="n">value</span> <span class="o">=</span> <span class="n">block</span><span class="p">.</span><span class="nf">call</span>
        <span class="n">value</span>
      <span class="k">end</span>
    <span class="k">rescue</span> <span class="no">TimeoutError</span>
      <span class="kp">false</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Alright, now let’s use it.</p>

<ol>
  <li>Modify JavaScript code to set result into some global variable (JavaScript function context, you know)</li>
  <li>Run the code that gets response in callback.</li>
  <li>Run the code that polls the response from global variable</li>
  <li>Wrap this code with <code class="language-plaintext highlighter-rouge">WaitHelper.wait_until(timeout) {}</code></li>
</ol>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">code_for_execution</span> <span class="o">=</span> <span class="o">&lt;&lt;-</span><span class="no">JS</span><span class="sh">
  setTimeout(function() {
    window.asyncResponse = 'some response';
  }, 1000)
</span><span class="no">JS</span>

<span class="n">code_for_polling</span> <span class="o">=</span> <span class="s1">'window.asyncResponse'</span>

<span class="no">Capybara</span><span class="p">.</span><span class="nf">current_session</span><span class="p">.</span><span class="nf">evaluate_script</span><span class="p">(</span><span class="n">code_for_execution</span><span class="p">)</span>
<span class="n">result</span> <span class="o">=</span> <span class="no">WaitHelper</span><span class="p">.</span><span class="nf">wait_until</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="k">do</span>
  <span class="no">Capybara</span><span class="p">.</span><span class="nf">current_session</span><span class="p">.</span><span class="nf">evaluate_script</span><span class="p">(</span><span class="n">code_for_polling</span><span class="p">)</span>
<span class="k">end</span>
<span class="nb">puts</span> <span class="n">result</span>
<span class="c1"># =&gt; 'some response'</span>
</code></pre></div></div>

<h1 id="can-we-organize-it-as-a-common-reusable-solution">Can we organize it as a common reusable solution?</h1>

<p>Why not. Here is a gem called <a href="https://github.com/iliabylich/capybara-async-runner"><code class="language-plaintext highlighter-rouge">capybara-async-runner</code></a>. And here is how to use it.</p>

<p>Installation:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Gemfile</span>
<span class="n">gem</span> <span class="s1">'capybara-async_runner'</span>
<span class="c1"># spec/spec_helper.rb</span>
<span class="nb">require</span> <span class="s1">'capybara/async_runner'</span>
</code></pre></div></div>

<p>First of all, I don’t like to mix JavaScript and Ruby code in a single file, so we need templates (like <code class="language-plaintext highlighter-rouge">.js.erb</code>).
You need to specify the directory with templates:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># spec/spec_helper.rb</span>
<span class="no">Capybara</span><span class="o">::</span><span class="no">AsyncRunner</span><span class="p">.</span><span class="nf">setup</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">commands_directory</span> <span class="o">=</span> <span class="no">Rails</span><span class="p">.</span><span class="nf">root</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="s1">'spec/fixtures/async_commands'</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Let’s write our first command</p>
<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">TestCommand</span> <span class="o">&lt;</span> <span class="no">Capybara</span><span class="o">::</span><span class="no">AsyncRunner</span><span class="o">::</span><span class="no">Command</span>
  <span class="c1"># global command name</span>
  <span class="nb">self</span><span class="p">.</span><span class="nf">command_name</span> <span class="o">=</span> <span class="ss">:test_command_name</span>

  <span class="c1"># .js.erb file in directory specified above</span>
  <span class="nb">self</span><span class="p">.</span><span class="nf">file_to_run</span> <span class="o">=</span> <span class="s1">'template'</span>

  <span class="n">response</span> <span class="ss">:parsed_json</span> <span class="k">do</span> <span class="o">|</span><span class="n">data</span><span class="o">|</span>
    <span class="no">JSON</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>This class follows the Command pattern, you can invoke it in the following way:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Capybara</span><span class="o">::</span><span class="no">AsyncRunner</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="ss">:test_command_name</span><span class="p">)</span>
<span class="c1"># or</span>
<span class="no">TestCommand</span><span class="p">.</span><span class="nf">new</span><span class="p">.</span><span class="nf">invoke</span>
</code></pre></div></div>

<p>Let’s create our template for this command:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// spec/fixtures/async_commands/template.js.erb</span>
<span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">json</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]);</span>
  <span class="o">&lt;%=</span> <span class="nx">parsed_json</span><span class="p">(</span><span class="nx">js</span><span class="p">[:</span><span class="nx">json</span><span class="p">])</span> <span class="o">%&gt;</span>
<span class="p">})</span>
</code></pre></div></div>

<p>There are few things that I need to explain:</p>

<ol>
  <li><code class="language-plaintext highlighter-rouge">parsed_json</code> - this is an output point from the script that was defined in the command class. When you call it in the template, it embeds some JavaScript that stores passed data into the global variable. <code class="language-plaintext highlighter-rouge">parsed_json(123)</code> produces something like <code class="language-plaintext highlighter-rouge">window.parsed_json_result = 123</code> (so we can can grab this response later from the second script)</li>
  <li><code class="language-plaintext highlighter-rouge">js</code> - this is a proxy method from the gem that acts like a Hash. The method <code class="language-plaintext highlighter-rouge">[]</code> on this Hash returns passed key (and the whole method <code class="language-plaintext highlighter-rouge">js</code> is kind of “JavaScript memory”). <code class="language-plaintext highlighter-rouge">&lt;%= parsed_json(js[:json]) %&gt;</code> produces <code class="language-plaintext highlighter-rouge">window.parsed_json_result = json</code> which is exactly what we need.</li>
  <li>When you call <code class="language-plaintext highlighter-rouge">Capybara::AsyncRunner.run(:test_command_name)</code>, the gem executes the script generated from your template in the context of <code class="language-plaintext highlighter-rouge">Capybara.current_session</code>. Then it subscribes to all defined responses (this is actually, the second script) and returns the first one that becomes defined (<code class="language-plaintext highlighter-rouge">window.parsed_json_result</code> in this case).</li>
  <li>The block that we have specified for <code class="language-plaintext highlighter-rouge">parsed_json</code> is like a handler for transforming data which it returns (we invoke <code class="language-plaintext highlighter-rouge">parsed_json</code> method with <code class="language-plaintext highlighter-rouge">json</code> variable which contains raw JSON, our handler parses it)</li>
</ol>

<p>If you are familiar with templates in Ruby, just quickly look at the <a href="https://github.com/iliabylich/capybara-async-runner/blob/master/lib/capybara/async_runner/env.rb">code</a>, this class is a context of rendering.</p>

<h1 id="wrapping-up">Wrapping up</h1>

<p>You need to follow these steps to create a command using a gem:</p>
<ol>
  <li>Specify the directory with templates in the gem configuration file</li>
  <li>Create a command class</li>
  <li>Specify its name</li>
  <li>Specify the name of template</li>
  <li>Create a template file</li>
  <li>Define a response(s)</li>
  <li>Call them in the template</li>
</ol>

<h1 id="passing-data-to-template">Passing data to template</h1>

<p>You can pass any data to the template:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">TestCommand</span> <span class="o">&lt;</span> <span class="no">Capybara</span><span class="o">::</span><span class="no">AsyncRunner</span><span class="o">::</span><span class="no">Command</span>
  <span class="nb">self</span><span class="p">.</span><span class="nf">command_name</span> <span class="o">=</span> <span class="ss">:test</span>
  <span class="nb">self</span><span class="p">.</span><span class="nf">template</span> <span class="o">=</span> <span class="s1">'template'</span>
  <span class="c1"># if you don't pass any block</span>
  <span class="c1"># it will return raw value</span>
  <span class="n">response</span> <span class="ss">:done</span>
<span class="k">end</span>

<span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
  <span class="ss">name: </span><span class="s1">'Ilya'</span>
<span class="p">}</span>
<span class="no">Capybara</span><span class="o">::</span><span class="no">AsyncRunner</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="ss">:test</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
<span class="c1"># =&gt; 'Ilya'</span>
</code></pre></div></div>

<p>And use it template:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">someLongRunningMethod</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// 'done' is a method that generates JavaScript</span>
  <span class="c1">// 'data' returns data that we've passed to 'run'</span>
  <span class="c1">// :name is a key in that Hash</span>
  <span class="o">&lt;%=</span> <span class="nx">done</span><span class="p">(</span><span class="nx">data</span><span class="p">[:</span><span class="nx">name</span><span class="p">])</span> <span class="o">%&gt;</span>
<span class="p">})</span>
</code></pre></div></div>

<h1 id="lets-write-something-complex">Let’s write something complex</h1>

<p>As I mentioned before, on my current project we use WebSQL, but it’s <a href="http://www.w3.org/TR/webdatabase/">deprecated</a>, so I’m not going to use it in examples. Instead let’s write a wrapper for IndexedDB.</p>

<p>First of all, we need a JavaScript wrapper, I don’t like the native IndexedDB API. First result from google = <a href="http://www.dexie.org/"><code class="language-plaintext highlighter-rouge">Dexie.js</code></a>.</p>

<p>Let’s plan our scenario:</p>
<ol>
  <li>Visit any page</li>
  <li>Inject <code class="language-plaintext highlighter-rouge">Dexie.js</code> into the page</li>
  <li>Create IndexedDB instance</li>
  <li>Write some data to the database</li>
  <li>Read them and print</li>
</ol>

<h2 id="visiting-the-page">Visiting the page</h2>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Capybara</span><span class="p">.</span><span class="nf">current_session</span><span class="p">.</span><span class="nf">visit</span><span class="p">(</span><span class="s1">'http://google.com'</span><span class="p">)</span>
</code></pre></div></div>

<h2 id="injecting-dexiejs-into-the-page">Injecting <code class="language-plaintext highlighter-rouge">Dexie.js</code> into the page</h2>

<ul>
  <li><a href="https://github.com/iliabylich/capybara-async-runner/blob/master/examples/indexeddb/commands/wrapper_loader.rb">Command</a></li>
  <li><a href="https://github.com/iliabylich/capybara-async-runner/blob/master/examples/indexeddb/templates/wrapper/inject.js.erb">Template</a></li>
</ul>

<p>How to invoke:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">module</span> <span class="nn">IndexedDB</span>
  <span class="no">URL</span> <span class="o">=</span> <span class="s1">'http://www.url.to.dexie.js.source'</span>
<span class="k">end</span>

<span class="no">Capybara</span><span class="o">::</span><span class="no">AsyncRunner</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="s1">'indexeddb:wrapper:inject'</span><span class="p">,</span> <span class="ss">url: </span><span class="no">IndexedDB</span><span class="o">::</span><span class="no">URL</span><span class="p">)</span>
</code></pre></div></div>

<p>Explanation:</p>

<ol>
  <li>JavaScript code detects whether the library has already been loaded</li>
  <li>If not - appends <code class="language-plaintext highlighter-rouge">&lt;script&gt;</code> tag to the <code class="language-plaintext highlighter-rouge">&lt;head&gt;</code></li>
  <li>If yes - returns ‘success’</li>
  <li>If 3 seconds passed and we still have no library code - returns ‘error’</li>
</ol>

<p>The command raises an exception if response is <code class="language-plaintext highlighter-rouge">error</code>.</p>

<p>All this manipulations are synchronous for Ruby. The end of running the command means that we can continue execution.</p>

<p>Moreover, this command is safe, we can call it multiple times and it will inject the script into the page only once.</p>

<h2 id="create-indexeddb-instance">Create IndexedDB instance</h2>

<ul>
  <li><a href="https://github.com/iliabylich/capybara-async-runner/blob/master/examples/indexeddb/commands/wrapper_initializer.rb">Command</a></li>
  <li><a href="https://github.com/iliabylich/capybara-async-runner/blob/master/examples/indexeddb/templates/wrapper/initialize.js.erb">Template</a></li>
</ul>

<p>How to invoke:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Capybara</span><span class="o">::</span><span class="no">AsyncRunner</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="s1">'indexeddb:wrapper:initialize'</span><span class="p">)</span>
</code></pre></div></div>

<p>Explanation:</p>

<ol>
  <li>JavaScript opens the database using <code class="language-plaintext highlighter-rouge">Dexie.js</code></li>
  <li>If <code class="language-plaintext highlighter-rouge">callback</code> was called, returns <code class="language-plaintext highlighter-rouge">sucess</code></li>
  <li>If <code class="language-plaintext highlighter-rouge">errback</code> was called, returns <code class="language-plaintext highlighter-rouge">error</code> with error message</li>
  <li>Ruby command raises error if <code class="language-plaintext highlighter-rouge">error</code> was returned</li>
</ol>

<h2 id="write-some-data-to-the-database">Write some data to the database</h2>

<ul>
  <li><a href="https://github.com/iliabylich/capybara-async-runner/blob/master/examples/indexeddb/commands/insert.rb">Command</a></li>
  <li><a href="https://github.com/iliabylich/capybara-async-runner/blob/master/examples/indexeddb/templates/commands/insert.js.erb">Template</a></li>
</ul>

<p>How to invoke:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">user_data</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">name: </span><span class="s1">'Some Name'</span> <span class="p">}</span>

<span class="n">user_id</span> <span class="o">=</span> <span class="no">Capybara</span><span class="o">::</span><span class="no">AsyncRunner</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="s1">'indexeddb:insert'</span><span class="p">,</span> <span class="ss">store: </span><span class="s1">'users'</span><span class="p">,</span> <span class="ss">data: </span><span class="n">user_data</span><span class="p">)</span>
<span class="nb">p</span> <span class="s2">"User ID: </span><span class="si">#{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">"</span>
</code></pre></div></div>

<p>This step is quite simple if you understand the previous one.</p>

<h2 id="reading-data">Reading data</h2>

<ul>
  <li><a href="https://github.com/iliabylich/capybara-async-runner/blob/master/examples/indexeddb/commands/query.rb">Command</a></li>
  <li><a href="https://github.com/iliabylich/capybara-async-runner/blob/master/examples/indexeddb/templates/commands/query.js.erb">Template</a></li>
</ul>

<p>How to invoke:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">methods</span> <span class="o">=</span> <span class="p">[</span>
  <span class="p">{</span> <span class="ss">method: </span><span class="s1">'where'</span><span class="p">,</span> <span class="ss">arguments: </span><span class="p">[</span><span class="s1">'id'</span><span class="p">]},</span>
  <span class="p">{</span> <span class="ss">method: </span><span class="s1">'equals'</span><span class="p">,</span> <span class="ss">arguments: </span><span class="p">[</span><span class="n">user_id</span><span class="p">]</span> <span class="p">},</span>
  <span class="p">{</span> <span class="ss">method: </span><span class="s1">'toArray'</span><span class="p">,</span> <span class="ss">arguments: </span><span class="p">[]</span> <span class="p">}</span>
<span class="p">]</span>

<span class="nb">p</span> <span class="no">Capybara</span><span class="o">::</span><span class="no">AsyncRunner</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="s1">'indexeddb:query'</span><span class="p">,</span> <span class="ss">store: </span><span class="s1">'users'</span><span class="p">,</span> <span class="ss">methods: </span><span class="nb">methods</span><span class="p">)</span>
</code></pre></div></div>

<p>Here we pass an array of methods and their arguments to template, iterate over them and build a <code class="language-plaintext highlighter-rouge">Dexie.js</code> scope (just like <code class="language-plaintext highlighter-rouge">ActiveRecord::Relation</code>), and return a result back to ruby command.</p>

<p>After wrapping it even more we can get interface like <a href="https://github.com/iliabylich/capybara-async-runner/blob/master/examples/indexeddb/indexdb.rb#L133">this</a></p>

<p>Full example can be found <a href="https://github.com/iliabylich/capybara-async-runner/tree/master/examples/indexeddb">here</a></p>

<h1 id="conclusion">Conclusion</h1>

<p>I would say the topic of this article is not so popular. Single page applications that work in offline mode (and because of this, use WebSQL/IndexedDB/some other asynchronous storage, probably) are still not frequent today. Usually when you build an SPA, you just write your tests using Jasmine or something like that. You mock your requests to the server API and test your client in some isolated environment. But these tests are still functional (you verify a single component - client, in this case - but not the whole application).</p>

<p>Someday working on a rich client-side application, remember about the idea of this post. You can control the logical flow of your client-server communication in integration tests, and this is good. Wrap your client code, build a micro-framework on top of this gem and test every piece of your code.</p>

</div>


  <div class="comments">
    <div id="disqus_thread"></div>
    <script>
        var disqus_config = function () {
          this.page.url = document.location.href;  // Replace PAGE_URL with your page's canonical URL variable
          this.page.identifier = document.location.pathname; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
        };
        (function() { // DON'T EDIT BELOW THIS LINE
          var d = document, s = d.createElement('script');
          s.src = 'https://ibylich-myblog.disqus.com/embed.js';
          s.setAttribute('data-timestamp', +new Date());
          (d.head || d.body).appendChild(s);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>


<div class="related">
  <h2>Related Posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/2021/12/27/writing-bindings-upside-down.html">
            Writing bindings upside down
            <small>27 Dec 2021</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2020/11/22/lib-ruby-parser.html">
            lib-ruby-parser
            <small>22 Nov 2020</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2020/01/25/evaluating-ruby-in-ruby.html">
            Evaluating Ruby in Ruby
            <small>25 Jan 2020</small>
          </a>
        </h3>
      </li>
    
  </ul>
</div>

    </div>
  </body>
</html>
