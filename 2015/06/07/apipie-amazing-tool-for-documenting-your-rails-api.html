<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Apipie - amazing tool for documenting your Rails API &middot; Ilya Bylich
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/hyde.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="192x192" href="/public/apple-touch-icon-192-precomposed.png">
                                 <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/feed.xml">

  <script async src="https://www.googletagmanager.com/gtag/js?id=G-EBV7BR668S"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-EBV7BR668S');
</script>

</head>


  <body class="theme-base-0b">

    <div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <h1>
        <a href="/">
          Ilya Bylich
        </a>
      </h1>
      <p class="lead">I'm a Ruby/Rust developer, sometimes I write long technical stories</p>
    </div>

    <nav class="sidebar-nav">
      <a class="sidebar-nav-item" href="/">Home</a>

      

      <a class="sidebar-nav-item" href="https://github.com/iliabylich">GitHub</a>
      <a class="sidebar-nav-item" href="https://twitter.com/IlyaBylich">Twitter</a>
      <a class="sidebar-nav-item" href="mailto:ibylich@gmail.com">Email me</a>
      <a class="sidebar-nav-item" href="https://iliabylich.github.io/feed.xml">RSS</a>

      <span class="sidebar-nav-item">
  <label for="current-theme">Theme</label>
  <select id="current-theme">
    <option>08</option>
    <option>09</option>
    <option>0a</option>
    <option>0b</option>
    <option>0c</option>
    <option>0d</option>
    <option>0f</option>
  </select>

  <script type="text/javascript">
    class Theme {
      static DEFAULT = "0b";

      static getCurrent() {
        return localStorage.getItem("current-theme") || Theme.DEFAULT;
      }

      static setCurrent(theme) {
        localStorage.setItem("current-theme", theme);
        document.body.className = `theme-base-${theme}`;
      }
    }

    const themeSelector = document.getElementById("current-theme");
    Theme.setCurrent(Theme.getCurrent());
    themeSelector.value = Theme.getCurrent();

    themeSelector.onchange = (e) => {
      const theme = e.target.value;
      Theme.setCurrent(theme);
    }
  </script>
</span>

    </nav>

    <p>&copy; 2024. All rights reserved.</p>
  </div>
</div>


    <div class="content container">
      <div class="post">
  <h1 class="post-title">Apipie - amazing tool for documenting your Rails API</h1>
  <span class="post-date">07 Jun 2015</span>

  <div class="reading-time" title="Estimated read time">
  This article will take 8 minutes to read
  <br />
  (or maybe less, the algorithm treats code as text)
</div>


  <div id="table-of-contents">
    <ul id="toc" class="section-nav">
<li class="toc-entry toc-h1"><a href="#features">Features</a>
<ul>
<li class="toc-entry toc-h2"><a href="#gathering-information-from-your-routes">Gathering information from your routes</a></li>
<li class="toc-entry toc-h2"><a href="#api-versioning">API versioning</a></li>
<li class="toc-entry toc-h2"><a href="#parameters-typing">Parameters typing</a></li>
<li class="toc-entry toc-h2"><a href="#parameters-validation">Parameters validation</a></li>
<li class="toc-entry toc-h2"><a href="#concerns">Concerns</a></li>
<li class="toc-entry toc-h2"><a href="#specs-recording">Specs recording</a></li>
<li class="toc-entry toc-h2"><a href="#other-features">Other features</a></li>
</ul>
</li>
<li class="toc-entry toc-h1"><a href="#customization">Customization</a>
<ul>
<li class="toc-entry toc-h2"><a href="#extracting-docs-to-mixins">Extracting docs to mixins</a></li>
<li class="toc-entry toc-h2"><a href="#the-power-of-ruby-based-doc">The power of ruby-based doc</a></li>
<li class="toc-entry toc-h2"><a href="#ability-to-define-default-documentation-for-all-actions-in-resource">Ability to define default documentation for all actions in resource</a></li>
</ul>
</li>
<li class="toc-entry toc-h1"><a href="#demo">Demo</a></li>
<li class="toc-entry toc-h1"><a href="#conclusion">Conclusion</a></li>
</ul>
  </div>

  <p>This article is about <a href="https://github.com/Apipie/apipie-rails">Apipie gem</a> which provides a DSL for documenting your API. I will try to cover features that I personally use on my project.</p>

<p>Comparing to other tools for generating API documentation (<code class="language-plaintext highlighter-rouge">yardoc</code>, <code class="language-plaintext highlighter-rouge">sdoc</code>) I would say that the main thing that you gain with Apipie is that your documentation is a real ruby code, so you can write computations, concerns etc.</p>

<p>Here is a simple example of how it looks in code:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="n">resource_description</span> <span class="k">do</span>
    <span class="n">formats</span> <span class="p">[</span><span class="ss">:json</span><span class="p">]</span>
    <span class="n">api_versions</span> <span class="s1">'public'</span>
  <span class="k">end</span>

  <span class="n">api</span> <span class="ss">:POST</span><span class="p">,</span> <span class="s1">'/users'</span> <span class="s1">'Create user'</span>
  <span class="n">description</span> <span class="s1">'Create user with specifed user params'</span>
  <span class="n">param</span> <span class="ss">:user</span><span class="p">,</span> <span class="no">Hash</span><span class="p">,</span> <span class="ss">desc: </span><span class="s1">'User information'</span> <span class="k">do</span>
    <span class="n">param</span> <span class="ss">:full_name</span><span class="p">,</span> <span class="no">String</span><span class="p">,</span> <span class="ss">desc: </span><span class="s1">'Full name of the user'</span>
    <span class="n">param</span> <span class="ss">:age</span><span class="p">,</span> <span class="no">Fixnum</span><span class="p">,</span> <span class="ss">desc: </span><span class="s1">'Age of the user'</span>
  <span class="k">end</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="c1"># Some application code</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>So, you invoke a DSL from Apipie before your action method and it automatically comes to generated docs.</p>

<h1 id="features">Features</h1>

<h2 id="gathering-information-from-your-routes">Gathering information from your routes</h2>

<p>In the example above we have passed an HTTP verb and a path of this action. We don’t have to do it! Instead, we can simply write:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">api!</span> <span class="s1">'Some description'</span>
<span class="c1"># other docs here...</span>
<span class="k">def</span> <span class="nf">create</span>
<span class="k">end</span>
</code></pre></div></div>

<p>It automatically takes information from your routes that look like</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">resources</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">only: </span><span class="p">[</span><span class="ss">:create</span><span class="p">]</span>
</code></pre></div></div>

<h2 id="api-versioning">API versioning</h2>

<p>You can pass versions of your API that include this endpoint on</p>
<ol>
  <li>resource level (as in example)</li>
  <li>action level (in pretty much the same way, <code class="language-plaintext highlighter-rouge">api_versions ...</code></li>
</ol>

<h2 id="parameters-typing">Parameters typing</h2>

<p>As you can see, in the first example we had 3 types:</p>
<ol>
  <li><code class="language-plaintext highlighter-rouge">Hash</code></li>
  <li><code class="language-plaintext highlighter-rouge">Array</code></li>
  <li><code class="language-plaintext highlighter-rouge">Fixnum</code></li>
</ol>

<p>Apipie has also:</p>
<ol>
  <li><code class="language-plaintext highlighter-rouge">Enum</code></li>
  <li><code class="language-plaintext highlighter-rouge">Regexp</code></li>
</ol>

<h2 id="parameters-validation">Parameters validation</h2>

<p>We have already typed parameters, so why do we ignore it and write custom <code class="language-plaintext highlighter-rouge">before_action</code>-s for validating parameters manually? This feature is enabled by default, but if you don’t think that it’s a good idea to validate your parameters through documenting tool, just pass</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">config</span><span class="p">.</span><span class="nf">validate</span> <span class="o">=</span> <span class="kp">false</span>
</code></pre></div></div>

<p>The creator of the gem told me that ‘People either love it or don’t understand why it’s even there’, so it’s up to you to decide if you need it.</p>

<h2 id="concerns">Concerns</h2>

<p>I would say that it does not work as people usually expect.</p>

<p><code class="language-plaintext highlighter-rouge">Apipie::DSL::Concern</code> allows you to document actions that are defined in concerns.</p>

<p><a href="https://github.com/Apipie/apipie-rails#concerns">A quick example</a></p>

<p>Usually people think that it allows you to extract documentation from your controller in order to not mix code with documentation and application logic. And, to be honest, I think so too. The workaround for doing this goes below in the sections ‘Extracting docs to mixins’</p>

<h2 id="specs-recording">Specs recording</h2>

<p>Are you tired of writing examples manually? Me too :) With Apipie you can record request/response pairs to separated YAML file and display them in generated HTML. Pass <code class="language-plaintext highlighter-rouge">:show_in_doc</code> to metadata of your RSpec example and enjoy. Apipie embeds a module for recording requests to `    ActionController::TestCase::Behavior<code class="language-plaintext highlighter-rouge"> which is the core of all requests specs for RSpec and Minitest (yes, both of them delegate performing requests internally to </code>ActionController::TestCase::Behavior` - <a href="https://github.com/rspec/rspec-rails/blob/master/lib/rspec/rails/example/controller_example_group.rb#L12">source</a>).</p>

<h2 id="other-features">Other features</h2>
<p>There is a plenty of other things in Apipie that are very cool, by I did not have a chance to use it yet.</p>

<ol>
  <li>Localization. Currently it supports English, Russian, Chinese and Brazilian. If you want to add support for your language, use this as an example - <a href="https://github.com/Apipie/apipie-rails/blob/master/config/locales/en.yml">source</a></li>
  <li>Disqus integration. This is extremely useful when you have a decentralized team. If you have any questions - just leave a comment and wait for response! No need to define any models for storing users/comments/relations, everything is in the cloud.</li>
  <li>Custom markup processors. Not sure that anyone can need it, default markup processor looks very stable.</li>
</ol>

<h1 id="customization">Customization</h1>

<p>Some of these items can be difficult to explain, if you have any questions after reading it, just google it, answers for all of them should be in ruby docs (or ping me if you still don’t get it).</p>

<h2 id="extracting-docs-to-mixins">Extracting docs to mixins</h2>

<p>This is the main question I have got after reading official README. I don’t want to mix documentation and application logic. First of all we need to understand how exactly Apipie builds mapping between action names and compiled DSL. Even without reading source code the only guess that we may have is <code class="language-plaintext highlighter-rouge">method_added</code> hook. Every time when you define a method (on instance or on class, it does not matter), Ruby automatically fires <code class="language-plaintext highlighter-rouge">method_added</code> method on your class.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">TestClass</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">method_added</span><span class="p">(</span><span class="n">method_name</span><span class="p">)</span>
    <span class="nb">puts</span> <span class="s2">"Added method </span><span class="si">#{</span><span class="n">method_name</span><span class="si">}</span><span class="s2">"</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">method1</span><span class="p">;</span> <span class="k">end</span>
  <span class="k">def</span> <span class="nf">method2</span><span class="p">;</span> <span class="k">end</span>
<span class="k">end</span>
<span class="c1"># =&gt; Added method method1</span>
<span class="c1"># =&gt; Added method method2</span>
</code></pre></div></div>

<p>So, the algorithm is like this:</p>
<ol>
  <li>You invoke method <code class="language-plaintext highlighter-rouge">api</code> (or <code class="language-plaintext highlighter-rouge">api!</code>)</li>
  <li>Apipie internally saves action name (let’s say, as <code class="language-plaintext highlighter-rouge">Apipie.current_action_name</code>) and arguments (in <code class="language-plaintext highlighter-rouge">Apipie.current_action_data</code>, for example)</li>
  <li>You invoke other DSL methods</li>
  <li>Apipie appends this data to <code class="language-plaintext highlighter-rouge">Apipie.current_action_data</code></li>
  <li>You define a method (action in our case)</li>
  <li>Apipie adds mapping <code class="language-plaintext highlighter-rouge">Apipie.current_action_name =&gt; Apipie.current_action_data</code> to a global Hash like <code class="language-plaintext highlighter-rouge">Apipie.all_docs</code></li>
  <li>When you visit <code class="language-plaintext highlighter-rouge">/docs</code>, Apipie displays all data from <code class="language-plaintext highlighter-rouge">Apipie.all_docs</code></li>
</ol>

<p>And if it’s true we can write something like:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># app/docs/users_doc.rb</span>
<span class="k">module</span> <span class="nn">UsersDoc</span>
  <span class="c1"># we need the DSL, right?</span>
  <span class="kp">extend</span> <span class="no">Apipie</span><span class="o">::</span><span class="no">DSL</span><span class="o">::</span><span class="no">Concern</span>

  <span class="n">api</span> <span class="ss">:GET</span><span class="p">,</span> <span class="s1">'/users'</span><span class="p">,</span> <span class="s1">'List users'</span>
  <span class="k">def</span> <span class="nf">show</span>
    <span class="c1"># Nothing here, it's just a stub</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="c1"># app/controller/users_controller.rb</span>
<span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="kp">include</span> <span class="no">UsersDoc</span>

  <span class="k">def</span> <span class="nf">show</span>
    <span class="c1"># Application code goes here</span>
    <span class="c1"># and it overrides blank method</span>
    <span class="c1"># from the module</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>And yes, it works! Let’s add resource description</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">module</span> <span class="nn">UsersDoc</span>
  <span class="kp">extend</span> <span class="no">Apipie</span><span class="o">::</span><span class="no">DSL</span><span class="o">::</span><span class="no">Concern</span>

  <span class="n">resource_description</span> <span class="k">do</span>
    <span class="n">formats</span> <span class="p">[</span><span class="ss">:json</span><span class="p">]</span>
    <span class="n">api_versions</span> <span class="s1">'public'</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Which breaks it…</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Apipie: Can not resolve resource UsersDoc name.
</code></pre></div></div>

<p>Yes, because our resource is <code class="language-plaintext highlighter-rouge">UsersController</code>. The error happens in the following lines in Apipie source code:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">def</span> <span class="nf">get_resource_name</span><span class="p">(</span><span class="n">klass</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">klass</span><span class="p">.</span><span class="nf">class</span> <span class="o">==</span> <span class="no">String</span>
        <span class="n">klass</span>
      <span class="k">elsif</span> <span class="vi">@controller_to_resource_id</span><span class="p">.</span><span class="nf">has_key?</span><span class="p">(</span><span class="n">klass</span><span class="p">)</span>
        <span class="vi">@controller_to_resource_id</span><span class="p">[</span><span class="n">klass</span><span class="p">]</span>
      <span class="k">elsif</span> <span class="no">Apipie</span><span class="p">.</span><span class="nf">configuration</span><span class="p">.</span><span class="nf">namespaced_resources?</span> <span class="o">&amp;&amp;</span> <span class="n">klass</span><span class="p">.</span><span class="nf">respond_to?</span><span class="p">(</span><span class="ss">:controller_path</span><span class="p">)</span>
        <span class="k">return</span> <span class="kp">nil</span> <span class="k">if</span> <span class="n">klass</span> <span class="o">==</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">Base</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">klass</span><span class="p">.</span><span class="nf">controller_path</span>
        <span class="n">path</span><span class="p">.</span><span class="nf">gsub</span><span class="p">(</span><span class="n">version_prefix</span><span class="p">(</span><span class="n">klass</span><span class="p">),</span> <span class="s2">""</span><span class="p">).</span><span class="nf">gsub</span><span class="p">(</span><span class="s2">"/"</span><span class="p">,</span> <span class="s2">"-"</span><span class="p">)</span>
      <span class="k">elsif</span> <span class="n">klass</span><span class="p">.</span><span class="nf">respond_to?</span><span class="p">(</span><span class="ss">:controller_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="kp">nil</span> <span class="k">if</span> <span class="n">klass</span> <span class="o">==</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">Base</span>
        <span class="n">klass</span><span class="p">.</span><span class="nf">controller_name</span>
      <span class="k">else</span>
        <span class="k">raise</span> <span class="s2">"Apipie: Can not resolve resource </span><span class="si">#{</span><span class="n">klass</span><span class="si">}</span><span class="s2"> name."</span>
      <span class="k">end</span>
    <span class="k">end</span>
</code></pre></div></div>

<p>Most of this code does not really matter, the thing is that Apipie does not know what to do with module <code class="language-plaintext highlighter-rouge">UsersDoc</code>. It has no <code class="language-plaintext highlighter-rouge">resource_id</code>, let’s define it.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">resource_description</span> <span class="k">do</span>
  <span class="n">resource_id</span> <span class="s1">'Users'</span>
  <span class="c1"># other dsl</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Now we get an error</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">undefined</span> <span class="nb">method</span> <span class="sb">`superclass' for UsersDoc:Module
</span></code></pre></div></div>

<p>But… Module (I mean, an instance of Module class) can’t have a parent class. It’s a module!</p>

<p>Forget that you are a ruby developer and define a method called <code class="language-plaintext highlighter-rouge">superclass</code> on your module :)</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># before calling DSL</span>
<span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">superclass</span>
  <span class="no">UsersController</span>
<span class="k">end</span>
</code></pre></div></div>

<p>So, from this moment</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">UsersDoc</span><span class="p">.</span><span class="nf">superclass</span> <span class="o">==</span> <span class="no">UsersController</span>
<span class="c1"># =&gt; true</span>
</code></pre></div></div>

<p>Refresh the page with documentation and see that it finally works!
Here is a gist with a full code that wraps ugly code and blank methods:
<a href="https://gist.github.com/iliabylich/c8032b193405673062e7">full gist</a></p>

<h2 id="the-power-of-ruby-based-doc">The power of ruby-based doc</h2>

<p>Imagine the following scenario:</p>

<p>I have two versions of API. When I was young and stupid, I implemented the first one (<code class="language-plaintext highlighter-rouge">v1</code>). And it has an authentication by plain username and password (in headers). Few years later something changed in my mind and I created another one (<code class="language-plaintext highlighter-rouge">v2</code>) which has token-based authentication.</p>

<p>First API contains 100 actions in 10 controllers, so does the second one, too. To make a documentation I have to copy-paste 2 lines of code 200 times (to put it for every action) or 20 times (to put it to every resource).</p>

<p>Instead of repeated copying the real description of authentication mechanism it would be really nice to have something like</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># for Api::V1</span>
<span class="n">auth_with</span> <span class="ss">:password</span>
<span class="c1"># for Api::V2</span>
<span class="n">auth_with</span> <span class="ss">:token</span>
</code></pre></div></div>

<p>And describe authentication in a more declarative way. In order to make it we need to add our own method to DSL. Here is what it may look like:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">module</span> <span class="nn">BaseDoc</span>
  <span class="c1"># ... code from the gist</span>

  <span class="no">AUTH_METHODS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="ss">password: </span><span class="no">Api</span><span class="o">::</span><span class="no">Auth</span><span class="o">::</span><span class="no">PasswordDoc</span><span class="p">,</span>
    <span class="ss">token: </span><span class="no">Api</span><span class="o">::</span><span class="no">Auth</span><span class="o">::</span><span class="no">TokenDoc</span>
  <span class="p">}</span>

  <span class="k">def</span> <span class="nf">auth_with</span><span class="p">(</span><span class="n">auth_method</span><span class="p">)</span>
    <span class="n">mod</span> <span class="o">=</span> <span class="no">AUTH_METHODS</span><span class="p">[</span><span class="n">auth_method</span><span class="p">]</span> <span class="ow">or</span>
      <span class="k">raise</span> <span class="s2">"Unknown auth strategy </span><span class="si">#{</span><span class="n">auth_method</span><span class="si">}</span><span class="s2">"</span>
    <span class="nb">send</span><span class="p">(</span><span class="ss">:include</span><span class="p">,</span> <span class="n">mod</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="c1"># app/docs/api/auth/password_doc.rb</span>
<span class="k">module</span> <span class="nn">Api::Auth::PasswordDoc</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">included</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
    <span class="n">base</span><span class="p">.</span><span class="nf">instance_eval</span> <span class="k">do</span>
      <span class="c1"># documentation of password-</span>
      <span class="c1">#  based authentication</span>
      <span class="n">header</span> <span class="ss">:username</span><span class="p">,</span> <span class="ss">required: </span><span class="kp">true</span>
      <span class="n">header</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">required: </span><span class="kp">true</span>
      <span class="n">error</span> <span class="ss">code: </span><span class="mi">401</span><span class="p">,</span> <span class="ss">desc: </span><span class="s1">'Unauthorized'</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="c1"># app/docs/api/auth/token_doc.rb</span>
<span class="k">module</span> <span class="nn">Api::Auth::TokenDoc</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">included</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
    <span class="n">base</span><span class="p">.</span><span class="nf">instance_eval</span> <span class="k">do</span>
      <span class="c1"># documentation of token-</span>
      <span class="c1">#  based authentication</span>
      <span class="n">header</span> <span class="s1">'Token'</span><span class="p">,</span> <span class="s1">'Your API token'</span>
      <span class="n">error</span> <span class="ss">code: </span><span class="mi">401</span><span class="p">,</span> <span class="ss">desc: </span><span class="s1">'Token is requried'</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>And from now we can write</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">module</span> <span class="nn">Api::V1::UsersDoc</span>
  <span class="kp">extend</span> <span class="no">BaseDoc</span>

  <span class="n">doc_for</span> <span class="ss">:show</span> <span class="k">do</span>
    <span class="n">auth_with</span> <span class="ss">:password</span>
    <span class="c1"># or</span>
    <span class="c1"># auth_with :token</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<h2 id="ability-to-define-default-documentation-for-all-actions-in-resource">Ability to define default documentation for all actions in resource</h2>

<p>So, we have a <code class="language-plaintext highlighter-rouge">resource_description</code> and <code class="language-plaintext highlighter-rouge">api</code> methods, but how can we define common parts for all of our actions? I hate copy-paste driven development, let’s write a DSL for this.</p>

<p>We want to have a <code class="language-plaintext highlighter-rouge">defaults</code> method which takes a block and executes it for each action.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">module</span> <span class="nn">BaseDoc</span>
  <span class="c1"># ...</span>

  <span class="k">def</span> <span class="nf">defaults</span><span class="p">(</span><span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
    <span class="vi">@defaults</span> <span class="o">=</span> <span class="n">block</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">doc_for</span><span class="p">(</span><span class="n">action_name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
    <span class="nb">instance_eval</span><span class="p">(</span><span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
    <span class="c1"># Only the next line added</span>
    <span class="nb">instance_eval</span><span class="p">(</span><span class="o">&amp;</span><span class="vi">@defaults</span><span class="p">)</span> <span class="k">if</span> <span class="vi">@defaults</span>
    <span class="n">api_version</span> <span class="n">namespace_name</span> <span class="k">if</span> <span class="n">namespace_name</span>
    <span class="n">define_method</span><span class="p">(</span><span class="n">action_name</span><span class="p">)</span> <span class="k">do</span>
      <span class="c1"># ... define it in your controller with the real code</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>So, we just store passed block and invoke it. This example is much simpler then the previous one.</p>

<h1 id="demo">Demo</h1>

<p><a href="https://github.com/iliabylich/apipie-demo">URL</a></p>

<p>You can click by statically generated docs (thanks to GitHub pages):</p>

<ul>
  <li><a href="http://iliabylich.github.io/apipie-demo/doc/apidoc/private_v1.html"><code class="language-plaintext highlighter-rouge">Private::V1</code></a></li>
  <li><a href="http://iliabylich.github.io/apipie-demo/doc/apidoc/private_v2.html"><code class="language-plaintext highlighter-rouge">Private::V2</code></a></li>
  <li><a href="http://iliabylich.github.io/apipie-demo/doc/apidoc/public.html"><code class="language-plaintext highlighter-rouge">Public</code></a></li>
</ul>

<h1 id="conclusion">Conclusion</h1>

<p>Apipie is an amazing library and its most significant advantage is that you document ruby using ruby (being a ruby developer), which gives you ability to define custom behaviors and scenarios. I can’t even imagine myself writing API docs using <code class="language-plaintext highlighter-rouge">yardoc</code> (however, I use it to document plain ruby classes).</p>

<p>If you have any bugs (or ideas to implement), please, <a href="https://github.com/Apipie/apipie-rails/issues">create an issue on GitHub</a>, let’s make it even better!</p>

</div>

<div class="related">
  <h2>Related Posts</h2>
  <ul class="related-posts">
    
    <li>
      <h3>
        <a href="/2021/12/27/writing-bindings-upside-down.html">
          Writing bindings upside down
          <small>27 Dec 2021</small>
        </a>
      </h3>
    </li>
    
    <li>
      <h3>
        <a href="/2020/11/22/lib-ruby-parser.html">
          lib-ruby-parser
          <small>22 Nov 2020</small>
        </a>
      </h3>
    </li>
    
    <li>
      <h3>
        <a href="/2020/01/25/evaluating-ruby-in-ruby.html">
          Evaluating Ruby in Ruby
          <small>25 Jan 2020</small>
        </a>
      </h3>
    </li>
    
  </ul>
</div>


<iframe src="https://commentary.ilyabylich.me/commentary/index?post_id=apipie-amazing-tool-for-documenting-your-rails-api" frameborder="0" scrolling="no"
  width="100%">
</iframe>

<script type="text/javascript">
  window.addEventListener("message", ({ data }) => {
    if (data.type === "resize") {
      document.querySelector("iframe").style.height = `${data.height}px`;
    }
  })
</script>

    </div>
  </body>
</html>
