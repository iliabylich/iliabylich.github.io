<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Redis cluster. Quick overview &middot; Ilya Bylich
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/hyde.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="192x192" href="/public/apple-touch-icon-192-precomposed.png">
                                 <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
</head>


  <body class="theme-base-0b">

    <div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <h1>
        <a href="/">
          Ilya Bylich
        </a>
      </h1>
      <p class="lead">I'm a Ruby/Rust developer, sometimes I write long technical stories</p>
    </div>

    <nav class="sidebar-nav">
      <a class="sidebar-nav-item" href="/">Home</a>

      

      <a class="sidebar-nav-item" href="https://github.com/iliabylich">GitHub</a>
      <a class="sidebar-nav-item" href="https://twitter.com/IlyaBylich">Twitter</a>
      <a class="sidebar-nav-item" href="mailto:ibylich@gmail.com">Email me</a>

      <span class="sidebar-nav-item">
  <label for="current-theme">Theme</label>
  <select id="current-theme">
    <option>08</option>
    <option>09</option>
    <option>0a</option>
    <option>0b</option>
    <option>0c</option>
    <option>0d</option>
    <option>0f</option>
  </select>

  <script type="text/javascript">
    class Theme {
      static DEFAULT = "0b";

      static getCurrent() {
        return localStorage.getItem("current-theme") || Theme.DEFAULT;
      }

      static setCurrent(theme) {
        localStorage.setItem("current-theme", theme);
        document.body.className = `theme-base-${theme}`;
      }
    }

    const themeSelector = document.getElementById("current-theme");
    Theme.setCurrent(Theme.getCurrent());
    themeSelector.value = Theme.getCurrent();

    themeSelector.onchange = (e) => {
      const theme = e.target.value;
      Theme.setCurrent(theme);
    }
  </script>
</span>

    </nav>

    <p>&copy; 2022. All rights reserved.</p>
  </div>
</div>


    <div class="content container">
      <div class="post">
  <h1 class="post-title">Redis cluster. Quick overview</h1>
  <span class="post-date">12 Apr 2015</span>

  <div class="reading-time" title="Estimated read time">
  This article will take 6 minutes to read
  <br />
  (or maybe less, the algorithm treats code as text)
</div>


  <div id="table-of-contents">
    <ul id="toc" class="section-nav">
<li class="toc-entry toc-h1"><a href="#setup">Setup</a></li>
<li class="toc-entry toc-h1"><a href="#cluster-configuration">Cluster configuration</a></li>
<li class="toc-entry toc-h1"><a href="#connecting-nodes">Connecting nodes</a></li>
<li class="toc-entry toc-h1"><a href="#testing-our-cluster">Testing our cluster</a></li>
<li class="toc-entry toc-h1"><a href="#benchmarks">Benchmarks</a></li>
<li class="toc-entry toc-h1"><a href="#testing-the-failover">Testing the failover</a></li>
<li class="toc-entry toc-h1"><a href="#conclusion">Conclusion</a></li>
<li class="toc-entry toc-h1"><a href="#links">Links</a></li>
</ul>
  </div>

  <p>Today I have tested version 3.0.0 of Redis server which includes Redis cluster. Here are some first thoughts about this.</p>

<h1 id="setup">Setup</h1>

<p>Here are my servers:</p>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 212.71.252.54  / 192.168.171.141 / node1</span>
<span class="c"># 176.58.103.254 / 192.168.171.142 / node2</span>
<span class="c"># 178.79.153.89  / 192.168.173.227 / node3</span>
</code></pre></div></div>

<p>Local hosts (on each server):</p>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># local hosts</span>
192.168.171.141 node1
192.168.171.142 node2
192.168.173.227 node3
</code></pre></div></div>

<p>And remote (on my PC):</p>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># remote hosts</span>
212.71.252.54  node1
176.58.103.254 node2
178.79.153.89  node3
</code></pre></div></div>

<p>First of all, let’s download and extract it (on each node).</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">mkdir </span>build <span class="o">&amp;&amp;</span> <span class="nb">cd </span>build
wget http://download.redis.io/releases/redis-3.0.0.tar.gz
<span class="nb">tar</span> <span class="nt">-xvzf</span> redis-3.0.0.tar.gz
<span class="nb">cd </span>redis-3.0.0/
</code></pre></div></div>

<p>Now we can build it</p>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apt-get <span class="nb">install</span> <span class="nt">-y</span> make gcc build-essential
make <span class="nv">MALLOC</span><span class="o">=</span>libc <span class="c"># also jemalloc can be used</span>
</code></pre></div></div>

<p>Let’s run tests</p>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apt-get <span class="nb">install</span> <span class="nt">-y</span> tk8.5 tcl8.5
make <span class="nb">test</span>
<span class="c"># a lot of output, should be green</span>
</code></pre></div></div>

<p>Then we can start Redis</p>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>src/redis-server ./redis.conf
</code></pre></div></div>

<h1 id="cluster-configuration">Cluster configuration</h1>

<p>We need to update our configuration file for each node</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># redis.conf
bind node1 # for node1
cluster-enabled yes
cluster-config-file nodes-6379.conf
cluster-node-timeout 5000
</code></pre></div></div>

<p>Here’s what should displayed:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>29338:M 13 Apr 21:05:00.214 * No cluster configuration found, I'm a1eec932d923b55e23a5fe6a488ed7a97e27c826
                _._
           _.-``__ ''-._
      _.-``    `.  `_.  ''-._           Redis 3.0.0 (00000000/0) 64 bit
  .-`` .-```.  ```\/    _.,_ ''-._
 (    '      ,       .-`  | `,    )     Running in cluster mode
 |`-._`-...-` __...-.``-._|'` _.-'|     Port: 6379
 |    `-._   `._    /     _.-'    |     PID: 29338
  `-._    `-._  `-./  _.-'    _.-'
 |`-._`-._    `-.__.-'    _.-'_.-'|
 |    `-._`-._        _.-'_.-'    |           http://redis.io
  `-._    `-._`-.__.-'_.-'    _.-'
 |`-._`-._    `-.__.-'    _.-'_.-'|
 |    `-._`-._        _.-'_.-'    |
  `-._    `-._`-.__.-'_.-'    _.-'
      `-._    `-.__.-'    _.-'
          `-._        _.-'
              `-.__.-'

29338:M 13 Apr 21:05:00.246 # Server started, Redis version 3.0.0
29338:M 13 Apr 21:05:00.247 * DB loaded from disk: 0.000 seconds
29338:M 13 Apr 21:05:00.247 * The server is now ready to accept connections on port 6379
</code></pre></div></div>

<p>Quite a lot of noisy debug information, but here is one line that is extremely important:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>No cluster configuration found, I'm a1eec932d923b55e23a5fe6a488ed7a97e27c826
</code></pre></div></div>

<p>So, our Redis server is running in cluster mode (… repeating same steps on other nodes …)</p>

<h1 id="connecting-nodes">Connecting nodes</h1>

<p>Now we have 3 nodes:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>node1:6379
node2:6379
node3:6379
</code></pre></div></div>

<p>Let’s connect them! Redis has a tool for connecting nodes called <code class="language-plaintext highlighter-rouge">redis-trib.rb</code>. And yes, it’s a ruby script and it requires <code class="language-plaintext highlighter-rouge">redis</code> gem to be installed (not a problem in my case).</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  redis-3.0.0 src/redis-trib.rb
Usage: redis-trib &lt;command&gt; &lt;options&gt; &lt;arguments ...&gt;

  create          host1:port1 ... hostN:portN
                  --replicas &lt;arg&gt;
  check           host:port
  fix             host:port
  reshard         host:port
                  --from &lt;arg&gt;
                  --to &lt;arg&gt;
                  --slots &lt;arg&gt;
                  --yes
  add-node        new_host:new_port existing_host:existing_port
                  --slave
                  --master-id &lt;arg&gt;
  del-node        host:port node_id
  set-timeout     host:port milliseconds
  call            host:port command arg arg .. arg
  import          host:port
                  --from &lt;arg&gt;
  help            (show this help)

For check, fix, reshard, del-node, set-timeout you can specify the host and port of any working node in the cluster.
</code></pre></div></div>

<p>For some reason, this tool does not support host names, we have to pass IP addresses manually.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  redis-3.0.0 src/redis-trib.rb create 192.168.171.141:6379 192.168.171.142:6379 192.168.173.227:6379

<span class="o">&gt;&gt;&gt;</span> Creating cluster
Connecting to node 192.168.171.141:6379: OK
Connecting to node 192.168.171.142:6379: OK
Connecting to node 192.168.173.227:6379: OK
<span class="o">&gt;&gt;&gt;</span> Performing <span class="nb">hash </span>slots allocation on 3 nodes...
Using 3 masters:
192.168.171.141:6379
192.168.171.142:6379
192.168.173.227:6379
M: 78a5bbdcd545848be8a66126a71dc69dd6d23bc4 192.168.171.141:6379
   slots:0-5460 <span class="o">(</span>5461 slots<span class="o">)</span> master
M: 1f6ed2478b461539f76b0b627de2e1b8565df719 192.168.171.142:6379
   slots:5461-10922 <span class="o">(</span>5462 slots<span class="o">)</span> master
M: 7a092b06c8c75e98176b7612e74d2e89e8b3eda7 192.168.173.227:6379
   slots:10923-16383 <span class="o">(</span>5461 slots<span class="o">)</span> master
Can I <span class="nb">set </span>the above configuration? <span class="o">(</span><span class="nb">type</span> <span class="s1">'yes'</span> to accept<span class="o">)</span>:
</code></pre></div></div>

<p>Looks beautiful! Each node is responsible for 1/3 of data. Typing ‘yes’…</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&gt;&gt;&gt; Nodes configuration updated
&gt;&gt;&gt; Assign a different config epoch to each node
&gt;&gt;&gt; Sending CLUSTER MEET messages to join the cluster
Waiting for the cluster to join.
&gt;&gt;&gt; Performing Cluster Check (using node 127.0.0.1:7001)
M: 78a5bbdcd545848be8a66126a71dc69dd6d23bc4 192.168.171.141:6379
   slots:0-5460 (5461 slots) master
M: 1f6ed2478b461539f76b0b627de2e1b8565df719 192.168.171.142:6379
   slots:5461-10922 (5462 slots) master
M: 7a092b06c8c75e98176b7612e74d2e89e8b3eda7 192.168.173.227:6379
   slots:10923-16383 (5461 slots) master
[OK] All nodes agree about slots configuration.
&gt;&gt;&gt; Check for open slots...
&gt;&gt;&gt; Check slots coverage...
[OK] All 16384 slots covered.
</code></pre></div></div>

<p>That’s it!</p>

<h1 id="testing-our-cluster">Testing our cluster</h1>

<p>Here is how to check the status of the cluster:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  redis-3.0.0 src/redis-cli -h node2 cluster nodes
7a092b06c8c75e98176b7612e74d2e89e8b3eda7 node1:6379 master - 0 1428949630273 3 connected 10923-16383
78a5bbdcd545848be8a66126a71dc69dd6d23bc4 node2:6379 myself,master - 0 0 1 connected 0-5460
1f6ed2478b461539f76b0b627de2e1b8565df719 node3:6379 master - 0 1428949629272 2 connected 5461-10922
</code></pre></div></div>

<p>Every single node knows about others, so the previous command can be executed on any node.</p>

<h1 id="benchmarks">Benchmarks</h1>

<p>Let’s setup <a href="https://github.com/antirez/redis-rb-cluster"><code class="language-plaintext highlighter-rouge">redis-rb-cluster</code></a></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  build wget https://github.com/antirez/redis-rb-cluster/archive/master.zip
➜  build unzip master.zip
➜  build cd redis-rb-cluster-master
</code></pre></div></div>

<p>We have the file <code class="language-plaintext highlighter-rouge">example.rb</code> which is pretty boring itself. It just writes random keys into our cluster and prints them:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  redis-rb-cluster-master ruby example.rb
1
2
3
...
</code></pre></div></div>

<p>Another example is more interesting.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  redis-rb-cluster-master ruby consistency-test.rb node1 6379
850 R (0 err) | 850 W (0 err) |
4682 R (0 err) | 4682 W (0 err) |
8490 R (0 err) | 8490 W (0 err) |
12196 R (0 err) | 12196 W (0 err) |
15785 R (0 err) | 15785 W (0 err) |
</code></pre></div></div>

<p>This tool writes a huge amount of data to Redis and check whether previously written data is still there.</p>

<h1 id="testing-the-failover">Testing the failover</h1>

<p>This chapter is something that I still don’t understand. I have tried to reproduce it many times and every time I have the same result.</p>

<p>Run <code class="language-plaintext highlighter-rouge">consistency-test.rb</code> again and kill any other node.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  redis-3.0.0 src/redis-cli -h node2 debug segfault
</code></pre></div></div>

<p>And here is the output that I’m getting every time:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>70273 R (0 err) | 70273 W (0 err) |
Reading: Too many Cluster redirections? (last error: MOVED 9515 127.0.0.1:7002)
Writing: Too many Cluster redirections? (last error: MOVED 9515 127.0.0.1:7002)
72378 R (1 err) | 72378 W (1 err) |
Reading: Too many Cluster redirections? (last error: MOVED 9650 127.0.0.1:7002)
Writing: Too many Cluster redirections? (last error: MOVED 9650 127.0.0.1:7002)
72379 R (2 err) | 72379 W (2 err) |
Reading: Too many Cluster redirections? (last error: MOVED 5797 127.0.0.1:7002)
Writing: Too many Cluster redirections? (last error: MOVED 5797 127.0.0.1:7002)
72380 R (3 err) | 72380 W (3 err) |
Reading: Too many Cluster redirections? (last error: MOVED 9772 127.0.0.1:7002)
Writing: Too many Cluster redirections? (last error: MOVED 9772 127.0.0.1:7002)
72384 R (4 err) | 72384 W (4 err) |
Reading: Too many Cluster redirections? (last error: MOVED 10245 127.0.0.1:7002)
Writing: Too many Cluster redirections? (last error: MOVED 10245 127.0.0.1:7002)
72385 R (5 err) | 72385 W (5 err) |
Reading: Too many Cluster redirections? (last error: MOVED 7376 127.0.0.1:7002)
Writing: Too many Cluster redirections? (last error: MOVED 7376 127.0.0.1:7002)
72385 R (6 err) | 72385 W (6 err) |
Reading: Too many Cluster redirections? (last error: MOVED 6781 127.0.0.1:7002)
Writing: Too many Cluster redirections? (last error: MOVED 6781 127.0.0.1:7002)
72396 R (7 err) | 72396 W (7 err) |
Reading: Too many Cluster redirections? (last error: MOVED 10275 127.0.0.1:7002)
Writing: Too many Cluster redirections? (last error: MOVED 10275 127.0.0.1:7002)
72401 R (8 err) | 72401 W (8 err) |
Reading: Too many Cluster redirections? (last error: MOVED 8639 127.0.0.1:7002)
Writing: Too many Cluster redirections? (last error: MOVED 8639 127.0.0.1:7002)
72402 R (9 err) | 72402 W (9 err) |
Reading: Too many Cluster redirections? (last error: MOVED 8173 127.0.0.1:7002)
Writing: Too many Cluster redirections? (last error: MOVED 8173 127.0.0.1:7002)
72402 R (10 err) | 72402 W (10 err) |
Reading: Too many Cluster redirections? (last error: MOVED 9525 127.0.0.1:7002)
Writing: Too many Cluster redirections? (last error: MOVED 9525 127.0.0.1:7002)
72403 R (11 err) | 72403 W (11 err) |
Reading: Too many Cluster redirections? (last error: MOVED 9346 127.0.0.1:7002)
Writing: Too many Cluster redirections? (last error: MOVED 9346 127.0.0.1:7002)
72406 R (12 err) | 72406 W (12 err) |
Reading: Too many Cluster redirections? (last error: MOVED 6391 127.0.0.1:7002)
Writing: Too many Cluster redirections? (last error: MOVED 6391 127.0.0.1:7002)
72411 R (13 err) | 72411 W (13 err) |
Reading: Too many Cluster redirections? (last error: MOVED 6353 127.0.0.1:7002)
Writing: Too many Cluster redirections? (last error: MOVED 6353 127.0.0.1:7002)
72413 R (14 err) | 72413 W (14 err) |
Reading: Too many Cluster redirections? (last error: MOVED 10245 127.0.0.1:7002)
Writing: Too many Cluster redirections? (last error: MOVED 10245 127.0.0.1:7002)
72418 R (15 err) | 72418 W (15 err) |
Reading: Too many Cluster redirections? (last error: MOVED 6438 127.0.0.1:7002)
Writing: Too many Cluster redirections? (last error: MOVED 6438 127.0.0.1:7002)
72422 R (16 err) | 72422 W (16 err) |
Reading: Too many Cluster redirections? (last error: MOVED 6826 127.0.0.1:7002)
Writing: Too many Cluster redirections? (last error: MOVED 6826 127.0.0.1:7002)
72423 R (17 err) | 72423 W (17 err) |
Reading: Too many Cluster redirections? (last error: MOVED 9713 127.0.0.1:7002)
Writing: CLUSTERDOWN The cluster is down
Reading: CLUSTERDOWN The cluster is down
Reading: CLUSTERDOWN The cluster is down
Writing: CLUSTERDOWN The cluster is down
72423 R (295 err) | 72423 W (295 err) |
72423 R (2219 err) | 72423 W (2219 err) |
Reading: CLUSTERDOWN The cluster is down
Writing: CLUSTERDOWN The cluster is down
Reading: CLUSTERDOWN The cluster is down
Writing: CLUSTERDOWN The cluster is down
72423 R (4186 err) | 72423 W (4186 err) |
Reading: CLUSTERDOWN The cluster is down
Writing: CLUSTERDOWN The cluster is down
72423 R (6190 err) | 72423 W (6190 err) |
Writing: CLUSTERDOWN The cluster is down
72423 R (8207 err) | 72423 W (8207 err) |
Reading: CLUSTERDOWN The cluster is down
Reading: CLUSTERDOWN The cluster is down
Writing: CLUSTERDOWN The cluster is down
</code></pre></div></div>

<p>As you can see, the cluster goes down and errors amount quickly increases. After all this steps I’m getting broken cluster (and each separated node is broken, too)</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  redis-3.0.0 src/redis-cli -h node3 ping
PONG
➜  redis-3.0.0 src/redis-cli -h node3 get 'test'
(error) CLUSTERDOWN The cluster is down
</code></pre></div></div>

<p>The cluster goes up after booting the first node manually</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># booting node2 manually...
➜  redis-3.0.0  src/redis-cli -h  get qwe
(error) MOVED 757 127.0.0.1:7001
➜  redis-3.0.0  src/redis-cli -p 7001 get qwe
(nil)
</code></pre></div></div>

<p>I hope this will be fixed soon.</p>

<h1 id="conclusion">Conclusion</h1>

<p>According to <a href="https://github.com/antirez/redis-rb-cluster#redis-rb-cluster">the repository</a> there are still a lot of things that need to be done before using Redis Cluster in production, but I would like to say Thanks to all contributors of Redis, <code class="language-plaintext highlighter-rouge">redis-rb</code> and <code class="language-plaintext highlighter-rouge">redis-rb-cluster</code>. Good job and looking forward to use in the real-world!</p>

<h1 id="links">Links</h1>

<ul>
  <li>
    <p><a href="http://redis.io/topics/cluster-tutorial">official tutorial</a></p>
  </li>
  <li>
    <p><a href="http://redis.io/topics/cluster-spec">cluster specification</a></p>
  </li>
  <li>
    <p><a href="https://raw.githubusercontent.com/antirez/redis/3.0/00-RELEASENOTES">changelog</a></p>
  </li>
</ul>

</div>


  <div class="comments">
    <div id="disqus_thread"></div>
    <script>
        var disqus_config = function () {
          this.page.url = document.location.href;  // Replace PAGE_URL with your page's canonical URL variable
          this.page.identifier = document.location.pathname; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
        };
        (function() { // DON'T EDIT BELOW THIS LINE
          var d = document, s = d.createElement('script');
          s.src = 'https://ibylich-myblog.disqus.com/embed.js';
          s.setAttribute('data-timestamp', +new Date());
          (d.head || d.body).appendChild(s);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>


<div class="related">
  <h2>Related Posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/2021/12/27/writing-bindings-upside-down.html">
            Writing bindings upside down
            <small>27 Dec 2021</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2020/11/22/lib-ruby-parser.html">
            lib-ruby-parser
            <small>22 Nov 2020</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2020/01/25/evaluating-ruby-in-ruby.html">
            Evaluating Ruby in Ruby
            <small>25 Jan 2020</small>
          </a>
        </h3>
      </li>
    
  </ul>
</div>

    </div>
  </body>
</html>
