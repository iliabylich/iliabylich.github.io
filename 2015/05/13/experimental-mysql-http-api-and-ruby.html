<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Experimental MySQL HTTP API and Ruby &middot; Ilya Bylich
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/hyde.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="192x192" href="/public/apple-touch-icon-192-precomposed.png">
                                 <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">

  <script async src="https://www.googletagmanager.com/gtag/js?id=G-EBV7BR668S"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-EBV7BR668S');
</script>

</head>


  <body class="theme-base-0b">

    <div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <h1>
        <a href="/">
          Ilya Bylich
        </a>
      </h1>
      <p class="lead">I'm a Ruby/Rust developer, sometimes I write long technical stories</p>
    </div>

    <nav class="sidebar-nav">
      <a class="sidebar-nav-item" href="/">Home</a>

      

      <a class="sidebar-nav-item" href="https://github.com/iliabylich">GitHub</a>
      <a class="sidebar-nav-item" href="https://twitter.com/IlyaBylich">Twitter</a>
      <a class="sidebar-nav-item" href="mailto:ibylich@gmail.com">Email me</a>

      <span class="sidebar-nav-item">
  <label for="current-theme">Theme</label>
  <select id="current-theme">
    <option>08</option>
    <option>09</option>
    <option>0a</option>
    <option>0b</option>
    <option>0c</option>
    <option>0d</option>
    <option>0f</option>
  </select>

  <script type="text/javascript">
    class Theme {
      static DEFAULT = "0b";

      static getCurrent() {
        return localStorage.getItem("current-theme") || Theme.DEFAULT;
      }

      static setCurrent(theme) {
        localStorage.setItem("current-theme", theme);
        document.body.className = `theme-base-${theme}`;
      }
    }

    const themeSelector = document.getElementById("current-theme");
    Theme.setCurrent(Theme.getCurrent());
    themeSelector.value = Theme.getCurrent();

    themeSelector.onchange = (e) => {
      const theme = e.target.value;
      Theme.setCurrent(theme);
    }
  </script>
</span>

    </nav>

    <p>&copy; 2022. All rights reserved.</p>
  </div>
</div>


    <div class="content container">
      <div class="post">
  <h1 class="post-title">Experimental MySQL HTTP API and Ruby</h1>
  <span class="post-date">13 May 2015</span>

  <div class="reading-time" title="Estimated read time">
  This article will take 8 minutes to read
  <br />
  (or maybe less, the algorithm treats code as text)
</div>


  <div id="table-of-contents">
    <ul id="toc" class="section-nav">
<li class="toc-entry toc-h2"><a href="#sql-endpoint">SQL endpoint</a></li>
<li class="toc-entry toc-h2"><a href="#crud-endpoint">CRUD endpoint</a></li>
<li class="toc-entry toc-h2"><a href="#json-document-endpoint">JSON document endpoint</a></li>
<li class="toc-entry toc-h1"><a href="#mysql-57-installation">MySQL 5.7 installation</a>
<ul>
<li class="toc-entry toc-h3"><a href="#download-package-from-mysql-site">Download package from MySQL site</a></li>
<li class="toc-entry toc-h3"><a href="#extract-it">Extract it</a></li>
<li class="toc-entry toc-h3"><a href="#create-mysqlmysql-usergroup">Create mysql:mysql user:group</a></li>
<li class="toc-entry toc-h3"><a href="#link-extracted-directory">Link extracted directory</a></li>
<li class="toc-entry toc-h3"><a href="#run-mysql_install_db">Run mysql_install_db</a></li>
<li class="toc-entry toc-h3"><a href="#run-mysql-server">Run MySQL server</a></li>
<li class="toc-entry toc-h3"><a href="#change-root-password">Change root password</a></li>
<li class="toc-entry toc-h3"><a href="#create-configuration-files-and-init-script">Create configuration files and init script</a></li>
<li class="toc-entry toc-h3"><a href="#and-change-basedir-and-datadir-in-etcinitdmysql">And change basedir and datadir in /etc/init.d/mysql</a></li>
<li class="toc-entry toc-h3"><a href="#run-mysql-server-again-with-configuration-files">Run MySQL server again with configuration files</a></li>
</ul>
</li>
<li class="toc-entry toc-h1"><a href="#http-api-plugin-installation">HTTP API plugin installation</a></li>
<li class="toc-entry toc-h1"><a href="#http-api-plugin-configuration">HTTP API plugin configuration</a></li>
<li class="toc-entry toc-h1"><a href="#connecting-with-ruby">Connecting with Ruby</a>
<ul>
<li class="toc-entry toc-h2"><a href="#playing-with-crud-endpoint">Playing with CRUD endpoint</a></li>
<li class="toc-entry toc-h2"><a href="#playing-with-sql-endpoint">Playing with SQL endpoint</a></li>
<li class="toc-entry toc-h2"><a href="#playing-with-json-document-endpoint">Playing with JSON document endpoint</a></li>
</ul>
</li>
<li class="toc-entry toc-h1"><a href="#conclusion">Conclusion</a></li>
</ul>
  </div>

  <p>Yes, MySQL has an HTTP API which is:</p>
<ol>
  <li>an experimental feature</li>
  <li>it ships as a native plugin <a href="http://labs.mysql.com/?id=3">only for 5.7 version</a></li>
</ol>

<p>Basically, it allows you to work with your database in the following ways:</p>
<ol>
  <li>as an SQL endpoint</li>
  <li>as a CRUD endpoint</li>
  <li>as a JSON document endpoint</li>
</ol>

<h2 id="sql-endpoint">SQL endpoint</h2>

<p>It gives an ability to run queries like</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>GET http://host:port/sql/:database/:query
</code></pre></div></div>

<p>For example</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>GET http://localhost:8080/sql/testdb/SELECT+1
</code></pre></div></div>

<p>is a synonym of SQL’s <code class="language-plaintext highlighter-rouge">SELECT 1</code>.</p>

<h2 id="crud-endpoint">CRUD endpoint</h2>

<p>Interface is:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>GET http://host:port/crud/:database/:table/:id
</code></pre></div></div>

<p>And</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>GET http://localhost:8080/crud/test_db/test_table/101<span class="s1">'
</span></code></pre></div></div>

<p>produces:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="nv">`test_db`</span><span class="p">.</span><span class="nv">`test_table`</span> <span class="k">WHERE</span> <span class="nv">`test_table`</span><span class="p">.</span><span class="nv">`id`</span> <span class="o">=</span> <span class="mi">101</span>
</code></pre></div></div>

<h2 id="json-document-endpoint">JSON document endpoint</h2>

<p>Basically, with this endpoint your table has only 3 fields:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">mysql</span><span class="o">&gt;</span> <span class="k">describe</span> <span class="n">test_db</span><span class="p">.</span><span class="n">test_table</span><span class="p">;</span>
<span class="o">+</span><span class="c1">--------+---------------------+------+-----+---------+-------+</span>
<span class="o">|</span> <span class="n">Field</span>  <span class="o">|</span> <span class="k">Type</span>                <span class="o">|</span> <span class="k">Null</span> <span class="o">|</span> <span class="k">Key</span> <span class="o">|</span> <span class="k">Default</span> <span class="o">|</span> <span class="n">Extra</span> <span class="o">|</span>
<span class="o">+</span><span class="c1">--------+---------------------+------+-----+---------+-------+</span>
<span class="o">|</span> <span class="n">_id</span>    <span class="o">|</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">36</span><span class="p">)</span>         <span class="o">|</span> <span class="k">NO</span>   <span class="o">|</span> <span class="n">PRI</span> <span class="o">|</span> <span class="k">NULL</span>    <span class="o">|</span>       <span class="o">|</span>
<span class="o">|</span> <span class="n">_rev</span>   <span class="o">|</span> <span class="nb">bigint</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span> <span class="nb">unsigned</span> <span class="o">|</span> <span class="k">NO</span>   <span class="o">|</span> <span class="n">PRI</span> <span class="o">|</span> <span class="mi">0</span>       <span class="o">|</span>       <span class="o">|</span>
<span class="o">|</span> <span class="n">_extra</span> <span class="o">|</span> <span class="nb">blob</span>                <span class="o">|</span> <span class="k">NO</span>   <span class="o">|</span>     <span class="o">|</span> <span class="k">NULL</span>    <span class="o">|</span>       <span class="o">|</span>
<span class="o">+</span><span class="c1">--------+---------------------+------+-----+---------+-------+</span>
</code></pre></div></div>

<p>All the data is stored in <code class="language-plaintext highlighter-rouge">_extra</code> column, <code class="language-plaintext highlighter-rouge">_id</code> is a regular document id, <code class="language-plaintext highlighter-rouge">_rev</code> is a revision of your document. There is no schema for API perspective and the documents are versioned. As for me it looks pretty much like CouchDB (of course, without querying the entire documents data :smile:)</p>

<h1 id="mysql-57-installation">MySQL 5.7 installation</h1>

<p>It’s dead simple (until you want to install it from source):</p>

<h3 id="download-package-from-mysql-site">Download package from MySQL site</h3>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>wget http://downloads.mysql.com/snapshots/pb/mysql-5.7.5-labs-http/mysql-5.7.5-labs-http-linux-glibc2.5-x86_64.tar.gz
</code></pre></div></div>

<h3 id="extract-it">Extract it</h3>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">tar</span> <span class="nt">-zxvf</span> mysql-5.7.5-labs-http-linux-glibc2.5-x86_64.tar.gz
</code></pre></div></div>

<h3 id="create-mysqlmysql-usergroup">Create <code class="language-plaintext highlighter-rouge">mysql:mysql user:group</code></h3>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>groupadd mysql
<span class="nv">$ </span>useradd <span class="nt">-r</span> <span class="nt">-g</span> mysql mysql
</code></pre></div></div>

<h3 id="link-extracted-directory">Link extracted directory</h3>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">ln</span> <span class="nt">-s</span> /root/mysql-5.7.5-labs-http-linux-glibc2.5-x86_64 /usr/local/mysql
<span class="nv">$ </span><span class="nb">cd</span> /usr/local/mysql
</code></pre></div></div>

<h3 id="run-mysql_install_db">Run <code class="language-plaintext highlighter-rouge">mysql_install_db</code></h3>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>bin/mysql_install_db <span class="nt">--user</span><span class="o">=</span>mysql <span class="nt">--datadir</span><span class="o">=</span>/var/lib/mysql
</code></pre></div></div>

<h3 id="run-mysql-server">Run MySQL server</h3>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>bin/mysqld_safe <span class="nt">--user</span><span class="o">=</span>mysql <span class="nt">--datadir</span><span class="o">=</span>/var/lib/mysql &amp;
</code></pre></div></div>

<h3 id="change-root-password">Change root password</h3>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cat</span> ~/.mysql_secret
<span class="c"># Here goes your root password!</span>
mysql <span class="nt">-uroot</span> <span class="nt">-p</span>
<span class="c"># &lt;Paste your root password from the file&gt;</span>
mysql&gt; SET <span class="nv">PASSWORD</span><span class="o">=</span>PASSWORD<span class="o">(</span><span class="s1">'root'</span><span class="o">)</span><span class="p">;</span> <span class="c"># Yes, I'm mad</span>
mysql&gt; <span class="nb">exit</span>
</code></pre></div></div>

<h3 id="create-configuration-files-and-init-script">Create configuration files and <code class="language-plaintext highlighter-rouge">init</code> script</h3>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">cp </span>support-files/my-default.cnf /etc/my.cnf
<span class="nv">$ </span><span class="nb">cp </span>support-files/mysql.server /etc/init.d/mysql
</code></pre></div></div>

<h3 id="and-change-basedir-and-datadir-in-etcinitdmysql">And change <code class="language-plaintext highlighter-rouge">basedir</code> and <code class="language-plaintext highlighter-rouge">datadir</code> in <code class="language-plaintext highlighter-rouge">/etc/init.d/mysql</code></h3>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># In my case</span>
<span class="nv">basedir</span><span class="o">=</span>/usr/local/mysql
<span class="nv">datadir</span><span class="o">=</span>/var/lib/mysql
</code></pre></div></div>

<h3 id="run-mysql-server-again-with-configuration-files">Run MySQL server again with configuration files</h3>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>/etc/init.d/mysql start
</code></pre></div></div>

<h1 id="http-api-plugin-installation">HTTP API plugin installation</h1>

<p>It’s already included into our MySQL installation:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-l</span> /usr/local/mysql/lib/plugin/libmyhttp.so
</code></pre></div></div>

<p>But it’s disabled by default, to enable it run</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">mysql</span><span class="o">&gt;</span> <span class="n">INSTALL</span> <span class="n">PLUGIN</span> <span class="n">myhttp</span> <span class="n">SONAME</span> <span class="s1">'libmyhttp.so'</span><span class="p">;</span>
<span class="p">...</span>
<span class="n">mysql</span><span class="o">&gt;</span> <span class="k">SHOW</span> <span class="n">PLUGINS</span><span class="p">;</span>
</code></pre></div></div>

<p>Once plugin is enabled, some MySQL variables become accessible:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mysql&gt; show variables like 'myhttp_%';
+----------------------------------+------------------------------+
| Variable_name                    | Value                        |
+----------------------------------+------------------------------+
| myhttp_basic_auth_user_name      | basic_auth_user              |
| myhttp_basic_auth_user_passwd    | basic_auth_passwd            |
| myhttp_crud_url_prefix           | /crud/                       |
| myhttp_default_db                | myhttp                       |
| myhttp_default_mysql_user_host   | 127.0.0.1                      |
| myhttp_default_mysql_user_name   | username                     |
| myhttp_default_mysql_user_passwd | userpass                     |
| myhttp_document_url_prefix       | /doc/                        |
| myhttp_http_enabled              | ON                           |
| myhttp_http_port                 | 8080                         |
| myhttp_https_enabled             | OFF                          |
| myhttp_https_port                | 8081                         |
| myhttp_https_ssl_key_file        | lib/plugin/myhttp_sslkey.pem |
| myhttp_sql_url_prefix            | /sql/                        |
+----------------------------------+------------------------------+
</code></pre></div></div>

<ol>
  <li><code class="language-plaintext highlighter-rouge">myhttp_basic_auth_user_name</code> - username that should be used for basic HTTP authentication</li>
  <li><code class="language-plaintext highlighter-rouge">myhttp_basic_auth_user_passwd</code> - password that should be used for basic HTTP authentication</li>
  <li><code class="language-plaintext highlighter-rouge">myhttp_crud_url_prefix</code> - prefix of CRUD endpoint</li>
  <li><code class="language-plaintext highlighter-rouge">myhttp_default_db</code> - database that will be used if no database specified in request</li>
  <li><code class="language-plaintext highlighter-rouge">myhttp_default_mysql_user_host</code>  - MySQL user that will be used for performing query provided with HTTP request</li>
  <li><code class="language-plaintext highlighter-rouge">myhttp_default_mysql_user_passwd</code> - password of this MySQL user</li>
  <li><code class="language-plaintext highlighter-rouge">myhttp_document_url_prefix</code> - prefix of JSON document endpoint</li>
  <li><code class="language-plaintext highlighter-rouge">myhttp_http_enabled</code> - boolean setting to enable/disable non-SSL HTTP API</li>
  <li><code class="language-plaintext highlighter-rouge">myhttp_http_port</code> - port of non-SSL HTTP API</li>
  <li><code class="language-plaintext highlighter-rouge">myhttp_https_enabled</code> - boolean setting to enable/disable SSL HTTP API (yes, it’s available)</li>
  <li><code class="language-plaintext highlighter-rouge">myhttp_https_port</code> - port of SSL HTTP API</li>
  <li><code class="language-plaintext highlighter-rouge">myhttp_https_ssl_key_file</code> - path to SSL certificate for SSL API</li>
  <li><code class="language-plaintext highlighter-rouge">myhttp_sql_url_prefix</code> - prefix of SQL endpoint</li>
</ol>

<p>Let’s try it!</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ curl -v localhost:8080
&gt; GET / HTTP/1.1
&gt; User-Agent: curl/7.35.0
&gt; Host: 127.0.0.1:8080
&gt; Accept: */*
&gt;
&lt; HTTP/1.1 404 Not Found
&lt; Cache-control: must-revalidate
&lt; Connection: Keep-Alive
&lt; Pragma: no-cache
* Server MyHTTP 1.0.0-alpha is not blacklisted
&lt; Server: MyHTTP 1.0.0-alpha
&lt; Content-Length: 36
&lt;
{"error":404, "message":"Not Found"}
</code></pre></div></div>

<p>Well, at least it returns something (be patient, this feature is experimental)</p>

<h1 id="http-api-plugin-configuration">HTTP API plugin configuration</h1>

<p>First of all, we need to create MySQL user and use his credentials in configuration file.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mysql&gt; CREATE USER 'username'@'%' IDENTIFIED BY 'userpass';
mysql&gt; GRANT ALL PRIVILEGES ON * . * TO 'username'@'%';
mysql&gt; FLUSH PRIVILEGES;
</code></pre></div></div>

<p>Then we can change plugin’s settings in <code class="language-plaintext highlighter-rouge">/etc/my.cnf</code> to something like:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[mysqld]
myhttp_default_db = myhttp
myhttp_default_mysql_user_name = username
myhttp_default_mysql_user_passwd = userpass
myhttp_default_mysql_user_host = 127.0.0.1
myhttp_basic_auth_user_name = basic_auth_user
myhttp_basic_auth_user_passwd = basic_auth_passwd
</code></pre></div></div>

<p>Here is how it should look using curl:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl --user basic_auth_user:basic_auth_passwd --url http://localhost:8080/crud/myhttp/simple/1
 {"id":"1","col_a":"Hello"}
</code></pre></div></div>

<h1 id="connecting-with-ruby">Connecting with Ruby</h1>

<p>First of all this is an HTTP API, so it’s available for both server-side and client-side.</p>

<h2 id="playing-with-crud-endpoint">Playing with CRUD endpoint</h2>

<p>If we need to work with MySQL over HTTP API (let’s imagine for a second that this is the only available way to fetch the data)
we need something like <a href="https://github.com/rails/activeresource"><code class="language-plaintext highlighter-rouge">ActiveResource</code></a>.</p>

<p><code class="language-plaintext highlighter-rouge">ActiveResource</code> is a gem for building <code class="language-plaintext highlighter-rouge">ActiveRecord</code>-like classes that actually fetch data over HTTP API.</p>

<p>Install it:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ gem install activeresource
</code></pre></div></div>

<p>And use:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s1">'activeresource'</span>

<span class="c1"># We should have a table `users` (yes, Rails convention)</span>
<span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveResource</span><span class="o">::</span><span class="no">Base</span>
  <span class="nb">self</span><span class="p">.</span><span class="nf">site</span> <span class="o">=</span> <span class="s1">'http://localhost:8080/crud'</span>
  <span class="nb">self</span><span class="p">.</span><span class="nf">user</span> <span class="o">=</span> <span class="s1">'basic_auth_user'</span>
  <span class="nb">self</span><span class="p">.</span><span class="nf">password</span> <span class="o">=</span> <span class="s1">'basic_auth_passwd'</span>
<span class="k">end</span>

<span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">user</span><span class="p">.</span><span class="nf">first_name</span>
<span class="c1"># =&gt; 'Sherlock'</span>
<span class="n">user</span><span class="p">.</span><span class="nf">last_name</span>
<span class="c1"># =&gt; 'Holmes'</span>
<span class="n">user</span><span class="p">.</span><span class="nf">first_name</span> <span class="o">=</span> <span class="s1">'John'</span>

<span class="no">User</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">first_name: </span><span class="s1">'John'</span><span class="p">,</span> <span class="ss">last_name: </span><span class="err">'</span><span class="no">Watson</span><span class="p">)</span>
<span class="c1"># =&gt; ActiveResource::MethodNotAllowed: Failed.  Response code = 405.  Response message = Method Not Allowed.</span>
</code></pre></div></div>

<p>By default <code class="language-plaintext highlighter-rouge">ActiveResource</code> sends POST request to create a new record. However MySQL HTTP API has some other standards and it uses PUT for creating new record. Moreover, its required to specify primary key (<code class="language-plaintext highlighter-rouge">id</code>) of the record you want to insert (even if <code class="language-plaintext highlighter-rouge">id</code> has auto-increment)</p>

<p><code class="language-plaintext highlighter-rouge">ActiveResource</code> does not allow us to specify HTTP verbs for its API calls
<a href="https://github.com/rails/activeresource/blob/master/lib/active_resource/base.rb#L1435">source</a>
Without this we can’t even create a single record in the database!</p>

<p>Let’s check for alternatives. <a href="https://github.com/remiprev/her"><code class="language-plaintext highlighter-rouge">Her</code></a> is a popular (according to stars on GitHub it’s even more popular then <code class="language-plaintext highlighter-rouge">ActiveResource</code>) alternative with a nice syntax sugar. Here is an example:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ gem install her
</code></pre></div></div>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s1">'her'</span>

<span class="no">Her</span><span class="o">::</span><span class="no">API</span><span class="p">.</span><span class="nf">setup</span> <span class="ss">url: </span><span class="s2">"http://localhost:8080/crud/testdb/"</span> <span class="k">do</span> <span class="o">|</span><span class="n">c</span><span class="o">|</span>
  <span class="c1"># Basic auth</span>
  <span class="n">c</span><span class="p">.</span><span class="nf">use</span> <span class="no">Faraday</span><span class="o">::</span><span class="no">Request</span><span class="o">::</span><span class="no">BasicAuthentication</span><span class="p">,</span>
    <span class="s2">"basic_auth_user"</span><span class="p">,</span> <span class="s2">"basic_auth_passwd"</span>

  <span class="c1"># Encode request</span>
  <span class="n">c</span><span class="p">.</span><span class="nf">use</span> <span class="no">Faraday</span><span class="o">::</span><span class="no">Request</span><span class="o">::</span><span class="no">UrlEncoded</span>

  <span class="c1"># Parse response</span>
  <span class="n">c</span><span class="p">.</span><span class="nf">use</span> <span class="no">Her</span><span class="o">::</span><span class="no">Middleware</span><span class="o">::</span><span class="no">DefaultParseJSON</span>

  <span class="c1"># Adapter</span>
  <span class="n">c</span><span class="p">.</span><span class="nf">use</span> <span class="no">Faraday</span><span class="o">::</span><span class="no">Adapter</span><span class="o">::</span><span class="no">NetHttp</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">User</span>
  <span class="kp">include</span> <span class="no">Her</span><span class="o">::</span><span class="no">Model</span>
  <span class="n">method_for</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">:put</span>
<span class="k">end</span>

<span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="c1"># =&gt; instance of user</span>
<span class="n">user</span><span class="p">.</span><span class="nf">first_name</span> <span class="o">=</span> <span class="s1">'another-name'</span>
<span class="n">user</span><span class="p">.</span><span class="nf">save</span>
<span class="c1"># =&gt; false</span>
</code></pre></div></div>

<p>No errors messages, just 400 Bad Request.
The thing is that body should be JSON-encoded, here is my middleware that encodes it:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">MySqlHttpApiFormatter</span> <span class="o">&lt;</span> <span class="no">Faraday</span><span class="o">::</span><span class="no">Middleware</span>
  <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">env</span><span class="p">[</span><span class="s1">'body'</span><span class="p">]</span> <span class="c1"># this middleware calls also for 'get' requests</span>
      <span class="n">env</span><span class="p">[</span><span class="s1">'body'</span><span class="p">].</span><span class="nf">delete</span><span class="p">(</span><span class="ss">:id</span><span class="p">)</span> <span class="c1"># id is already in the url</span>
      <span class="n">env</span><span class="p">[</span><span class="s1">'body'</span><span class="p">]</span> <span class="o">=</span> <span class="n">env</span><span class="p">[</span><span class="s1">'body'</span><span class="p">].</span><span class="nf">to_json</span>
    <span class="k">end</span>
    <span class="vi">@app</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="no">Her</span><span class="o">::</span><span class="no">API</span><span class="p">.</span><span class="nf">setup</span> <span class="o">...</span> <span class="k">do</span> <span class="o">|</span><span class="n">c</span><span class="o">|</span>
  <span class="n">c</span><span class="p">.</span><span class="nf">use</span> <span class="no">MySqlHttpApiFormatter</span>
<span class="k">end</span>

<span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">first_name: </span><span class="s1">'Test'</span><span class="p">,</span> <span class="ss">last_name: </span><span class="s1">'User'</span><span class="p">,</span> <span class="ss">id: </span><span class="mi">25</span><span class="p">)</span>
<span class="c1"># =&gt; instance of user</span>
</code></pre></div></div>

<p>And finally it works! The only thing that I personally don’t like in design of this API is that both <code class="language-plaintext highlighter-rouge">INSERT</code> and <code class="language-plaintext highlighter-rouge">UPDATE</code> have to be called using PUT because it produces query:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>REPLACE INTO db.table SET ..., pk = ...
</code></pre></div></div>

<p>That’s why we have to pass id, <code class="language-plaintext highlighter-rouge">create</code> and <code class="language-plaintext highlighter-rouge">update</code> actions are combined into single <code class="language-plaintext highlighter-rouge">replace</code> (and I don’t see any explanation for that).</p>

<p>Theoretically, this API can be used for both client-side and server-side (but it’s important to make sure that you can allow users to change the data in your database)</p>

<h2 id="playing-with-sql-endpoint">Playing with SQL endpoint</h2>

<p>Honestly saying nothing interesting.</p>
<ul>
  <li>This API can’t be used for client-side applications because of potential SQL injections (yes, you can restrict user from deleting/updating data and grant only <code class="language-plaintext highlighter-rouge">Select_priv</code> privilege, but it still looks dangerous). Even if you are 100% sure that you are completely secured from any application-related vulnerabilities, CRUD API still looks better then passing raw SQL queries over HTTP.</li>
  <li>Yes, it’s possible to use it on the server, but for what? <code class="language-plaintext highlighter-rouge">mysql2</code> gem is still much faster (and can be easily combined with ActiveRecord)… nothing to discuss.</li>
</ul>

<h2 id="playing-with-json-document-endpoint">Playing with JSON document endpoint</h2>

<p>First of all, it looks quite strange comparing with regular MySQL tables. The database that is compatible with this API <strong>must</strong> be created using the same API. And as I wrote before, it creates 3 fields:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">_id</code> - some unique identifier</li>
  <li><code class="language-plaintext highlighter-rouge">_rev</code> - revision of document (I can’t call it ‘record’)</li>
  <li><code class="language-plaintext highlighter-rouge">_ext</code> - serialized mapping <code class="language-plaintext highlighter-rouge">attribute_name =&gt; value</code></li>
</ul>

<p>Here is how it looks it MySQL:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mysql&gt; select * from json_types\G
*************************** 1. row ***************************
   _id: 1
  _rev: 1
_extra: {"json_null": null, "json_string": "string", "json_number": 123.456, "json_bool": true}
1 row in set (0.00 sec)
</code></pre></div></div>

<p>CouchDB has similar interface (HTTP API, schema-less documents, MVCC) but it provides one core feature of all databases: ability to run queries. You can’t run any query when your data is serialized (no, I don’t know what is <code class="language-plaintext highlighter-rouge">where _rev LIKE '%"some":json_structure%'"</code>). Moreover MVCC for this table is not real :) It stores only latest revision.</p>

<p>From my experience when you need to store schema-less documents you have two options:</p>
<ol>
  <li>Use real schema-less storage (yes, like MongoDB)</li>
  <li>Serialize fields <strong>that need to be serialized</strong> into single column (and Rails provides functionality for this out-of-box: <code class="language-plaintext highlighter-rouge">ActiveRecord::Base.serialize</code>) and query the database using non-serialized column.</li>
</ol>

<p>JSON document API can be useful when you already have MySQL and don’t want to setup any other databases to store tons of unstructured data. Yes, sounds awful, but looks like a true.</p>

<h1 id="conclusion">Conclusion</h1>

<p>HTTP API is a tool, and it solves a lot of possible issues. It’s not released yet (and I suppose it will not be included into default MySQL 5.7 installation), but I’m waiting for it so much. Today, when Single-Page Applications are so popular and Rails application may have only HTTP API, it can simplify our server code. Let’s give it a chance!</p>

</div>


  <div class="comments">
    <div id="disqus_thread"></div>
    <script>
        var disqus_config = function () {
          this.page.url = document.location.href;  // Replace PAGE_URL with your page's canonical URL variable
          this.page.identifier = document.location.pathname; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
        };
        (function() { // DON'T EDIT BELOW THIS LINE
          var d = document, s = d.createElement('script');
          s.src = 'https://ibylich-myblog.disqus.com/embed.js';
          s.setAttribute('data-timestamp', +new Date());
          (d.head || d.body).appendChild(s);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>


<div class="related">
  <h2>Related Posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/2021/12/27/writing-bindings-upside-down.html">
            Writing bindings upside down
            <small>27 Dec 2021</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2020/11/22/lib-ruby-parser.html">
            lib-ruby-parser
            <small>22 Nov 2020</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2020/01/25/evaluating-ruby-in-ruby.html">
            Evaluating Ruby in Ruby
            <small>25 Jan 2020</small>
          </a>
        </h3>
      </li>
    
  </ul>
</div>

    </div>
  </body>
</html>
