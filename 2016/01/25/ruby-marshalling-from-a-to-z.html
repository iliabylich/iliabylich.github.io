<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Ruby Marshalling from A to Z &middot; Ilya Bylich
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/hyde.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-144-precomposed.png">
                                 <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
</head>


  <body class="theme-base-0b">

    <div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <h1>
        <a href="/">
          Ilya Bylich
        </a>
      </h1>
      <p class="lead">I'm a Ruby/Rust developer, sometimes I write long technical stories</p>
    </div>

    <nav class="sidebar-nav">
      <a class="sidebar-nav-item" href="/">Home</a>

      

      <a class="sidebar-nav-item" href="https://github.com/iliabylich">GitHub</a>
      <a class="sidebar-nav-item" href="https://twitter.com/IlyaBylich">Twitter</a>
      <a class="sidebar-nav-item" href="mailto:ibylich@gmail.com">Email me</a>

      <span class="sidebar-nav-item">
  <label for="current-theme">Theme</label>
  <select id="current-theme">
    <option>08</option>
    <option>09</option>
    <option>0a</option>
    <option>0b</option>
    <option>0c</option>
    <option>0d</option>
    <option>0f</option>
  </select>

  <script type="text/javascript">
    class Theme {
      static DEFAULT = "0b";

      static getCurrent() {
        return localStorage.getItem("current-theme") || Theme.DEFAULT;
      }

      static setCurrent(theme) {
        localStorage.setItem("current-theme", theme);
        document.body.className = `theme-base-${theme}`;
      }
    }

    const themeSelector = document.getElementById("current-theme");
    Theme.setCurrent(Theme.getCurrent());
    themeSelector.value = Theme.getCurrent();

    themeSelector.onchange = (e) => {
      const theme = e.target.value;
      Theme.setCurrent(theme);
    }
  </script>
</span>

    </nav>

    <p>&copy; 2022. All rights reserved.</p>
  </div>
</div>


    <div class="content container">
      <div class="post">
  <h1 class="post-title">Ruby Marshalling from A to Z</h1>
  <span class="post-date">25 Jan 2016</span>

  <div id="table-of-contents">
    <ul id="toc" class="section-nav">
<li class="toc-entry toc-h1"><a href="#the-gem">The gem</a></li>
<li class="toc-entry toc-h1"><a href="#reading">Reading</a>
<ul>
<li class="toc-entry toc-h2"><a href="#decompressing">Decompressing</a></li>
<li class="toc-entry toc-h2"><a href="#getting-objects-from-the-raw-data">Getting objects from the raw data</a></li>
<li class="toc-entry toc-h2"><a href="#nilclass-trueclass-falseclass">NilClass, TrueClass, FalseClass</a></li>
<li class="toc-entry toc-h2"><a href="#tests">Tests</a></li>
<li class="toc-entry toc-h2"><a href="#integer">Integer</a></li>
<li class="toc-entry toc-h2"><a href="#symbol">Symbol</a></li>
<li class="toc-entry toc-h2"><a href="#string">String</a></li>
<li class="toc-entry toc-h2"><a href="#array">Array</a></li>
<li class="toc-entry toc-h2"><a href="#hash">Hash</a></li>
<li class="toc-entry toc-h2"><a href="#float">Float</a></li>
<li class="toc-entry toc-h2"><a href="#class">Class</a></li>
<li class="toc-entry toc-h2"><a href="#module">Module</a></li>
<li class="toc-entry toc-h2"><a href="#struct">Struct</a></li>
<li class="toc-entry toc-h2"><a href="#regexp">Regexp</a></li>
<li class="toc-entry toc-h2"><a href="#abstract-object">Abstract object</a></li>
<li class="toc-entry toc-h2"><a href="#user-class">User class</a></li>
<li class="toc-entry toc-h2"><a href="#extended-object">Extended object</a></li>
<li class="toc-entry toc-h2"><a href="#symbol-links">Symbol links</a></li>
<li class="toc-entry toc-h2"><a href="#object-links">Object links</a></li>
<li class="toc-entry toc-h2"><a href="#other-cases">Other cases</a></li>
</ul>
</li>
<li class="toc-entry toc-h1"><a href="#writing">Writing</a></li>
<li class="toc-entry toc-h1"><a href="#optimizations">Optimizations</a></li>
<li class="toc-entry toc-h1"><a href="#what-is-it-for">What is it for?</a></li>
<li class="toc-entry toc-h1"><a href="#links">Links</a></li>
</ul>
  </div>

  <p>Marshalling is a serialization process when you convert an object to a binary string.
Ruby has a standard class <code class="language-plaintext highlighter-rouge">Marshal</code> that does all the job for serialization and deserialization.
To serialize an object, use <code class="language-plaintext highlighter-rouge">Marshal.dump</code>, to deserialize - <code class="language-plaintext highlighter-rouge">Marshal.load</code> or <code class="language-plaintext highlighter-rouge">Marshal.restore</code>.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">marshalled</span> <span class="o">=</span> <span class="no">Marshal</span><span class="p">.</span><span class="nf">dump</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">'string'</span><span class="p">,</span> <span class="no">Object</span><span class="p">.</span><span class="nf">new</span><span class="p">])</span>
<span class="c1"># =&gt; "\x04\b[\ti\x06i\aI\"\vstring\x06:\x06ETo:\vObject\x00"</span>

<span class="no">Marshal</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span><span class="n">marshalled</span><span class="p">)</span>
<span class="c1"># =&gt; [1, 2, "string", #&lt;Object:0x00000002643000&gt;]</span>
</code></pre></div></div>

<p>This article explains the format of marshalling and shows how to write a pure Ruby marshalling library
compatible with the standard Ruby implementation.</p>

<h1 id="the-gem">The gem</h1>

<p>Let’s try to make a pure Ruby gem that is compatible with standard <code class="language-plaintext highlighter-rouge">Marshal</code> class.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>bundle gem pure_ruby_marshal
<span class="nv">$ </span>tree pure_ruby_marshal
pure_ruby_marshal
├── bin
│ ├── console
│ └── setup
├── CODE_OF_CONDUCT.md
├── Gemfile
├── lib
│ ├── pure_ruby_marshal
│ │ └── version.rb
│ └── pure_ruby_marshal.rb
├── LICENSE.txt
├── pure_ruby_marshal.gemspec
├── Rakefile
└── README.md
</code></pre></div></div>

<p>Our main module <code class="language-plaintext highlighter-rouge">PureRubyMarshal</code> has the following interface:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">module</span> <span class="nn">PureRubyMarshal</span>
  <span class="kp">extend</span> <span class="nb">self</span>

  <span class="k">def</span> <span class="nf">dump</span><span class="p">(</span><span class="n">object</span><span class="p">)</span>
    <span class="c1"># ...</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="c1"># ...</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Also I’d like to extract all logic related into reading/writing encoded data
to separate classes - <code class="language-plaintext highlighter-rouge">ReadBuffer</code> for reading, <code class="language-plaintext highlighter-rouge">WriteBuffer</code> for writing.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">module</span> <span class="nn">PureRubyMarshal</span>
  <span class="kp">extend</span> <span class="nb">self</span>

  <span class="nb">autoload</span> <span class="ss">:ReadBuffer</span><span class="p">,</span>  <span class="s1">'pure_ruby_marshal/read_buffer'</span>
  <span class="nb">autoload</span> <span class="ss">:WriteBuffer</span><span class="p">,</span> <span class="s1">'pure_ruby_marshal/write_buffer'</span>

  <span class="k">def</span> <span class="nf">dump</span><span class="p">(</span><span class="n">object</span><span class="p">)</span>
    <span class="no">WriteBuffer</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">object</span><span class="p">).</span><span class="nf">write</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="no">ReadBuffer</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">data</span><span class="p">).</span><span class="nf">read</span>
  <span class="k">end</span>
<span class="k">end</span>

</code></pre></div></div>

<h1 id="reading">Reading</h1>

<p>As we decided before, <code class="language-plaintext highlighter-rouge">ReadBuffer</code> is our class responsible for reading an object from marshalled data.
Here is how it should look:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">PureRubyMarshal::ReadBuffer</span>
  <span class="nb">attr_reader</span> <span class="ss">:data</span>

  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="vi">@data</span> <span class="o">=</span> <span class="n">data</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">read</span>
    <span class="c1"># ...</span>
  <span class="k">end</span>
<span class="k">end</span>

</code></pre></div></div>

<h2 id="decompressing">Decompressing</h2>

<p>First let’s take a look at <code class="language-plaintext highlighter-rouge">Marshal.dump</code>.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">marshalled</span> <span class="o">=</span> <span class="no">Marshal</span><span class="p">.</span><span class="nf">dump</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">'string'</span><span class="p">,</span> <span class="no">Object</span><span class="p">.</span><span class="nf">new</span><span class="p">])</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">marshalled</span><span class="p">.</span><span class="nf">chars</span>
<span class="c1"># =&gt; [a long array of characters]</span>
</code></pre></div></div>

<p>The first two characters represent a version of library that was used for marshalling:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">ord</span>
<span class="c1"># =&gt; 4</span>
<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nf">ord</span>
<span class="c1"># =&gt; 8</span>
</code></pre></div></div>

<p>Which represents a current version of Marshal library - <code class="language-plaintext highlighter-rouge">4.8</code>
(<a href="https://github.com/ruby/ruby/blob/trunk/marshal.c#L54-L55">link to the source</a>).
This values are constants for any marshalled data and they are stored in <code class="language-plaintext highlighter-rouge">Marshal::MAJOR_VERSION</code> and <code class="language-plaintext highlighter-rouge">Marshal::MINOR_VERSION</code>:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="p">:</span><span class="mo">001</span> <span class="o">&gt;</span> <span class="no">Marshal</span><span class="o">::</span><span class="no">MAJOR_VERSION</span>
 <span class="o">=&gt;</span> <span class="mi">4</span>
 <span class="p">:</span><span class="mo">002</span> <span class="o">&gt;</span> <span class="no">Marshal</span><span class="o">::</span><span class="no">MINOR_VERSION</span>
 <span class="o">=&gt;</span> <span class="mi">8</span>
</code></pre></div></div>

<p>Our <code class="language-plaintext highlighter-rouge">PureRubyMarshal</code> should have same constants:</p>
<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">module</span> <span class="nn">PureRubyMarshal</span>
  <span class="no">MAJOR_VERSION</span> <span class="o">=</span> <span class="mi">4</span>
  <span class="no">MINOR_VERSION</span> <span class="o">=</span> <span class="mi">8</span>
<span class="k">end</span>
</code></pre></div></div>

<p>The rest of the array is actually a marshalled object.
So, for now marshalled data looks like <code class="language-plaintext highlighter-rouge">['4.8', some unknown characters]</code></p>

<p>To read the version of <code class="language-plaintext highlighter-rouge">Marshal</code> library we can modify <code class="language-plaintext highlighter-rouge">ReadBuffer#initialize</code>:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">attr_reader</span> <span class="ss">:minor_version</span><span class="p">,</span> <span class="ss">:major_version</span>

<span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
  <span class="vi">@data</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="nf">chars</span>
  <span class="vi">@major_version</span> <span class="o">=</span> <span class="n">read_byte</span>
  <span class="vi">@minor_version</span> <span class="o">=</span> <span class="n">read_byte</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">read_char</span>
  <span class="n">data</span><span class="p">.</span><span class="nf">shift</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">read_byte</span>
  <span class="n">read_char</span><span class="p">.</span><span class="nf">ord</span>
<span class="k">end</span>

<span class="c1"># In irb:</span>
<span class="n">marshalled</span> <span class="o">=</span> <span class="no">Marshal</span><span class="p">.</span><span class="nf">dump</span><span class="p">(</span><span class="mi">123</span><span class="p">)</span>
<span class="n">read_buffer</span> <span class="o">=</span> <span class="no">PureRubyMarshal</span><span class="o">::</span><span class="no">ReadBuffer</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">marshalled</span><span class="p">)</span>
<span class="n">read_buffer</span><span class="p">.</span><span class="nf">major_version</span>
 <span class="o">=&gt;</span> <span class="mi">4</span>
<span class="n">read_buffer</span><span class="p">.</span><span class="nf">minor_version</span>
 <span class="o">=&gt;</span> <span class="mi">8</span>
</code></pre></div></div>

<h2 id="getting-objects-from-the-raw-data">Getting objects from the raw data</h2>

<p>When <code class="language-plaintext highlighter-rouge">Marshal</code> converts your object to a string, it uses very simple rules:</p>
<ul>
  <li>All primitives like <code class="language-plaintext highlighter-rouge">Fixnum</code>, <code class="language-plaintext highlighter-rouge">Hash</code> or <code class="language-plaintext highlighter-rouge">Array</code> always use the same format of serialization,
prepended by a special character (each character for each unique type)</li>
  <li>If an object has instance variables, these ivars are always dumped in the same way (<code class="language-plaintext highlighter-rouge">Iobject{hash:of,instance:variables}</code>)</li>
  <li>You can’t dump multiple objects in a single operation,
so there’s always a root object in marshalled string (which is actually placed in the beginning of the string)</li>
  <li>This object is followed by all other data, like ivars, string encodings etc.</li>
</ul>

<h2 id="nilclass-trueclass-falseclass">NilClass, TrueClass, FalseClass</h2>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">ReadBuffer</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="no">Marshal</span><span class="p">.</span><span class="nf">dump</span><span class="p">(</span><span class="kp">nil</span><span class="p">)).</span><span class="nf">data</span>
 <span class="o">=&gt;</span> <span class="p">[</span><span class="s2">"0"</span><span class="p">]</span>
</code></pre></div></div>

<p>Character <code class="language-plaintext highlighter-rouge">0</code> means that encoded object is <code class="language-plaintext highlighter-rouge">nil</code>. To handle it, we can write something like:</p>
<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">PureRubyMarshal::ReadBuffer</span>
  <span class="c1"># ...</span>

  <span class="k">def</span> <span class="nf">read</span>
    <span class="n">char</span> <span class="o">=</span> <span class="n">read_char</span>
    <span class="k">case</span> <span class="n">char</span>
    <span class="k">when</span> <span class="s1">'0'</span> <span class="k">then</span> <span class="kp">nil</span>
    <span class="k">else</span>
      <span class="k">raise</span> <span class="no">NotImplementedError</span><span class="p">,</span> <span class="s2">"Unknown object type </span><span class="si">#{</span><span class="n">char</span><span class="si">}</span><span class="s2">"</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

 <span class="p">:</span><span class="mo">001</span> <span class="o">&gt;</span> <span class="no">ReadBuffer</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="no">Marshal</span><span class="p">.</span><span class="nf">dump</span><span class="p">(</span><span class="kp">nil</span><span class="p">)).</span><span class="nf">read</span>
 <span class="o">=&gt;</span> <span class="kp">nil</span>
</code></pre></div></div>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="p">:</span><span class="mo">001</span> <span class="o">&gt;</span> <span class="no">ReadBuffer</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="no">Marshal</span><span class="p">.</span><span class="nf">dump</span><span class="p">(</span><span class="kp">true</span><span class="p">)).</span><span class="nf">data</span>
 <span class="o">=&gt;</span> <span class="p">[</span><span class="s2">"T"</span><span class="p">]</span>
 <span class="p">:</span><span class="mo">002</span> <span class="o">&gt;</span> <span class="no">ReadBuffer</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="no">Marshal</span><span class="p">.</span><span class="nf">dump</span><span class="p">(</span><span class="kp">false</span><span class="p">)).</span><span class="nf">data</span>
 <span class="o">=&gt;</span> <span class="p">[</span><span class="s2">"F"</span><span class="p">]</span>
</code></pre></div></div>
<p><code class="language-plaintext highlighter-rouge">true</code> converts to <code class="language-plaintext highlighter-rouge">T</code>, <code class="language-plaintext highlighter-rouge">false</code> converts to <code class="language-plaintext highlighter-rouge">F</code>, nothing complex for now.</p>

<p>Let’s extend our <code class="language-plaintext highlighter-rouge">case</code> statement:</p>
<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">when</span> <span class="s1">'T'</span> <span class="k">then</span> <span class="kp">true</span>
<span class="k">when</span> <span class="s1">'F'</span> <span class="k">then</span> <span class="kp">false</span>
</code></pre></div></div>

<h2 id="tests">Tests</h2>

<p>Of course, we can’t develop without tests,</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># fixtures.rb</span>

<span class="no">FIXTURES</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s1">'nil'</span> <span class="o">=&gt;</span> <span class="kp">nil</span><span class="p">,</span>
  <span class="s1">'true'</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span>
  <span class="s1">'false'</span> <span class="o">=&gt;</span> <span class="kp">false</span>
<span class="p">}</span>

<span class="c1"># pure_ruby_marshal_spec.rb</span>

<span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="no">PureRubyMarshal</span> <span class="k">do</span>
  <span class="n">describe</span> <span class="s1">'.load'</span> <span class="k">do</span>
    <span class="no">FIXTURES</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">fixture_name</span><span class="p">,</span> <span class="n">fixture_value</span><span class="o">|</span>
      <span class="n">it</span> <span class="s2">"loads marshalled </span><span class="si">#{</span><span class="n">fixture_name</span><span class="si">}</span><span class="s2">"</span> <span class="k">do</span>
        <span class="n">result</span> <span class="o">=</span> <span class="no">PureRubyMarshal</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span><span class="no">Marshal</span><span class="p">.</span><span class="nf">dump</span><span class="p">(</span><span class="n">fixture_value</span><span class="p">))</span>
        <span class="n">expect</span><span class="p">(</span><span class="n">result</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="n">fixture_value</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="c1"># rspec --format documentation</span>

<span class="no">PureRubyMarshal</span>
  <span class="p">.</span><span class="nf">load</span>
    <span class="n">loads</span> <span class="n">marshalled</span> <span class="kp">nil</span>
    <span class="n">loads</span> <span class="n">marshalled</span> <span class="kp">true</span>
    <span class="n">loads</span> <span class="n">marshalled</span> <span class="kp">false</span>

<span class="mi">3</span> <span class="n">examples</span><span class="p">,</span> <span class="mi">0</span> <span class="n">failures</span>
</code></pre></div></div>

<h2 id="integer">Integer</h2>

<p>All encoded integers are prepended with an <code class="language-plaintext highlighter-rouge">"i"</code> symbol. Added one more <code class="language-plaintext highlighter-rouge">when</code> to our <code class="language-plaintext highlighter-rouge">case</code>:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">when</span> <span class="s1">'i'</span> <span class="k">then</span> <span class="n">read_integer</span>
</code></pre></div></div>

<p>The next byte defines a strategy of decoding the rest of the data. Then comes a bytes sequence representing a number.</p>

<p>Let’s say that <code class="language-plaintext highlighter-rouge">byte = (first_char_code_after_i ^ 128) - 128</code> (it ranges from <code class="language-plaintext highlighter-rouge">-128 .. 128</code>).</p>

<p>There are 5 different cases depending on the byte value:</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">byte is 0</code></li>
  <li><code class="language-plaintext highlighter-rouge">byte in [4..128]</code></li>
  <li><code class="language-plaintext highlighter-rouge">byte in [1..4]</code></li>
  <li><code class="language-plaintext highlighter-rouge">byte in [-128..-4]</code></li>
  <li><code class="language-plaintext highlighter-rouge">byte in [-5..-1]</code></li>
</ul>

<p>Let’s write a utility lambda to simplify examples:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">get_sequence</span> <span class="o">=</span> <span class="nb">lambda</span> <span class="k">do</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span>
  <span class="n">buffer</span> <span class="o">=</span> <span class="no">ReadBuffer</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="no">Marshal</span><span class="p">.</span><span class="nf">dump</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>
  <span class="n">buffer</span><span class="p">.</span><span class="nf">read_char</span>
  <span class="n">buffer</span><span class="p">.</span><span class="nf">data</span><span class="p">.</span><span class="nf">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:ord</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div></div>

<p>It:</p>
<ul>
  <li>marshalls passed number with native <code class="language-plaintext highlighter-rouge">Marshal</code></li>
  <li>loads it through our pure ruby <code class="language-plaintext highlighter-rouge">ReadBuffer</code></li>
  <li>reads one char (<code class="language-plaintext highlighter-rouge">"i"</code>)</li>
  <li>takes the rest of the data</li>
  <li>and converts characters to their codes</li>
</ul>

<p><strong>The first case</strong> is the simplest one:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">get_sequence</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
 <span class="o">=&gt;</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</code></pre></div></div>
<p>Zero is actually encoded as zero.</p>

<p><strong>The second case</strong>:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">get_sequence</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span>
 <span class="o">=&gt;</span> <span class="p">[</span><span class="mi">12</span><span class="p">]</span>
<span class="n">get_sequence</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span>
 <span class="o">=&gt;</span> <span class="p">[</span><span class="mi">13</span><span class="p">]</span>
<span class="n">get_sequence</span><span class="p">[</span><span class="mi">120</span><span class="p">]</span>
 <span class="o">=&gt;</span> <span class="p">[</span><span class="mi">125</span><span class="p">]</span>
</code></pre></div></div>
<p>In this case <code class="language-plaintext highlighter-rouge">result = byte - 5</code> and it covers small positive numbers.</p>

<p><strong>The third case</strong>:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">get_sequence</span><span class="p">[</span><span class="mi">99999</span><span class="p">]</span>
 <span class="o">=&gt;</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">159</span><span class="p">,</span> <span class="mi">134</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
</code></pre></div></div>

<p>3 means three numbers representing a single number, they should be merged with binary <code class="language-plaintext highlighter-rouge">OR</code> and byte shifting:</p>
<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="mi">159</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">8</span><span class="o">*</span><span class="mi">0</span><span class="p">))</span> <span class="o">|</span> <span class="p">(</span><span class="mi">134</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">8</span><span class="o">*</span><span class="mi">1</span><span class="p">))</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">8</span><span class="o">*</span><span class="mi">2</span><span class="p">))</span>
 <span class="o">=&gt;</span> <span class="mi">99999</span>
</code></pre></div></div>

<p><strong>The fourth and the fifth examples</strong> are just like 2nd and 3rd, but for negative numbers.</p>

<p>Let’s implement our <code class="language-plaintext highlighter-rouge">read_integer</code> method!</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">read_integer</span>
    <span class="c1"># c is our first byte</span>
    <span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="n">read_byte</span> <span class="o">^</span> <span class="mi">128</span><span class="p">)</span> <span class="o">-</span> <span class="mi">128</span>

    <span class="k">case</span> <span class="n">c</span>
    <span class="k">when</span> <span class="mi">0</span>
      <span class="c1"># 0 means 0</span>
      <span class="mi">0</span>
    <span class="k">when</span> <span class="p">(</span><span class="mi">4</span><span class="o">..</span><span class="mi">127</span><span class="p">)</span>
      <span class="c1"># case for small positive numbers</span>
      <span class="n">c</span> <span class="o">-</span> <span class="mi">5</span>
    <span class="k">when</span> <span class="p">(</span><span class="mi">1</span><span class="o">..</span><span class="mi">3</span><span class="p">)</span>
      <span class="c1"># c next bytes is our big positive number</span>
      <span class="n">c</span><span class="p">.</span>
        <span class="nf">times</span><span class="p">.</span>
        <span class="nf">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span> <span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">read_byte</span><span class="p">]</span> <span class="p">}.</span>
        <span class="nf">inject</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">result</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">byte</span><span class="p">)</span><span class="o">|</span> <span class="n">result</span> <span class="o">|</span> <span class="p">(</span><span class="n">byte</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">8</span><span class="o">*</span><span class="n">i</span><span class="p">))</span>  <span class="p">}</span>
    <span class="k">when</span> <span class="p">(</span><span class="o">-</span><span class="mi">128</span><span class="o">..-</span><span class="mi">6</span><span class="p">)</span>
      <span class="c1"># case for small negative numbers</span>
      <span class="n">c</span> <span class="o">+</span> <span class="mi">5</span>
    <span class="k">when</span> <span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="o">..-</span><span class="mi">1</span><span class="p">)</span>
      <span class="c1"># (-c) next bytes is our number</span>
      <span class="p">(</span><span class="o">-</span><span class="n">c</span><span class="p">).</span>
        <span class="nf">times</span><span class="p">.</span>
        <span class="nf">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span> <span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">read_byte</span><span class="p">]</span> <span class="p">}.</span>
        <span class="nf">inject</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">result</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">byte</span><span class="p">)</span><span class="o">|</span>
          <span class="n">a</span> <span class="o">=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0xff</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">8</span><span class="o">*</span><span class="n">i</span><span class="p">))</span>
          <span class="n">b</span> <span class="o">=</span> <span class="n">byte</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">8</span><span class="o">*</span><span class="n">i</span><span class="p">)</span>
          <span class="p">(</span><span class="n">result</span> <span class="o">&amp;</span> <span class="n">a</span><span class="p">)</span> <span class="o">|</span> <span class="n">b</span>
        <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
</code></pre></div></div>

<p>To add tests for integers, we can just add more key-value pairs to our
<code class="language-plaintext highlighter-rouge">FIXTURES</code> constant.</p>

<p>Complex data types like</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">Array</code></li>
  <li><code class="language-plaintext highlighter-rouge">String</code></li>
  <li><code class="language-plaintext highlighter-rouge">Hash</code></li>
  <li><code class="language-plaintext highlighter-rouge">Regexp</code></li>
</ul>

<p>and others include numbers into their encoded structure to represent their length.</p>

<h2 id="symbol">Symbol</h2>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">ReadBuffer</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="no">Marshal</span><span class="p">.</span><span class="nf">dump</span><span class="p">(</span><span class="ss">:a_symbol</span><span class="p">)).</span><span class="nf">data</span>
 <span class="o">=&gt;</span> <span class="p">[</span><span class="s2">":"</span><span class="p">,</span> <span class="s2">"</span><span class="se">\r</span><span class="s2">"</span><span class="p">,</span> <span class="s2">"a"</span><span class="p">,</span> <span class="s2">"_"</span><span class="p">,</span> <span class="s2">"s"</span><span class="p">,</span> <span class="s2">"y"</span><span class="p">,</span> <span class="s2">"m"</span><span class="p">,</span> <span class="s2">"b"</span><span class="p">,</span> <span class="s2">"o"</span><span class="p">,</span> <span class="s2">"l"</span><span class="p">]</span>
</code></pre></div></div>

<p>Symbols are encoded using:</p>
<ul>
  <li>a special <code class="language-plaintext highlighter-rouge">":"</code> character</li>
  <li>Symbol length (<code class="language-plaintext highlighter-rouge">"\r".ord - 5 = 8</code>) as Integer (we can fetch it using <code class="language-plaintext highlighter-rouge">read_integer</code> method)</li>
  <li>The Symbol itself, character by character</li>
</ul>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># one more "when" statement</span>
<span class="k">when</span> <span class="s1">':'</span> <span class="k">then</span> <span class="n">read_symbol</span>

<span class="c1"># and implementation</span>
<span class="k">def</span> <span class="nf">read_symbol</span>
  <span class="n">read_integer</span><span class="p">.</span><span class="nf">times</span><span class="p">.</span><span class="nf">map</span> <span class="p">{</span> <span class="n">read_char</span> <span class="p">}.</span><span class="nf">join</span><span class="p">.</span><span class="nf">to_sym</span>
<span class="k">end</span>
</code></pre></div></div>

<h2 id="string">String</h2>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">ReadBuffer</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="no">Marshal</span><span class="p">.</span><span class="nf">dump</span><span class="p">(</span><span class="s2">"a string"</span><span class="p">)).</span><span class="nf">data</span>
 <span class="o">=&gt;</span> <span class="p">[</span><span class="s2">"</span><span class="se">\"</span><span class="s2">"</span><span class="p">,</span> <span class="s2">"</span><span class="se">\r</span><span class="s2">"</span><span class="p">,</span> <span class="s2">"a"</span><span class="p">,</span> <span class="s2">" "</span><span class="p">,</span> <span class="s2">"s"</span><span class="p">,</span> <span class="s2">"t"</span><span class="p">,</span> <span class="s2">"r"</span><span class="p">,</span> <span class="s2">"i"</span><span class="p">,</span> <span class="s2">"n"</span><span class="p">,</span> <span class="s2">"g"</span><span class="p">]</span>
</code></pre></div></div>

<p>Where:</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">"\""</code> is actually a <code class="language-plaintext highlighter-rouge">"</code> symbol which shows the beginning of the encoded string</li>
  <li>the next encoded number <code class="language-plaintext highlighter-rouge">n = 8</code> is a length of the string</li>
  <li><code class="language-plaintext highlighter-rouge">n</code> following symbols are the string itself.</li>
</ul>

<p>To support loading marshalled string, we can use the following code:</p>
<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># ...</span>
<span class="k">when</span> <span class="s1">'"'</span> <span class="k">then</span> <span class="n">read_string</span>
<span class="c1"># ...</span>
<span class="k">def</span> <span class="nf">read_string</span>
  <span class="n">read_integer</span><span class="p">.</span><span class="nf">times</span><span class="p">.</span><span class="nf">map</span> <span class="p">{</span> <span class="n">read_char</span> <span class="p">}.</span><span class="nf">join</span>
<span class="k">end</span>
</code></pre></div></div>

<h2 id="array">Array</h2>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">ReadBuffer</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="no">Marshal</span><span class="p">.</span><span class="nf">dump</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">])).</span><span class="nf">data</span>
 <span class="o">=&gt;</span> <span class="p">[</span><span class="s2">"["</span><span class="p">,</span> <span class="s2">"</span><span class="se">\b</span><span class="s2">"</span><span class="p">,</span> <span class="s2">"i"</span><span class="p">,</span> <span class="s2">"</span><span class="se">\x06</span><span class="s2">"</span><span class="p">,</span> <span class="s2">"i"</span><span class="p">,</span> <span class="s2">"</span><span class="se">\a</span><span class="s2">"</span><span class="p">,</span> <span class="s2">"i"</span><span class="p">,</span> <span class="s2">"</span><span class="se">\b</span><span class="s2">"</span><span class="p">]</span>
</code></pre></div></div>

<ul>
  <li><code class="language-plaintext highlighter-rouge">"["</code> means that converted object is an <code class="language-plaintext highlighter-rouge">Array</code></li>
  <li>the next encoded number <code class="language-plaintext highlighter-rouge">n = 3</code> is a length of our array</li>
  <li><code class="language-plaintext highlighter-rouge">"i", "1"</code> is an <code class="language-plaintext highlighter-rouge">Integer 1</code></li>
  <li><code class="language-plaintext highlighter-rouge">"i", "2"</code> is an <code class="language-plaintext highlighter-rouge">Integer 2</code></li>
  <li><code class="language-plaintext highlighter-rouge">"i", "3"</code> is an <code class="language-plaintext highlighter-rouge">Integer 3</code></li>
</ul>

<p>Array items are encoded as separate objects, every item is prepended by its own service character:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># ...</span>
<span class="k">when</span> <span class="s1">'['</span> <span class="k">then</span> <span class="n">read_array</span>
<span class="c1"># ...</span>
<span class="k">def</span> <span class="nf">read_array</span>
  <span class="n">read_integer</span><span class="p">.</span><span class="nf">times</span><span class="p">.</span><span class="nf">map</span> <span class="p">{</span> <span class="n">read</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre></div></div>

<h2 id="hash">Hash</h2>

<p><code class="language-plaintext highlighter-rouge">Hash</code> is encoded as an array of key-value pairs:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">ReadBuffer</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="no">Marshal</span><span class="p">.</span><span class="nf">dump</span><span class="p">({</span> <span class="mi">15</span> <span class="o">=&gt;</span> <span class="mi">5</span> <span class="p">})).</span><span class="nf">data</span>
 <span class="o">=&gt;</span> <span class="p">[</span><span class="s2">"{"</span><span class="p">,</span> <span class="s2">"</span><span class="se">\x06</span><span class="s2">"</span><span class="p">,</span> <span class="s2">"i"</span><span class="p">,</span> <span class="s2">"</span><span class="se">\x14</span><span class="s2">"</span><span class="p">,</span> <span class="s2">"i"</span><span class="p">,</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">]</span>
</code></pre></div></div>

<ul>
  <li><code class="language-plaintext highlighter-rouge">"{"</code> is the beginning of hash</li>
  <li><code class="language-plaintext highlighter-rouge">1</code> is a number of <code class="language-plaintext highlighter-rouge">key =&gt; value</code> pairs</li>
  <li><code class="language-plaintext highlighter-rouge">"i" 15</code> is an <code class="language-plaintext highlighter-rouge">Integer 15</code></li>
  <li><code class="language-plaintext highlighter-rouge">"i" 5</code> is an <code class="language-plaintext highlighter-rouge">Integer 5</code></li>
</ul>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># ...</span>
<span class="k">when</span> <span class="s1">'{'</span> <span class="k">then</span> <span class="n">read_hash</span>
<span class="c1"># ...</span>
<span class="k">def</span> <span class="nf">read_hash</span>
  <span class="n">pairs</span> <span class="o">=</span> <span class="n">read_integer</span><span class="p">.</span><span class="nf">times</span><span class="p">.</span><span class="nf">map</span> <span class="p">{</span> <span class="p">[</span><span class="n">read</span><span class="p">,</span> <span class="n">read</span><span class="p">]</span> <span class="p">}</span>
  <span class="no">Hash</span><span class="p">[</span><span class="n">pairs</span><span class="p">]</span>
<span class="k">end</span>
</code></pre></div></div>

<h2 id="float">Float</h2>

<p><code class="language-plaintext highlighter-rouge">Float</code> is encoded as its string representation</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">ReadBuffer</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="no">Marshal</span><span class="p">.</span><span class="nf">dump</span><span class="p">(</span><span class="mf">1.5</span><span class="p">)).</span><span class="nf">data</span>
 <span class="o">=&gt;</span> <span class="p">[</span><span class="s2">"f"</span><span class="p">,</span> <span class="s2">"</span><span class="se">\b</span><span class="s2">"</span><span class="p">,</span> <span class="s2">"1"</span><span class="p">,</span> <span class="s2">"."</span><span class="p">,</span> <span class="s2">"5"</span><span class="p">]</span>
</code></pre></div></div>

<p>Floats are encoded using <code class="language-plaintext highlighter-rouge">#to_s</code> method:</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">"f"</code> is the beginning of <code class="language-plaintext highlighter-rouge">Float</code></li>
  <li><code class="language-plaintext highlighter-rouge">3</code> is the length</li>
  <li><code class="language-plaintext highlighter-rouge">"1", ".", "5"</code> is its string representation</li>
</ul>

<p>To get it back, we can use <code class="language-plaintext highlighter-rouge">String#to_f</code> method:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># ...</span>
<span class="k">when</span> <span class="s1">'f'</span> <span class="k">then</span> <span class="n">read_float</span>
<span class="c1"># ...</span>
<span class="k">def</span> <span class="nf">read_float</span>
  <span class="n">read_string</span><span class="p">.</span><span class="nf">to_f</span>
<span class="k">end</span>
</code></pre></div></div>

<h2 id="class">Class</h2>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">ReadBuffer</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="no">Marshal</span><span class="p">.</span><span class="nf">dump</span><span class="p">(</span><span class="no">Array</span><span class="p">)).</span><span class="nf">data</span>
 <span class="o">=&gt;</span> <span class="p">[</span><span class="s2">"c"</span><span class="p">,</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span> <span class="s2">"A"</span><span class="p">,</span> <span class="s2">"r"</span><span class="p">,</span> <span class="s2">"r"</span><span class="p">,</span> <span class="s2">"a"</span><span class="p">,</span> <span class="s2">"y"</span><span class="p">]</span>
</code></pre></div></div>

<p>Classes are represented by their names:</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">"c"</code> means a <code class="language-plaintext highlighter-rouge">Class</code></li>
  <li><code class="language-plaintext highlighter-rouge">5</code> is the length of its name</li>
  <li>next 5 characters are the name itself</li>
</ul>

<p>After reading the name we can do <code class="language-plaintext highlighter-rouge">Object.const_get(const_name)</code> to retrieve the actual class.
The only remark here is that when the class doesn’t exist anymore,
<code class="language-plaintext highlighter-rouge">Marshal</code> re-raises <code class="language-plaintext highlighter-rouge">ArgumentError, "undefined class/module #{const_name}"</code> instead of a <code class="language-plaintext highlighter-rouge">NameError</code>.
Moreover, if the constant returned by <code class="language-plaintext highlighter-rouge">Object.const_get</code> is not a class,
<code class="language-plaintext highlighter-rouge">Marshal</code> raises <code class="language-plaintext highlighter-rouge">ArgumentError, "#{const_name} does not refer to a Class"</code>.
So, the constant <strong>must</strong> exist and it <strong>must</strong> be a <code class="language-plaintext highlighter-rouge">Class</code></p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># ...</span>
<span class="k">when</span> <span class="s1">'c'</span> <span class="k">then</span> <span class="n">read_class</span>
<span class="c1"># ...</span>
<span class="k">def</span> <span class="nf">marshal_const_get</span><span class="p">(</span><span class="n">const_name</span><span class="p">)</span>
  <span class="no">Object</span><span class="p">.</span><span class="nf">const_get</span><span class="p">(</span><span class="n">const_name</span><span class="p">)</span>
<span class="k">rescue</span> <span class="no">NameError</span>
  <span class="k">raise</span> <span class="no">ArgumentError</span><span class="p">,</span> <span class="s2">"undefined class/module </span><span class="si">#{</span><span class="n">const_name</span><span class="si">}</span><span class="s2">"</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">read_class</span>
  <span class="n">const_name</span> <span class="o">=</span> <span class="n">read_string</span>
  <span class="n">klass</span> <span class="o">=</span> <span class="n">marshal_const_get</span><span class="p">(</span><span class="n">const_name</span><span class="p">)</span>
  <span class="k">unless</span> <span class="n">klass</span><span class="p">.</span><span class="nf">instance_of?</span><span class="p">(</span><span class="no">Class</span><span class="p">)</span>
    <span class="k">raise</span> <span class="no">ArgumentError</span><span class="p">,</span> <span class="s2">"</span><span class="si">#{</span><span class="n">const_name</span><span class="si">}</span><span class="s2"> does not refer to a Class"</span>
  <span class="k">end</span>
  <span class="n">klass</span>
<span class="k">end</span>
</code></pre></div></div>

<p>I’ve extracted <code class="language-plaintext highlighter-rouge">marshal_const_get</code> to a separate method to use it later for
reading a <code class="language-plaintext highlighter-rouge">Module</code> from the marshalled data.</p>

<h2 id="module">Module</h2>

<p>Modules are similar to Classes, but the “magical” character is <code class="language-plaintext highlighter-rouge">"m"</code> instead of <code class="language-plaintext highlighter-rouge">"c"</code>
(and, of course, messages of exceptions are about modules).</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># ...</span>
<span class="k">when</span> <span class="s1">'m'</span> <span class="k">then</span> <span class="n">read_module</span>
<span class="c1"># ...</span>
<span class="k">def</span> <span class="nf">read_module</span>
  <span class="n">const_name</span> <span class="o">=</span> <span class="n">read_string</span>
  <span class="n">klass</span> <span class="o">=</span> <span class="n">marshal_const_get</span><span class="p">(</span><span class="n">const_name</span><span class="p">)</span>
  <span class="k">unless</span> <span class="n">klass</span><span class="p">.</span><span class="nf">instance_of?</span><span class="p">(</span><span class="no">Module</span><span class="p">)</span>
    <span class="k">raise</span> <span class="no">ArgumentError</span><span class="p">,</span> <span class="s2">"</span><span class="si">#{</span><span class="n">const_name</span><span class="si">}</span><span class="s2"> does not refer to a Module"</span>
  <span class="k">end</span>
  <span class="n">klass</span>
<span class="k">end</span>
</code></pre></div></div>

<h2 id="struct">Struct</h2>

<p>Struct are encoded by their class names + their data:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Point</span> <span class="o">=</span> <span class="no">Struct</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">:x</span><span class="p">,</span> <span class="ss">:y</span><span class="p">)</span>
<span class="n">a</span> <span class="o">=</span> <span class="no">Point</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
<span class="no">ReadBuffer</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="no">Marshal</span><span class="p">.</span><span class="nf">dump</span><span class="p">(</span><span class="n">a</span><span class="p">)).</span><span class="nf">data</span>
 <span class="o">=&gt;</span> <span class="p">[</span><span class="s2">"S"</span><span class="p">,</span> <span class="s2">":"</span><span class="p">,</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span> <span class="s2">"P"</span><span class="p">,</span> <span class="s2">"o"</span><span class="p">,</span> <span class="s2">"i"</span><span class="p">,</span> <span class="s2">"n"</span><span class="p">,</span> <span class="s2">"t"</span><span class="p">,</span> <span class="s2">"</span><span class="se">\a</span><span class="s2">"</span><span class="p">,</span> <span class="s2">":"</span><span class="p">,</span> <span class="s2">"</span><span class="se">\x06</span><span class="s2">"</span><span class="p">,</span> <span class="s2">"x"</span><span class="p">,</span> <span class="s2">"i"</span><span class="p">,</span> <span class="s2">"</span><span class="se">\b</span><span class="s2">"</span><span class="p">,</span> <span class="s2">":"</span><span class="p">,</span> <span class="s2">"</span><span class="se">\x06</span><span class="s2">"</span><span class="p">,</span> <span class="s2">"y"</span><span class="p">,</span> <span class="s2">"i"</span><span class="p">,</span> <span class="s2">"</span><span class="se">\f</span><span class="s2">"</span><span class="p">]</span>
</code></pre></div></div>

<p>This output can be split to:</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">"S"</code> means a beginning of encoded <code class="language-plaintext highlighter-rouge">Struct</code></li>
  <li><code class="language-plaintext highlighter-rouge">":", 5, "P", "o", "i", "n", "t"</code> is a Symbol <code class="language-plaintext highlighter-rouge">:Point</code></li>
  <li><code class="language-plaintext highlighter-rouge">2, ":", 1, "x", "i", 2, ":", 1, "y", "i", 3</code> is a visually unmarked Hash (i.e. no <code class="language-plaintext highlighter-rouge">{</code> symbol) with 2 pairs:
    <ul>
      <li><code class="language-plaintext highlighter-rouge">":", 1, "x"</code> is a Symbol <code class="language-plaintext highlighter-rouge">:x</code></li>
      <li><code class="language-plaintext highlighter-rouge">"i", 2</code> is an Integer <code class="language-plaintext highlighter-rouge">2</code></li>
      <li><code class="language-plaintext highlighter-rouge">":", 1, "y"</code> is a Symbol <code class="language-plaintext highlighter-rouge">:y</code></li>
      <li><code class="language-plaintext highlighter-rouge">"i", 3</code> is an Integer <code class="language-plaintext highlighter-rouge">3</code></li>
    </ul>
  </li>
</ul>

<p>So, we have a Struct defined with its class name and the Hash containing object’s data</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># ...</span>
<span class="k">when</span> <span class="s1">'S'</span> <span class="k">then</span> <span class="n">read_struct</span>
<span class="c1"># ...</span>
<span class="k">def</span> <span class="nf">read_struct</span>
  <span class="n">klass</span> <span class="o">=</span> <span class="n">marshal_const_get</span><span class="p">(</span><span class="n">read</span><span class="p">)</span> <span class="c1"># Point</span>
  <span class="n">attributes</span> <span class="o">=</span> <span class="n">read_hash</span> <span class="c1"># { x: 3, y: 7 }</span>
  <span class="n">values</span> <span class="o">=</span> <span class="n">attributes</span><span class="p">.</span><span class="nf">values_at</span><span class="p">(</span><span class="o">*</span><span class="n">klass</span><span class="p">.</span><span class="nf">members</span><span class="p">)</span> <span class="c1"># [3, 7]</span>
  <span class="n">klass</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="o">*</span><span class="n">values</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Why is class name encoded as a <code class="language-plaintext highlighter-rouge">Symbol</code>, not a <code class="language-plaintext highlighter-rouge">String</code>? See section ‘Symbol link’</p>

<h2 id="regexp">Regexp</h2>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">ReadBuffer</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="no">Marshal</span><span class="p">.</span><span class="nf">dump</span><span class="p">(</span><span class="sr">/a_regexp/</span><span class="p">)).</span><span class="nf">data</span>
 <span class="o">=&gt;</span> <span class="p">[</span><span class="s2">"/"</span><span class="p">,</span> <span class="s2">"</span><span class="se">\r</span><span class="s2">"</span><span class="p">,</span> <span class="s2">"a"</span><span class="p">,</span> <span class="s2">"_"</span><span class="p">,</span> <span class="s2">"r"</span><span class="p">,</span> <span class="s2">"e"</span><span class="p">,</span> <span class="s2">"g"</span><span class="p">,</span> <span class="s2">"e"</span><span class="p">,</span> <span class="s2">"x"</span><span class="p">,</span> <span class="s2">"p"</span><span class="p">,</span> <span class="s2">"</span><span class="se">\x00</span><span class="s2">"</span><span class="p">]</span>
</code></pre></div></div>

<p>Alright, there are:</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">"/"</code> - a beginning of a regexp</li>
  <li><code class="language-plaintext highlighter-rouge">8</code> - length of its string representation</li>
  <li><code class="language-plaintext highlighter-rouge">"a_regexp"</code> - string representation</li>
  <li>0 - a <a href="http://ruby-doc.org/core-2.1.1/Regexp.html#method-c-new">kcode</a> that was passed to a constructor</li>
</ul>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># ...</span>
<span class="k">when</span> <span class="s1">'/'</span> <span class="k">then</span> <span class="n">read_regexp</span>
<span class="c1"># ...</span>
<span class="k">def</span> <span class="nf">read_regexp</span>
  <span class="n">string</span> <span class="o">=</span> <span class="n">read_string</span>
  <span class="n">kcode</span> <span class="o">=</span> <span class="n">read_byte</span>
  <span class="no">Regexp</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="n">kcode</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div></div>

<h2 id="abstract-object">Abstract object</h2>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Point2</span>
  <span class="nb">attr_reader</span> <span class="ss">:x</span><span class="p">,</span> <span class="ss">:y</span>

  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="vi">@x</span><span class="p">,</span> <span class="vi">@y</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">==</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
    <span class="n">other</span><span class="p">.</span><span class="nf">is_a?</span><span class="p">(</span><span class="no">Point2</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
      <span class="n">other</span><span class="p">.</span><span class="nf">x</span> <span class="o">==</span> <span class="nb">self</span><span class="p">.</span><span class="nf">x</span> <span class="o">&amp;&amp;</span>
      <span class="n">other</span><span class="p">.</span><span class="nf">y</span> <span class="o">==</span> <span class="nb">self</span><span class="p">.</span><span class="nf">y</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="n">point</span> <span class="o">=</span> <span class="no">Point2</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<span class="no">ReadBuffer</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="no">Marshal</span><span class="p">.</span><span class="nf">dump</span><span class="p">(</span><span class="n">point</span><span class="p">)).</span><span class="nf">data</span>
 <span class="o">=&gt;</span> <span class="p">[</span><span class="s2">"o"</span><span class="p">,</span> <span class="s2">":"</span><span class="p">,</span> <span class="s2">"</span><span class="se">\v</span><span class="s2">"</span><span class="p">,</span> <span class="s2">"P"</span><span class="p">,</span> <span class="s2">"o"</span><span class="p">,</span> <span class="s2">"i"</span><span class="p">,</span> <span class="s2">"n"</span><span class="p">,</span> <span class="s2">"t"</span><span class="p">,</span> <span class="s2">"2"</span><span class="p">,</span> <span class="s2">"</span><span class="se">\a</span><span class="s2">"</span><span class="p">,</span> <span class="s2">":"</span><span class="p">,</span> <span class="s2">"</span><span class="se">\a</span><span class="s2">"</span><span class="p">,</span> <span class="s2">"@"</span><span class="p">,</span> <span class="s2">"x"</span><span class="p">,</span> <span class="s2">"i"</span><span class="p">,</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span> <span class="s2">":"</span><span class="p">,</span> <span class="s2">"</span><span class="se">\a</span><span class="s2">"</span><span class="p">,</span> <span class="s2">"@"</span><span class="p">,</span> <span class="s2">"y"</span><span class="p">,</span> <span class="s2">"i"</span><span class="p">,</span> <span class="s2">"</span><span class="se">\x0F</span><span class="s2">"</span><span class="p">]</span>
</code></pre></div></div>

<ul>
  <li><code class="language-plaintext highlighter-rouge">"o"</code> means the beginning of any non-standard object</li>
  <li><code class="language-plaintext highlighter-rouge">":", 6, "P", "o", "i", "n", "t", "2"</code> is a Symbol <code class="language-plaintext highlighter-rouge">:Point2</code></li>
  <li><code class="language-plaintext highlighter-rouge">2, ":", 2, "@", "x", "i", 5, ":", 2, "@", "y", "i", 10</code> is a Hash with 2 key-value pairs:
    <ul>
      <li>key <code class="language-plaintext highlighter-rouge">":", 2, "@", "x"</code> is a Symbol <code class="language-plaintext highlighter-rouge">@x</code></li>
      <li>value <code class="language-plaintext highlighter-rouge">"i", 5</code> is an Integer <code class="language-plaintext highlighter-rouge">4</code></li>
      <li>key <code class="language-plaintext highlighter-rouge">":", 2, "@", "y"</code> is a Symbol <code class="language-plaintext highlighter-rouge">@y</code></li>
      <li>value <code class="language-plaintext highlighter-rouge">"i", 10</code> is an Integer <code class="language-plaintext highlighter-rouge">5</code></li>
    </ul>
  </li>
</ul>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># ...</span>
<span class="k">when</span> <span class="s1">'o'</span> <span class="k">then</span> <span class="n">read_object</span>
<span class="c1"># ...</span>
<span class="k">def</span> <span class="nf">read_object</span>
  <span class="n">klass</span> <span class="o">=</span> <span class="n">marshal_const_get</span><span class="p">(</span><span class="n">read</span><span class="p">)</span> <span class="c1"># Point2</span>
  <span class="n">ivars_data</span> <span class="o">=</span> <span class="n">read_hash</span> <span class="c1"># { :@x =&gt; 5, :@y = 10 }</span>
  <span class="n">object</span> <span class="o">=</span> <span class="n">klass</span><span class="p">.</span><span class="nf">allocate</span> <span class="c1"># #&lt;Point &gt;</span>
  <span class="n">ivars_data</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">ivar_name</span><span class="p">,</span> <span class="n">value</span><span class="o">|</span>
    <span class="n">object</span><span class="p">.</span><span class="nf">instance_variable_set</span><span class="p">(</span><span class="n">ivar_name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="n">object</span>
<span class="k">end</span>
</code></pre></div></div>

<h2 id="user-class">User class</h2>

<p>User classes are classes inherited from default classes:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">MyArray</span> <span class="o">&lt;</span> <span class="no">Array</span>
<span class="k">end</span>
<span class="n">my_array</span> <span class="o">=</span> <span class="no">MyArray</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span>

<span class="no">ReadBuffer</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="no">Marshal</span><span class="p">.</span><span class="nf">dump</span><span class="p">(</span><span class="n">my_array</span><span class="p">)).</span><span class="nf">data</span>
 <span class="o">=&gt;</span> <span class="p">[</span><span class="s2">"C"</span><span class="p">,</span> <span class="s2">":"</span><span class="p">,</span> <span class="s2">"</span><span class="se">\f</span><span class="s2">"</span><span class="p">,</span> <span class="s2">"M"</span><span class="p">,</span> <span class="s2">"y"</span><span class="p">,</span> <span class="s2">"A"</span><span class="p">,</span> <span class="s2">"r"</span><span class="p">,</span> <span class="s2">"r"</span><span class="p">,</span> <span class="s2">"a"</span><span class="p">,</span> <span class="s2">"y"</span><span class="p">,</span> <span class="s2">"["</span><span class="p">,</span> <span class="s2">"</span><span class="se">\b</span><span class="s2">"</span><span class="p">,</span> <span class="s2">"i"</span><span class="p">,</span> <span class="s2">"</span><span class="se">\x06</span><span class="s2">"</span><span class="p">,</span> <span class="s2">"i"</span><span class="p">,</span> <span class="s2">"</span><span class="se">\a</span><span class="s2">"</span><span class="p">,</span> <span class="s2">"i"</span><span class="p">,</span> <span class="s2">"</span><span class="se">\b</span><span class="s2">"</span><span class="p">]</span>
</code></pre></div></div>

<p>Objects of these classes are encoded in the following way:</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">"C"</code> - a beginning of a user class</li>
  <li><code class="language-plaintext highlighter-rouge">":", 7, "M", "y", "A", "r", "r", "a", "y"</code> - a symbol <code class="language-plaintext highlighter-rouge">:MyArray</code> - the name of the user class</li>
  <li>the rest of the data that should be passed to constructor (array <code class="language-plaintext highlighter-rouge">[1, 2, 3]</code> for this example)</li>
</ul>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># ...</span>
<span class="k">when</span> <span class="s1">'C'</span> <span class="k">then</span> <span class="n">read_userclass</span>
<span class="c1"># ...</span>
<span class="k">def</span> <span class="nf">read_userclass</span>
  <span class="n">klass</span> <span class="o">=</span> <span class="n">marshal_const_get</span><span class="p">(</span><span class="n">read</span><span class="p">)</span>
  <span class="n">data</span> <span class="o">=</span> <span class="n">read</span>
  <span class="n">klass</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div></div>

<h2 id="extended-object">Extended object</h2>

<p>Sometimes your object is very, very complex. Like an object extended with some modules:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">MyModule</span> <span class="o">=</span> <span class="no">Module</span><span class="p">.</span><span class="nf">new</span>
<span class="n">obj</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">obj</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="no">MyModule</span><span class="p">)</span>
</code></pre></div></div>

<p>In this case <code class="language-plaintext highlighter-rouge">Marshal</code> prepends you object structure with the list of extended modules:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">ReadBuffer</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="no">Marshal</span><span class="p">.</span><span class="nf">dump</span><span class="p">(</span><span class="n">obj</span><span class="p">)).</span><span class="nf">data</span>
 <span class="o">=&gt;</span> <span class="p">[</span><span class="s2">"e"</span><span class="p">,</span> <span class="s2">":"</span><span class="p">,</span> <span class="s2">"</span><span class="se">\r</span><span class="s2">"</span><span class="p">,</span> <span class="s2">"M"</span><span class="p">,</span> <span class="s2">"y"</span><span class="p">,</span> <span class="s2">"M"</span><span class="p">,</span> <span class="s2">"o"</span><span class="p">,</span> <span class="s2">"d"</span><span class="p">,</span> <span class="s2">"u"</span><span class="p">,</span> <span class="s2">"l"</span><span class="p">,</span> <span class="s2">"e"</span><span class="p">,</span> <span class="s2">"["</span><span class="p">,</span> <span class="s2">"</span><span class="se">\x00</span><span class="s2">"</span><span class="p">]</span>
</code></pre></div></div>

<p>Where:</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">"e"</code> means that marshalled data has the following scheme:
    <ul>
      <li>a <code class="language-plaintext highlighter-rouge">Symbol</code> that represents a name of a Ruby module (<code class="language-plaintext highlighter-rouge">:MyModule</code>)</li>
      <li>an abstract dumped object that was extended with this module and should be retrieved</li>
    </ul>
  </li>
</ul>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># ...</span>
<span class="k">when</span> <span class="s1">'e'</span> <span class="k">then</span> <span class="n">read_extended_object</span>
<span class="c1"># ...</span>
<span class="k">def</span> <span class="nf">read_extended_object</span>
  <span class="n">mod</span> <span class="o">=</span> <span class="n">marshal_const_get</span><span class="p">(</span><span class="n">read</span><span class="p">)</span> <span class="c1"># MyModule</span>
  <span class="n">object</span> <span class="o">=</span> <span class="n">read</span> <span class="c1"># []</span>
  <span class="n">object</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">mod</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div></div>

<h2 id="symbol-links">Symbol links</h2>

<p>I guess this idea was originally created for compressing marshalled output.
Consider the following situation: you have a collection of objects of the same class
(the simplest example is a result of calling <code class="language-plaintext highlighter-rouge">YourActiveRecordModel.all</code>).
When you pass this collection to <code class="language-plaintext highlighter-rouge">Marshal.dump</code>, it converts objects one by one, writing them to an output stream.
But an abstract object is represented by its class name and a hash of instance variables.
Symbol links save you from writing the same <code class="language-plaintext highlighter-rouge">class.name</code> again and again to the output.
Instead, it remembers all symbols that have been written, and when the symbol appears twice in the sequence,
it writes its sequence number.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">a1</span> <span class="o">=</span> <span class="p">[</span><span class="ss">:symbol1</span><span class="p">,</span> <span class="ss">:symbol2</span><span class="p">]</span>
<span class="n">a2</span> <span class="o">=</span> <span class="p">[</span><span class="ss">:symbol1</span><span class="p">,</span> <span class="ss">:symbol1</span><span class="p">]</span>

<span class="n">dumped1</span> <span class="o">=</span> <span class="no">Marshal</span><span class="p">.</span><span class="nf">dump</span><span class="p">(</span><span class="n">a1</span><span class="p">)</span>
 <span class="o">=&gt;</span> <span class="s2">"</span><span class="se">\x04\b</span><span class="s2">[</span><span class="se">\a</span><span class="s2">:</span><span class="se">\f</span><span class="s2">symbol1:</span><span class="se">\f</span><span class="s2">symbol2"</span>
<span class="n">dumped1</span><span class="p">.</span><span class="nf">length</span>
 <span class="o">=&gt;</span> <span class="mi">22</span>

<span class="n">dumped2</span> <span class="o">=</span> <span class="no">Marshal</span><span class="p">.</span><span class="nf">dump</span><span class="p">(</span><span class="n">a2</span><span class="p">)</span>
 <span class="o">=&gt;</span> <span class="s2">"</span><span class="se">\x04\b</span><span class="s2">[</span><span class="se">\a</span><span class="s2">:</span><span class="se">\f</span><span class="s2">symbol1;</span><span class="se">\x00</span><span class="s2">"</span>
<span class="n">dumped2</span><span class="p">.</span><span class="nf">length</span>
 <span class="o">=&gt;</span> <span class="mi">15</span>
</code></pre></div></div>

<p>For this example it saves us 31% of the initial size. Let’s see how it works:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">ReadBuffer</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="no">Marshal</span><span class="p">.</span><span class="nf">dump</span><span class="p">(</span><span class="n">a2</span><span class="p">)).</span><span class="nf">data</span>
 <span class="o">=&gt;</span> <span class="p">[</span><span class="s2">"["</span><span class="p">,</span> <span class="s2">"</span><span class="se">\a</span><span class="s2">"</span><span class="p">,</span> <span class="s2">":"</span><span class="p">,</span> <span class="s2">"</span><span class="se">\f</span><span class="s2">"</span><span class="p">,</span> <span class="s2">"s"</span><span class="p">,</span> <span class="s2">"y"</span><span class="p">,</span> <span class="s2">"m"</span><span class="p">,</span> <span class="s2">"b"</span><span class="p">,</span> <span class="s2">"o"</span><span class="p">,</span> <span class="s2">"l"</span><span class="p">,</span> <span class="s2">"1"</span><span class="p">,</span> <span class="s2">";"</span><span class="p">,</span> <span class="s2">"</span><span class="se">\x00</span><span class="s2">"</span><span class="p">]</span>
</code></pre></div></div>

<p>So we have an array of two items:</p>
<ul>
  <li>a <code class="language-plaintext highlighter-rouge">Symbol</code> <code class="language-plaintext highlighter-rouge">:symbol1</code></li>
  <li>a special character <code class="language-plaintext highlighter-rouge">";"</code> representing beginning of symbol link and an encoded <code class="language-plaintext highlighter-rouge">Integer</code> that represents a symbol with this index</li>
</ul>

<p>The algorithm for parsing <code class="language-plaintext highlighter-rouge">Symbol</code> should be changed a little bit
to save all symbols to an internal array.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">initialize</span>
  <span class="c1"># ...</span>
  <span class="vi">@symbols_cache</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="c1"># ...</span>
<span class="k">end</span>

<span class="c1"># ...</span>

<span class="k">def</span> <span class="nf">read_symbol</span>
  <span class="n">symbol</span> <span class="o">=</span> <span class="n">read_integer</span><span class="p">.</span><span class="nf">times</span><span class="p">.</span><span class="nf">map</span> <span class="p">{</span> <span class="n">read_char</span> <span class="p">}.</span><span class="nf">join</span><span class="p">.</span><span class="nf">to_sym</span> <span class="c1"># no changes here</span>
  <span class="vi">@symbols_cache</span> <span class="o">&lt;&lt;</span> <span class="n">symbol</span> <span class="c1"># save a symbol</span>
  <span class="n">symbol</span>
<span class="k">end</span>

<span class="c1"># ...</span>

<span class="k">when</span> <span class="s1">';'</span> <span class="k">then</span> <span class="n">read_symbol_link</span>

<span class="c1"># ...</span>

<span class="k">def</span> <span class="nf">read_symbol_link</span>
  <span class="vi">@symbols_cache</span><span class="p">[</span><span class="n">read_integer</span><span class="p">]</span>
<span class="k">end</span>
</code></pre></div></div>

<p>I’ll return to symbol links and my thoughts about how it can be used to compress marshalled output
in “Optimizations” section.</p>

<h2 id="object-links">Object links</h2>

<p>Same story here, when you have an object that appears multiple times in your data, <code class="language-plaintext highlighter-rouge">Marshal</code> will serialize it only once:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">obj1</span> <span class="o">=</span> <span class="no">Object</span><span class="p">.</span><span class="nf">new</span>
<span class="n">obj2</span> <span class="o">=</span> <span class="no">Object</span><span class="p">.</span><span class="nf">new</span>

<span class="n">a1</span> <span class="o">=</span> <span class="p">[</span><span class="n">obj1</span><span class="p">,</span> <span class="n">obj2</span><span class="p">]</span>
<span class="n">a2</span> <span class="o">=</span> <span class="p">[</span><span class="n">obj1</span><span class="p">,</span> <span class="n">obj1</span><span class="p">]</span>

<span class="n">dumped1</span> <span class="o">=</span> <span class="no">Marshal</span><span class="p">.</span><span class="nf">dump</span><span class="p">(</span><span class="n">a1</span><span class="p">)</span>
<span class="n">dumped1</span><span class="p">.</span><span class="nf">length</span>
 <span class="o">=&gt;</span> <span class="mi">18</span>

<span class="n">dumped2</span> <span class="o">=</span> <span class="no">Marshal</span><span class="p">.</span><span class="nf">dump</span><span class="p">(</span><span class="n">a2</span><span class="p">)</span>
<span class="n">dumped2</span><span class="p">.</span><span class="nf">length</span>
 <span class="o">=&gt;</span> <span class="mi">16</span>
</code></pre></div></div>

<p>A symbol that indicates a beginning of an object link is <code class="language-plaintext highlighter-rouge">"@"</code>. However the criteria for
dumping an object link instead of an object itself is objects equality (<code class="language-plaintext highlighter-rouge">equal?</code>).
Here’s the problem: if you dump an array <code class="language-plaintext highlighter-rouge">[{}, {}]</code>, <code class="language-plaintext highlighter-rouge">Marshal</code> will dump
both objects without any object links, because these objects are not equal.</p>

<p>Also <code class="language-plaintext highlighter-rouge">Marshal</code> doesn’t cache:</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">true</code>/<code class="language-plaintext highlighter-rouge">false</code>/<code class="language-plaintext highlighter-rouge">nil</code></li>
  <li><code class="language-plaintext highlighter-rouge">Integer</code></li>
  <li><code class="language-plaintext highlighter-rouge">String</code> when it’s a part of float/regexp</li>
  <li><code class="language-plaintext highlighter-rouge">Hash</code> when it’s a hash of instance variables/struct members</li>
</ul>

<p>Which is mostly correct.</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">true</code>/<code class="language-plaintext highlighter-rouge">false</code>/<code class="language-plaintext highlighter-rouge">nil</code>/integers/floats always point to the same object in the memory</li>
  <li>If we dump <code class="language-plaintext highlighter-rouge">[s, Regexp.new(s)]</code> it will not create an object link. Why? <code class="language-plaintext highlighter-rouge">Regexp.new</code> always creates a copy of the string inside, so there’s no way to save any memory using object links, <code class="language-plaintext highlighter-rouge">regexp.source</code> is always a unique object in the memory.</li>
  <li>If we dump two objects with the same hash of instance variables there are two cases:
    <ul>
      <li>If these objects have the same class, then it’s almost 100% gurantee
that these objects are the same. Then the output stream looks like <code class="language-plaintext highlighter-rouge">[Object, ObjectLink]</code>.</li>
      <li>If these objects have a different class but the same hash of ivars -
then we shouldn’t create an object link and that’s correct.</li>
    </ul>
  </li>
</ul>

<p>The code for object links is quite big to paste it here, you can find it
<a href="https://github.com/iliabylich/pure_ruby_marshal/commit/a26aa1aecec20cee1c2a908673fe79275dcdfa58">here</a></p>

<h2 id="other-cases">Other cases</h2>

<p>To be honest, there are a few more cases, but they are too complex
for implementing and pasting it here. I’m not going to cover here:</p>
<ul>
  <li>Encoding</li>
  <li>User marshalled objects (i.e. with <code class="language-plaintext highlighter-rouge">marshal_dump/load</code>)</li>
  <li>Bignum</li>
  <li>Edge cases of <code class="language-plaintext highlighter-rouge">Float</code> like infinity</li>
  <li>Some stuff that I just don’t know from marshalling like UserDef/Hashdef/ModuleOld</li>
</ul>

<h1 id="writing">Writing</h1>

<p>If you’ve read the previous part, I suppose it should be clear for you how to write it youself :)</p>

<h1 id="optimizations">Optimizations</h1>

<p>Let’s try on the real-world examples. Stuff that usually gets serialized is your data.
And I can remember only one example where <code class="language-plaintext highlighter-rouge">Marshal</code> is used - model caching.</p>

<p>Imagine I have a model <code class="language-plaintext highlighter-rouge">User</code> with the following columns:</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">id</code></li>
  <li><code class="language-plaintext highlighter-rouge">email</code></li>
  <li><code class="language-plaintext highlighter-rouge">created_at</code>/<code class="language-plaintext highlighter-rouge">updated_at</code></li>
</ul>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Marshal</span><span class="p">.</span><span class="nf">dump</span><span class="p">(</span><span class="no">User</span><span class="p">.</span><span class="nf">first</span><span class="p">).</span><span class="nf">length</span>
 <span class="o">=&gt;</span> <span class="mi">891</span>
</code></pre></div></div>

<p>That’s a lot… The easiest solution is to dump only <code class="language-plaintext highlighter-rouge">attributes</code> hash:</p>
<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="k">def</span> <span class="nf">marshal_dump</span><span class="p">(</span><span class="o">*</span><span class="p">)</span>
    <span class="n">attributes</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">marshal_load</span><span class="p">(</span><span class="n">attributes</span><span class="p">)</span>
    <span class="n">initialize</span><span class="p">(</span><span class="n">attributes</span><span class="p">)</span>
    <span class="vi">@new_record</span> <span class="o">=</span> <span class="nb">id</span><span class="p">.</span><span class="nf">blank?</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="no">Marshal</span><span class="p">.</span><span class="nf">load</span> <span class="no">Marshal</span><span class="p">.</span><span class="nf">dump</span><span class="p">(</span><span class="no">User</span><span class="p">.</span><span class="nf">first</span><span class="p">)</span>
 <span class="o">=&gt;</span> <span class="c1">#&lt;User id: 131 ...&gt;</span>
<span class="no">Marshal</span><span class="p">.</span><span class="nf">dump</span><span class="p">(</span><span class="no">User</span><span class="p">.</span><span class="nf">first</span><span class="p">).</span><span class="nf">length</span>
 <span class="o">=&gt;</span> <span class="mi">205</span>
</code></pre></div></div>

<p>That’s better, let’s see what else we can improve.</p>

<p>By default <code class="language-plaintext highlighter-rouge">ActiveRecord::Base#attributes</code> returns a hash where keys are <code class="language-plaintext highlighter-rouge">String</code>. That sounds like
it can be optimized by calling <code class="language-plaintext highlighter-rouge">attributes.symbolize_keys</code> in <code class="language-plaintext highlighter-rouge">marshal_dump</code> to use symbol links
when we dump a collection. <strong>But that’s not true!</strong></p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">User</span><span class="p">.</span><span class="nf">all</span><span class="p">.</span><span class="nf">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:attributes</span><span class="p">).</span><span class="nf">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:keys</span><span class="p">).</span><span class="nf">flatten</span><span class="p">.</span><span class="nf">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:object_id</span><span class="p">).</span><span class="nf">uniq</span><span class="p">.</span><span class="nf">length</span>
 <span class="o">=&gt;</span> <span class="mi">4</span> <span class="p">(</span><span class="k">for</span> <span class="mi">4</span> <span class="n">columns</span><span class="p">)</span>
</code></pre></div></div>

<p>This is an amazing example of optimization!</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">User</span><span class="o">::</span><span class="no">AttrNames</span><span class="p">.</span><span class="nf">constants</span>
 <span class="o">=&gt;</span> <span class="p">[</span><span class="ss">:ATTR_9646</span><span class="p">,</span> <span class="ss">:ATTR_56d61696c6</span><span class="p">,</span> <span class="ss">:ATTR_36275616475646f51647</span><span class="p">,</span> <span class="ss">:ATTR_57074616475646f51647</span><span class="p">]</span>

<span class="no">User</span><span class="o">::</span><span class="no">AttrNames</span><span class="p">.</span><span class="nf">constants</span><span class="p">.</span><span class="nf">map</span> <span class="k">do</span> <span class="o">|</span><span class="n">const_name</span><span class="o">|</span>
  <span class="no">User</span><span class="o">::</span><span class="no">AttrNames</span><span class="p">.</span><span class="nf">const_get</span><span class="p">(</span><span class="n">const_name</span><span class="p">)</span>
<span class="k">end</span>
 <span class="o">=&gt;</span> <span class="p">[</span><span class="s2">"id"</span><span class="p">,</span> <span class="s2">"email"</span><span class="p">,</span> <span class="s2">"created_at"</span><span class="p">,</span> <span class="s2">"updated_at"</span><span class="p">]</span>
</code></pre></div></div>

<p>Keys in the <code class="language-plaintext highlighter-rouge">attributes</code> hash are from these constants, so they are always the same
objects, so <code class="language-plaintext highlighter-rouge">Marshal</code> cashes them using object links.</p>

<p>By the way, why does ActiveRecord save attribute names as <code class="language-plaintext highlighter-rouge">String</code>? The answer is simple,
<code class="language-plaintext highlighter-rouge">Symbol</code> doesn’t support encodings.</p>

<p>Well, currently our record is represented by:</p>
<ul>
  <li>class name as a symbol (so it’s cacheable)</li>
  <li>hash of attributes:
    <ol>
      <li><code class="language-plaintext highlighter-rouge">String</code> “id” / object link</li>
      <li><code class="language-plaintext highlighter-rouge">Integer</code> id - can’t do anything here</li>
      <li><code class="language-plaintext highlighter-rouge">String</code> “email” / object link</li>
      <li><code class="language-plaintext highlighter-rouge">String</code> email - nothing to optimize</li>
      <li><code class="language-plaintext highlighter-rouge">String</code> “created_at” / object link</li>
      <li><code class="language-plaintext highlighter-rouge">ActiveSupport::TimeWithZone</code> created_at - probably optimizable</li>
      <li><code class="language-plaintext highlighter-rouge">String</code> “updated_at” / object link</li>
      <li><code class="language-plaintext highlighter-rouge">ActiveSupport::TimeWithZone</code> udpated_at - see #6</li>
    </ol>
  </li>
</ul>

<p>Let’s see what happens when we serialize <code class="language-plaintext highlighter-rouge">AS::TimeWithZone</code>:</p>
<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Marshal</span><span class="p">.</span><span class="nf">dump</span><span class="p">(</span><span class="no">Time</span><span class="p">.</span><span class="nf">zone</span><span class="p">.</span><span class="nf">now</span><span class="p">).</span><span class="nf">length</span>
 <span class="o">=&gt;</span> <span class="mi">120</span>
</code></pre></div></div>

<p>So, from 205 characters of our record 120 is taken for a time with zone. <code class="language-plaintext highlighter-rouge">AS::TimeWithZone</code> has
its custom implementation of <code class="language-plaintext highlighter-rouge">marshal_load</code> that converts it to <code class="language-plaintext highlighter-rouge">[utc, zone, time]</code>.
If you always use your application time zone,
then you can store it as epoch time:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">ActiveSupport::TimeWithZone</span>
  <span class="k">def</span> <span class="nf">marshal_dump</span><span class="p">(</span><span class="o">*</span><span class="p">)</span>
    <span class="n">to_i</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">marshal_load</span><span class="p">(</span><span class="n">epoch</span><span class="p">)</span>
    <span class="n">utc</span> <span class="o">=</span> <span class="no">Time</span><span class="p">.</span><span class="nf">at</span><span class="p">(</span><span class="n">epoch</span><span class="p">)</span>
    <span class="n">zone</span> <span class="o">=</span> <span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">config</span><span class="p">.</span><span class="nf">time_zone</span>
    <span class="n">local</span> <span class="o">=</span> <span class="n">utc</span><span class="p">.</span><span class="nf">in_time_zone</span><span class="p">(</span><span class="n">zone</span><span class="p">)</span>
    <span class="n">initialize</span><span class="p">(</span><span class="n">utc</span><span class="p">.</span><span class="nf">utc</span><span class="p">,</span> <span class="o">::</span><span class="no">Time</span><span class="p">.</span><span class="nf">find_zone</span><span class="p">(</span><span class="n">zone</span><span class="p">),</span> <span class="n">local</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Marshal</span><span class="p">.</span><span class="nf">dump</span><span class="p">(</span><span class="no">User</span><span class="p">.</span><span class="nf">first</span><span class="p">).</span><span class="nf">length</span>
 <span class="o">=&gt;</span> <span class="mi">139</span>
<span class="no">Marshal</span><span class="p">.</span><span class="nf">dump</span><span class="p">(</span><span class="no">User</span><span class="p">.</span><span class="nf">first</span><span class="p">(</span><span class="mi">3</span><span class="p">)).</span><span class="nf">length</span>
 <span class="o">=&gt;</span> <span class="mi">261</span>
</code></pre></div></div>

<p>Personally I’m not sure that the next optimization is a good idea, but you can try:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">marshallable_attributes</span>
    <span class="vi">@marshallable_attributes</span> <span class="o">||=</span> <span class="sx">%w(
      id
      email
      created_at
      updated_at
    )</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">marshal_dump</span><span class="p">(</span><span class="o">*</span><span class="p">)</span>
    <span class="nb">self</span><span class="p">.</span><span class="nf">class</span><span class="p">.</span><span class="nf">marshallable_attributes</span><span class="p">.</span><span class="nf">map</span> <span class="k">do</span> <span class="o">|</span><span class="n">attribute</span><span class="o">|</span>
      <span class="n">attributes</span><span class="p">[</span><span class="n">attribute</span><span class="p">]</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">marshal_load</span><span class="p">(</span><span class="n">attributes</span><span class="p">)</span>
    <span class="n">attributes</span> <span class="o">=</span> <span class="nb">self</span><span class="p">.</span><span class="nf">class</span><span class="p">.</span><span class="nf">marshallable_attributes</span><span class="p">.</span><span class="nf">zip</span><span class="p">(</span><span class="n">attributes</span><span class="p">)</span>
    <span class="n">attributes</span> <span class="o">=</span> <span class="no">Hash</span><span class="p">[</span><span class="n">attributes</span><span class="p">]</span>
    <span class="n">initialize</span><span class="p">(</span><span class="n">attributes</span><span class="p">)</span>
    <span class="vi">@new_record</span> <span class="o">=</span> <span class="nb">id</span><span class="p">.</span><span class="nf">blank?</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>The idea is to store a hard-coded sequence of attribute names and using it
serialize only values of attributes. It allows us to not serialize object links
of attribute names.</p>

<p>Why can’t we just get <code class="language-plaintext highlighter-rouge">attributes.keys.sort</code>? Because you can add one more
column that may come to the middle of that array. As a result, your
attributes may become shuffled. But probably you can avoid it by changing a cache key
right after adding a column.</p>

<p>You can extend this solution to something similar to <code class="language-plaintext highlighter-rouge">ActiveModel::Serializer</code>
where you have a separate serializer class for every model class.</p>

<p>Let’s see what this optimization gives us:</p>
<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Marshal</span><span class="p">.</span><span class="nf">dump</span><span class="p">(</span><span class="no">User</span><span class="p">.</span><span class="nf">first</span><span class="p">).</span><span class="nf">length</span>
 <span class="o">=&gt;</span> <span class="mi">84</span>
<span class="no">Marshal</span><span class="p">.</span><span class="nf">dump</span><span class="p">(</span><span class="no">User</span><span class="p">.</span><span class="nf">first</span><span class="p">(</span><span class="mi">3</span><span class="p">).</span><span class="nf">to_a</span><span class="p">).</span><span class="nf">length</span>
 <span class="o">=&gt;</span> <span class="mi">190</span>
</code></pre></div></div>

<p>That’s 10 times less then initial size, good job!</p>

<p>Of course, if you have columns with type <code class="language-plaintext highlighter-rouge">text</code> there’s nothing to
optimize, this is my example and my expirience.</p>

<h1 id="what-is-it-for">What is it for?</h1>

<p>I’ve been working for about 3 weeks on implementing <code class="language-plaintext highlighter-rouge">Marshal</code> module for <a href="https://github.com/opal/opal">opal</a>.
It’s almost compatible with MRI implementation. I believe <code class="language-plaintext highlighter-rouge">Marshal</code> is the thing
that can bring real isomorphism to opal applications. If you have a dumpable object
on the server and its class was compiled on the client, you can pass it <strong>directly</strong>
from the server without any serialization on the client/server.</p>

<h1 id="links">Links</h1>

<p><a href="https://github.com/iliabylich/pure_ruby_marshal">Github repo with PureRubyMarshal</a></p>

<p><a href="https://github.com/opal/opal/pull/1191">Possible Opal implementation of Marshal</a></p>

</div>


  <div class="comments">
    <div id="disqus_thread"></div>
    <script>
        var disqus_config = function () {
          this.page.url = document.location.href;  // Replace PAGE_URL with your page's canonical URL variable
          this.page.identifier = document.location.pathname; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
        };
        (function() { // DON'T EDIT BELOW THIS LINE
          var d = document, s = d.createElement('script');
          s.src = 'https://ibylich-myblog.disqus.com/embed.js';
          s.setAttribute('data-timestamp', +new Date());
          (d.head || d.body).appendChild(s);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>


<div class="related">
  <h2>Related Posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/2021/12/27/writing-bindings-upside-down.html">
            Writing bindings upside down
            <small>27 Dec 2021</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2020/11/22/lib-ruby-parser.html">
            lib-ruby-parser
            <small>22 Nov 2020</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2020/01/25/evaluating-ruby-in-ruby.html">
            Evaluating Ruby in Ruby
            <small>25 Jan 2020</small>
          </a>
        </h3>
      </li>
    
  </ul>
</div>

    </div>
  </body>
</html>
