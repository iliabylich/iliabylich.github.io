<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=cache-control content="max-age=0"><meta http-equiv=cache-control content="no-cache"><meta http-equiv=expires content="0"><meta http-equiv=expires content="Tue, 01 Jan 1980 1:00:00 GMT"><meta http-equiv=pragma content="no-cache"><link rel=apple-touch-icon-precomposed sizes=192x192 href=/icon-192x192.png><link rel="shortcut icon" href=/favicon.ico><link rel=preconnect href=https://fonts.googleapis.com crossorigin><link rel=preload href="https://fonts.googleapis.com/css2?family=Inter&display=swap" onload='this.onload=null,this.rel="stylesheet",this.removeAttribute("as")' as=style><noscript><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=Inter&display=swap"></noscript><meta name=description content="HandlerSocket + Ruby"><title>HandlerSocket + Ruby</title>





<link rel="stylesheet" href="/css/main.c8826345ad7ba562c619be2596e20207fe470ef61aecf9db4c6405371222040f.css" integrity="sha256-yIJjRa17pWLGGb4lluICB/5HDvYa7PnbTGQFNxIiBA8=" crossorigin="anonymous">





</head><body class="m-auto px-4 xl:pl-80 font-inter dark:bg-gray-900 text-black dark:text-gray-400"><nav class="pt-5 pb-5"><ul class="flex flex-row items-center justify-start"><li class=pr-3><a class="text-blue-500 hover:underline dark:text-blue-300" href=/>Home</a></li><li class=pr-3><a class="text-blue-500 hover:underline dark:text-blue-300" href=https://github.com/iliabylich>GitHub</a></li><li class=pr-3><a class="text-blue-500 hover:underline dark:text-blue-300" href=https://twitter.com/IlyaBylich>Twitter</a></li><li class=pr-3><a class="text-blue-500 hover:underline dark:text-blue-300" href=mailto:ibylich@gmail.com>Email me</a></li><li class=pr-3><a class="text-blue-500 hover:underline dark:text-blue-300" href=/index.xml>RSS</a></li></ul></nav><div class=pb-2><h1 class="font-bold text-2xl pb-5">HandlerSocket + Ruby</h1><span>Nov 10, 2015</span></div><aside class="relative bg-gray-200 border-1 p-6 border-black dark:bg-gray-800 xl:dark:bg-transparent xl:fixed xl:left-1 xl:top-1 xl:w-80 xl:bg-transparent xl:border-0 xl:text-xs"><a class="block hover:underline pl-0" href=#what-is-handlersocket-hs>What is HandlerSocket (HS)
</a><a class="block hover:underline pl-0" href=#installation>Installation
</a><a class="block hover:underline pl-0" href=#configuration>Configuration
</a><a class="block hover:underline pl-0" href=#simple-queries>Simple queries
</a><a class="block hover:underline pl-0" href=#use-cases>Use cases
</a><a class="block hover:underline pl-0" href=#ruby-adapter>Ruby adapter
</a><a class="block hover:underline pl-0" href=#adapter-api>Adapter API
</a><a class="block hover:underline pl-0" href=#benchmarks>Benchmarks
</a><a class="block hover:underline pl-0" href=#future-plans>Future plans
</a><a class="block hover:underline pl-0" href=#conclusion>Conclusion
</a><a class="block hover:underline pl-0" href=#links>Links</a></aside><main><h1 id=what-is-handlersocket-hs class="text-4xl border-b-2 mt-8 mb-2 border-black dark:border-gray-400">What is HandlerSocket (HS)
<a href=#what-is-handlersocket-hs>#</a></h1><ul><li>a plugin for MySQL</li><li>which allows you to read/write to MySQL</li><li>and gives you a separate connection to MySQL</li><li>and does not allow you to run SQL queries</li><li>but allows to run simple CRUD queries <em>only</em> using indexes</li></ul><p>HandlerSocket query language is very simple (I&rsquo;d even say it&rsquo;s primitive), but it&rsquo;s much faster than MySQL&rsquo;s one. Though, of course, there are some limitations. Interested?</p><h1 id=installation class="text-4xl border-b-2 mt-8 mb-2 border-black dark:border-gray-400">Installation
<a href=#installation>#</a></h1><p>You already have it if you are using Percona Server or MariaDB. If not, install it from <a class="text-blue-500 hover:underline" href=https://github.com/DeNA/HandlerSocket-Plugin-for-MySQL target=_blank rel="noreferrer nofollow">the source</a>
.</p><p>To activate the plugin, run:</p><div class="group relative"><button class="hidden group-hover:inline absolute top-0.5 right-0.5 bg-gray-200 p-2 hover:bg-gray-400" data-copy=true>copy</button><pre class="bg-neutral-800 text-white p-4"><span style=display:flex><span>INSTALL PLUGIN handlersocket SONAME <span style=color:#e6db74>&#39;handlersocket.so&#39;</span>;</span></span></pre></div><h1 id=configuration class="text-4xl border-b-2 mt-8 mb-2 border-black dark:border-gray-400">Configuration
<a href=#configuration>#</a></h1><p>My configuration is the following:</p><div class="group relative"><button class="hidden group-hover:inline absolute top-0.5 right-0.5 bg-gray-200 p-2 hover:bg-gray-400" data-copy=true>copy</button><pre class="bg-neutral-800 text-white p-4"><span style=display:flex><span># [mysqld] section
</span></span><span style=display:flex><span># the port number to bind to for read requests
</span></span><span style=display:flex><span>loose_handlersocket_port = 9998
</span></span><span style=display:flex><span># the port number to bind to for write requests
</span></span><span style=display:flex><span>loose_handlersocket_port_wr = 9999
</span></span><span style=display:flex><span># the number of worker threads for read requests
</span></span><span style=display:flex><span>loose_handlersocket_threads = 16
</span></span><span style=display:flex><span># the number of worker threads for write requests
</span></span><span style=display:flex><span>loose_handlersocket_threads_wr = 1
</span></span><span style=display:flex><span>open_files_limit = 65535</span></span></pre></div><p>You can find a detailed documentation of all available configuration options <a class="text-blue-500 hover:underline" href=https://github.com/ahiguti/HandlerSocket-Plugin-for-MySQL/blob/master/docs-en/configuration-options.en.txt target=_blank rel="noreferrer nofollow">here</a></p><p>Restart your MySQL server and run:</p><div class="group relative"><button class="hidden group-hover:inline absolute top-0.5 right-0.5 bg-gray-200 p-2 hover:bg-gray-400" data-copy=true>copy</button><pre class="bg-neutral-800 text-white p-4"><span style=display:flex><span><span style=color:#66d9ef>show</span> processlist<span style=color:#960050;background-color:#1e0010>\</span><span style=color:#66d9ef>G</span></span></span></pre></div><p>You should see a lot of rows like:</p><div class="group relative"><button class="hidden group-hover:inline absolute top-0.5 right-0.5 bg-gray-200 p-2 hover:bg-gray-400" data-copy=true>copy</button><pre class="bg-neutral-800 text-white p-4"><span style=display:flex><span>           Id: <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>         <span style=color:#66d9ef>User</span>: <span style=color:#66d9ef>system</span> <span style=color:#66d9ef>user</span>
</span></span><span style=display:flex><span>         <span style=color:#66d9ef>Host</span>: connecting <span style=color:#66d9ef>host</span>
</span></span><span style=display:flex><span>           db: <span style=color:#66d9ef>NULL</span>
</span></span><span style=display:flex><span>      Command: <span style=color:#66d9ef>Connect</span>
</span></span><span style=display:flex><span>         Time: <span style=color:#66d9ef>NULL</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>State</span>: handlersocket: <span style=color:#66d9ef>mode</span><span style=color:#f92672>=</span>rd, <span style=color:#ae81ff>0</span> conns, <span style=color:#ae81ff>0</span> active
</span></span><span style=display:flex><span>         Info: <span style=color:#66d9ef>NULL</span>
</span></span><span style=display:flex><span>    Rows_sent: <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>Rows_examined: <span style=color:#ae81ff>0</span></span></span></pre></div><p>which means that HS daemon is up and running.</p><h1 id=simple-queries class="text-4xl border-b-2 mt-8 mb-2 border-black dark:border-gray-400">Simple queries
<a href=#simple-queries>#</a></h1><p>You can test it locally using <code>telnet</code>:</p><div class="group relative"><button class="hidden group-hover:inline absolute top-0.5 right-0.5 bg-gray-200 p-2 hover:bg-gray-400" data-copy=true>copy</button><pre class="bg-neutral-800 text-white p-4"><span style=display:flex><span>$ telnet 0.0.0.0 <span style=color:#ae81ff>9999</span>
</span></span><span style=display:flex><span>Trying 0.0.0.0...
</span></span><span style=display:flex><span>Connected to 0.0.0.0.
</span></span><span style=display:flex><span>Escape character is <span style=color:#e6db74>&#39;^]&#39;</span>.</span></span></pre></div><p>Type <code>P -> 0 -> your_database -> your_table -> PRIMARY -> id,some_column</code> (where <code>-></code> is Tab). And press Enter. It should return <code>0 -> 1</code>.</p><p>This protocol looks ugly, but it may save you a lot of network usage. It&rsquo;s very compact, and parsing does not require any CPU usage.</p><h1 id=use-cases class="text-4xl border-b-2 mt-8 mb-2 border-black dark:border-gray-400">Use cases
<a href=#use-cases>#</a></h1><p>If you don&rsquo;t have too much queries per second, probably you don&rsquo;t need HS. It does not optimize queries, but you may save some time on request parsing + some network. You may find it interesting if you have a lot of simple queries, like simple <code>SELECT</code>&rsquo;s by primary key.</p><h1 id=ruby-adapter class="text-4xl border-b-2 mt-8 mb-2 border-black dark:border-gray-400">Ruby adapter
<a href=#ruby-adapter>#</a></h1><p>Here goes my Ruby for HandlerSocket protocol. You can find it <a class="text-blue-500 hover:underline" href=https://github.com/iliabylich/handlersocket-ruby target=_blank rel="noreferrer nofollow">here</a>
.</p><p>It has two implementations inside:</p><ul><li><a class="text-blue-500 hover:underline" href=https://github.com/iliabylich/handlersocket-ruby/blob/master/lib/handlersocket/pure.rb target=_blank rel="noreferrer nofollow">Ruby-based</a></li><li><a class="text-blue-500 hover:underline" href=https://github.com/iliabylich/handlersocket-ruby/blob/master/ext/handlersocket_ext/handlersocket_ext.c target=_blank rel="noreferrer nofollow">C-based</a></li></ul><p>Ruby implementation is very slow, it&rsquo;s there mainly to explain the protocol. C-based is quite fast.</p><h1 id=adapter-api class="text-4xl border-b-2 mt-8 mb-2 border-black dark:border-gray-400">Adapter API
<a href=#adapter-api>#</a></h1><p>To require a specific implementation, run</p><div class="group relative"><button class="hidden group-hover:inline absolute top-0.5 right-0.5 bg-gray-200 p-2 hover:bg-gray-400" data-copy=true>copy</button><pre class="bg-neutral-800 text-white p-4"><span style=display:flex><span><span style=color:#75715e># For slow pure Ruby implementation</span>
</span></span><span style=display:flex><span>require <span style=color:#e6db74>&#39;handlersocket/pure&#39;</span>
</span></span><span style=display:flex><span><span style=color:#75715e># For fast C implementation</span>
</span></span><span style=display:flex><span>require <span style=color:#e6db74>&#39;handlersocket/ext&#39;</span></span></span></pre></div><p>To create a connection, run</p><div class="group relative"><button class="hidden group-hover:inline absolute top-0.5 right-0.5 bg-gray-200 p-2 hover:bg-gray-400" data-copy=true>copy</button><pre class="bg-neutral-800 text-white p-4"><span style=display:flex><span>hs <span style=color:#f92672>=</span> <span style=color:#66d9ef>Handlersocket</span><span style=color:#f92672>.</span>new(<span style=color:#e6db74>&#39;0.0.0.0&#39;</span>, <span style=color:#ae81ff>9999</span>)</span></span></pre></div><p>Both pure Ruby and C implementations have the same API, so the <code>require</code> place is the only difference.</p><p>To open an index, run</p><div class="group relative"><button class="hidden group-hover:inline absolute top-0.5 right-0.5 bg-gray-200 p-2 hover:bg-gray-400" data-copy=true>copy</button><pre class="bg-neutral-800 text-white p-4"><span style=display:flex><span>hs<span style=color:#f92672>.</span>open_index(<span style=color:#e6db74>&#39;0&#39;</span>, <span style=color:#e6db74>&#39;hs_test&#39;</span>, <span style=color:#e6db74>&#39;users&#39;</span>, <span style=color:#e6db74>&#39;PRIMARY&#39;</span>, <span style=color:#f92672>[</span><span style=color:#e6db74>&#39;id&#39;</span>, <span style=color:#e6db74>&#39;email&#39;</span><span style=color:#f92672>]</span>)</span></span></pre></div><p>To read the data from that index, run</p><div class="group relative"><button class="hidden group-hover:inline absolute top-0.5 right-0.5 bg-gray-200 p-2 hover:bg-gray-400" data-copy=true>copy</button><pre class="bg-neutral-800 text-white p-4"><span style=display:flex><span>hs<span style=color:#f92672>.</span>find(<span style=color:#e6db74>&#39;0&#39;</span>, <span style=color:#e6db74>&#39;=&#39;</span>, <span style=color:#f92672>[</span><span style=color:#e6db74>&#39;12&#39;</span><span style=color:#f92672>]</span>, <span style=color:#f92672>[</span><span style=color:#e6db74>&#39;100]&#39;</span><span style=color:#f92672>]</span>)
</span></span><span style=display:flex><span><span style=color:#75715e># Which is equal to</span>
</span></span><span style=display:flex><span><span style=color:#75715e># SELECT id, name FROM hs_test.users WHERE id = 12 LIMIT 100</span></span></span></pre></div><p>Other commands like <code>auth</code>/<code>insert</code>/<code>update</code>/<code>delete</code> are not there yet. But it&rsquo;s not that difficult to add them, check out <a class="text-blue-500 hover:underline" href=https://github.com/iliabylich/handlersocket-ruby/blob/master/lib/handlersocket.rb#L37 target=_blank rel="noreferrer nofollow">this file</a>
, implementation of other methods also takes ~2 lines of code.</p><h1 id=benchmarks class="text-4xl border-b-2 mt-8 mb-2 border-black dark:border-gray-400">Benchmarks
<a href=#benchmarks>#</a></h1><p>The most interesting part. To run benchmarks locally, clone the gem repository on <a class="text-blue-500 hover:underline" href=https://github.com/iliabylich/handlersocket-ruby target=_blank rel="noreferrer nofollow">GitHub</a>
and run <code>rake benchmark</code>. It compares <code>mysql2</code> gem to Ruby-based and C-based implementations. Here are my results:</p><div class="group relative"><button class="hidden group-hover:inline absolute top-0.5 right-0.5 bg-gray-200 p-2 hover:bg-gray-400" data-copy=true>copy</button><pre class="bg-neutral-800 text-white p-4"><span style=display:flex><span>Calculating -------------------------------------
</span></span><span style=display:flex><span>             pure HS     2.000  i/100ms
</span></span><span style=display:flex><span>              ext HS     3.149k i/100ms
</span></span><span style=display:flex><span>              mysql2   669.000  i/100ms
</span></span><span style=display:flex><span>-------------------------------------------------
</span></span><span style=display:flex><span>             pure HS     49.979  (± 2.0%) i/s -    250.000
</span></span><span style=display:flex><span>              ext HS    110.369M (±15.7%) i/s -    467.793M
</span></span><span style=display:flex><span>              mysql2      5.218M (±16.3%) i/s -     23.869M
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Comparison:
</span></span><span style=display:flex><span>              ext HS: 110369437.2 i/s
</span></span><span style=display:flex><span>              mysql2:  5218120.6 i/s - 21.15x slower
</span></span><span style=display:flex><span>             pure HS:       50.0 i/s - 2208314.91x slower</span></span></pre></div><p>I have run these benchmarks on 4 cores server with 4 GB ram on Percona server 5.6. On both small and huge (30 millions records) datasets, with enabled and disabled query cache, with a small and a big value of <code>innodb_buffer_pool_size</code>.</p><p>There&rsquo;s a <code>20-30x</code> performance difference between <code>mysql2</code> and a C-based version of HandlerSocket because:</p><ul><li>almost no time is taken for request parsing</li><li><code>mysql2</code> is just a way more complex than my gem</li></ul><p>And I was really disappointed by performance of Ruby-based implementation. It&rsquo;s 2 millions times slower than C-based. Why? There&rsquo;s a magical number <code>50.0 i/s</code>, but I cannot find what does it mean. If you have an answer, please, ping me on Twitter.</p><h1 id=future-plans class="text-4xl border-b-2 mt-8 mb-2 border-black dark:border-gray-400">Future plans
<a href=#future-plans>#</a></h1><p>The gem <em>mostly</em> works, but there are some points that should be refined. Currently when network goes down there&rsquo;s no way to reconnect because HS protocol is stateful. There&rsquo;s no history tracking in HS objects, so if you open an index and then reconnect, you lose your opened index. I&rsquo;m not sure if it should be implemented on a low level of abstraction in HS gem, probably it&rsquo;s better to make a separated high-level gem for AR that does this job.</p><h1 id=conclusion class="text-4xl border-b-2 mt-8 mb-2 border-black dark:border-gray-400">Conclusion
<a href=#conclusion>#</a></h1><p>Once again, HandlerSocket saves your time on query parsing, building a query plan, it&rsquo;s more compact, but is very limited. If you don&rsquo;t have too many requests, don&rsquo;t even think about using it.</p><h1 id=links class="text-4xl border-b-2 mt-8 mb-2 border-black dark:border-gray-400">Links
<a href=#links>#</a></h1><p><a class="text-blue-500 hover:underline" href=https://github.com/DeNA/HandlerSocket-Plugin-for-MySQL/blob/master/docs-en/protocol.en.txt target=_blank rel="noreferrer nofollow">HandlerSocket protocol</a></p><p><a class="text-blue-500 hover:underline" href=https://github.com/iliabylich/handlersocket-ruby target=_blank rel="noreferrer nofollow">Ruby gem for HandlerSocket</a></p><p><a class="text-blue-500 hover:underline" href=https://github.com/ahiguti/HandlerSocket-Plugin-for-MySQL/blob/master/docs-en/configuration-options.en.txt target=_blank rel="noreferrer nofollow">HandlerSocket configuration</a></p></main><br><footer><script type=module defer>
  const copyToClipboard = (e) => {
    const button = e.target;
    const src = button.nextElementSibling.textContent
    navigator.clipboard.writeText(src)

    const originalText = button.innerText
    button.innerText = "copied!"
    setTimeout(() => {
      button.innerText = originalText
    }, 1500);
  }

  Array.from(document.querySelectorAll("[data-copy]")).forEach(button => {
    button.addEventListener("click", copyToClipboard)
  })
</script></footer></body></html>