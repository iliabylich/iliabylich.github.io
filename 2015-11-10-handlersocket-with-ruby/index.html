<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=cache-control content="max-age=0"><meta http-equiv=cache-control content="no-cache"><meta http-equiv=expires content="0"><meta http-equiv=expires content="Tue, 01 Jan 1980 1:00:00 GMT"><meta http-equiv=pragma content="no-cache"><link rel=apple-touch-icon-precomposed sizes=192x192 href=/icon-192x192.png><link rel="shortcut icon" href=/favicon.ico><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#1b1b1b"><meta name=description content="HandlerSocket + Ruby"><title>HandlerSocket + Ruby | Ilya Bylich - Blog</title><style>:root{--background:#ffffff}@media(prefers-color-scheme:dark){:root{--background:#1b1b1b}}html{background-color:var(--background)}body{background-color:var(--background)}</style><link rel=stylesheet type=text/css href=/style.min.4fed9ac4c3b0f6bfa63910fda772dff0eac2295876cd9f9770b2337489272971.css media=all></head><body><nav><ul class=menu><li><a tabindex=-1 class=menu-link href=/>Home</a></li><li><a tabindex=-1 class=menu-link href=https://github.com/iliabylich>GitHub</a></li><li><a tabindex=-1 class=menu-link href=https://twitter.com/IlyaBylich>Twitter</a></li><li><a tabindex=-1 class=menu-link href=mailto:ibylich@gmail.com>Email me</a></li><li><a tabindex=-1 class=menu-link href=/index.xml>RSS</a></li></ul></nav><div id=single-header><h1>HandlerSocket + Ruby</h1><div id=single-meta><span class=datesub>Nov 10, 2015</span>
<span id=tags>&nbsp;&nbsp;
<span><a href=https://iliabylich.github.io/tags/ruby/>#ruby</a>
</span>&nbsp; <span><a href=https://iliabylich.github.io/tags/mysql/>#mysql</a>
</span>&nbsp; <span><a href=https://iliabylich.github.io/tags/handlersocket/>#handlersocket</a>
</span>&nbsp; <span><a href=https://iliabylich.github.io/tags/databases/>#databases</a>
</span>&nbsp; <span><a href=https://iliabylich.github.io/tags/sql/>#sql</a>
</span>&nbsp; <span><a href=https://iliabylich.github.io/tags/nosql/>#nosql</a>
</span>&nbsp;</span></div></div><aside class="hidden lg:block toc" id=tableOfContentContainer><nav id=TableOfContents><ul><li><a href=#what-is-handlersocket-hs>What is HandlerSocket (HS)</a></li><li><a href=#installation>Installation</a></li><li><a href=#configuration>Configuration</a></li><li><a href=#simple-queries>Simple queries</a></li><li><a href=#use-cases>Use cases</a></li><li><a href=#ruby-adapter>Ruby adapter</a></li><li><a href=#adapter-api>Adapter API</a></li><li><a href=#benchmarks>Benchmarks</a></li><li><a href=#future-plans>Future plans</a></li><li><a href=#conclusion>Conclusion</a></li><li><a href=#links>Links</a></li></ul></nav></aside><main><h2 id=what-is-handlersocket-hs>What is HandlerSocket (HS)</h2><ul><li>a plugin for MySQL</li><li>which allows you to read/write to MySQL</li><li>and gives you a separate connection to MySQL</li><li>and does not allow you to run SQL queries</li><li>but allows to run simple CRUD queries <em>only</em> using indexes</li></ul><p>HandlerSocket query language is very simple (I&rsquo;d even say it&rsquo;s primitive), but it&rsquo;s much faster than MySQL&rsquo;s one. Though, of course, there are some limitations. Interested?</p><h2 id=installation>Installation</h2><p>You already have it if you are using Percona Server or MariaDB. If not, install it from <a href=https://github.com/DeNA/HandlerSocket-Plugin-for-MySQL target=_blank rel="noreferrer nofollow">the source</a>
.</p><p>To activate the plugin, run:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>INSTALL PLUGIN handlersocket SONAME <span style=color:#e6db74>&#39;handlersocket.so&#39;</span>;
</span></span></code></pre></div><h2 id=configuration>Configuration</h2><p>My configuration is the following:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span># [mysqld] section
</span></span><span style=display:flex><span># the port number to bind to for read requests
</span></span><span style=display:flex><span>loose_handlersocket_port = 9998
</span></span><span style=display:flex><span># the port number to bind to for write requests
</span></span><span style=display:flex><span>loose_handlersocket_port_wr = 9999
</span></span><span style=display:flex><span># the number of worker threads for read requests
</span></span><span style=display:flex><span>loose_handlersocket_threads = 16
</span></span><span style=display:flex><span># the number of worker threads for write requests
</span></span><span style=display:flex><span>loose_handlersocket_threads_wr = 1
</span></span><span style=display:flex><span>open_files_limit = 65535
</span></span></code></pre></div><p>You can find a detailed documentation of all available configuration options <a href=https://github.com/ahiguti/HandlerSocket-Plugin-for-MySQL/blob/master/docs-en/configuration-options.en.txt target=_blank rel="noreferrer nofollow">here</a></p><p>Restart your MySQL server and run:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>show</span> processlist<span style=color:#960050;background-color:#1e0010>\</span><span style=color:#66d9ef>G</span>
</span></span></code></pre></div><p>You should see a lot of rows like:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>           Id: <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>         <span style=color:#66d9ef>User</span>: <span style=color:#66d9ef>system</span> <span style=color:#66d9ef>user</span>
</span></span><span style=display:flex><span>         <span style=color:#66d9ef>Host</span>: connecting <span style=color:#66d9ef>host</span>
</span></span><span style=display:flex><span>           db: <span style=color:#66d9ef>NULL</span>
</span></span><span style=display:flex><span>      Command: <span style=color:#66d9ef>Connect</span>
</span></span><span style=display:flex><span>         Time: <span style=color:#66d9ef>NULL</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>State</span>: handlersocket: <span style=color:#66d9ef>mode</span><span style=color:#f92672>=</span>rd, <span style=color:#ae81ff>0</span> conns, <span style=color:#ae81ff>0</span> active
</span></span><span style=display:flex><span>         Info: <span style=color:#66d9ef>NULL</span>
</span></span><span style=display:flex><span>    Rows_sent: <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>Rows_examined: <span style=color:#ae81ff>0</span>
</span></span></code></pre></div><p>which means that HS daemon is up and running.</p><h2 id=simple-queries>Simple queries</h2><p>You can test it locally using <code>telnet</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ telnet 0.0.0.0 <span style=color:#ae81ff>9999</span>
</span></span><span style=display:flex><span>Trying 0.0.0.0...
</span></span><span style=display:flex><span>Connected to 0.0.0.0.
</span></span><span style=display:flex><span>Escape character is <span style=color:#e6db74>&#39;^]&#39;</span>.
</span></span></code></pre></div><p>Type <code>P -> 0 -> your_database -> your_table -> PRIMARY -> id,some_column</code> (where <code>-></code> is Tab). And press Enter. It should return <code>0 -> 1</code>.</p><p>This protocol looks ugly, but it may save you a lot of network usage. It&rsquo;s very compact, and parsing does not require any CPU usage.</p><h2 id=use-cases>Use cases</h2><p>If you don&rsquo;t have too much queries per second, probably you don&rsquo;t need HS. It does not optimize queries, but you may save some time on request parsing + some network. You may find it interesting if you have a lot of simple queries, like simple <code>SELECT</code>&rsquo;s by primary key.</p><h2 id=ruby-adapter>Ruby adapter</h2><p>Here goes my Ruby for HandlerSocket protocol. You can find it <a href=https://github.com/iliabylich/handlersocket-ruby target=_blank rel="noreferrer nofollow">here</a>
.</p><p>It has two implementations inside:</p><ul><li><a href=https://github.com/iliabylich/handlersocket-ruby/blob/master/lib/handlersocket/pure.rb target=_blank rel="noreferrer nofollow">Ruby-based</a></li><li><a href=https://github.com/iliabylich/handlersocket-ruby/blob/master/ext/handlersocket_ext/handlersocket_ext.c target=_blank rel="noreferrer nofollow">C-based</a></li></ul><p>Ruby implementation is very slow, it&rsquo;s there mainly to explain the protocol. C-based is quite fast.</p><h2 id=adapter-api>Adapter API</h2><p>To require a specific implementation, run</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#75715e># For slow pure Ruby implementation</span>
</span></span><span style=display:flex><span>require <span style=color:#e6db74>&#39;handlersocket/pure&#39;</span>
</span></span><span style=display:flex><span><span style=color:#75715e># For fast C implementation</span>
</span></span><span style=display:flex><span>require <span style=color:#e6db74>&#39;handlersocket/ext&#39;</span>
</span></span></code></pre></div><p>To create a connection, run</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span>hs <span style=color:#f92672>=</span> <span style=color:#66d9ef>Handlersocket</span><span style=color:#f92672>.</span>new(<span style=color:#e6db74>&#39;0.0.0.0&#39;</span>, <span style=color:#ae81ff>9999</span>)
</span></span></code></pre></div><p>Both pure Ruby and C implementations have the same API, so the <code>require</code> place is the only difference.</p><p>To open an index, run</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span>hs<span style=color:#f92672>.</span>open_index(<span style=color:#e6db74>&#39;0&#39;</span>, <span style=color:#e6db74>&#39;hs_test&#39;</span>, <span style=color:#e6db74>&#39;users&#39;</span>, <span style=color:#e6db74>&#39;PRIMARY&#39;</span>, <span style=color:#f92672>[</span><span style=color:#e6db74>&#39;id&#39;</span>, <span style=color:#e6db74>&#39;email&#39;</span><span style=color:#f92672>]</span>)
</span></span></code></pre></div><p>To read the data from that index, run</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span>hs<span style=color:#f92672>.</span>find(<span style=color:#e6db74>&#39;0&#39;</span>, <span style=color:#e6db74>&#39;=&#39;</span>, <span style=color:#f92672>[</span><span style=color:#e6db74>&#39;12&#39;</span><span style=color:#f92672>]</span>, <span style=color:#f92672>[</span><span style=color:#e6db74>&#39;100]&#39;</span><span style=color:#f92672>]</span>)
</span></span><span style=display:flex><span><span style=color:#75715e># Which is equal to</span>
</span></span><span style=display:flex><span><span style=color:#75715e># SELECT id, name FROM hs_test.users WHERE id = 12 LIMIT 100</span>
</span></span></code></pre></div><p>Other commands like <code>auth</code>/<code>insert</code>/<code>update</code>/<code>delete</code> are not there yet. But it&rsquo;s not that difficult to add them, check out <a href=https://github.com/iliabylich/handlersocket-ruby/blob/master/lib/handlersocket.rb#L37 target=_blank rel="noreferrer nofollow">this file</a>
, implementation of other methods also takes ~2 lines of code.</p><h2 id=benchmarks>Benchmarks</h2><p>The most interesting part. To run benchmarks locally, clone the gem repository on <a href=https://github.com/iliabylich/handlersocket-ruby target=_blank rel="noreferrer nofollow">GitHub</a>
and run <code>rake benchmark</code>. It compares <code>mysql2</code> gem to Ruby-based and C-based implementations. Here are my results:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>Calculating -------------------------------------
</span></span><span style=display:flex><span>             pure HS     2.000  i/100ms
</span></span><span style=display:flex><span>              ext HS     3.149k i/100ms
</span></span><span style=display:flex><span>              mysql2   669.000  i/100ms
</span></span><span style=display:flex><span>-------------------------------------------------
</span></span><span style=display:flex><span>             pure HS     49.979  (± 2.0%) i/s -    250.000
</span></span><span style=display:flex><span>              ext HS    110.369M (±15.7%) i/s -    467.793M
</span></span><span style=display:flex><span>              mysql2      5.218M (±16.3%) i/s -     23.869M
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Comparison:
</span></span><span style=display:flex><span>              ext HS: 110369437.2 i/s
</span></span><span style=display:flex><span>              mysql2:  5218120.6 i/s - 21.15x slower
</span></span><span style=display:flex><span>             pure HS:       50.0 i/s - 2208314.91x slower
</span></span></code></pre></div><p>I have run these benchmarks on 4 cores server with 4 GB ram on Percona server 5.6. On both small and huge (30 millions records) datasets, with enabled and disabled query cache, with a small and a big value of <code>innodb_buffer_pool_size</code>.</p><p>There&rsquo;s a <code>20-30x</code> performance difference between <code>mysql2</code> and a C-based version of HandlerSocket because:</p><ul><li>almost no time is taken for request parsing</li><li><code>mysql2</code> is just a way more complex than my gem</li></ul><p>And I was really disappointed by performance of Ruby-based implementation. It&rsquo;s 2 millions times slower than C-based. Why? There&rsquo;s a magical number <code>50.0 i/s</code>, but I cannot find what does it mean. If you have an answer, please, ping me on Twitter.</p><h2 id=future-plans>Future plans</h2><p>The gem <em>mostly</em> works, but there are some points that should be refined. Currently when network goes down there&rsquo;s no way to reconnect because HS protocol is stateful. There&rsquo;s no history tracking in HS objects, so if you open an index and then reconnect, you lose your opened index. I&rsquo;m not sure if it should be implemented on a low level of abstraction in HS gem, probably it&rsquo;s better to make a separated high-level gem for AR that does this job.</p><h2 id=conclusion>Conclusion</h2><p>Once again, HandlerSocket saves your time on query parsing, building a query plan, it&rsquo;s more compact, but is very limited. If you don&rsquo;t have too many requests, don&rsquo;t even think about using it.</p><h2 id=links>Links</h2><p><a href=https://github.com/DeNA/HandlerSocket-Plugin-for-MySQL/blob/master/docs-en/protocol.en.txt target=_blank rel="noreferrer nofollow">HandlerSocket protocol</a></p><p><a href=https://github.com/iliabylich/handlersocket-ruby target=_blank rel="noreferrer nofollow">Ruby gem for HandlerSocket</a></p><p><a href=https://github.com/ahiguti/HandlerSocket-Plugin-for-MySQL/blob/master/docs-en/configuration-options.en.txt target=_blank rel="noreferrer nofollow">HandlerSocket configuration</a></p></main><br><footer><script defer>function addCopyButtonToCodeBlocks(){const e=document.querySelectorAll('code[class^="language-"]');e.forEach(e=>{const t=document.createElement("button");t.classList.add("copy-code-button"),t.innerHTML="copy",t.addEventListener("click",()=>{const n=e.textContent;navigator.clipboard.writeText(n),t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},1500)}),e.parentNode.before(t)})}setTimeout(function(){addCopyButtonToCodeBlocks()},100)</script><script defer>function throttle(e,t){var n=Date.now();return function(){var s=Date.now();n+t-s<0&&(e(),n=s)}}function scrollHandler(){const e=Array.from(document.querySelectorAll("body h2, body h3"));function t(){for(var n,s,o,i=window.pageYOffset||document.documentElement.scrollTop,t=0;t<e.length;t++)s=e[t].getAttribute("id"),n=document.querySelector('nav ul li a[href="#'+s+'"]'),n&&n.classList.remove("active-toc");for(t=e.length-1;t>=0;t--)if(o=e[t].offsetTop,i>o-75&&(s=e[t].getAttribute("id"),n=document.querySelector('nav ul li a[href="#'+s+'"]'),n)){n.classList.add("active-toc");break}}window.addEventListener("scroll",throttle(t,300))}setTimeout(scrollHandler,100)</script></footer></body></html>