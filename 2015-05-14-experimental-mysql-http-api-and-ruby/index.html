<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=cache-control content="max-age=0"><meta http-equiv=cache-control content="no-cache"><meta http-equiv=expires content="0"><meta http-equiv=expires content="Tue, 01 Jan 1980 1:00:00 GMT"><meta http-equiv=pragma content="no-cache"><link rel=apple-touch-icon-precomposed sizes=192x192 href=/icon-192x192.png><link rel="shortcut icon" href=/favicon.ico><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#1b1b1b"><meta name=description content="Experimental MySQL HTTP API and Ruby"><title>Experimental MySQL HTTP API and Ruby | Ilya Bylich - Blog</title><style>:root{--background:#ffffff}@media(prefers-color-scheme:dark){:root{--background:#1b1b1b}}html{background-color:var(--background)}body{background-color:var(--background)}</style><link rel=stylesheet type=text/css href=/style.min.c8a2df3058ea59fb74948f071267ef16e3a4d0b23b7ec84883692939ef5dea45.css media=all></head><body><nav><ul class=menu><li><a tabindex=-1 class=menu-link href=/>Home</a></li><li><a tabindex=-1 class=menu-link href=https://github.com/iliabylich>GitHub</a></li><li><a tabindex=-1 class=menu-link href=https://twitter.com/IlyaBylich>Twitter</a></li><li><a tabindex=-1 class=menu-link href=mailto:ibylich@gmail.com>Email me</a></li><li><a tabindex=-1 class=menu-link href=/index.xml>RSS</a></li></ul></nav><div id=single-header><h1>Experimental MySQL HTTP API and Ruby</h1><div id=single-meta><span class=datesub>May 14, 2015</span>
<span id=tags>&nbsp;&nbsp;
<span><a href=https://iliabylich.github.io/tags/ruby/>#ruby</a>
</span>&nbsp; <span><a href=https://iliabylich.github.io/tags/mysql/>#mysql</a>
</span>&nbsp; <span><a href=https://iliabylich.github.io/tags/databases/>#databases</a>
</span>&nbsp;</span></div></div><aside class="hidden lg:block toc" id=tableOfContentContainer><nav id=TableOfContents><ul><li><a href=#http-api>HTTP API</a></li><li><a href=#sql-endpoint>SQL endpoint</a></li><li><a href=#crud-endpoint>CRUD endpoint</a></li><li><a href=#json-document-endpoint>JSON document endpoint</a></li><li><a href=#mysql-57-installation>MySQL 5.7 installation</a><ul><li><a href=#download-package-from-mysql-site>Download package from MySQL site</a></li><li><a href=#extract-it>Extract it</a></li><li><a href=#create-mysqlmysql-usergroup>Create <code>mysql:mysql user:group</code></a></li><li><a href=#link-extracted-directory>Link extracted directory</a></li><li><a href=#run-mysql_install_db>Run <code>mysql_install_db</code></a></li><li><a href=#run-mysql-server>Run MySQL server</a></li><li><a href=#change-root-password>Change root password</a></li><li><a href=#create-configuration-files-and-init-script>Create configuration files and <code>init</code> script</a></li><li><a href=#and-change-basedir-and-datadir-in-etcinitdmysql>And change <code>basedir</code> and <code>datadir</code> in <code>/etc/init.d/mysql</code></a></li><li><a href=#run-mysql-server-again-with-configuration-files>Run MySQL server again with configuration files</a></li></ul></li><li><a href=#http-api-plugin-installation>HTTP API plugin installation</a></li><li><a href=#http-api-plugin-configuration>HTTP API plugin configuration</a></li><li><a href=#connecting-with-ruby>Connecting with Ruby</a><ul><li><a href=#playing-with-crud-endpoint>Playing with CRUD endpoint</a></li><li><a href=#playing-with-sql-endpoint>Playing with SQL endpoint</a></li><li><a href=#playing-with-json-document-endpoint>Playing with JSON document endpoint</a></li></ul></li><li><a href=#conclusion>Conclusion</a></li></ul></nav></aside><main><h2 id=http-api>HTTP API</h2><p>Yes, MySQL has an HTTP API which is:</p><ol><li>an experimental feature</li><li>it ships as a native plugin <a href="http://labs.mysql.com/?id=3" target=_blank rel="noreferrer nofollow">only for 5.7 version</a></li></ol><p>Basically, it allows you to work with your database in the following ways:</p><ol><li>as an SQL endpoint</li><li>as a CRUD endpoint</li><li>as a JSON document endpoint</li></ol><h2 id=sql-endpoint>SQL endpoint</h2><p>It gives an ability to run queries like</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>GET http://host:port/sql/:database/:query
</span></span></code></pre></div><p>For example</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>GET http://localhost:8080/sql/testdb/SELECT+1
</span></span></code></pre></div><p>is a synonym of SQL&rsquo;s <code>SELECT 1</code>.</p><h2 id=crud-endpoint>CRUD endpoint</h2><p>Interface is:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>GET http://host:port/crud/:database/:table/:id
</span></span></code></pre></div><p>And</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>GET http://localhost:8080/crud/test_db/test_table/101<span style=color:#960050;background-color:#1e0010>&#39;</span>
</span></span></code></pre></div><p>produces:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>FROM</span> <span style=color:#f92672>`</span>test_db<span style=color:#f92672>`</span>.<span style=color:#f92672>`</span>test_table<span style=color:#f92672>`</span> <span style=color:#66d9ef>WHERE</span> <span style=color:#f92672>`</span>test_table<span style=color:#f92672>`</span>.<span style=color:#f92672>`</span>id<span style=color:#f92672>`</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>101</span>
</span></span></code></pre></div><h2 id=json-document-endpoint>JSON document endpoint</h2><p>Basically, with this endpoint your table has only 3 fields:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>mysql<span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>describe</span> test_db.test_table;
</span></span><span style=display:flex><span><span style=color:#f92672>+</span><span style=color:#75715e>--------+---------------------+------+-----+---------+-------+
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#f92672>|</span> Field  <span style=color:#f92672>|</span> <span style=color:#66d9ef>Type</span>                <span style=color:#f92672>|</span> <span style=color:#66d9ef>Null</span> <span style=color:#f92672>|</span> <span style=color:#66d9ef>Key</span> <span style=color:#f92672>|</span> <span style=color:#66d9ef>Default</span> <span style=color:#f92672>|</span> Extra <span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>+</span><span style=color:#75715e>--------+---------------------+------+-----+---------+-------+
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#f92672>|</span> _id    <span style=color:#f92672>|</span> varchar(<span style=color:#ae81ff>36</span>)         <span style=color:#f92672>|</span> <span style=color:#66d9ef>NO</span>   <span style=color:#f92672>|</span> PRI <span style=color:#f92672>|</span> <span style=color:#66d9ef>NULL</span>    <span style=color:#f92672>|</span>       <span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> _rev   <span style=color:#f92672>|</span> bigint(<span style=color:#ae81ff>20</span>) unsigned <span style=color:#f92672>|</span> <span style=color:#66d9ef>NO</span>   <span style=color:#f92672>|</span> PRI <span style=color:#f92672>|</span> <span style=color:#ae81ff>0</span>       <span style=color:#f92672>|</span>       <span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|</span> _extra <span style=color:#f92672>|</span> blob                <span style=color:#f92672>|</span> <span style=color:#66d9ef>NO</span>   <span style=color:#f92672>|</span>     <span style=color:#f92672>|</span> <span style=color:#66d9ef>NULL</span>    <span style=color:#f92672>|</span>       <span style=color:#f92672>|</span>
</span></span><span style=display:flex><span><span style=color:#f92672>+</span><span style=color:#75715e>--------+---------------------+------+-----+---------+-------+
</span></span></span></code></pre></div><p>All the data is stored in <code>_extra</code> column, <code>_id</code> is a regular document id, <code>_rev</code> is a revision of your document. There is no schema for API perspective and the documents are versioned. As for me it looks pretty much like CouchDB (of course, without querying the entire documents data :smile:)</p><h2 id=mysql-57-installation>MySQL 5.7 installation</h2><p>It&rsquo;s dead simple (until you want to install it from source):</p><h3 id=download-package-from-mysql-site>Download package from MySQL site</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ wget http://downloads.mysql.com/snapshots/pb/mysql-5.7.5-labs-http/mysql-5.7.5-labs-http-linux-glibc2.5-x86_64.tar.gz
</span></span></code></pre></div><h3 id=extract-it>Extract it</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ tar -zxvf mysql-5.7.5-labs-http-linux-glibc2.5-x86_64.tar.gz
</span></span></code></pre></div><h3 id=create-mysqlmysql-usergroup>Create <code>mysql:mysql user:group</code></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ groupadd mysql
</span></span><span style=display:flex><span>$ useradd -r -g mysql mysql
</span></span></code></pre></div><h3 id=link-extracted-directory>Link extracted directory</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ ln -s /root/mysql-5.7.5-labs-http-linux-glibc2.5-x86_64 /usr/local/mysql
</span></span><span style=display:flex><span>$ cd /usr/local/mysql
</span></span></code></pre></div><h3 id=run-mysql_install_db>Run <code>mysql_install_db</code></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ bin/mysql_install_db --user<span style=color:#f92672>=</span>mysql --datadir<span style=color:#f92672>=</span>/var/lib/mysql
</span></span></code></pre></div><h3 id=run-mysql-server>Run MySQL server</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ bin/mysqld_safe --user<span style=color:#f92672>=</span>mysql --datadir<span style=color:#f92672>=</span>/var/lib/mysql &amp;
</span></span></code></pre></div><h3 id=change-root-password>Change root password</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>cat ~/.mysql_secret
</span></span><span style=display:flex><span><span style=color:#75715e># Here goes your root password!</span>
</span></span><span style=display:flex><span>mysql -uroot -p
</span></span><span style=display:flex><span><span style=color:#75715e># &lt;Paste your root password from the file&gt;</span>
</span></span><span style=display:flex><span>mysql&gt; SET PASSWORD<span style=color:#f92672>=</span>PASSWORD<span style=color:#f92672>(</span><span style=color:#e6db74>&#39;root&#39;</span><span style=color:#f92672>)</span>; <span style=color:#75715e># Yes, I&#39;m mad</span>
</span></span><span style=display:flex><span>mysql&gt; exit
</span></span></code></pre></div><h3 id=create-configuration-files-and-init-script>Create configuration files and <code>init</code> script</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ cp support-files/my-default.cnf /etc/my.cnf
</span></span><span style=display:flex><span>$ cp support-files/mysql.server /etc/init.d/mysql
</span></span></code></pre></div><h3 id=and-change-basedir-and-datadir-in-etcinitdmysql>And change <code>basedir</code> and <code>datadir</code> in <code>/etc/init.d/mysql</code></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#75715e># In my case</span>
</span></span><span style=display:flex><span>basedir<span style=color:#f92672>=</span>/usr/local/mysql
</span></span><span style=display:flex><span>datadir<span style=color:#f92672>=</span>/var/lib/mysql
</span></span></code></pre></div><h3 id=run-mysql-server-again-with-configuration-files>Run MySQL server again with configuration files</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ /etc/init.d/mysql start
</span></span></code></pre></div><h2 id=http-api-plugin-installation>HTTP API plugin installation</h2><p>It&rsquo;s already included into our MySQL installation:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ ls -l /usr/local/mysql/lib/plugin/libmyhttp.so
</span></span></code></pre></div><p>But it&rsquo;s disabled by default, to enable it run</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>mysql<span style=color:#f92672>&gt;</span> INSTALL PLUGIN myhttp SONAME <span style=color:#e6db74>&#39;libmyhttp.so&#39;</span>;
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>mysql<span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>SHOW</span> PLUGINS;
</span></span></code></pre></div><p>Once plugin is enabled, some MySQL variables become accessible:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>mysql&gt; show variables like &#39;myhttp_%&#39;;
</span></span><span style=display:flex><span>+----------------------------------+------------------------------+
</span></span><span style=display:flex><span>| Variable_name                    | Value                        |
</span></span><span style=display:flex><span>+----------------------------------+------------------------------+
</span></span><span style=display:flex><span>| myhttp_basic_auth_user_name      | basic_auth_user              |
</span></span><span style=display:flex><span>| myhttp_basic_auth_user_passwd    | basic_auth_passwd            |
</span></span><span style=display:flex><span>| myhttp_crud_url_prefix           | /crud/                       |
</span></span><span style=display:flex><span>| myhttp_default_db                | myhttp                       |
</span></span><span style=display:flex><span>| myhttp_default_mysql_user_host   | 127.0.0.1                    |
</span></span><span style=display:flex><span>| myhttp_default_mysql_user_name   | username                     |
</span></span><span style=display:flex><span>| myhttp_default_mysql_user_passwd | userpass                     |
</span></span><span style=display:flex><span>| myhttp_document_url_prefix       | /doc/                        |
</span></span><span style=display:flex><span>| myhttp_http_enabled              | ON                           |
</span></span><span style=display:flex><span>| myhttp_http_port                 | 8080                         |
</span></span><span style=display:flex><span>| myhttp_https_enabled             | OFF                          |
</span></span><span style=display:flex><span>| myhttp_https_port                | 8081                         |
</span></span><span style=display:flex><span>| myhttp_https_ssl_key_file        | lib/plugin/myhttp_sslkey.pem |
</span></span><span style=display:flex><span>| myhttp_sql_url_prefix            | /sql/                        |
</span></span><span style=display:flex><span>+----------------------------------+------------------------------+
</span></span></code></pre></div><ol><li><code>myhttp_basic_auth_user_name</code> - username that should be used for basic HTTP authentication</li><li><code>myhttp_basic_auth_user_passwd</code> - password that should be used for basic HTTP authentication</li><li><code>myhttp_crud_url_prefix</code> - prefix of CRUD endpoint</li><li><code>myhttp_default_db</code> - database that will be used if no database specified in request</li><li><code>myhttp_default_mysql_user_host</code> - MySQL user that will be used for performing query provided with HTTP request</li><li><code>myhttp_default_mysql_user_passwd</code> - password of this MySQL user</li><li><code>myhttp_document_url_prefix</code> - prefix of JSON document endpoint</li><li><code>myhttp_http_enabled</code> - boolean setting to enable/disable non-SSL HTTP API</li><li><code>myhttp_http_port</code> - port of non-SSL HTTP API</li><li><code>myhttp_https_enabled</code> - boolean setting to enable/disable SSL HTTP API (yes, it&rsquo;s available)</li><li><code>myhttp_https_port</code> - port of SSL HTTP API</li><li><code>myhttp_https_ssl_key_file</code> - path to SSL certificate for SSL API</li><li><code>myhttp_sql_url_prefix</code> - prefix of SQL endpoint</li></ol><p>Let&rsquo;s try it!</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ curl -v localhost:8080
</span></span><span style=display:flex><span>&gt; GET / HTTP/1.1
</span></span><span style=display:flex><span>&gt; User-Agent: curl/7.35.0
</span></span><span style=display:flex><span>&gt; Host: 127.0.0.1:8080
</span></span><span style=display:flex><span>&gt; Accept: */*
</span></span><span style=display:flex><span>&gt;
</span></span><span style=display:flex><span>&lt; HTTP/1.1 <span style=color:#ae81ff>404</span> Not Found
</span></span><span style=display:flex><span>&lt; Cache-control: must-revalidate
</span></span><span style=display:flex><span>&lt; Connection: Keep-Alive
</span></span><span style=display:flex><span>&lt; Pragma: no-cache
</span></span><span style=display:flex><span>* Server MyHTTP 1.0.0-alpha is not blacklisted
</span></span><span style=display:flex><span>&lt; Server: MyHTTP 1.0.0-alpha
</span></span><span style=display:flex><span>&lt; Content-Length: <span style=color:#ae81ff>36</span>
</span></span><span style=display:flex><span>&lt;
</span></span><span style=display:flex><span><span style=color:#f92672>{</span><span style=color:#e6db74>&#34;error&#34;</span>:404, <span style=color:#e6db74>&#34;message&#34;</span>:<span style=color:#e6db74>&#34;Not Found&#34;</span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>Well, at least it returns something (be patient, this feature is experimental)</p><h2 id=http-api-plugin-configuration>HTTP API plugin configuration</h2><p>First of all, we need to create MySQL user and use his credentials in configuration file.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>mysql<span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>USER</span> <span style=color:#e6db74>&#39;username&#39;</span><span style=color:#f92672>@</span><span style=color:#e6db74>&#39;%&#39;</span> IDENTIFIED <span style=color:#66d9ef>BY</span> <span style=color:#e6db74>&#39;userpass&#39;</span>;
</span></span><span style=display:flex><span>mysql<span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>GRANT</span> <span style=color:#66d9ef>ALL</span> <span style=color:#66d9ef>PRIVILEGES</span> <span style=color:#66d9ef>ON</span> <span style=color:#f92672>*</span> . <span style=color:#f92672>*</span> <span style=color:#66d9ef>TO</span> <span style=color:#e6db74>&#39;username&#39;</span><span style=color:#f92672>@</span><span style=color:#e6db74>&#39;%&#39;</span>;
</span></span><span style=display:flex><span>mysql<span style=color:#f92672>&gt;</span> FLUSH <span style=color:#66d9ef>PRIVILEGES</span>;
</span></span></code></pre></div><p>Then we can change plugin&rsquo;s settings in <code>/etc/my.cnf</code> to something like:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>[mysqld]
</span></span><span style=display:flex><span>myhttp_default_db = myhttp
</span></span><span style=display:flex><span>myhttp_default_mysql_user_name = username
</span></span><span style=display:flex><span>myhttp_default_mysql_user_passwd = userpass
</span></span><span style=display:flex><span>myhttp_default_mysql_user_host = 127.0.0.1
</span></span><span style=display:flex><span>myhttp_basic_auth_user_name = basic_auth_user
</span></span><span style=display:flex><span>myhttp_basic_auth_user_passwd = basic_auth_passwd
</span></span></code></pre></div><p>Here is how it should look using curl:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ curl --user basic_auth_user:basic_auth_passwd --url http://localhost:8080/crud/myhttp/simple/1
</span></span><span style=display:flex><span> <span style=color:#f92672>{</span><span style=color:#e6db74>&#34;id&#34;</span>:<span style=color:#e6db74>&#34;1&#34;</span>,<span style=color:#e6db74>&#34;col_a&#34;</span>:<span style=color:#e6db74>&#34;Hello&#34;</span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h2 id=connecting-with-ruby>Connecting with Ruby</h2><p>First of all this is an HTTP API, so it&rsquo;s available for both server-side and client-side.</p><h3 id=playing-with-crud-endpoint>Playing with CRUD endpoint</h3><p>If we need to work with MySQL over HTTP API (let&rsquo;s imagine for a second that this is the only available way to fetch the data)
we need something like <a href=https://github.com/rails/activeresource target=_blank rel="noreferrer nofollow"><code>ActiveResource</code></a>
.</p><p><code>ActiveResource</code> is a gem for building <code>ActiveRecord</code>-like classes that actually fetch data over HTTP API.</p><p>Install it:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ gem install activeresource
</span></span></code></pre></div><p>And use:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span>require <span style=color:#e6db74>&#39;activeresource&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># We should have a table `users` (yes, Rails convention)</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>User</span> <span style=color:#f92672>&lt;</span> <span style=color:#66d9ef>ActiveResource</span><span style=color:#f92672>::</span><span style=color:#66d9ef>Base</span>
</span></span><span style=display:flex><span>  self<span style=color:#f92672>.</span>site <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;http://localhost:8080/crud&#39;</span>
</span></span><span style=display:flex><span>  self<span style=color:#f92672>.</span>user <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;basic_auth_user&#39;</span>
</span></span><span style=display:flex><span>  self<span style=color:#f92672>.</span>password <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;basic_auth_passwd&#39;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>user <span style=color:#f92672>=</span> <span style=color:#66d9ef>User</span><span style=color:#f92672>.</span>find(<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>user<span style=color:#f92672>.</span>first_name
</span></span><span style=display:flex><span><span style=color:#75715e># =&gt; &#39;Sherlock&#39;</span>
</span></span><span style=display:flex><span>user<span style=color:#f92672>.</span>last_name
</span></span><span style=display:flex><span><span style=color:#75715e># =&gt; &#39;Holmes&#39;</span>
</span></span><span style=display:flex><span>user<span style=color:#f92672>.</span>first_name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;John&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>User</span><span style=color:#f92672>.</span>create(<span style=color:#e6db74>first_name</span>: <span style=color:#e6db74>&#39;John&#39;</span>, <span style=color:#e6db74>last_name</span>: <span style=color:#960050;background-color:#1e0010>&#39;</span><span style=color:#66d9ef>Watson</span>)
</span></span><span style=display:flex><span><span style=color:#75715e># =&gt; ActiveResource::MethodNotAllowed: Failed.  Response code = 405.  Response message = Method Not Allowed.</span>
</span></span></code></pre></div><p>By default <code>ActiveResource</code> sends POST request to create a new record. However MySQL HTTP API has some other standards and it uses PUT for creating new record. Moreover, its required to specify primary key (<code>id</code>) of the record you want to insert (even if <code>id</code> has auto-increment)</p><p><code>ActiveResource</code> does not allow us to specify HTTP verbs for its API calls
<a href=https://github.com/rails/activeresource/blob/master/lib/active_resource/base.rb#L1435 target=_blank rel="noreferrer nofollow">source</a>
Without this we can&rsquo;t even create a single record in the database!</p><p>Let&rsquo;s check for alternatives. <a href=https://github.com/remiprev/her target=_blank rel="noreferrer nofollow"><code>Her</code></a>
is a popular (according to stars on GitHub it&rsquo;s even more popular then <code>ActiveResource</code>) alternative with a nice syntax sugar. Here is an example:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ gem install her
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span>require <span style=color:#e6db74>&#39;her&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>Her</span><span style=color:#f92672>::</span><span style=color:#66d9ef>API</span><span style=color:#f92672>.</span>setup <span style=color:#e6db74>url</span>: <span style=color:#e6db74>&#34;http://localhost:8080/crud/testdb/&#34;</span> <span style=color:#66d9ef>do</span> <span style=color:#f92672>|</span>c<span style=color:#f92672>|</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># Basic auth</span>
</span></span><span style=display:flex><span>  c<span style=color:#f92672>.</span>use <span style=color:#66d9ef>Faraday</span><span style=color:#f92672>::</span><span style=color:#66d9ef>Request</span><span style=color:#f92672>::</span><span style=color:#66d9ef>BasicAuthentication</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;basic_auth_user&#34;</span>, <span style=color:#e6db74>&#34;basic_auth_passwd&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># Encode request</span>
</span></span><span style=display:flex><span>  c<span style=color:#f92672>.</span>use <span style=color:#66d9ef>Faraday</span><span style=color:#f92672>::</span><span style=color:#66d9ef>Request</span><span style=color:#f92672>::</span><span style=color:#66d9ef>UrlEncoded</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># Parse response</span>
</span></span><span style=display:flex><span>  c<span style=color:#f92672>.</span>use <span style=color:#66d9ef>Her</span><span style=color:#f92672>::</span><span style=color:#66d9ef>Middleware</span><span style=color:#f92672>::</span><span style=color:#66d9ef>DefaultParseJSON</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># Adapter</span>
</span></span><span style=display:flex><span>  c<span style=color:#f92672>.</span>use <span style=color:#66d9ef>Faraday</span><span style=color:#f92672>::</span><span style=color:#66d9ef>Adapter</span><span style=color:#f92672>::</span><span style=color:#66d9ef>NetHttp</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>User</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>include</span> <span style=color:#66d9ef>Her</span><span style=color:#f92672>::</span><span style=color:#66d9ef>Model</span>
</span></span><span style=display:flex><span>  method_for <span style=color:#e6db74>:create</span>, <span style=color:#e6db74>:put</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>user <span style=color:#f92672>=</span> <span style=color:#66d9ef>User</span><span style=color:#f92672>.</span>find(<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span><span style=color:#75715e># =&gt; instance of user</span>
</span></span><span style=display:flex><span>user<span style=color:#f92672>.</span>first_name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;another-name&#39;</span>
</span></span><span style=display:flex><span>user<span style=color:#f92672>.</span>save
</span></span><span style=display:flex><span><span style=color:#75715e># =&gt; false</span>
</span></span></code></pre></div><p>No errors messages, just 400 Bad Request.
The thing is that body should be JSON-encoded, here is my middleware that encodes it:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MySqlHttpApiFormatter</span> <span style=color:#f92672>&lt;</span> <span style=color:#66d9ef>Faraday</span><span style=color:#f92672>::</span><span style=color:#66d9ef>Middleware</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>call</span>(env)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> env<span style=color:#f92672>[</span><span style=color:#e6db74>&#39;body&#39;</span><span style=color:#f92672>]</span> <span style=color:#75715e># this middleware calls also for &#39;get&#39; requests</span>
</span></span><span style=display:flex><span>      env<span style=color:#f92672>[</span><span style=color:#e6db74>&#39;body&#39;</span><span style=color:#f92672>].</span>delete(<span style=color:#e6db74>:id</span>) <span style=color:#75715e># id is already in the url</span>
</span></span><span style=display:flex><span>      env<span style=color:#f92672>[</span><span style=color:#e6db74>&#39;body&#39;</span><span style=color:#f92672>]</span> <span style=color:#f92672>=</span> env<span style=color:#f92672>[</span><span style=color:#e6db74>&#39;body&#39;</span><span style=color:#f92672>].</span>to_json
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>    @app<span style=color:#f92672>.</span>call(env)
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>Her</span><span style=color:#f92672>::</span><span style=color:#66d9ef>API</span><span style=color:#f92672>.</span>setup <span style=color:#f92672>...</span> <span style=color:#66d9ef>do</span> <span style=color:#f92672>|</span>c<span style=color:#f92672>|</span>
</span></span><span style=display:flex><span>  c<span style=color:#f92672>.</span>use <span style=color:#66d9ef>MySqlHttpApiFormatter</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>user <span style=color:#f92672>=</span> <span style=color:#66d9ef>User</span><span style=color:#f92672>.</span>create(<span style=color:#e6db74>first_name</span>: <span style=color:#e6db74>&#39;Test&#39;</span>, <span style=color:#e6db74>last_name</span>: <span style=color:#e6db74>&#39;User&#39;</span>, id: <span style=color:#ae81ff>25</span>)
</span></span><span style=display:flex><span><span style=color:#75715e># =&gt; instance of user</span>
</span></span></code></pre></div><p>And finally it works! The only thing that I personally don&rsquo;t like in design of this API is that both <code>INSERT</code> and <code>UPDATE</code> have to be called using PUT because it produces query:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>REPLACE</span> <span style=color:#66d9ef>INTO</span> db.<span style=color:#66d9ef>table</span> <span style=color:#66d9ef>SET</span> ..., pk <span style=color:#f92672>=</span> ...
</span></span></code></pre></div><p>That&rsquo;s why we have to pass id, <code>create</code> and <code>update</code> actions are combined into single <code>replace</code> (and I don&rsquo;t see any explanation for that).</p><p>Theoretically, this API can be used for both client-side and server-side (but it&rsquo;s important to make sure that you can allow users to change the data in your database)</p><h3 id=playing-with-sql-endpoint>Playing with SQL endpoint</h3><p>Honestly saying nothing interesting.</p><ul><li>This API can&rsquo;t be used for client-side applications because of potential SQL injections (yes, you can restrict user from deleting/updating data and grant only <code>Select_priv</code> privilege, but it still looks dangerous). Even if you are 100% sure that you are completely secured from any application-related vulnerabilities, CRUD API still looks better then passing raw SQL queries over HTTP.</li><li>Yes, it&rsquo;s possible to use it on the server, but for what? <code>mysql2</code> gem is still much faster (and can be easily combined with ActiveRecord)&mldr; nothing to discuss.</li></ul><h3 id=playing-with-json-document-endpoint>Playing with JSON document endpoint</h3><p>First of all, it looks quite strange comparing with regular MySQL tables. The database that is compatible with this API <strong>must</strong> be created using the same API. And as I wrote before, it creates 3 fields:</p><ul><li><code>_id</code> - some unique identifier</li><li><code>_rev</code> - revision of document (I can&rsquo;t call it &lsquo;record&rsquo;)</li><li><code>_ext</code> - serialized mapping <code>attribute_name => value</code></li></ul><p>Here is how it looks it MySQL:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>mysql<span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>select</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>from</span> json_types<span style=color:#960050;background-color:#1e0010>\</span><span style=color:#66d9ef>G</span>
</span></span><span style=display:flex><span><span style=color:#f92672>***************************</span> <span style=color:#ae81ff>1</span>. <span style=color:#66d9ef>row</span> <span style=color:#f92672>***************************</span>
</span></span><span style=display:flex><span>   _id: <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>  _rev: <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>_extra: <span style=color:#960050;background-color:#1e0010>{</span><span style=color:#e6db74>&#34;json_null&#34;</span>: <span style=color:#66d9ef>null</span>, <span style=color:#e6db74>&#34;json_string&#34;</span>: <span style=color:#e6db74>&#34;string&#34;</span>, <span style=color:#e6db74>&#34;json_number&#34;</span>: <span style=color:#ae81ff>123</span>.<span style=color:#ae81ff>456</span>, <span style=color:#e6db74>&#34;json_bool&#34;</span>: <span style=color:#66d9ef>true</span><span style=color:#960050;background-color:#1e0010>}</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>1</span> <span style=color:#66d9ef>row</span> <span style=color:#66d9ef>in</span> <span style=color:#66d9ef>set</span> (<span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>00</span> sec)
</span></span></code></pre></div><p>CouchDB has similar interface (HTTP API, schema-less documents, MVCC) but it provides one core feature of all databases: ability to run queries. You can&rsquo;t run any query when your data is serialized (no, I don&rsquo;t know what is <code>where _rev LIKE '%"some":json_structure%'"</code>). Moreover MVCC for this table is not real :) It stores only latest revision.</p><p>From my experience when you need to store schema-less documents you have two options:</p><ol><li>Use real schema-less storage (yes, like MongoDB)</li><li>Serialize fields <strong>that need to be serialized</strong> into single column (and Rails provides functionality for this out-of-box: <code>ActiveRecord::Base.serialize</code>) and query the database using non-serialized column.</li></ol><p>JSON document API can be useful when you already have MySQL and don&rsquo;t want to setup any other databases to store tons of unstructured data. Yes, sounds awful, but looks like a true.</p><h2 id=conclusion>Conclusion</h2><p>HTTP API is a tool, and it solves a lot of possible issues. It&rsquo;s not released yet (and I suppose it will not be included into default MySQL 5.7 installation), but I&rsquo;m waiting for it so much. Today, when Single-Page Applications are so popular and Rails application may have only HTTP API, it can simplify our server code. Let&rsquo;s give it a chance!</p></main><br><footer><script defer>function addCopyButtonToCodeBlocks(){const e=document.querySelectorAll('code[class^="language-"]');e.forEach(e=>{const t=document.createElement("button");t.classList.add("copy-code-button"),t.innerHTML="copy",t.addEventListener("click",()=>{const n=e.textContent;navigator.clipboard.writeText(n),t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},1500)}),e.parentNode.before(t)})}setTimeout(function(){addCopyButtonToCodeBlocks()},100)</script><script defer>function throttle(e,t){var n=Date.now();return function(){var s=Date.now();n+t-s<0&&(e(),n=s)}}function scrollHandler(){const e=Array.from(document.querySelectorAll("body h2, body h3"));function t(){for(var n,s,o,i=window.pageYOffset||document.documentElement.scrollTop,t=0;t<e.length;t++)s=e[t].getAttribute("id"),n=document.querySelector('nav ul li a[href="#'+s+'"]'),n&&n.classList.remove("active-toc");for(t=e.length-1;t>=0;t--)if(o=e[t].offsetTop,i>o-75&&(s=e[t].getAttribute("id"),n=document.querySelector('nav ul li a[href="#'+s+'"]'),n)){n.classList.add("active-toc");break}}window.addEventListener("scroll",throttle(t,300))}setTimeout(scrollHandler,100)</script></footer></body></html>