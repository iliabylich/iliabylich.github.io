<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=cache-control content="max-age=0"><meta http-equiv=cache-control content="no-cache"><meta http-equiv=expires content="0"><meta http-equiv=expires content="Tue, 01 Jan 1980 1:00:00 GMT"><meta http-equiv=pragma content="no-cache"><link rel=apple-touch-icon-precomposed sizes=192x192 href=/icon-192x192.png><link rel="shortcut icon" href=/favicon.ico><link rel=preconnect href=https://fonts.googleapis.com crossorigin><link rel=preload href="https://fonts.googleapis.com/css2?family=Inter&display=swap" onload='this.onload=null,this.rel="stylesheet",this.removeAttribute("as")' as=style><noscript><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=Inter&display=swap"></noscript><meta name=description content="ExceptionManager gem"><title>ExceptionManager gem</title>





<link rel="stylesheet" href="/css/main.c8826345ad7ba562c619be2596e20207fe470ef61aecf9db4c6405371222040f.css" integrity="sha256-yIJjRa17pWLGGb4lluICB/5HDvYa7PnbTGQFNxIiBA8=" crossorigin="anonymous">





</head><body class="m-auto px-4 xl:pl-80 font-inter dark:bg-gray-900 text-black dark:text-gray-400"><nav class="pt-5 pb-5"><ul class="flex flex-row items-center justify-start"><li class=pr-3><a class="text-blue-500 hover:underline dark:text-blue-300" href=/>Home</a></li><li class=pr-3><a class="text-blue-500 hover:underline dark:text-blue-300" href=https://github.com/iliabylich>GitHub</a></li><li class=pr-3><a class="text-blue-500 hover:underline dark:text-blue-300" href=https://twitter.com/IlyaBylich>Twitter</a></li><li class=pr-3><a class="text-blue-500 hover:underline dark:text-blue-300" href=mailto:ibylich@gmail.com>Email me</a></li><li class=pr-3><a class="text-blue-500 hover:underline dark:text-blue-300" href=/index.xml>RSS</a></li></ul></nav><div class=pb-2><h1 class="font-bold text-2xl pb-5">ExceptionManager gem</h1><span>Apr 14, 2015</span></div><aside class="relative bg-gray-200 border-1 p-6 border-black dark:bg-gray-800 xl:dark:bg-transparent xl:fixed xl:left-1 xl:top-1 xl:w-80 xl:bg-transparent xl:border-0 xl:text-xs"><a class="block hover:underline pl-0" href=#what-is-this>What is this?
</a><a class="block hover:underline pl-0" href=#integration-with-newrelic>Integration with NewRelic
</a><a class="block hover:underline pl-0" href=#how-it-works>How it works
</a><a class="block hover:underline pl-0" href=#compatibility>Compatibility
</a><a class="block hover:underline pl-0" href=#questions>Questions</a></aside><main><h1 id=what-is-this class="text-4xl border-b-2 mt-8 mb-2 border-black dark:border-gray-400">What is this?
<a href=#what-is-this>#</a></h1><p><code>ExceptionManager</code> is a gem for getting extra information from your exception.</p><p>Source code: <a class="text-blue-500 hover:underline" href=https://github.com/iliabylich/exception_manager target=_blank rel="noreferrer nofollow">https://github.com/iliabylich/exception_manager</a></p><p>With this gem every time when you get an exception, it&rsquo;s possible to grab <code>subject</code> of exception (the instance of class where <code>raise</code> happened), <code>locals</code> - local variables, <code>subject_instance_variables</code> and <code>subject_class_variables</code></p><p>Examples:</p><div class="group relative"><button class="hidden group-hover:inline absolute top-0.5 right-0.5 bg-gray-200 p-2 hover:bg-gray-400" data-copy=true>copy</button><pre class="bg-neutral-800 text-white p-4"><span style=display:flex><span>require <span style=color:#e6db74>&#39;exception_manager&#39;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>ExceptionManager</span><span style=color:#f92672>.</span>enable!
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>TestClassThatRaisesException</span>
</span></span><span style=display:flex><span>  @@class_variable <span style=color:#f92672>=</span> <span style=color:#e6db74>:class_value</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>test_error</span>(<span style=color:#f92672>*</span>args)
</span></span><span style=display:flex><span>    @instance_variable <span style=color:#f92672>=</span> <span style=color:#e6db74>:instance_value</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>raise</span> <span style=color:#e6db74>&#39;Test error&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>TestClassThatRaisesException</span><span style=color:#f92672>.</span>new<span style=color:#f92672>.</span>test_error(<span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>3</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>rescue</span> <span style=color:#f92672>=&gt;</span> e
</span></span><span style=display:flex><span>  puts <span style=color:#e6db74>&#34;Subject: </span><span style=color:#e6db74>#{</span>e<span style=color:#f92672>.</span>subject<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>  puts <span style=color:#e6db74>&#34;Locals: </span><span style=color:#e6db74>#{</span>e<span style=color:#f92672>.</span>locals<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>  puts <span style=color:#e6db74>&#34;Instance variables: </span><span style=color:#e6db74>#{</span>e<span style=color:#f92672>.</span>subject_instance_variables<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>  puts <span style=color:#e6db74>&#34;Class variables: </span><span style=color:#e6db74>#{</span>e<span style=color:#f92672>.</span>subject_class_variables<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>  puts <span style=color:#e6db74>&#34;Summary: </span><span style=color:#e6db74>#{</span>e<span style=color:#f92672>.</span>summary<span style=color:#f92672>.</span>inspect<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span></span></span></pre></div><p>This code snippet prints:</p><div class="group relative"><button class="hidden group-hover:inline absolute top-0.5 right-0.5 bg-gray-200 p-2 hover:bg-gray-400" data-copy=true>copy</button><pre class="bg-neutral-800 text-white p-4"><span style=display:flex><span><span style=color:#e6db74>Subject</span>: <span style=color:#75715e>#&lt;TestClassThatRaisesException:0x00000001512268&gt;</span>
</span></span><span style=display:flex><span><span style=color:#e6db74>Locals</span>: {<span style=color:#e6db74>:args</span><span style=color:#f92672>=&gt;[</span><span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>3</span><span style=color:#f92672>]</span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>Instance</span> <span style=color:#e6db74>variables</span>: {<span style=color:#e6db74>:@instance_variable</span><span style=color:#f92672>=&gt;</span><span style=color:#e6db74>:instance_value</span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>Class</span> <span style=color:#e6db74>variables</span>: {<span style=color:#e6db74>:@@class_variable</span><span style=color:#f92672>=&gt;</span><span style=color:#e6db74>:class_value</span>}
</span></span><span style=display:flex><span><span style=color:#e6db74>Summary</span>: {
</span></span><span style=display:flex><span>  <span style=color:#e6db74>:locals</span> <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#e6db74>:klass</span> <span style=color:#f92672>=&gt;</span> <span style=color:#66d9ef>TestClassThatRaisesException</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>:args</span><span style=color:#f92672>=&gt;</span> <span style=color:#f92672>[</span><span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>3</span><span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  <span style=color:#e6db74>:subject</span> <span style=color:#f92672>=&gt;</span> <span style=color:#75715e>#&lt;TestClassThatRaisesException:0x00000001512268&gt;,</span>
</span></span><span style=display:flex><span>  <span style=color:#e6db74>:subject_instance_variables</span> <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#e6db74>:@instance_variable</span> <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>:instance_value</span>
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  <span style=color:#e6db74>:subject_class_variables</span> <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#e6db74>:@@class_variable</span> <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>:class_value</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}</span></span></pre></div><p>So, you can get local variables of you exception, instance where it happened and the whole context.</p><p>If you have <code>pry</code> installed, you can inject pry session into stored binding:</p><div class="group relative"><button class="hidden group-hover:inline absolute top-0.5 right-0.5 bg-gray-200 p-2 hover:bg-gray-400" data-copy=true>copy</button><pre class="bg-neutral-800 text-white p-4"><span style=display:flex><span><span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>TestClassThatRaisesException</span><span style=color:#f92672>.</span>new<span style=color:#f92672>.</span>test_error(<span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>3</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>rescue</span> <span style=color:#f92672>=&gt;</span> e
</span></span><span style=display:flex><span>  e<span style=color:#f92672>.</span>_binding<span style=color:#f92672>.</span>pry
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span></span></span></pre></div><h1 id=integration-with-newrelic class="text-4xl border-b-2 mt-8 mb-2 border-black dark:border-gray-400">Integration with NewRelic
<a href=#integration-with-newrelic>#</a></h1><p>Just use the following snippet:</p><div class="group relative"><button class="hidden group-hover:inline absolute top-0.5 right-0.5 bg-gray-200 p-2 hover:bg-gray-400" data-copy=true>copy</button><pre class="bg-neutral-800 text-white p-4"><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>StandardError</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>original_exception</span>
</span></span><span style=display:flex><span>    message_for_new_relic <span style=color:#f92672>=</span> <span style=color:#f92672>[</span>message, summary<span style=color:#f92672>.</span>inspect<span style=color:#f92672>].</span>join(<span style=color:#e6db74>&#39; &#39;</span>)
</span></span><span style=display:flex><span>    self<span style=color:#f92672>.</span>exception(message_for_new_relic)
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span></span></span></pre></div><p>NewRelic gem by default calls <code>.original_exception.to_s</code> on every caught exception. Yes, looks dirty, but saves a lot of time!</p><h1 id=how-it-works class="text-4xl border-b-2 mt-8 mb-2 border-black dark:border-gray-400">How it works
<a href=#how-it-works>#</a></h1><p>In old versions of ruby there was a <code>Kernel</code> method called <code>set_trace_func</code> which allows to set trigger for every executed line (including c-calls).</p><p>Ruby 2.0.0 (and newer) has a class called <code>TracePoint</code> which allows to subscribe to any specific method call (<code>raise</code> in our case).</p><p>So, simplified version of the main code looks like:</p><div class="group relative"><button class="hidden group-hover:inline absolute top-0.5 right-0.5 bg-gray-200 p-2 hover:bg-gray-400" data-copy=true>copy</button><pre class="bg-neutral-800 text-white p-4"><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Exception</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>attr_accessor</span> <span style=color:#e6db74>:_binding</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>TracePoint</span><span style=color:#f92672>.</span>new(<span style=color:#e6db74>:raise</span>) <span style=color:#66d9ef>do</span> <span style=color:#f92672>|</span>tp<span style=color:#f92672>|</span>
</span></span><span style=display:flex><span>  tp<span style=color:#f92672>.</span>raised_exception<span style=color:#f92672>.</span>_binding <span style=color:#f92672>=</span> tp<span style=color:#f92672>.</span>binding
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span></span></span></pre></div><p>And then we can get everything through this binding</p><h1 id=compatibility class="text-4xl border-b-2 mt-8 mb-2 border-black dark:border-gray-400">Compatibility
<a href=#compatibility>#</a></h1><p><code>ExceptionManager</code> is compatible (and tested on Travis CI) with the following versions of ruby</p><ul><li>2.0.0</li><li>2.1.0</li><li>2.2.0</li></ul><p>(In other words, in all versions of ruby that has <code>TracePoint</code> class).</p><h1 id=questions class="text-4xl border-b-2 mt-8 mb-2 border-black dark:border-gray-400">Questions
<a href=#questions>#</a></h1><p>If you have any questions/suggestions feel free <a class="text-blue-500 hover:underline" href=https://github.com/iliabylich/exception_manager/issues target=_blank rel="noreferrer nofollow">to create an issue on GitHub</a>
.</p></main><br><footer><script type=module defer>
  const copyToClipboard = (e) => {
    const button = e.target;
    const src = button.nextElementSibling.textContent
    navigator.clipboard.writeText(src)

    const originalText = button.innerText
    button.innerText = "copied!"
    setTimeout(() => {
      button.innerText = originalText
    }, 1500);
  }

  Array.from(document.querySelectorAll("[data-copy]")).forEach(button => {
    button.addEventListener("click", copyToClipboard)
  })
</script></footer></body></html>