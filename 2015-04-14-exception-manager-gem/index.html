<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=cache-control content="max-age=0"><meta http-equiv=cache-control content="no-cache"><meta http-equiv=expires content="0"><meta http-equiv=expires content="Tue, 01 Jan 1980 1:00:00 GMT"><meta http-equiv=pragma content="no-cache"><link rel=apple-touch-icon-precomposed sizes=192x192 href=/icon-192x192.png><link rel="shortcut icon" href=/favicon.ico><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Inter&display=swap" rel=stylesheet><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#1b1b1b"><meta name=description content="ExceptionManager gem"><title>ExceptionManager gem | Ilya Bylich - Blog</title><style>:root{--background:#ffffff}@media(prefers-color-scheme:dark){:root{--background:#1b1b1b}}html{background-color:var(--background)}body{background-color:var(--background)}</style><link rel=stylesheet type=text/css href=/style.min.2b907de83c90cfa7c3d79a41f7775098387ed032abb1f83426627b3438329fdc.css media=all></head><body><nav><ul class=menu><li><a tabindex=-1 class=menu-link href=/>Home</a></li><li><a tabindex=-1 class=menu-link href=https://github.com/iliabylich>GitHub</a></li><li><a tabindex=-1 class=menu-link href=https://twitter.com/IlyaBylich>Twitter</a></li><li><a tabindex=-1 class=menu-link href=mailto:ibylich@gmail.com>Email me</a></li><li><a tabindex=-1 class=menu-link href=/index.xml>RSS</a></li></ul></nav><div id=single-header><h1>ExceptionManager gem</h1><div id=single-meta><span class=datesub>Apr 14, 2015</span>
<span id=tags>&nbsp;&nbsp;
<span><a href=https://iliabylich.github.io/tags/ruby/>#ruby</a>
</span>&nbsp; <span><a href=https://iliabylich.github.io/tags/gem/>#gem</a>
</span>&nbsp; <span><a href=https://iliabylich.github.io/tags/exceptions/>#exceptions</a>
</span>&nbsp;</span></div></div><aside class="hidden lg:block toc" id=tableOfContentContainer><nav id=TableOfContents><ul><li><a href=#what-is-this>What is this?</a></li><li><a href=#integration-with-newrelic>Integration with NewRelic</a></li><li><a href=#how-it-works>How it works</a></li><li><a href=#compatibility>Compatibility</a></li><li><a href=#questions>Questions</a></li></ul></nav></aside><main><h2 id=what-is-this>What is this?</h2><p><code>ExceptionManager</code> is a gem for getting extra information from your exception.</p><p>Source code: <a href=https://github.com/iliabylich/exception_manager target=_blank rel="noreferrer nofollow">https://github.com/iliabylich/exception_manager</a></p><p>With this gem every time when you get an exception, it&rsquo;s possible to grab <code>subject</code> of exception (the instance of class where <code>raise</code> happened), <code>locals</code> - local variables, <code>subject_instance_variables</code> and <code>subject_class_variables</code></p><p>Examples:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span>require <span style=color:#e6db74>&#39;exception_manager&#39;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>ExceptionManager</span><span style=color:#f92672>.</span>enable!
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>TestClassThatRaisesException</span>
</span></span><span style=display:flex><span>  @@class_variable <span style=color:#f92672>=</span> <span style=color:#e6db74>:class_value</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>test_error</span>(<span style=color:#f92672>*</span>args)
</span></span><span style=display:flex><span>    @instance_variable <span style=color:#f92672>=</span> <span style=color:#e6db74>:instance_value</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>raise</span> <span style=color:#e6db74>&#39;Test error&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>TestClassThatRaisesException</span><span style=color:#f92672>.</span>new<span style=color:#f92672>.</span>test_error(<span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>3</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>rescue</span> <span style=color:#f92672>=&gt;</span> e
</span></span><span style=display:flex><span>  puts <span style=color:#e6db74>&#34;Subject: </span><span style=color:#e6db74>#{</span>e<span style=color:#f92672>.</span>subject<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>  puts <span style=color:#e6db74>&#34;Locals: </span><span style=color:#e6db74>#{</span>e<span style=color:#f92672>.</span>locals<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>  puts <span style=color:#e6db74>&#34;Instance variables: </span><span style=color:#e6db74>#{</span>e<span style=color:#f92672>.</span>subject_instance_variables<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>  puts <span style=color:#e6db74>&#34;Class variables: </span><span style=color:#e6db74>#{</span>e<span style=color:#f92672>.</span>subject_class_variables<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>  puts <span style=color:#e6db74>&#34;Summary: </span><span style=color:#e6db74>#{</span>e<span style=color:#f92672>.</span>summary<span style=color:#f92672>.</span>inspect<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><p>This code snippet prints:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#e6db74>Subject</span>: <span style=color:#75715e>#&lt;TestClassThatRaisesException:0x00000001512268&gt;</span>
</span></span><span style=display:flex><span><span style=color:#e6db74>Locals</span>: {<span style=color:#e6db74>:args</span><span style=color:#f92672>=&gt;[</span><span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>3</span><span style=color:#f92672>]</span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>Instance</span> <span style=color:#e6db74>variables</span>: {<span style=color:#e6db74>:@instance_variable</span><span style=color:#f92672>=&gt;</span><span style=color:#e6db74>:instance_value</span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>Class</span> <span style=color:#e6db74>variables</span>: {<span style=color:#e6db74>:@@class_variable</span><span style=color:#f92672>=&gt;</span><span style=color:#e6db74>:class_value</span>}
</span></span><span style=display:flex><span><span style=color:#e6db74>Summary</span>: {
</span></span><span style=display:flex><span>  <span style=color:#e6db74>:locals</span> <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#e6db74>:klass</span> <span style=color:#f92672>=&gt;</span> <span style=color:#66d9ef>TestClassThatRaisesException</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>:args</span><span style=color:#f92672>=&gt;</span> <span style=color:#f92672>[</span><span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>3</span><span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  <span style=color:#e6db74>:subject</span> <span style=color:#f92672>=&gt;</span> <span style=color:#75715e>#&lt;TestClassThatRaisesException:0x00000001512268&gt;,</span>
</span></span><span style=display:flex><span>  <span style=color:#e6db74>:subject_instance_variables</span> <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#e6db74>:@instance_variable</span> <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>:instance_value</span>
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  <span style=color:#e6db74>:subject_class_variables</span> <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#e6db74>:@@class_variable</span> <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>:class_value</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>So, you can get local variables of you exception, instance where it happened and the whole context.</p><p>If you have <code>pry</code> installed, you can inject pry session into stored binding:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#66d9ef>begin</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>TestClassThatRaisesException</span><span style=color:#f92672>.</span>new<span style=color:#f92672>.</span>test_error(<span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>3</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>rescue</span> <span style=color:#f92672>=&gt;</span> e
</span></span><span style=display:flex><span>  e<span style=color:#f92672>.</span>_binding<span style=color:#f92672>.</span>pry
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><h2 id=integration-with-newrelic>Integration with NewRelic</h2><p>Just use the following snippet:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>StandardError</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>original_exception</span>
</span></span><span style=display:flex><span>    message_for_new_relic <span style=color:#f92672>=</span> <span style=color:#f92672>[</span>message, summary<span style=color:#f92672>.</span>inspect<span style=color:#f92672>].</span>join(<span style=color:#e6db74>&#39; &#39;</span>)
</span></span><span style=display:flex><span>    self<span style=color:#f92672>.</span>exception(message_for_new_relic)
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><p>NewRelic gem by default calls <code>.original_exception.to_s</code> on every caught exception. Yes, looks dirty, but saves a lot of time!</p><h2 id=how-it-works>How it works</h2><p>In old versions of ruby there was a <code>Kernel</code> method called <code>set_trace_func</code> which allows to set trigger for every executed line (including c-calls).</p><p>Ruby 2.0.0 (and newer) has a class called <code>TracePoint</code> which allows to subscribe to any specific method call (<code>raise</code> in our case).</p><p>So, simplified version of the main code looks like:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Exception</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>attr_accessor</span> <span style=color:#e6db74>:_binding</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>TracePoint</span><span style=color:#f92672>.</span>new(<span style=color:#e6db74>:raise</span>) <span style=color:#66d9ef>do</span> <span style=color:#f92672>|</span>tp<span style=color:#f92672>|</span>
</span></span><span style=display:flex><span>  tp<span style=color:#f92672>.</span>raised_exception<span style=color:#f92672>.</span>_binding <span style=color:#f92672>=</span> tp<span style=color:#f92672>.</span>binding
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><p>And then we can get everything through this binding</p><h2 id=compatibility>Compatibility</h2><p><code>ExceptionManager</code> is compatible (and tested on Travis CI) with the following versions of ruby</p><ul><li>2.0.0</li><li>2.1.0</li><li>2.2.0</li></ul><p>(In other words, in all versions of ruby that has <code>TracePoint</code> class).</p><h2 id=questions>Questions</h2><p>If you have any questions/suggestions feel free <a href=https://github.com/iliabylich/exception_manager/issues target=_blank rel="noreferrer nofollow">to create an issue on GitHub</a>
.</p></main><br><footer><script defer>function addCopyButtonToCodeBlocks(){const e=document.querySelectorAll('code[class^="language-"]');e.forEach(e=>{const t=document.createElement("button");t.classList.add("copy-code-button"),t.innerHTML="copy",t.addEventListener("click",()=>{const n=e.textContent;navigator.clipboard.writeText(n),t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},1500)}),e.parentNode.before(t)})}setTimeout(function(){addCopyButtonToCodeBlocks()},100)</script><script defer>function throttle(e,t){var n=Date.now();return function(){var s=Date.now();n+t-s<0&&(e(),n=s)}}function scrollHandler(){const e=Array.from(document.querySelectorAll("body h2, body h3"));function t(){for(var n,s,o,i=window.pageYOffset||document.documentElement.scrollTop,t=0;t<e.length;t++)s=e[t].getAttribute("id"),n=document.querySelector('nav ul li a[href="#'+s+'"]'),n&&n.classList.remove("active-toc");for(t=e.length-1;t>=0;t--)if(o=e[t].offsetTop,i>o-75&&(s=e[t].getAttribute("id"),n=document.querySelector('nav ul li a[href="#'+s+'"]'),n)){n.classList.add("active-toc");break}}window.addEventListener("scroll",throttle(t,300))}setTimeout(scrollHandler,100)</script></footer></body></html>