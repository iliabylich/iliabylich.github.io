<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=cache-control content="max-age=0"><meta http-equiv=cache-control content="no-cache"><meta http-equiv=expires content="0"><meta http-equiv=expires content="Tue, 01 Jan 1980 1:00:00 GMT"><meta http-equiv=pragma content="no-cache"><link rel=apple-touch-icon-precomposed sizes=192x192 href=/icon-192x192.png><link rel="shortcut icon" href=/favicon.ico><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Inter&display=swap" rel=stylesheet><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#1b1b1b"><meta name=description content="Ruby Marshalling from A to Z"><title>Ruby Marshalling from A to Z | Ilya Bylich - Blog</title><style>:root{--background:#ffffff}@media(prefers-color-scheme:dark){:root{--background:#1b1b1b}}html{background-color:var(--background)}body{background-color:var(--background)}</style><link rel=stylesheet type=text/css href=/style.min.2b907de83c90cfa7c3d79a41f7775098387ed032abb1f83426627b3438329fdc.css media=all></head><body><nav><ul class=menu><li><a tabindex=-1 class=menu-link href=/>Home</a></li><li><a tabindex=-1 class=menu-link href=https://github.com/iliabylich>GitHub</a></li><li><a tabindex=-1 class=menu-link href=https://twitter.com/IlyaBylich>Twitter</a></li><li><a tabindex=-1 class=menu-link href=mailto:ibylich@gmail.com>Email me</a></li><li><a tabindex=-1 class=menu-link href=/index.xml>RSS</a></li></ul></nav><div id=single-header><h1>Ruby Marshalling from A to Z</h1><div id=single-meta><span class=datesub>Jan 26, 2016</span>
<span id=tags>&nbsp;&nbsp;
<span><a href=https://iliabylich.github.io/tags/ruby/>#ruby</a>
</span>&nbsp; <span><a href=https://iliabylich.github.io/tags/marshalling/>#marshalling</a>
</span>&nbsp; <span><a href=https://iliabylich.github.io/tags/serialization/>#serialization</a>
</span>&nbsp; <span><a href=https://iliabylich.github.io/tags/tlv/>#tlv</a>
</span>&nbsp;</span></div></div><aside class="hidden lg:block toc" id=tableOfContentContainer><nav id=TableOfContents><ul><li><a href=#what-is-marshalling>What is Marshalling</a></li><li><a href=#the-gem>The gem</a></li><li><a href=#reading>Reading</a></li><li><a href=#decompressing>Decompressing</a></li><li><a href=#getting-objects-from-the-raw-data>Getting objects from the raw data</a></li><li><a href=#nilclass-trueclass-falseclass><code>NilClass</code>, <code>TrueClass</code>, <code>FalseClass</code></a></li><li><a href=#tests>Tests</a></li><li><a href=#integer>Integer</a></li><li><a href=#symbol>Symbol</a></li><li><a href=#string>String</a></li><li><a href=#array>Array</a></li><li><a href=#hash>Hash</a></li><li><a href=#float>Float</a></li><li><a href=#class>Class</a></li><li><a href=#module>Module</a></li><li><a href=#struct><code>Struct</code></a></li><li><a href=#regexp>Regexp</a></li><li><a href=#abstract-object>Abstract object</a></li><li><a href=#user-class>User class</a></li><li><a href=#extended-object>Extended object</a></li><li><a href=#symbol-links>Symbol links</a></li><li><a href=#object-links>Object links</a></li><li><a href=#other-cases>Other cases</a></li><li><a href=#writing>Writing</a></li><li><a href=#optimizations>Optimizations</a></li><li><a href=#what-is-it-for>What is it for?</a></li><li><a href=#links>Links</a></li></ul></nav></aside><main><h2 id=what-is-marshalling>What is Marshalling</h2><p>Marshalling is a serialization process when you convert an object to a binary string.
Ruby has a standard class <code>Marshal</code> that does all the job for serialization and deserialization.
To serialize an object, use <code>Marshal.dump</code>, to deserialize - <code>Marshal.load</code> or <code>Marshal.restore</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span>marshalled <span style=color:#f92672>=</span> <span style=color:#66d9ef>Marshal</span><span style=color:#f92672>.</span>dump(<span style=color:#f92672>[</span><span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>2</span>, <span style=color:#e6db74>&#39;string&#39;</span>, <span style=color:#66d9ef>Object</span><span style=color:#f92672>.</span>new<span style=color:#f92672>]</span>)
</span></span><span style=display:flex><span><span style=color:#75715e># =&gt; &#34;\x04\b[\ti\x06i\aI\&#34;\vstring\x06:\x06ETo:\vObject\x00&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>Marshal</span><span style=color:#f92672>.</span>load(marshalled)
</span></span><span style=display:flex><span><span style=color:#75715e># =&gt; [1, 2, &#34;string&#34;, #&lt;Object:0x00000002643000&gt;]</span>
</span></span></code></pre></div><p>This article explains the format of marshalling and shows how to write a pure Ruby marshalling library
compatible with the standard Ruby implementation.</p><h2 id=the-gem>The gem</h2><p>Let&rsquo;s try to make a pure Ruby gem that is compatible with standard <code>Marshal</code> class.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ bundle gem pure_ruby_marshal
</span></span><span style=display:flex><span>$ tree pure_ruby_marshal
</span></span><span style=display:flex><span>pure_ruby_marshal
</span></span><span style=display:flex><span>├── bin
</span></span><span style=display:flex><span>│ ├── console
</span></span><span style=display:flex><span>│ └── setup
</span></span><span style=display:flex><span>├── CODE_OF_CONDUCT.md
</span></span><span style=display:flex><span>├── Gemfile
</span></span><span style=display:flex><span>├── lib
</span></span><span style=display:flex><span>│ ├── pure_ruby_marshal
</span></span><span style=display:flex><span>│ │ └── version.rb
</span></span><span style=display:flex><span>│ └── pure_ruby_marshal.rb
</span></span><span style=display:flex><span>├── LICENSE.txt
</span></span><span style=display:flex><span>├── pure_ruby_marshal.gemspec
</span></span><span style=display:flex><span>├── Rakefile
</span></span><span style=display:flex><span>└── README.md
</span></span></code></pre></div><p>Our main module <code>PureRubyMarshal</code> has the following interface:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#66d9ef>module</span> PureRubyMarshal
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>extend</span> self
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>dump</span>(object)
</span></span><span style=display:flex><span>    <span style=color:#75715e># ...</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>load</span>(data)
</span></span><span style=display:flex><span>    <span style=color:#75715e># ...</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><p>Also I&rsquo;d like to extract all logic related into reading/writing encoded data
to separate classes - <code>ReadBuffer</code> for reading, <code>WriteBuffer</code> for writing.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#66d9ef>module</span> PureRubyMarshal
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>extend</span> self
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  autoload <span style=color:#e6db74>:ReadBuffer</span>,  <span style=color:#e6db74>&#39;pure_ruby_marshal/read_buffer&#39;</span>
</span></span><span style=display:flex><span>  autoload <span style=color:#e6db74>:WriteBuffer</span>, <span style=color:#e6db74>&#39;pure_ruby_marshal/write_buffer&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>dump</span>(object)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>WriteBuffer</span><span style=color:#f92672>.</span>new(object)<span style=color:#f92672>.</span>write
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>load</span>(data)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>ReadBuffer</span><span style=color:#f92672>.</span>new(data)<span style=color:#f92672>.</span>read
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><h2 id=reading>Reading</h2><p>As we decided before, <code>ReadBuffer</code> is our class responsible for reading an object from marshalled data.
Here is how it should look:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>PureRubyMarshal</span><span style=color:#f92672>::</span><span style=color:#66d9ef>ReadBuffer</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>attr_reader</span> <span style=color:#e6db74>:data</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>initialize</span>(data)
</span></span><span style=display:flex><span>    @data <span style=color:#f92672>=</span> data
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>read</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># ...</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><h2 id=decompressing>Decompressing</h2><p>First let&rsquo;s take a look at <code>Marshal.dump</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span>marshalled <span style=color:#f92672>=</span> <span style=color:#66d9ef>Marshal</span><span style=color:#f92672>.</span>dump(<span style=color:#f92672>[</span><span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>2</span>, <span style=color:#e6db74>&#39;string&#39;</span>, <span style=color:#66d9ef>Object</span><span style=color:#f92672>.</span>new<span style=color:#f92672>]</span>)
</span></span><span style=display:flex><span>data <span style=color:#f92672>=</span> marshalled<span style=color:#f92672>.</span>chars
</span></span><span style=display:flex><span><span style=color:#75715e># =&gt; [a long array of characters]</span>
</span></span></code></pre></div><p>The first two characters represent a version of library that was used for marshalling:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span>data<span style=color:#f92672>[</span><span style=color:#ae81ff>0</span><span style=color:#f92672>].</span>ord
</span></span><span style=display:flex><span><span style=color:#75715e># =&gt; 4</span>
</span></span><span style=display:flex><span>data<span style=color:#f92672>[</span><span style=color:#ae81ff>1</span><span style=color:#f92672>].</span>ord
</span></span><span style=display:flex><span><span style=color:#75715e># =&gt; 8</span>
</span></span></code></pre></div><p>Which represents a current version of Marshal library - <code>4.8</code>
(<a href=https://github.com/ruby/ruby/blob/trunk/marshal.c#L54-L55 target=_blank rel="noreferrer nofollow">link to the source</a>
).
This values are constants for any marshalled data and they are stored in <code>Marshal::MAJOR_VERSION</code> and <code>Marshal::MINOR_VERSION</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span> :<span style=color:#ae81ff>001</span> <span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>Marshal</span><span style=color:#f92672>::</span><span style=color:#66d9ef>MAJOR_VERSION</span>
</span></span><span style=display:flex><span> <span style=color:#f92672>=&gt;</span> <span style=color:#ae81ff>4</span>
</span></span><span style=display:flex><span> :<span style=color:#ae81ff>002</span> <span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>Marshal</span><span style=color:#f92672>::</span><span style=color:#66d9ef>MINOR_VERSION</span>
</span></span><span style=display:flex><span> <span style=color:#f92672>=&gt;</span> <span style=color:#ae81ff>8</span>
</span></span></code></pre></div><p>Our <code>PureRubyMarshal</code> should have same constants:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#66d9ef>module</span> PureRubyMarshal
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>MAJOR_VERSION</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>4</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>MINOR_VERSION</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>8</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><p>The rest of the array is actually a marshalled object.
So, for now marshalled data looks like <code>['4.8', some unknown characters]</code></p><p>To read the version of <code>Marshal</code> library we can modify <code>ReadBuffer#initialize</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#66d9ef>attr_reader</span> <span style=color:#e6db74>:minor_version</span>, <span style=color:#e6db74>:major_version</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>initialize</span>(data)
</span></span><span style=display:flex><span>  @data <span style=color:#f92672>=</span> data<span style=color:#f92672>.</span>chars
</span></span><span style=display:flex><span>  @major_version <span style=color:#f92672>=</span> read_byte
</span></span><span style=display:flex><span>  @minor_version <span style=color:#f92672>=</span> read_byte
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>read_char</span>
</span></span><span style=display:flex><span>  data<span style=color:#f92672>.</span>shift
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>read_byte</span>
</span></span><span style=display:flex><span>  read_char<span style=color:#f92672>.</span>ord
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># In irb:</span>
</span></span><span style=display:flex><span>marshalled <span style=color:#f92672>=</span> <span style=color:#66d9ef>Marshal</span><span style=color:#f92672>.</span>dump(<span style=color:#ae81ff>123</span>)
</span></span><span style=display:flex><span>read_buffer <span style=color:#f92672>=</span> <span style=color:#66d9ef>PureRubyMarshal</span><span style=color:#f92672>::</span><span style=color:#66d9ef>ReadBuffer</span><span style=color:#f92672>.</span>new(marshalled)
</span></span><span style=display:flex><span>read_buffer<span style=color:#f92672>.</span>major_version
</span></span><span style=display:flex><span> <span style=color:#f92672>=&gt;</span> <span style=color:#ae81ff>4</span>
</span></span><span style=display:flex><span>read_buffer<span style=color:#f92672>.</span>minor_version
</span></span><span style=display:flex><span> <span style=color:#f92672>=&gt;</span> <span style=color:#ae81ff>8</span>
</span></span></code></pre></div><h2 id=getting-objects-from-the-raw-data>Getting objects from the raw data</h2><p>When <code>Marshal</code> converts your object to a string, it uses very simple rules:</p><ul><li>All primitives like <code>Fixnum</code>, <code>Hash</code> or <code>Array</code> always use the same format of serialization,
prepended by a special character (each character for each unique type)</li><li>If an object has instance variables, these instance variables are always dumped in the same way (<code>Iobject{hash:of,instance:variables}</code>)</li><li>You can&rsquo;t dump multiple objects in a single operation,
so there&rsquo;s always a root object in marshalled string (which is actually placed in the beginning of the string)</li><li>This object is followed by all other data, like instance variables, string encoding etc.</li></ul><h2 id=nilclass-trueclass-falseclass><code>NilClass</code>, <code>TrueClass</code>, <code>FalseClass</code></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#66d9ef>ReadBuffer</span><span style=color:#f92672>.</span>new(<span style=color:#66d9ef>Marshal</span><span style=color:#f92672>.</span>dump(<span style=color:#66d9ef>nil</span>))<span style=color:#f92672>.</span>data
</span></span><span style=display:flex><span> <span style=color:#f92672>=&gt;</span> <span style=color:#f92672>[</span><span style=color:#e6db74>&#34;0&#34;</span><span style=color:#f92672>]</span>
</span></span></code></pre></div><p>Character <code>0</code> means that encoded object is <code>nil</code>. To handle it, we can write something like:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>PureRubyMarshal</span><span style=color:#f92672>::</span><span style=color:#66d9ef>ReadBuffer</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># ...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>read</span>
</span></span><span style=display:flex><span>    char <span style=color:#f92672>=</span> read_char
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> char
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>when</span> <span style=color:#e6db74>&#39;0&#39;</span> <span style=color:#66d9ef>then</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>raise</span> <span style=color:#66d9ef>NotImplementedError</span>, <span style=color:#e6db74>&#34;Unknown object type </span><span style=color:#e6db74>#{</span>char<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> :<span style=color:#ae81ff>001</span> <span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>ReadBuffer</span><span style=color:#f92672>.</span>new(<span style=color:#66d9ef>Marshal</span><span style=color:#f92672>.</span>dump(<span style=color:#66d9ef>nil</span>))<span style=color:#f92672>.</span>read
</span></span><span style=display:flex><span> <span style=color:#f92672>=&gt;</span> <span style=color:#66d9ef>nil</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span> :<span style=color:#ae81ff>001</span> <span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>ReadBuffer</span><span style=color:#f92672>.</span>new(<span style=color:#66d9ef>Marshal</span><span style=color:#f92672>.</span>dump(<span style=color:#66d9ef>true</span>))<span style=color:#f92672>.</span>data
</span></span><span style=display:flex><span> <span style=color:#f92672>=&gt;</span> <span style=color:#f92672>[</span><span style=color:#e6db74>&#34;T&#34;</span><span style=color:#f92672>]</span>
</span></span><span style=display:flex><span> :<span style=color:#ae81ff>002</span> <span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>ReadBuffer</span><span style=color:#f92672>.</span>new(<span style=color:#66d9ef>Marshal</span><span style=color:#f92672>.</span>dump(<span style=color:#66d9ef>false</span>))<span style=color:#f92672>.</span>data
</span></span><span style=display:flex><span> <span style=color:#f92672>=&gt;</span> <span style=color:#f92672>[</span><span style=color:#e6db74>&#34;F&#34;</span><span style=color:#f92672>]</span>
</span></span></code></pre></div><p><code>true</code> converts to <code>T</code>, <code>false</code> converts to <code>F</code>, nothing complex for now.</p><p>Let&rsquo;s extend our <code>case</code> statement:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#66d9ef>when</span> <span style=color:#e6db74>&#39;T&#39;</span> <span style=color:#66d9ef>then</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>when</span> <span style=color:#e6db74>&#39;F&#39;</span> <span style=color:#66d9ef>then</span> <span style=color:#66d9ef>false</span>
</span></span></code></pre></div><h2 id=tests>Tests</h2><p>Of course, we can&rsquo;t develop without tests,</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#75715e># fixtures.rb</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>FIXTURES</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#39;nil&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#66d9ef>nil</span>,
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#39;true&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#39;false&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># pure_ruby_marshal_spec.rb</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>require <span style=color:#e6db74>&#39;spec_helper&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>describe <span style=color:#66d9ef>PureRubyMarshal</span> <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>  describe <span style=color:#e6db74>&#39;.load&#39;</span> <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>FIXTURES</span><span style=color:#f92672>.</span>each <span style=color:#66d9ef>do</span> <span style=color:#f92672>|</span>fixture_name, fixture_value<span style=color:#f92672>|</span>
</span></span><span style=display:flex><span>      it <span style=color:#e6db74>&#34;loads marshalled </span><span style=color:#e6db74>#{</span>fixture_name<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span> <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>        result <span style=color:#f92672>=</span> <span style=color:#66d9ef>PureRubyMarshal</span><span style=color:#f92672>.</span>load(<span style=color:#66d9ef>Marshal</span><span style=color:#f92672>.</span>dump(fixture_value))
</span></span><span style=display:flex><span>        expect(result)<span style=color:#f92672>.</span>to eq(fixture_value)
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># rspec --format documentation</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>PureRubyMarshal</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>.</span>load
</span></span><span style=display:flex><span>    loads marshalled <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>    loads marshalled <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>    loads marshalled <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>3</span> examples, <span style=color:#ae81ff>0</span> failures
</span></span></code></pre></div><h2 id=integer>Integer</h2><p>All encoded integers are prepended with an <code>"i"</code> symbol. Added one more <code>when</code> to our <code>case</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#66d9ef>when</span> <span style=color:#e6db74>&#39;i&#39;</span> <span style=color:#66d9ef>then</span> read_integer
</span></span></code></pre></div><p>The next byte defines a strategy of decoding the rest of the data. Then comes a bytes sequence representing a number.</p><p>Let&rsquo;s say that <code>byte = (first_char_code_after_i ^ 128) - 128</code> (it ranges from <code>-128 .. 128</code>).</p><p>There are 5 different cases depending on the byte value:</p><ul><li><code>byte is 0</code></li><li><code>byte in [4..128]</code></li><li><code>byte in [1..4]</code></li><li><code>byte in [-128..-4]</code></li><li><code>byte in [-5..-1]</code></li></ul><p>Let&rsquo;s write a utility lambda to simplify examples:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span>get_sequence <span style=color:#f92672>=</span> lambda <span style=color:#66d9ef>do</span> <span style=color:#f92672>|</span>n<span style=color:#f92672>|</span>
</span></span><span style=display:flex><span>  buffer <span style=color:#f92672>=</span> <span style=color:#66d9ef>ReadBuffer</span><span style=color:#f92672>.</span>new(<span style=color:#66d9ef>Marshal</span><span style=color:#f92672>.</span>dump(n))
</span></span><span style=display:flex><span>  buffer<span style=color:#f92672>.</span>read_char
</span></span><span style=display:flex><span>  buffer<span style=color:#f92672>.</span>data<span style=color:#f92672>.</span>map(<span style=color:#f92672>&amp;</span><span style=color:#e6db74>:ord</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><p>It:</p><ul><li>marshalls passed number with native <code>Marshal</code></li><li>loads it through our pure ruby <code>ReadBuffer</code></li><li>reads one char (<code>"i"</code>)</li><li>takes the rest of the data</li><li>and converts characters to their codes</li></ul><p><strong>The first case</strong> is the simplest one:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span>get_sequence<span style=color:#f92672>[</span><span style=color:#ae81ff>0</span><span style=color:#f92672>]</span>
</span></span><span style=display:flex><span> <span style=color:#f92672>=&gt;</span> <span style=color:#f92672>[</span><span style=color:#ae81ff>0</span><span style=color:#f92672>]</span>
</span></span></code></pre></div><p>Zero is actually encoded as zero.</p><p><strong>The second case</strong>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span>get_sequence<span style=color:#f92672>[</span><span style=color:#ae81ff>7</span><span style=color:#f92672>]</span>
</span></span><span style=display:flex><span> <span style=color:#f92672>=&gt;</span> <span style=color:#f92672>[</span><span style=color:#ae81ff>12</span><span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>get_sequence<span style=color:#f92672>[</span><span style=color:#ae81ff>8</span><span style=color:#f92672>]</span>
</span></span><span style=display:flex><span> <span style=color:#f92672>=&gt;</span> <span style=color:#f92672>[</span><span style=color:#ae81ff>13</span><span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>get_sequence<span style=color:#f92672>[</span><span style=color:#ae81ff>120</span><span style=color:#f92672>]</span>
</span></span><span style=display:flex><span> <span style=color:#f92672>=&gt;</span> <span style=color:#f92672>[</span><span style=color:#ae81ff>125</span><span style=color:#f92672>]</span>
</span></span></code></pre></div><p>In this case <code>result = byte - 5</code> and it covers small positive numbers.</p><p><strong>The third case</strong>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span>get_sequence<span style=color:#f92672>[</span><span style=color:#ae81ff>99999</span><span style=color:#f92672>]</span>
</span></span><span style=display:flex><span> <span style=color:#f92672>=&gt;</span> <span style=color:#f92672>[</span><span style=color:#ae81ff>3</span>, <span style=color:#ae81ff>159</span>, <span style=color:#ae81ff>134</span>, <span style=color:#ae81ff>1</span><span style=color:#f92672>]</span>
</span></span></code></pre></div><p>3 means three numbers representing a single number, they should be merged with binary <code>OR</code> and byte shifting:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span>(<span style=color:#ae81ff>159</span> <span style=color:#f92672>&lt;&lt;</span> (<span style=color:#ae81ff>8</span><span style=color:#f92672>*</span><span style=color:#ae81ff>0</span>)) <span style=color:#f92672>|</span> (<span style=color:#ae81ff>134</span> <span style=color:#f92672>&lt;&lt;</span> (<span style=color:#ae81ff>8</span><span style=color:#f92672>*</span><span style=color:#ae81ff>1</span>)) <span style=color:#f92672>|</span> (<span style=color:#ae81ff>1</span> <span style=color:#f92672>&lt;&lt;</span> (<span style=color:#ae81ff>8</span><span style=color:#f92672>*</span><span style=color:#ae81ff>2</span>))
</span></span><span style=display:flex><span> <span style=color:#f92672>=&gt;</span> <span style=color:#ae81ff>99999</span>
</span></span></code></pre></div><p><strong>The fourth and the fifth examples</strong> are just like 2nd and 3rd, but for negative numbers.</p><p>Let&rsquo;s implement our <code>read_integer</code> method!</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>read_integer</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># c is our first byte</span>
</span></span><span style=display:flex><span>    c <span style=color:#f92672>=</span> (read_byte <span style=color:#f92672>^</span> <span style=color:#ae81ff>128</span>) <span style=color:#f92672>-</span> <span style=color:#ae81ff>128</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> c
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>when</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e># 0 means 0</span>
</span></span><span style=display:flex><span>      <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>when</span> (<span style=color:#ae81ff>4</span><span style=color:#f92672>..</span><span style=color:#ae81ff>127</span>)
</span></span><span style=display:flex><span>      <span style=color:#75715e># case for small positive numbers</span>
</span></span><span style=display:flex><span>      c <span style=color:#f92672>-</span> <span style=color:#ae81ff>5</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>when</span> (<span style=color:#ae81ff>1</span><span style=color:#f92672>..</span><span style=color:#ae81ff>3</span>)
</span></span><span style=display:flex><span>      <span style=color:#75715e># c next bytes is our big positive number</span>
</span></span><span style=display:flex><span>      c<span style=color:#f92672>.</span>
</span></span><span style=display:flex><span>        times<span style=color:#f92672>.</span>
</span></span><span style=display:flex><span>        map { <span style=color:#f92672>|</span>i<span style=color:#f92672>|</span> <span style=color:#f92672>[</span>i, read_byte<span style=color:#f92672>]</span> }<span style=color:#f92672>.</span>
</span></span><span style=display:flex><span>        inject(<span style=color:#ae81ff>0</span>) { <span style=color:#f92672>|</span>result, (i, byte)<span style=color:#f92672>|</span> result <span style=color:#f92672>|</span> (byte <span style=color:#f92672>&lt;&lt;</span> (<span style=color:#ae81ff>8</span><span style=color:#f92672>*</span>i))  }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>when</span> (<span style=color:#f92672>-</span><span style=color:#ae81ff>128</span><span style=color:#f92672>..-</span><span style=color:#ae81ff>6</span>)
</span></span><span style=display:flex><span>      <span style=color:#75715e># case for small negative numbers</span>
</span></span><span style=display:flex><span>      c <span style=color:#f92672>+</span> <span style=color:#ae81ff>5</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>when</span> (<span style=color:#f92672>-</span><span style=color:#ae81ff>5</span><span style=color:#f92672>..-</span><span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>      <span style=color:#75715e># (-c) next bytes is our number</span>
</span></span><span style=display:flex><span>      (<span style=color:#f92672>-</span>c)<span style=color:#f92672>.</span>
</span></span><span style=display:flex><span>        times<span style=color:#f92672>.</span>
</span></span><span style=display:flex><span>        map { <span style=color:#f92672>|</span>i<span style=color:#f92672>|</span> <span style=color:#f92672>[</span>i, read_byte<span style=color:#f92672>]</span> }<span style=color:#f92672>.</span>
</span></span><span style=display:flex><span>        inject(<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>) <span style=color:#66d9ef>do</span> <span style=color:#f92672>|</span>result, (i, byte)<span style=color:#f92672>|</span>
</span></span><span style=display:flex><span>          a <span style=color:#f92672>=</span> <span style=color:#f92672>~</span>(<span style=color:#ae81ff>0xff</span> <span style=color:#f92672>&lt;&lt;</span> (<span style=color:#ae81ff>8</span><span style=color:#f92672>*</span>i))
</span></span><span style=display:flex><span>          b <span style=color:#f92672>=</span> byte <span style=color:#f92672>&lt;&lt;</span> (<span style=color:#ae81ff>8</span><span style=color:#f92672>*</span>i)
</span></span><span style=display:flex><span>          (result <span style=color:#f92672>&amp;</span> a) <span style=color:#f92672>|</span> b
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span></code></pre></div><p>To add tests for integers, we can just add more key-value pairs to our
<code>FIXTURES</code> constant.</p><p>Complex data types like</p><ul><li><code>Array</code></li><li><code>String</code></li><li><code>Hash</code></li><li><code>Regexp</code></li></ul><p>and others include numbers into their encoded structure to represent their length.</p><h2 id=symbol>Symbol</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#66d9ef>ReadBuffer</span><span style=color:#f92672>.</span>new(<span style=color:#66d9ef>Marshal</span><span style=color:#f92672>.</span>dump(<span style=color:#e6db74>:a_symbol</span>))<span style=color:#f92672>.</span>data
</span></span><span style=display:flex><span> <span style=color:#f92672>=&gt;</span> <span style=color:#f92672>[</span><span style=color:#e6db74>&#34;:&#34;</span>, <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\r</span><span style=color:#e6db74>&#34;</span>, <span style=color:#e6db74>&#34;a&#34;</span>, <span style=color:#e6db74>&#34;_&#34;</span>, <span style=color:#e6db74>&#34;s&#34;</span>, <span style=color:#e6db74>&#34;y&#34;</span>, <span style=color:#e6db74>&#34;m&#34;</span>, <span style=color:#e6db74>&#34;b&#34;</span>, <span style=color:#e6db74>&#34;o&#34;</span>, <span style=color:#e6db74>&#34;l&#34;</span><span style=color:#f92672>]</span>
</span></span></code></pre></div><p>Symbols are encoded using:</p><ul><li>a special <code>":"</code> character</li><li>Symbol length (<code>"\r".ord - 5 = 8</code>) as Integer (we can fetch it using <code>read_integer</code> method)</li><li>The Symbol itself, character by character</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#75715e># one more &#34;when&#34; statement</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>when</span> <span style=color:#e6db74>&#39;:&#39;</span> <span style=color:#66d9ef>then</span> read_symbol
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># and implementation</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>read_symbol</span>
</span></span><span style=display:flex><span>  read_integer<span style=color:#f92672>.</span>times<span style=color:#f92672>.</span>map { read_char }<span style=color:#f92672>.</span>join<span style=color:#f92672>.</span>to_sym
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><h2 id=string>String</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#66d9ef>ReadBuffer</span><span style=color:#f92672>.</span>new(<span style=color:#66d9ef>Marshal</span><span style=color:#f92672>.</span>dump(<span style=color:#e6db74>&#34;a string&#34;</span>))<span style=color:#f92672>.</span>data
</span></span><span style=display:flex><span> <span style=color:#f92672>=&gt;</span> <span style=color:#f92672>[</span><span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\&#34;</span><span style=color:#e6db74>&#34;</span>, <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\r</span><span style=color:#e6db74>&#34;</span>, <span style=color:#e6db74>&#34;a&#34;</span>, <span style=color:#e6db74>&#34; &#34;</span>, <span style=color:#e6db74>&#34;s&#34;</span>, <span style=color:#e6db74>&#34;t&#34;</span>, <span style=color:#e6db74>&#34;r&#34;</span>, <span style=color:#e6db74>&#34;i&#34;</span>, <span style=color:#e6db74>&#34;n&#34;</span>, <span style=color:#e6db74>&#34;g&#34;</span><span style=color:#f92672>]</span>
</span></span></code></pre></div><p>Where:</p><ul><li><code>"\""</code> is actually a <code>"</code> symbol which shows the beginning of the encoded string</li><li>the next encoded number <code>n = 8</code> is a length of the string</li><li><code>n</code> following symbols are the string itself.</li></ul><p>To support loading marshalled string, we can use the following code:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#75715e># ...</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>when</span> <span style=color:#e6db74>&#39;&#34;&#39;</span> <span style=color:#66d9ef>then</span> read_string
</span></span><span style=display:flex><span><span style=color:#75715e># ...</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>read_string</span>
</span></span><span style=display:flex><span>  read_integer<span style=color:#f92672>.</span>times<span style=color:#f92672>.</span>map { read_char }<span style=color:#f92672>.</span>join
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><h2 id=array>Array</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#66d9ef>ReadBuffer</span><span style=color:#f92672>.</span>new(<span style=color:#66d9ef>Marshal</span><span style=color:#f92672>.</span>dump(<span style=color:#f92672>[</span><span style=color:#ae81ff>1</span>,<span style=color:#ae81ff>2</span>,<span style=color:#ae81ff>3</span><span style=color:#f92672>]</span>))<span style=color:#f92672>.</span>data
</span></span><span style=display:flex><span> <span style=color:#f92672>=&gt;</span> <span style=color:#f92672>[</span><span style=color:#e6db74>&#34;[&#34;</span>, <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\b</span><span style=color:#e6db74>&#34;</span>, <span style=color:#e6db74>&#34;i&#34;</span>, <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\x06</span><span style=color:#e6db74>&#34;</span>, <span style=color:#e6db74>&#34;i&#34;</span>, <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\a</span><span style=color:#e6db74>&#34;</span>, <span style=color:#e6db74>&#34;i&#34;</span>, <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\b</span><span style=color:#e6db74>&#34;</span><span style=color:#f92672>]</span>
</span></span></code></pre></div><ul><li><code>"["</code> means that converted object is an <code>Array</code></li><li>the next encoded number <code>n = 3</code> is a length of our array</li><li><code>"i", "1"</code> is an <code>Integer 1</code></li><li><code>"i", "2"</code> is an <code>Integer 2</code></li><li><code>"i", "3"</code> is an <code>Integer 3</code></li></ul><p>Array items are encoded as separate objects, every item is prepended by its own service character:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#75715e># ...</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>when</span> <span style=color:#e6db74>&#39;[&#39;</span> <span style=color:#66d9ef>then</span> read_array
</span></span><span style=display:flex><span><span style=color:#75715e># ...</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>read_array</span>
</span></span><span style=display:flex><span>  read_integer<span style=color:#f92672>.</span>times<span style=color:#f92672>.</span>map { read }
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><h2 id=hash>Hash</h2><p><code>Hash</code> is encoded as an array of key-value pairs:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#66d9ef>ReadBuffer</span><span style=color:#f92672>.</span>new(<span style=color:#66d9ef>Marshal</span><span style=color:#f92672>.</span>dump({ <span style=color:#ae81ff>15</span> <span style=color:#f92672>=&gt;</span> <span style=color:#ae81ff>5</span> }))<span style=color:#f92672>.</span>data
</span></span><span style=display:flex><span> <span style=color:#f92672>=&gt;</span> <span style=color:#f92672>[</span><span style=color:#e6db74>&#34;{&#34;</span>, <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\x06</span><span style=color:#e6db74>&#34;</span>, <span style=color:#e6db74>&#34;i&#34;</span>, <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\x14</span><span style=color:#e6db74>&#34;</span>, <span style=color:#e6db74>&#34;i&#34;</span>, <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span><span style=color:#f92672>]</span>
</span></span></code></pre></div><ul><li><code>"{"</code> is the beginning of hash</li><li><code>1</code> is a number of <code>key => value</code> pairs</li><li><code>"i" 15</code> is an <code>Integer 15</code></li><li><code>"i" 5</code> is an <code>Integer 5</code></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#75715e># ...</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>when</span> <span style=color:#e6db74>&#39;{&#39;</span> <span style=color:#66d9ef>then</span> read_hash
</span></span><span style=display:flex><span><span style=color:#75715e># ...</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>read_hash</span>
</span></span><span style=display:flex><span>  pairs <span style=color:#f92672>=</span> read_integer<span style=color:#f92672>.</span>times<span style=color:#f92672>.</span>map { <span style=color:#f92672>[</span>read, read<span style=color:#f92672>]</span> }
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>Hash</span><span style=color:#f92672>[</span>pairs<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><h2 id=float>Float</h2><p><code>Float</code> is encoded as its string representation</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#66d9ef>ReadBuffer</span><span style=color:#f92672>.</span>new(<span style=color:#66d9ef>Marshal</span><span style=color:#f92672>.</span>dump(<span style=color:#ae81ff>1</span><span style=color:#f92672>.</span><span style=color:#ae81ff>5</span>))<span style=color:#f92672>.</span>data
</span></span><span style=display:flex><span> <span style=color:#f92672>=&gt;</span> <span style=color:#f92672>[</span><span style=color:#e6db74>&#34;f&#34;</span>, <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\b</span><span style=color:#e6db74>&#34;</span>, <span style=color:#e6db74>&#34;1&#34;</span>, <span style=color:#e6db74>&#34;.&#34;</span>, <span style=color:#e6db74>&#34;5&#34;</span><span style=color:#f92672>]</span>
</span></span></code></pre></div><p>Floats are encoded using <code>#to_s</code> method:</p><ul><li><code>"f"</code> is the beginning of <code>Float</code></li><li><code>3</code> is the length</li><li><code>"1", ".", "5"</code> is its string representation</li></ul><p>To get it back, we can use <code>String#to_f</code> method:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#75715e># ...</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>when</span> <span style=color:#e6db74>&#39;f&#39;</span> <span style=color:#66d9ef>then</span> read_float
</span></span><span style=display:flex><span><span style=color:#75715e># ...</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>read_float</span>
</span></span><span style=display:flex><span>  read_string<span style=color:#f92672>.</span>to_f
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><h2 id=class>Class</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#66d9ef>ReadBuffer</span><span style=color:#f92672>.</span>new(<span style=color:#66d9ef>Marshal</span><span style=color:#f92672>.</span>dump(Array))<span style=color:#f92672>.</span>data
</span></span><span style=display:flex><span> <span style=color:#f92672>=&gt;</span> <span style=color:#f92672>[</span><span style=color:#e6db74>&#34;c&#34;</span>, <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, <span style=color:#e6db74>&#34;A&#34;</span>, <span style=color:#e6db74>&#34;r&#34;</span>, <span style=color:#e6db74>&#34;r&#34;</span>, <span style=color:#e6db74>&#34;a&#34;</span>, <span style=color:#e6db74>&#34;y&#34;</span><span style=color:#f92672>]</span>
</span></span></code></pre></div><p>Classes are represented by their names:</p><ul><li><code>"c"</code> means a <code>Class</code></li><li><code>5</code> is the length of its name</li><li>next 5 characters are the name itself</li></ul><p>After reading the name we can do <code>Object.const_get(const_name)</code> to retrieve the actual class.
The only remark here is that when the class does not exist anymore,
<code>Marshal</code> re-raises <code>ArgumentError, "undefined class/module #{const_name}"</code> instead of a <code>NameError</code>.
Moreover, if the constant returned by <code>Object.const_get</code> is not a class,
<code>Marshal</code> raises <code>ArgumentError, "#{const_name} does not refer to a Class"</code>.
So, the constant <strong>must</strong> exist and it <strong>must</strong> be a <code>Class</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#75715e># ...</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>when</span> <span style=color:#e6db74>&#39;c&#39;</span> <span style=color:#66d9ef>then</span> read_class
</span></span><span style=display:flex><span><span style=color:#75715e># ...</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>marshal_const_get</span>(const_name)
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>Object</span><span style=color:#f92672>.</span>const_get(const_name)
</span></span><span style=display:flex><span><span style=color:#66d9ef>rescue</span> <span style=color:#66d9ef>NameError</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>raise</span> <span style=color:#66d9ef>ArgumentError</span>, <span style=color:#e6db74>&#34;undefined class/module </span><span style=color:#e6db74>#{</span>const_name<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>read_class</span>
</span></span><span style=display:flex><span>  const_name <span style=color:#f92672>=</span> read_string
</span></span><span style=display:flex><span>  klass <span style=color:#f92672>=</span> marshal_const_get(const_name)
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>unless</span> klass<span style=color:#f92672>.</span>instance_of?(<span style=color:#66d9ef>Class</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>raise</span> <span style=color:#66d9ef>ArgumentError</span>, <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>#{</span>const_name<span style=color:#e6db74>}</span><span style=color:#e6db74> does not refer to a Class&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>  klass
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><p>I have extracted <code>marshal_const_get</code> to a separate method to use it later for
reading a <code>Module</code> from the marshalled data.</p><h2 id=module>Module</h2><p>Modules are similar to Classes, but the &ldquo;magical&rdquo; character is <code>"m"</code> instead of <code>"c"</code>
(and, of course, messages of exceptions are about modules).</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#75715e># ...</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>when</span> <span style=color:#e6db74>&#39;m&#39;</span> <span style=color:#66d9ef>then</span> read_module
</span></span><span style=display:flex><span><span style=color:#75715e># ...</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>read_module</span>
</span></span><span style=display:flex><span>  const_name <span style=color:#f92672>=</span> read_string
</span></span><span style=display:flex><span>  klass <span style=color:#f92672>=</span> marshal_const_get(const_name)
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>unless</span> klass<span style=color:#f92672>.</span>instance_of?(<span style=color:#66d9ef>Module</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>raise</span> <span style=color:#66d9ef>ArgumentError</span>, <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>#{</span>const_name<span style=color:#e6db74>}</span><span style=color:#e6db74> does not refer to a Module&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>  klass
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><h2 id=struct><code>Struct</code></h2><p><code>Struct</code> classes are encoded by their class names + their data:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#66d9ef>Point</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>Struct</span><span style=color:#f92672>.</span>new(<span style=color:#e6db74>:x</span>, <span style=color:#e6db74>:y</span>)
</span></span><span style=display:flex><span>a <span style=color:#f92672>=</span> <span style=color:#66d9ef>Point</span><span style=color:#f92672>.</span>new(<span style=color:#ae81ff>3</span>, <span style=color:#ae81ff>7</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>ReadBuffer</span><span style=color:#f92672>.</span>new(<span style=color:#66d9ef>Marshal</span><span style=color:#f92672>.</span>dump(a))<span style=color:#f92672>.</span>data
</span></span><span style=display:flex><span> <span style=color:#f92672>=&gt;</span> <span style=color:#f92672>[</span><span style=color:#e6db74>&#34;S&#34;</span>, <span style=color:#e6db74>&#34;:&#34;</span>, <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, <span style=color:#e6db74>&#34;P&#34;</span>, <span style=color:#e6db74>&#34;o&#34;</span>, <span style=color:#e6db74>&#34;i&#34;</span>, <span style=color:#e6db74>&#34;n&#34;</span>, <span style=color:#e6db74>&#34;t&#34;</span>, <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\a</span><span style=color:#e6db74>&#34;</span>, <span style=color:#e6db74>&#34;:&#34;</span>, <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\x06</span><span style=color:#e6db74>&#34;</span>, <span style=color:#e6db74>&#34;x&#34;</span>, <span style=color:#e6db74>&#34;i&#34;</span>, <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\b</span><span style=color:#e6db74>&#34;</span>, <span style=color:#e6db74>&#34;:&#34;</span>, <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\x06</span><span style=color:#e6db74>&#34;</span>, <span style=color:#e6db74>&#34;y&#34;</span>, <span style=color:#e6db74>&#34;i&#34;</span>, <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\f</span><span style=color:#e6db74>&#34;</span><span style=color:#f92672>]</span>
</span></span></code></pre></div><p>This output can be split to:</p><ul><li><code>"S"</code> means a beginning of encoded <code>Struct</code></li><li><code>":", 5, "P", "o", "i", "n", "t"</code> is a Symbol <code>:Point</code></li><li><code>2, ":", 1, "x", "i", 2, ":", 1, "y", "i", 3</code> is a visually unmarked Hash (i.e. no <code>{</code> header) with 2 pairs:<ul><li><code>":", 1, "x"</code> is a Symbol <code>:x</code></li><li><code>"i", 2</code> is an Integer <code>2</code></li><li><code>":", 1, "y"</code> is a Symbol <code>:y</code></li><li><code>"i", 3</code> is an Integer <code>3</code></li></ul></li></ul><p>So, we have a <code>Struct</code> defined with its class name and the Hash containing object&rsquo;s data</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#75715e># ...</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>when</span> <span style=color:#e6db74>&#39;S&#39;</span> <span style=color:#66d9ef>then</span> read_struct
</span></span><span style=display:flex><span><span style=color:#75715e># ...</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>read_struct</span>
</span></span><span style=display:flex><span>  klass <span style=color:#f92672>=</span> marshal_const_get(read) <span style=color:#75715e># Point</span>
</span></span><span style=display:flex><span>  attributes <span style=color:#f92672>=</span> read_hash <span style=color:#75715e># { x: 3, y: 7 }</span>
</span></span><span style=display:flex><span>  values <span style=color:#f92672>=</span> attributes<span style=color:#f92672>.</span>values_at(<span style=color:#f92672>*</span>klass<span style=color:#f92672>.</span>members) <span style=color:#75715e># [3, 7]</span>
</span></span><span style=display:flex><span>  klass<span style=color:#f92672>.</span>new(<span style=color:#f92672>*</span>values)
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><p>Why is class name encoded as a <code>Symbol</code>, not a <code>String</code>? See section &lsquo;Symbol link&rsquo;</p><h2 id=regexp>Regexp</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#66d9ef>ReadBuffer</span><span style=color:#f92672>.</span>new(<span style=color:#66d9ef>Marshal</span><span style=color:#f92672>.</span>dump(<span style=color:#e6db74>/a_regexp/</span>))<span style=color:#f92672>.</span>data
</span></span><span style=display:flex><span> <span style=color:#f92672>=&gt;</span> <span style=color:#f92672>[</span><span style=color:#e6db74>&#34;/&#34;</span>, <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\r</span><span style=color:#e6db74>&#34;</span>, <span style=color:#e6db74>&#34;a&#34;</span>, <span style=color:#e6db74>&#34;_&#34;</span>, <span style=color:#e6db74>&#34;r&#34;</span>, <span style=color:#e6db74>&#34;e&#34;</span>, <span style=color:#e6db74>&#34;g&#34;</span>, <span style=color:#e6db74>&#34;e&#34;</span>, <span style=color:#e6db74>&#34;x&#34;</span>, <span style=color:#e6db74>&#34;p&#34;</span>, <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\x00</span><span style=color:#e6db74>&#34;</span><span style=color:#f92672>]</span>
</span></span></code></pre></div><p>Alright, there are:</p><ul><li><code>"/"</code> - a beginning of a regexp</li><li><code>8</code> - length of its string representation</li><li><code>"a_regexp"</code> - string representation</li><li>0 - a <a href=http://ruby-doc.org/core-2.1.1/Regexp.html#method-c-new target=_blank rel="noreferrer nofollow"><code>kcode</code></a>
that was passed to a constructor</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#75715e># ...</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>when</span> <span style=color:#e6db74>&#39;/&#39;</span> <span style=color:#66d9ef>then</span> read_regexp
</span></span><span style=display:flex><span><span style=color:#75715e># ...</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>read_regexp</span>
</span></span><span style=display:flex><span>  string <span style=color:#f92672>=</span> read_string
</span></span><span style=display:flex><span>  kcode <span style=color:#f92672>=</span> read_byte
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>Regexp</span><span style=color:#f92672>.</span>new(string, kcode)
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><h2 id=abstract-object>Abstract object</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Point2</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>attr_reader</span> <span style=color:#e6db74>:x</span>, <span style=color:#e6db74>:y</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>initialize</span>(x, y)
</span></span><span style=display:flex><span>    @x, @y <span style=color:#f92672>=</span> x, y
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>==</span>(other)
</span></span><span style=display:flex><span>    other<span style=color:#f92672>.</span>is_a?(<span style=color:#66d9ef>Point2</span>) <span style=color:#f92672>&amp;&amp;</span>
</span></span><span style=display:flex><span>      other<span style=color:#f92672>.</span>x <span style=color:#f92672>==</span> self<span style=color:#f92672>.</span>x <span style=color:#f92672>&amp;&amp;</span>
</span></span><span style=display:flex><span>      other<span style=color:#f92672>.</span>y <span style=color:#f92672>==</span> self<span style=color:#f92672>.</span>y
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>point <span style=color:#f92672>=</span> <span style=color:#66d9ef>Point2</span><span style=color:#f92672>.</span>new(<span style=color:#ae81ff>5</span>, <span style=color:#ae81ff>10</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>ReadBuffer</span><span style=color:#f92672>.</span>new(<span style=color:#66d9ef>Marshal</span><span style=color:#f92672>.</span>dump(point))<span style=color:#f92672>.</span>data
</span></span><span style=display:flex><span> <span style=color:#f92672>=&gt;</span> <span style=color:#f92672>[</span><span style=color:#e6db74>&#34;o&#34;</span>, <span style=color:#e6db74>&#34;:&#34;</span>, <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\v</span><span style=color:#e6db74>&#34;</span>, <span style=color:#e6db74>&#34;P&#34;</span>, <span style=color:#e6db74>&#34;o&#34;</span>, <span style=color:#e6db74>&#34;i&#34;</span>, <span style=color:#e6db74>&#34;n&#34;</span>, <span style=color:#e6db74>&#34;t&#34;</span>, <span style=color:#e6db74>&#34;2&#34;</span>, <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\a</span><span style=color:#e6db74>&#34;</span>, <span style=color:#e6db74>&#34;:&#34;</span>, <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\a</span><span style=color:#e6db74>&#34;</span>, <span style=color:#e6db74>&#34;@&#34;</span>, <span style=color:#e6db74>&#34;x&#34;</span>, <span style=color:#e6db74>&#34;i&#34;</span>, <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, <span style=color:#e6db74>&#34;:&#34;</span>, <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\a</span><span style=color:#e6db74>&#34;</span>, <span style=color:#e6db74>&#34;@&#34;</span>, <span style=color:#e6db74>&#34;y&#34;</span>, <span style=color:#e6db74>&#34;i&#34;</span>, <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\x0F</span><span style=color:#e6db74>&#34;</span><span style=color:#f92672>]</span>
</span></span></code></pre></div><ul><li><code>"o"</code> means the beginning of any non-standard object</li><li><code>":", 6, "P", "o", "i", "n", "t", "2"</code> is a Symbol <code>:Point2</code></li><li><code>2, ":", 2, "@", "x", "i", 5, ":", 2, "@", "y", "i", 10</code> is a Hash with 2 key-value pairs:<ul><li>key <code>":", 2, "@", "x"</code> is a Symbol <code>@x</code></li><li>value <code>"i", 5</code> is an Integer <code>4</code></li><li>key <code>":", 2, "@", "y"</code> is a Symbol <code>@y</code></li><li>value <code>"i", 10</code> is an Integer <code>5</code></li></ul></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#75715e># ...</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>when</span> <span style=color:#e6db74>&#39;o&#39;</span> <span style=color:#66d9ef>then</span> read_object
</span></span><span style=display:flex><span><span style=color:#75715e># ...</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>read_object</span>
</span></span><span style=display:flex><span>  klass <span style=color:#f92672>=</span> marshal_const_get(read) <span style=color:#75715e># Point2</span>
</span></span><span style=display:flex><span>  ivars_data <span style=color:#f92672>=</span> read_hash <span style=color:#75715e># { :@x =&gt; 5, :@y = 10 }</span>
</span></span><span style=display:flex><span>  object <span style=color:#f92672>=</span> klass<span style=color:#f92672>.</span>allocate <span style=color:#75715e># #&lt;Point &gt;</span>
</span></span><span style=display:flex><span>  ivars_data<span style=color:#f92672>.</span>each <span style=color:#66d9ef>do</span> <span style=color:#f92672>|</span>ivar_name, value<span style=color:#f92672>|</span>
</span></span><span style=display:flex><span>    object<span style=color:#f92672>.</span>instance_variable_set(ivar_name, value)
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>  object
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><h2 id=user-class>User class</h2><p>User classes are classes inherited from default classes:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MyArray</span> <span style=color:#f92672>&lt;</span> Array
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>my_array <span style=color:#f92672>=</span> <span style=color:#66d9ef>MyArray</span><span style=color:#f92672>[</span><span style=color:#ae81ff>1</span>,<span style=color:#ae81ff>2</span>,<span style=color:#ae81ff>3</span><span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>ReadBuffer</span><span style=color:#f92672>.</span>new(<span style=color:#66d9ef>Marshal</span><span style=color:#f92672>.</span>dump(my_array))<span style=color:#f92672>.</span>data
</span></span><span style=display:flex><span> <span style=color:#f92672>=&gt;</span> <span style=color:#f92672>[</span><span style=color:#e6db74>&#34;C&#34;</span>, <span style=color:#e6db74>&#34;:&#34;</span>, <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\f</span><span style=color:#e6db74>&#34;</span>, <span style=color:#e6db74>&#34;M&#34;</span>, <span style=color:#e6db74>&#34;y&#34;</span>, <span style=color:#e6db74>&#34;A&#34;</span>, <span style=color:#e6db74>&#34;r&#34;</span>, <span style=color:#e6db74>&#34;r&#34;</span>, <span style=color:#e6db74>&#34;a&#34;</span>, <span style=color:#e6db74>&#34;y&#34;</span>, <span style=color:#e6db74>&#34;[&#34;</span>, <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\b</span><span style=color:#e6db74>&#34;</span>, <span style=color:#e6db74>&#34;i&#34;</span>, <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\x06</span><span style=color:#e6db74>&#34;</span>, <span style=color:#e6db74>&#34;i&#34;</span>, <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\a</span><span style=color:#e6db74>&#34;</span>, <span style=color:#e6db74>&#34;i&#34;</span>, <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\b</span><span style=color:#e6db74>&#34;</span><span style=color:#f92672>]</span>
</span></span></code></pre></div><p>Objects of these classes are encoded in the following way:</p><ul><li><code>"C"</code> - a beginning of a user class</li><li><code>":", 7, "M", "y", "A", "r", "r", "a", "y"</code> - a symbol <code>:MyArray</code> - the name of the user class</li><li>the rest of the data that should be passed to constructor (array <code>[1, 2, 3]</code> for this example)</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#75715e># ...</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>when</span> <span style=color:#e6db74>&#39;C&#39;</span> <span style=color:#66d9ef>then</span> read_userclass
</span></span><span style=display:flex><span><span style=color:#75715e># ...</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>read_userclass</span>
</span></span><span style=display:flex><span>  klass <span style=color:#f92672>=</span> marshal_const_get(read)
</span></span><span style=display:flex><span>  data <span style=color:#f92672>=</span> read
</span></span><span style=display:flex><span>  klass<span style=color:#f92672>.</span>new(data)
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><h2 id=extended-object>Extended object</h2><p>Sometimes your object is very, very complex. Like an object extended with some modules:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#66d9ef>MyModule</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>Module</span><span style=color:#f92672>.</span>new
</span></span><span style=display:flex><span>obj <span style=color:#f92672>=</span> <span style=color:#f92672>[]</span>
</span></span><span style=display:flex><span>obj<span style=color:#f92672>.</span>extend(<span style=color:#66d9ef>MyModule</span>)
</span></span></code></pre></div><p>In this case <code>Marshal</code> prepends you object structure with the list of extended modules:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#66d9ef>ReadBuffer</span><span style=color:#f92672>.</span>new(<span style=color:#66d9ef>Marshal</span><span style=color:#f92672>.</span>dump(obj))<span style=color:#f92672>.</span>data
</span></span><span style=display:flex><span> <span style=color:#f92672>=&gt;</span> <span style=color:#f92672>[</span><span style=color:#e6db74>&#34;e&#34;</span>, <span style=color:#e6db74>&#34;:&#34;</span>, <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\r</span><span style=color:#e6db74>&#34;</span>, <span style=color:#e6db74>&#34;M&#34;</span>, <span style=color:#e6db74>&#34;y&#34;</span>, <span style=color:#e6db74>&#34;M&#34;</span>, <span style=color:#e6db74>&#34;o&#34;</span>, <span style=color:#e6db74>&#34;d&#34;</span>, <span style=color:#e6db74>&#34;u&#34;</span>, <span style=color:#e6db74>&#34;l&#34;</span>, <span style=color:#e6db74>&#34;e&#34;</span>, <span style=color:#e6db74>&#34;[&#34;</span>, <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\x00</span><span style=color:#e6db74>&#34;</span><span style=color:#f92672>]</span>
</span></span></code></pre></div><p>Where:</p><ul><li><code>"e"</code> means that marshalled data has the following scheme:<ul><li>a <code>Symbol</code> that represents a name of a Ruby module (<code>:MyModule</code>)</li><li>an abstract dumped object that was extended with this module and should be retrieved</li></ul></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#75715e># ...</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>when</span> <span style=color:#e6db74>&#39;e&#39;</span> <span style=color:#66d9ef>then</span> read_extended_object
</span></span><span style=display:flex><span><span style=color:#75715e># ...</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>read_extended_object</span>
</span></span><span style=display:flex><span>  mod <span style=color:#f92672>=</span> marshal_const_get(read) <span style=color:#75715e># MyModule</span>
</span></span><span style=display:flex><span>  object <span style=color:#f92672>=</span> read <span style=color:#75715e># []</span>
</span></span><span style=display:flex><span>  object<span style=color:#f92672>.</span>extend(mod)
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><h2 id=symbol-links>Symbol links</h2><p>I guess this idea was originally created for compressing marshalled output.
Consider the following situation: you have a collection of objects of the same class
(the simplest example is a result of calling <code>YourActiveRecordModel.all</code>).
When you pass this collection to <code>Marshal.dump</code>, it converts objects one by one, writing them to an output stream.
But an abstract object is represented by its class name and a hash of instance variables.
Symbol links save you from writing the same <code>class.name</code> again and again to the output.
Instead, it remembers all symbols that have been written, and when the symbol appears twice in the sequence,
it writes its sequence number.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span>a1 <span style=color:#f92672>=</span> <span style=color:#f92672>[</span><span style=color:#e6db74>:symbol1</span>, <span style=color:#e6db74>:symbol2</span><span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>a2 <span style=color:#f92672>=</span> <span style=color:#f92672>[</span><span style=color:#e6db74>:symbol1</span>, <span style=color:#e6db74>:symbol1</span><span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>dumped1 <span style=color:#f92672>=</span> <span style=color:#66d9ef>Marshal</span><span style=color:#f92672>.</span>dump(a1)
</span></span><span style=display:flex><span> <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\x04\b</span><span style=color:#e6db74>[</span><span style=color:#ae81ff>\a</span><span style=color:#e6db74>:</span><span style=color:#ae81ff>\f</span><span style=color:#e6db74>symbol1:</span><span style=color:#ae81ff>\f</span><span style=color:#e6db74>symbol2&#34;</span>
</span></span><span style=display:flex><span>dumped1<span style=color:#f92672>.</span>length
</span></span><span style=display:flex><span> <span style=color:#f92672>=&gt;</span> <span style=color:#ae81ff>22</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>dumped2 <span style=color:#f92672>=</span> <span style=color:#66d9ef>Marshal</span><span style=color:#f92672>.</span>dump(a2)
</span></span><span style=display:flex><span> <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\x04\b</span><span style=color:#e6db74>[</span><span style=color:#ae81ff>\a</span><span style=color:#e6db74>:</span><span style=color:#ae81ff>\f</span><span style=color:#e6db74>symbol1;</span><span style=color:#ae81ff>\x00</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>dumped2<span style=color:#f92672>.</span>length
</span></span><span style=display:flex><span> <span style=color:#f92672>=&gt;</span> <span style=color:#ae81ff>15</span>
</span></span></code></pre></div><p>For this example it saves us 31% of the initial size. Let&rsquo;s see how it works:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#66d9ef>ReadBuffer</span><span style=color:#f92672>.</span>new(<span style=color:#66d9ef>Marshal</span><span style=color:#f92672>.</span>dump(a2))<span style=color:#f92672>.</span>data
</span></span><span style=display:flex><span> <span style=color:#f92672>=&gt;</span> <span style=color:#f92672>[</span><span style=color:#e6db74>&#34;[&#34;</span>, <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\a</span><span style=color:#e6db74>&#34;</span>, <span style=color:#e6db74>&#34;:&#34;</span>, <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\f</span><span style=color:#e6db74>&#34;</span>, <span style=color:#e6db74>&#34;s&#34;</span>, <span style=color:#e6db74>&#34;y&#34;</span>, <span style=color:#e6db74>&#34;m&#34;</span>, <span style=color:#e6db74>&#34;b&#34;</span>, <span style=color:#e6db74>&#34;o&#34;</span>, <span style=color:#e6db74>&#34;l&#34;</span>, <span style=color:#e6db74>&#34;1&#34;</span>, <span style=color:#e6db74>&#34;;&#34;</span>, <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\x00</span><span style=color:#e6db74>&#34;</span><span style=color:#f92672>]</span>
</span></span></code></pre></div><p>So we have an array of two items:</p><ul><li>a <code>Symbol</code> <code>:symbol1</code></li><li>a special character <code>";"</code> representing beginning of symbol link and an encoded <code>Integer</code> that represents a symbol with this index</li></ul><p>The algorithm for parsing <code>Symbol</code> should be changed a little bit
to save all symbols to an internal array.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>initialize</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># ...</span>
</span></span><span style=display:flex><span>  @symbols_cache <span style=color:#f92672>=</span> <span style=color:#f92672>[]</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># ...</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># ...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>read_symbol</span>
</span></span><span style=display:flex><span>  symbol <span style=color:#f92672>=</span> read_integer<span style=color:#f92672>.</span>times<span style=color:#f92672>.</span>map { read_char }<span style=color:#f92672>.</span>join<span style=color:#f92672>.</span>to_sym <span style=color:#75715e># no changes here</span>
</span></span><span style=display:flex><span>  @symbols_cache <span style=color:#f92672>&lt;&lt;</span> symbol <span style=color:#75715e># save a symbol</span>
</span></span><span style=display:flex><span>  symbol
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># ...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>when</span> <span style=color:#e6db74>&#39;;&#39;</span> <span style=color:#66d9ef>then</span> read_symbol_link
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># ...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>read_symbol_link</span>
</span></span><span style=display:flex><span>  @symbols_cache<span style=color:#f92672>[</span>read_integer<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><p>I&rsquo;ll return to symbol links and my thoughts about how it can be used to compress marshalled output
in &ldquo;Optimizations&rdquo; section.</p><h2 id=object-links>Object links</h2><p>Same story here, when you have an object that appears multiple times in your data, <code>Marshal</code> will serialize it only once:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span>obj1 <span style=color:#f92672>=</span> <span style=color:#66d9ef>Object</span><span style=color:#f92672>.</span>new
</span></span><span style=display:flex><span>obj2 <span style=color:#f92672>=</span> <span style=color:#66d9ef>Object</span><span style=color:#f92672>.</span>new
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>a1 <span style=color:#f92672>=</span> <span style=color:#f92672>[</span>obj1, obj2<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>a2 <span style=color:#f92672>=</span> <span style=color:#f92672>[</span>obj1, obj1<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>dumped1 <span style=color:#f92672>=</span> <span style=color:#66d9ef>Marshal</span><span style=color:#f92672>.</span>dump(a1)
</span></span><span style=display:flex><span>dumped1<span style=color:#f92672>.</span>length
</span></span><span style=display:flex><span> <span style=color:#f92672>=&gt;</span> <span style=color:#ae81ff>18</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>dumped2 <span style=color:#f92672>=</span> <span style=color:#66d9ef>Marshal</span><span style=color:#f92672>.</span>dump(a2)
</span></span><span style=display:flex><span>dumped2<span style=color:#f92672>.</span>length
</span></span><span style=display:flex><span> <span style=color:#f92672>=&gt;</span> <span style=color:#ae81ff>16</span>
</span></span></code></pre></div><p>A symbol that indicates a beginning of an object link is <code>"@"</code>. However the criteria for
dumping an object link instead of an object itself is objects equality (<code>equal?</code>).
Here&rsquo;s the problem: if you dump an array <code>[{}, {}]</code>, <code>Marshal</code> will dump
both objects without any object links, because these objects are not equal.</p><p>Also <code>Marshal</code> does not cache:</p><ul><li><code>true</code>/<code>false</code>/<code>nil</code></li><li><code>Integer</code></li><li><code>String</code> when it&rsquo;s a part of float/regexp</li><li><code>Hash</code> when it&rsquo;s a hash of instance variables/<code>struct</code> members</li></ul><p>Which is mostly correct.</p><ul><li><code>true</code>/<code>false</code>/<code>nil</code>/integers/floats always point to the same object in the memory</li><li>If we dump <code>[s, Regexp.new(s)]</code> it will not create an object link. Why? <code>Regexp.new</code> always creates a copy of the string inside, so there&rsquo;s no way to save any memory using object links, <code>regexp.source</code> is always a unique object in the memory.</li><li>If we dump two objects with the same hash of instance variables there are two cases:<ul><li>If these objects have the same class, then it&rsquo;s almost 100% guarantee
that these objects are the same. Then the output stream looks like <code>[Object, ObjectLink]</code>.</li><li>If these objects have a different class but the same hash of instance variables -
then we should not create an object link and that&rsquo;s correct.</li></ul></li></ul><p>The code for object links is quite big to paste it here, you can find it
<a href=https://github.com/iliabylich/pure_ruby_marshal/commit/a26aa1aecec20cee1c2a908673fe79275dcdfa58 target=_blank rel="noreferrer nofollow">here</a></p><h2 id=other-cases>Other cases</h2><p>To be honest, there are a few more cases, but they are too complex
for implementing and pasting it here. I&rsquo;m not going to cover here:</p><ul><li>Encoding</li><li>User marshalled objects (i.e. with <code>marshal_dump/load</code>)</li><li><code>Bignum</code></li><li>Edge cases of <code>Float</code> like infinity</li><li>Some stuff that I just don&rsquo;t know from marshalling like <code>UserDef</code>/<code>Hashdef</code>/<code>ModuleOld</code></li></ul><h2 id=writing>Writing</h2><p>If you have read the previous part, I suppose it should be clear for you how to write it yourself :)</p><h2 id=optimizations>Optimizations</h2><p>Let&rsquo;s try on the real-world examples. Stuff that usually gets serialized is your data.
And I can remember only one example where <code>Marshal</code> is used - model caching.</p><p>Imagine I have a model <code>User</code> with the following columns:</p><ul><li><code>id</code></li><li><code>email</code></li><li><code>created_at</code>/<code>updated_at</code></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#66d9ef>Marshal</span><span style=color:#f92672>.</span>dump(<span style=color:#66d9ef>User</span><span style=color:#f92672>.</span>first)<span style=color:#f92672>.</span>length
</span></span><span style=display:flex><span> <span style=color:#f92672>=&gt;</span> <span style=color:#ae81ff>891</span>
</span></span></code></pre></div><p>That&rsquo;s a lot&mldr; The easiest solution is to dump only <code>attributes</code> hash:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>User</span> <span style=color:#f92672>&lt;</span> <span style=color:#66d9ef>ActiveRecord</span><span style=color:#f92672>::</span><span style=color:#66d9ef>Base</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>marshal_dump</span>(<span style=color:#f92672>*</span>)
</span></span><span style=display:flex><span>    attributes
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>marshal_load</span>(attributes)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>initialize</span>(attributes)
</span></span><span style=display:flex><span>    @new_record <span style=color:#f92672>=</span> id<span style=color:#f92672>.</span>blank?
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>Marshal</span><span style=color:#f92672>.</span>load <span style=color:#66d9ef>Marshal</span><span style=color:#f92672>.</span>dump(<span style=color:#66d9ef>User</span><span style=color:#f92672>.</span>first)
</span></span><span style=display:flex><span> <span style=color:#f92672>=&gt;</span> <span style=color:#75715e>#&lt;User id: 131 ...&gt;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>Marshal</span><span style=color:#f92672>.</span>dump(<span style=color:#66d9ef>User</span><span style=color:#f92672>.</span>first)<span style=color:#f92672>.</span>length
</span></span><span style=display:flex><span> <span style=color:#f92672>=&gt;</span> <span style=color:#ae81ff>205</span>
</span></span></code></pre></div><p>That&rsquo;s better, let&rsquo;s see what else we can improve.</p><p>By default <code>ActiveRecord::Base#attributes</code> returns a hash where keys are <code>String</code>. That sounds like
it can be optimized by calling <code>attributes.symbolize_keys</code> in <code>marshal_dump</code> to use symbol links
when we dump a collection. <strong>But that&rsquo;s not true!</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#66d9ef>User</span><span style=color:#f92672>.</span>all<span style=color:#f92672>.</span>map(<span style=color:#f92672>&amp;</span><span style=color:#e6db74>:attributes</span>)<span style=color:#f92672>.</span>map(<span style=color:#f92672>&amp;</span><span style=color:#e6db74>:keys</span>)<span style=color:#f92672>.</span>flatten<span style=color:#f92672>.</span>map(<span style=color:#f92672>&amp;</span><span style=color:#e6db74>:object_id</span>)<span style=color:#f92672>.</span>uniq<span style=color:#f92672>.</span>length
</span></span><span style=display:flex><span> <span style=color:#f92672>=&gt;</span> <span style=color:#ae81ff>4</span> (<span style=color:#66d9ef>for</span> <span style=color:#ae81ff>4</span> columns)
</span></span></code></pre></div><p>This is an amazing example of optimization!</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#66d9ef>User</span><span style=color:#f92672>::</span><span style=color:#66d9ef>AttrNames</span><span style=color:#f92672>.</span>constants
</span></span><span style=display:flex><span> <span style=color:#f92672>=&gt;</span> <span style=color:#f92672>[</span><span style=color:#e6db74>:ATTR_9646</span>, <span style=color:#e6db74>:ATTR_56d61696c6</span>, <span style=color:#e6db74>:ATTR_36275616475646f51647</span>, <span style=color:#e6db74>:ATTR_57074616475646f51647</span><span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>User</span><span style=color:#f92672>::</span><span style=color:#66d9ef>AttrNames</span><span style=color:#f92672>.</span>constants<span style=color:#f92672>.</span>map <span style=color:#66d9ef>do</span> <span style=color:#f92672>|</span>const_name<span style=color:#f92672>|</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>User</span><span style=color:#f92672>::</span><span style=color:#66d9ef>AttrNames</span><span style=color:#f92672>.</span>const_get(const_name)
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span> <span style=color:#f92672>=&gt;</span> <span style=color:#f92672>[</span><span style=color:#e6db74>&#34;id&#34;</span>, <span style=color:#e6db74>&#34;email&#34;</span>, <span style=color:#e6db74>&#34;created_at&#34;</span>, <span style=color:#e6db74>&#34;updated_at&#34;</span><span style=color:#f92672>]</span>
</span></span></code></pre></div><p>Keys in the <code>attributes</code> hash are from these constants, so they are always the same
objects, so <code>Marshal</code> cashes them using object links.</p><p>By the way, why does ActiveRecord save attribute names as <code>String</code>? The answer is simple,
<code>Symbol</code> has no encoding.</p><p>Well, currently our record is represented by:</p><ul><li>class name as a symbol (so it can be cached)</li><li>hash of attributes:<ol><li><code>String</code> &ldquo;id&rdquo; / object link</li><li><code>Integer</code> id - can&rsquo;t do anything here</li><li><code>String</code> &ldquo;email&rdquo; / object link</li><li><code>String</code> email - nothing to optimize</li><li><code>String</code> &ldquo;created_at&rdquo; / object link</li><li><code>ActiveSupport::TimeWithZone</code> created_at - probably can be optimized</li><li><code>String</code> &ldquo;updated_at&rdquo; / object link</li><li><code>ActiveSupport::TimeWithZone</code> updated_at - probably can be optimized</li></ol></li></ul><p>Let&rsquo;s see what happens when we serialize <code>AS::TimeWithZone</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#66d9ef>Marshal</span><span style=color:#f92672>.</span>dump(<span style=color:#66d9ef>Time</span><span style=color:#f92672>.</span>zone<span style=color:#f92672>.</span>now)<span style=color:#f92672>.</span>length
</span></span><span style=display:flex><span> <span style=color:#f92672>=&gt;</span> <span style=color:#ae81ff>120</span>
</span></span></code></pre></div><p>So, from 205 characters of our record 120 is taken for a time with zone. <code>AS::TimeWithZone</code> has
its custom implementation of <code>marshal_load</code> that converts it to <code>[utc, zone, time]</code>.
If you always use your application time zone,
then you can store it as epoch time:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ActiveSupport</span><span style=color:#f92672>::</span><span style=color:#66d9ef>TimeWithZone</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>marshal_dump</span>(<span style=color:#f92672>*</span>)
</span></span><span style=display:flex><span>    to_i
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>marshal_load</span>(epoch)
</span></span><span style=display:flex><span>    utc <span style=color:#f92672>=</span> <span style=color:#66d9ef>Time</span><span style=color:#f92672>.</span>at(epoch)
</span></span><span style=display:flex><span>    zone <span style=color:#f92672>=</span> <span style=color:#66d9ef>Rails</span><span style=color:#f92672>.</span>application<span style=color:#f92672>.</span>config<span style=color:#f92672>.</span>time_zone
</span></span><span style=display:flex><span>    local <span style=color:#f92672>=</span> utc<span style=color:#f92672>.</span>in_time_zone(zone)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>initialize</span>(utc<span style=color:#f92672>.</span>utc, <span style=color:#f92672>::</span><span style=color:#66d9ef>Time</span><span style=color:#f92672>.</span>find_zone(zone), local)
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#66d9ef>Marshal</span><span style=color:#f92672>.</span>dump(<span style=color:#66d9ef>User</span><span style=color:#f92672>.</span>first)<span style=color:#f92672>.</span>length
</span></span><span style=display:flex><span> <span style=color:#f92672>=&gt;</span> <span style=color:#ae81ff>139</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>Marshal</span><span style=color:#f92672>.</span>dump(<span style=color:#66d9ef>User</span><span style=color:#f92672>.</span>first(<span style=color:#ae81ff>3</span>))<span style=color:#f92672>.</span>length
</span></span><span style=display:flex><span> <span style=color:#f92672>=&gt;</span> <span style=color:#ae81ff>261</span>
</span></span></code></pre></div><p>Personally I&rsquo;m not sure that the next optimization is a good idea, but you can try:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>User</span> <span style=color:#f92672>&lt;</span> <span style=color:#66d9ef>ActiveRecord</span><span style=color:#f92672>::</span><span style=color:#66d9ef>Base</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>self</span><span style=color:#f92672>.</span><span style=color:#a6e22e>marshallable_attributes</span>
</span></span><span style=display:flex><span>    @marshallable_attributes <span style=color:#f92672>||=</span> <span style=color:#e6db74>%w(
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      id
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      email
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      created_at
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      updated_at
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    )</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>marshal_dump</span>(<span style=color:#f92672>*</span>)
</span></span><span style=display:flex><span>    self<span style=color:#f92672>.</span>class<span style=color:#f92672>.</span>marshallable_attributes<span style=color:#f92672>.</span>map <span style=color:#66d9ef>do</span> <span style=color:#f92672>|</span>attribute<span style=color:#f92672>|</span>
</span></span><span style=display:flex><span>      attributes<span style=color:#f92672>[</span>attribute<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>marshal_load</span>(attributes)
</span></span><span style=display:flex><span>    attributes <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>class<span style=color:#f92672>.</span>marshallable_attributes<span style=color:#f92672>.</span>zip(attributes)
</span></span><span style=display:flex><span>    attributes <span style=color:#f92672>=</span> <span style=color:#66d9ef>Hash</span><span style=color:#f92672>[</span>attributes<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>initialize</span>(attributes)
</span></span><span style=display:flex><span>    @new_record <span style=color:#f92672>=</span> id<span style=color:#f92672>.</span>blank?
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><p>The idea is to store a hard-coded sequence of attribute names and using it
serialize only values of attributes. It allows us to not serialize object links
of attribute names.</p><p>Why can&rsquo;t we just get <code>attributes.keys.sort</code>? Because you can add one more
column that may come to the middle of that array. As a result, your
attributes may become shuffled. But probably you can avoid it by changing a cache key
right after adding a column.</p><p>You can extend this solution to something similar to <code>ActiveModel::Serializer</code>
where you have a separate serializer class for every model class.</p><p>Let&rsquo;s see what this optimization gives us:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#66d9ef>Marshal</span><span style=color:#f92672>.</span>dump(<span style=color:#66d9ef>User</span><span style=color:#f92672>.</span>first)<span style=color:#f92672>.</span>length
</span></span><span style=display:flex><span> <span style=color:#f92672>=&gt;</span> <span style=color:#ae81ff>84</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>Marshal</span><span style=color:#f92672>.</span>dump(<span style=color:#66d9ef>User</span><span style=color:#f92672>.</span>first(<span style=color:#ae81ff>3</span>)<span style=color:#f92672>.</span>to_a)<span style=color:#f92672>.</span>length
</span></span><span style=display:flex><span> <span style=color:#f92672>=&gt;</span> <span style=color:#ae81ff>190</span>
</span></span></code></pre></div><p>That&rsquo;s 10 times less then initial size, good job!</p><p>Of course, if you have columns with type <code>text</code> there&rsquo;s nothing to
optimize, this is my example and my experience.</p><h2 id=what-is-it-for>What is it for?</h2><p>I have been working for about 3 weeks on implementing <code>Marshal</code> module for <a href=https://github.com/opal/opal target=_blank rel="noreferrer nofollow">opal</a>
.
It&rsquo;s almost compatible with MRI implementation. I believe <code>Marshal</code> is the thing
that can bring real isomorphism to opal applications. If you have an object that can be dumped
on the server and its class was compiled on the client, you can pass it <strong>directly</strong>
from the server without any serialization on the client/server.</p><h2 id=links>Links</h2><p><a href=https://github.com/iliabylich/pure_ruby_marshal target=_blank rel="noreferrer nofollow">GitHub repository with <code>PureRubyMarshal</code></a></p><p><a href=https://github.com/opal/opal/pull/1191 target=_blank rel="noreferrer nofollow">Possible Opal implementation of Marshal</a></p></main><br><footer><script defer>function addCopyButtonToCodeBlocks(){const e=document.querySelectorAll('code[class^="language-"]');e.forEach(e=>{const t=document.createElement("button");t.classList.add("copy-code-button"),t.innerHTML="copy",t.addEventListener("click",()=>{const n=e.textContent;navigator.clipboard.writeText(n),t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},1500)}),e.parentNode.before(t)})}setTimeout(function(){addCopyButtonToCodeBlocks()},100)</script><script defer>function throttle(e,t){var n=Date.now();return function(){var s=Date.now();n+t-s<0&&(e(),n=s)}}function scrollHandler(){const e=Array.from(document.querySelectorAll("body h2, body h3"));function t(){for(var n,s,o,i=window.pageYOffset||document.documentElement.scrollTop,t=0;t<e.length;t++)s=e[t].getAttribute("id"),n=document.querySelector('nav ul li a[href="#'+s+'"]'),n&&n.classList.remove("active-toc");for(t=e.length-1;t>=0;t--)if(o=e[t].offsetTop,i>o-75&&(s=e[t].getAttribute("id"),n=document.querySelector('nav ul li a[href="#'+s+'"]'),n)){n.classList.add("active-toc");break}}window.addEventListener("scroll",throttle(t,300))}setTimeout(scrollHandler,100)</script></footer></body></html>